[build]
builder = "nixpacks"

# Next.js Frontend Service
[[services]]
name = "bookiji-frontend"
source_dir = "."
build_command = "npm install && npm run build"
start_command = "npm start"
healthcheck_path = "/"
healthcheck_timeout = 300
restart_policy_type = "on_failure"
restart_policy_max_retries = 10

[services.envs]
NODE_ENV = "production"
NEXT_PUBLIC_APP_URL = "https://bookiji-frontend.railway.app"

# LLM Service (Ollama)
[[services]]
name = "bookiji-llm"
source_dir = "./llm"
build_command = "docker build -t bookiji-llm ."
start_command = "ollama serve"
healthcheck_path = "/api/tags"
healthcheck_timeout = 60
restart_policy_type = "on_failure"
restart_policy_max_retries = 5

[services.envs]
OLLAMA_HOST = "0.0.0.0"
OLLAMA_ORIGINS = "*"

# PostgreSQL Database Service
[[services]]
name = "bookiji-database"
image = "postgres:15"
start_command = "postgres -c log_statement=all"
healthcheck_path = "/"
healthcheck_timeout = 30
restart_policy_type = "on_failure"
restart_policy_max_retries = 3

[services.envs]
POSTGRES_DB = "bookiji"
POSTGRES_USER = "bookiji_user"
POSTGRES_PASSWORD = "bookiji_password_2024"

# Service Dependencies
[services.dependencies]
bookiji-frontend = ["bookiji-database", "bookiji-llm"]
bookiji-llm = ["bookiji-database"] 