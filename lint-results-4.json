[{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\app\\admin\\simcity\\mission-control\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'useRef' is defined but never used. Allowed unused vars must match /^_/u.","line":3,"column":38,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":44},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'AnimatePresence' is defined but never used. Allowed unused vars must match /^_/u.","line":26,"column":18,"nodeType":null,"messageId":"unusedVar","endLine":26,"endColumn":33},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CardDescription' is defined but never used. Allowed unused vars must match /^_/u.","line":40,"column":52,"nodeType":null,"messageId":"unusedVar","endLine":40,"endColumn":67},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Input' is defined but never used. Allowed unused vars must match /^_/u.","line":42,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":42,"endColumn":15},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Tabs' is defined but never used. Allowed unused vars must match /^_/u.","line":43,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":43,"endColumn":14},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'TabsContent' is defined but never used. Allowed unused vars must match /^_/u.","line":43,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":43,"endColumn":27},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'TabsList' is defined but never used. Allowed unused vars must match /^_/u.","line":43,"column":29,"nodeType":null,"messageId":"unusedVar","endLine":43,"endColumn":37},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'TabsTrigger' is defined but never used. Allowed unused vars must match /^_/u.","line":43,"column":39,"nodeType":null,"messageId":"unusedVar","endLine":43,"endColumn":50},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Slider' is defined but never used. Allowed unused vars must match /^_/u.","line":44,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":44,"endColumn":16}],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":56,"column":12,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":56,"endColumn":15,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1234,1237],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1234,1237],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":123,"column":72,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":123,"endColumn":75,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3916,3919],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3916,3919],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":147,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":147,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5200,5203],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5200,5203],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchData'. Either include it or remove the dependency array.","line":160,"column":6,"nodeType":"ArrayExpression","endLine":160,"endColumn":44,"suggestions":[{"desc":"Update the dependencies array to be: [mode, selectedRunId, refreshInterval, fetchData]","fix":{"range":[5787,5825],"text":"[mode, selectedRunId, refreshInterval, fetchData]"}}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchRequests'. Either include it or remove the dependency array.","line":167,"column":6,"nodeType":"ArrayExpression","endLine":167,"endColumn":12,"suggestions":[{"desc":"Update the dependencies array to be: [fetchRequests, mode]","fix":{"range":[5977,5983],"text":"[fetchRequests, mode]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":9,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport React, { useEffect, useState, useRef, useMemo } from 'react';\r\nimport { \r\n  Activity, \r\n  _Play, \r\n  Square, \r\n  Clock, \r\n  ShieldAlert, \r\n  _History, \r\n  _ChevronRight, \r\n  _Search,\r\n  _Filter,\r\n  _BarChart3,\r\n  List,\r\n  AlertCircle,\r\n  Zap,\r\n  RefreshCcw,\r\n  _Copy,\r\n  _Terminal,\r\n  _Database,\r\n  ArrowRight,\r\n  Globe,\r\n  Cpu\r\n} from 'lucide-react';\r\nimport { motion, AnimatePresence } from 'framer-motion';\r\nimport { \r\n  _LineChart, \r\n  _Line, \r\n  _XAxis, \r\n  _YAxis, \r\n  _CartesianGrid, \r\n  _Tooltip, \r\n  _ResponsiveContainer,\r\n  _AreaChart,\r\n  _Area\r\n} from 'recharts';\r\n\r\nimport { Button } from '@/components/ui/button';\r\nimport { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';\r\nimport { Badge } from '@/components/ui/badge';\r\nimport { Input } from '@/components/ui/input';\r\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';\r\nimport { Slider } from '@/components/ui/slider';\r\n\r\n// --- Types ---\r\n\r\ninterface OpsEvent {\r\n  id: string;\r\n  ts: string;\r\n  source: 'prod' | 'simcity';\r\n  run_id: string | null;\r\n  provider_id: string | null;\r\n  type: string;\r\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  payload: any;\r\n}\r\n\r\ninterface OpsMetrics {\r\n  bookings_created_count: number;\r\n  cancellations_count: number;\r\n  reschedules_count: number;\r\n  active_bookings_count: number;\r\n  slots_available_count: number;\r\n  slots_unavailable_count: number;\r\n  invariant_failures_count: number;\r\n}\r\n\r\ninterface _FusedMetrics {\r\n  prod: OpsMetrics;\r\n  simcity: OpsMetrics;\r\n  fused: OpsMetrics;\r\n}\r\n\r\ninterface SimCityRunRequest {\r\n  id: string;\r\n  status: string;\r\n  tier: string;\r\n  seed: number;\r\n  created_at: string;\r\n  run_id: string | null;\r\n}\r\n\r\n// --- Components ---\r\n\r\nconst EventDetailModal = ({ event, onClose }: { event: OpsEvent | null, onClose: () => void }) => {\r\n  if (!event) return null;\r\n  return (\r\n    <div className=\"fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-950/80 backdrop-blur-sm\">\r\n      <div className=\"bg-slate-900 border border-slate-800 rounded-xl w-full max-w-2xl max-h-[90vh] flex flex-col shadow-2xl\">\r\n        <div className=\"p-4 border-b border-slate-800 flex justify-between items-center\">\r\n          <h3 className=\"text-cyan-400 font-mono font-bold\">Event Details</h3>\r\n          <Button variant=\"ghost\" size=\"sm\" onClick={onClose} className=\"text-slate-400 hover:text-white\">\r\n            <Square className=\"w-4 h-4\" />\r\n          </Button>\r\n        </div>\r\n        <div className=\"p-6 overflow-auto font-mono text-xs bg-slate-950 m-4 rounded-lg border border-slate-800\">\r\n          <div className=\"mb-4\">\r\n            <span className=\"text-slate-500\">Source:</span> <Badge className={event.source === 'prod' ? 'bg-blue-500/20 text-blue-400' : 'bg-cyan-500/20 text-cyan-400'}>{event.source}</Badge>\r\n          </div>\r\n          <div className=\"mb-4\">\r\n            <span className=\"text-slate-500\">Type:</span> <span className=\"text-slate-200\">{event.type}</span>\r\n          </div>\r\n          <div className=\"mb-4\">\r\n            <span className=\"text-slate-500\">Timestamp:</span> <span className=\"text-slate-200\">{new Date(event.ts).toLocaleString()}</span>\r\n          </div>\r\n          {event.run_id && (\r\n            <div className=\"mb-4\">\r\n              <span className=\"text-slate-500\">Run ID:</span> <span className=\"text-slate-200\">{event.run_id}</span>\r\n            </div>\r\n          )}\r\n          <pre className=\"text-cyan-200/80\">{JSON.stringify(event.payload, null, 2)}</pre>\r\n        </div>\r\n        <div className=\"p-4 border-t border-slate-800 flex justify-end\">\r\n          <Button variant=\"outline\" size=\"sm\" onClick={onClose}>Close</Button>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n};\r\n\r\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nconst KPICard = ({ title, value, splitValue, colorClass, icon: Icon }: any) => (\r\n  <Card className=\"bg-slate-900/40 border-slate-800 shadow-none overflow-hidden group\">\r\n    <CardHeader className=\"p-4 pb-0 flex flex-row items-center justify-between\">\r\n      <CardTitle className=\"text-[10px] uppercase text-slate-500 font-bold tracking-widest\">{title}</CardTitle>\r\n      <Icon className={`w-3 h-3 ${colorClass} opacity-50 group-hover:opacity-100 transition-opacity`} />\r\n    </CardHeader>\r\n    <CardContent className=\"p-4\">\r\n      <div className={`text-3xl font-mono font-bold ${colorClass}`}>\r\n        {value}\r\n      </div>\r\n      {splitValue && (\r\n        <div className=\"flex items-center mt-2 space-x-3 text-[10px] font-mono text-slate-500\">\r\n          <span className=\"flex items-center\"><Globe className=\"w-2.5 h-2.5 mr-1 text-blue-500/70\" /> {splitValue.prod}</span>\r\n          <span className=\"flex items-center\"><Cpu className=\"w-2.5 h-2.5 mr-1 text-cyan-500/70\" /> {splitValue.simcity}</span>\r\n        </div>\r\n      )}\r\n    </CardContent>\r\n  </Card>\r\n);\r\n\r\nexport default function MissionControlPage() {\r\n  const [mode, setMode] = useState<'FUSED' | 'LIVE' | 'SIMCITY'>('FUSED');\r\n  const [events, setEvents] = useState<OpsEvent[]>([]);\r\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  const [metrics, setMetrics] = useState<any>(null);\r\n  const [requests, setRequests] = useState<SimCityRunRequest[]>([]);\r\n  const [selectedRunId, setSelectedRunId] = useState<string | null>(null);\r\n  const [isLoading, _setIsLoading] = useState(false);\r\n  const [selectedEvent, setSelectedEvent] = useState<OpsEvent | null>(null);\r\n  const [refreshInterval, _setRefreshInterval] = useState(5000);\r\n\r\n  // Mode effects\r\n  useEffect(() => {\r\n    fetchData();\r\n    const interval = setInterval(fetchData, refreshInterval);\r\n    return () => clearInterval(interval);\r\n  // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [mode, selectedRunId, refreshInterval]);\r\n\r\n  useEffect(() => {\r\n    if (mode === 'SIMCITY') {\r\n      fetchRequests();\r\n    }\r\n  // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [mode]);\r\n\r\n  const fetchData = async () => {\r\n    try {\r\n      const sourceMap = { 'FUSED': 'fused', 'LIVE': 'prod', 'SIMCITY': 'simcity' };\r\n      const source = sourceMap[mode];\r\n      \r\n      let eventsUrl = `/api/ops/events?source=${source}&limit=50`;\r\n      if (mode === 'SIMCITY' && selectedRunId) {\r\n        eventsUrl += `&run_id=${selectedRunId}`;\r\n      }\r\n      \r\n      const metricsUrl = `/api/ops/metrics?source=${source}&window_seconds=3600`;\r\n      \r\n      const [eventsRes, metricsRes] = await Promise.all([\r\n        fetch(eventsUrl),\r\n        fetch(metricsUrl)\r\n      ]);\r\n      \r\n      const eventsData = await eventsRes.json();\r\n      const metricsData = await metricsRes.json();\r\n      \r\n      setEvents(eventsData.data || []);\r\n      setMetrics(metricsData.data);\r\n    } catch (err) {\r\n      console.error('Failed to fetch data', err);\r\n    }\r\n  };\r\n\r\n  const fetchRequests = async () => {\r\n    try {\r\n      const res = await fetch('/api/ops/simcity/run-requests');\r\n      if (!res.ok) {\r\n        console.error('Failed to fetch requests:', res.statusText);\r\n        setRequests([]);\r\n        return;\r\n      }\r\n      const data = await res.json();\r\n      // Ensure data is an array\r\n      const requestsArray = Array.isArray(data) ? data : [];\r\n      setRequests(requestsArray);\r\n      if (requestsArray.length > 0 && !selectedRunId) {\r\n        setSelectedRunId(requestsArray[0].run_id);\r\n      }\r\n    } catch (err) {\r\n      console.error('Failed to fetch requests', err);\r\n      setRequests([]); // Set to empty array on error\r\n    }\r\n  };\r\n\r\n  const handleStartRun = async () => {\r\n    try {\r\n      await fetch('/api/ops/simcity/run', {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n          tier: 'A',\r\n          seed: Math.floor(Math.random() * 1000000),\r\n          concurrency: 5,\r\n          max_events: 100,\r\n          duration_seconds: 60\r\n        })\r\n      });\r\n      fetchRequests();\r\n    } catch (err) {\r\n      console.error('Failed to start run', err);\r\n    }\r\n  };\r\n\r\n  const displayMetrics = useMemo(() => {\r\n    if (!metrics) return null;\r\n    if (mode === 'FUSED') return metrics.fused;\r\n    return metrics;\r\n  }, [metrics, mode]);\r\n\r\n  const splitMetrics = useMemo(() => {\r\n    if (mode !== 'FUSED' || !metrics) return null;\r\n    return {\r\n      active: { prod: metrics.prod.active_bookings_count, simcity: metrics.simcity.active_bookings_count },\r\n      created: { prod: metrics.prod.bookings_created_count, simcity: metrics.simcity.bookings_created_count },\r\n      cancelled: { prod: metrics.prod.cancellations_count, simcity: metrics.simcity.cancellations_count },\r\n      failures: { prod: metrics.prod.invariant_failures_count, simcity: metrics.simcity.invariant_failures_count }\r\n    };\r\n  }, [metrics, mode]);\r\n\r\n  return (\r\n    <div className=\"flex h-screen bg-slate-950 text-slate-100 overflow-hidden font-sans selection:bg-cyan-500/30\">\r\n      {/* Sidebar for SimCity runs */}\r\n      {mode === 'SIMCITY' && (\r\n        <div className=\"w-80 border-r border-slate-800 flex flex-col bg-slate-900/50 backdrop-blur-xl shrink-0\">\r\n          <div className=\"p-4 border-b border-slate-800 space-y-4\">\r\n            <h2 className=\"text-xs font-bold text-slate-500 uppercase tracking-widest\">SimCity Runs</h2>\r\n            <Button className=\"w-full bg-cyan-600 hover:bg-cyan-500 text-white shadow-lg\" onClick={handleStartRun}>\r\n              <Zap className=\"w-4 h-4 mr-2\" /> New Run\r\n            </Button>\r\n          </div>\r\n          <div className=\"flex-1 overflow-y-auto p-2 space-y-1\">\r\n            {Array.isArray(requests) && requests.length > 0 ? (\r\n              requests.map((req) => (\r\n                <button\r\n                  key={req.id}\r\n                  onClick={() => setSelectedRunId(req.run_id)}\r\n                  className={`w-full text-left p-3 rounded-lg border transition-all ${\r\n                    selectedRunId === req.run_id ? 'bg-cyan-500/10 border-cyan-500/50' : 'hover:bg-slate-800/50 border-transparent'\r\n                  }`}\r\n                >\r\n                  <div className=\"flex justify-between items-center mb-1\">\r\n                    <span className=\"font-mono text-[10px] text-slate-500\">#{req.run_id?.slice(0, 8) || 'PENDING'}</span>\r\n                    <Badge variant=\"outline\" className=\"text-[8px] uppercase\">{req.status}</Badge>\r\n                  </div>\r\n                  <div className=\"text-sm font-medium\">Tier {req.tier} â€¢ Seed {req.seed}</div>\r\n                  <div className=\"text-[10px] text-slate-600 mt-1\">{new Date(req.created_at).toLocaleString()}</div>\r\n                </button>\r\n              ))\r\n            ) : (\r\n              <div className=\"p-4 text-center text-slate-500 text-sm\">\r\n                No SimCity runs found\r\n              </div>\r\n            )}\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {/* Main Content Area */}\r\n      <div className=\"flex-1 flex flex-col min-w-0\">\r\n        {/* Header with Mode Selector */}\r\n        <header className=\"h-20 border-b border-slate-800 flex items-center justify-between px-8 bg-slate-900/30\">\r\n          <div className=\"flex items-center space-x-8\">\r\n            <h1 className=\"text-2xl font-black tracking-tighter bg-gradient-to-r from-blue-400 to-cyan-400 bg-clip-text text-transparent\">MISSION CONTROL</h1>\r\n            <div className=\"flex bg-slate-950 border border-slate-800 rounded-full p-1 p-x-2\">\r\n              {(['FUSED', 'LIVE', 'SIMCITY'] as const).map((m) => (\r\n                <button\r\n                  key={m}\r\n                  onClick={() => setMode(m)}\r\n                  className={`px-6 py-1.5 rounded-full text-[10px] font-bold tracking-widest transition-all ${\r\n                    mode === m \r\n                      ? 'bg-gradient-to-r from-blue-600 to-cyan-600 text-white shadow-lg shadow-cyan-900/40' \r\n                      : 'text-slate-500 hover:text-slate-300'\r\n                  }`}\r\n                >\r\n                  {m}\r\n                </button>\r\n              ))}\r\n            </div>\r\n          </div>\r\n          <div className=\"flex items-center space-x-4\">\r\n            <div className=\"flex items-center space-x-2 bg-slate-900/50 border border-slate-800 px-3 py-1.5 rounded-lg\">\r\n              <div className={`w-2 h-2 rounded-full ${isLoading ? 'bg-amber-500 animate-pulse' : 'bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.5)]'}`} />\r\n              <span className=\"text-[10px] font-mono text-slate-400 uppercase tracking-widest\">{isLoading ? 'Syncing...' : 'Connected'}</span>\r\n            </div>\r\n            <Button variant=\"ghost\" size=\"icon\" onClick={fetchData} className=\"hover:bg-slate-800\">\r\n              <RefreshCcw className=\"w-4 h-4 text-slate-500\" />\r\n            </Button>\r\n          </div>\r\n        </header>\r\n\r\n        {/* Dash Content */}\r\n        <div className=\"flex-1 overflow-hidden flex flex-col p-8 space-y-8\">\r\n          {/* KPI Grid */}\r\n          <div className=\"grid grid-cols-4 gap-6\">\r\n            <KPICard \r\n              title=\"Active Bookings\" \r\n              value={displayMetrics?.active_bookings_count || 0} \r\n              splitValue={splitMetrics?.active}\r\n              colorClass=\"text-emerald-400\" \r\n              icon={Activity}\r\n            />\r\n            <KPICard \r\n              title=\"Bookings Created\" \r\n              value={displayMetrics?.bookings_created_count || 0} \r\n              splitValue={splitMetrics?.created}\r\n              colorClass=\"text-blue-400\" \r\n              icon={Zap}\r\n            />\r\n            <KPICard \r\n              title=\"Cancellations\" \r\n              value={displayMetrics?.cancellations_count || 0} \r\n              splitValue={splitMetrics?.cancelled}\r\n              colorClass=\"text-rose-400\" \r\n              icon={AlertCircle}\r\n            />\r\n            <KPICard \r\n              title=\"Invariant Failures\" \r\n              value={displayMetrics?.invariant_failures_count || 0} \r\n              splitValue={splitMetrics?.failures}\r\n              colorClass=\"text-amber-400\" \r\n              icon={ShieldAlert}\r\n            />\r\n          </div>\r\n\r\n          {/* Timeline Lanes */}\r\n          <div className=\"bg-slate-900/40 border border-slate-800 rounded-2xl p-6 flex flex-col\">\r\n            <h3 className=\"text-xs font-bold uppercase tracking-widest text-slate-500 mb-6 flex items-center\">\r\n              <Clock className=\"w-4 h-4 mr-2 text-blue-500\" />\r\n              Fusion Ops Stream (Last 50 Events)\r\n            </h3>\r\n            \r\n            <div className=\"space-y-6\">\r\n              {/* Prod Lane */}\r\n              {(mode === 'FUSED' || mode === 'LIVE') && (\r\n                <div className=\"relative group\">\r\n                  <div className=\"absolute -left-12 top-1/2 -translate-y-1/2 -rotate-90 text-[8px] font-black tracking-tighter text-blue-500/40 uppercase group-hover:text-blue-400 transition-colors\">PROD</div>\r\n                  <div className=\"h-16 bg-slate-950/50 rounded-xl border border-slate-800/50 flex items-center px-4 space-x-1 overflow-hidden\">\r\n                    {events.filter(e => e.source === 'prod').map(e => (\r\n                      <motion.div\r\n                        key={e.id}\r\n                        initial={{ scale: 0 }}\r\n                        animate={{ scale: 1 }}\r\n                        className={`w-3 h-8 rounded-sm cursor-pointer hover:w-6 hover:brightness-125 transition-all ${\r\n                          e.type.includes('fail') ? 'bg-red-500' :\r\n                          e.type.includes('cancel') ? 'bg-rose-500' :\r\n                          e.type.includes('reschedule') ? 'bg-amber-500' :\r\n                          'bg-blue-500'\r\n                        }`}\r\n                        onClick={() => setSelectedEvent(e)}\r\n                      />\r\n                    ))}\r\n                    {events.filter(e => e.source === 'prod').length === 0 && (\r\n                      <div className=\"text-[10px] text-slate-700 uppercase tracking-widest font-bold\">No production traffic detected</div>\r\n                    )}\r\n                  </div>\r\n                </div>\r\n              )}\r\n\r\n              {/* SimCity Lane */}\r\n              {(mode === 'FUSED' || mode === 'SIMCITY') && (\r\n                <div className=\"relative group\">\r\n                  <div className=\"absolute -left-12 top-1/2 -translate-y-1/2 -rotate-90 text-[8px] font-black tracking-tighter text-cyan-500/40 uppercase group-hover:text-cyan-400 transition-colors\">SIMCITY</div>\r\n                  <div className=\"h-16 bg-slate-950/50 rounded-xl border border-slate-800/50 flex items-center px-4 space-x-1 overflow-hidden\">\r\n                    {events.filter(e => e.source === 'simcity').map(e => (\r\n                      <motion.div\r\n                        key={e.id}\r\n                        initial={{ scale: 0 }}\r\n                        animate={{ scale: 1 }}\r\n                        className={`w-3 h-8 rounded-sm cursor-pointer hover:w-6 hover:brightness-125 transition-all ${\r\n                          e.type.includes('fail') ? 'bg-red-500' :\r\n                          e.type.includes('cancel') ? 'bg-rose-500' :\r\n                          e.type.includes('reschedule') ? 'bg-amber-500' :\r\n                          'bg-cyan-500'\r\n                        }`}\r\n                        onClick={() => setSelectedEvent(e)}\r\n                      />\r\n                    ))}\r\n                    {events.filter(e => e.source === 'simcity').length === 0 && (\r\n                      <div className=\"text-[10px] text-slate-700 uppercase tracking-widest font-bold\">No SimCity traffic detected</div>\r\n                    )}\r\n                  </div>\r\n                </div>\r\n              )}\r\n            </div>\r\n          </div>\r\n\r\n          {/* Event Feed */}\r\n          <div className=\"flex-1 min-h-0 bg-slate-900/40 border border-slate-800 rounded-2xl flex flex-col overflow-hidden\">\r\n            <div className=\"p-4 border-b border-slate-800 bg-slate-800/20 flex items-center justify-between\">\r\n              <h3 className=\"text-xs font-bold uppercase tracking-widest text-slate-400 flex items-center\">\r\n                <List className=\"w-4 h-4 mr-2 text-blue-500\" />\r\n                Raw Event sequence\r\n              </h3>\r\n              <Badge variant=\"outline\" className=\"font-mono text-[9px]\">{events.length} EVENTS</Badge>\r\n            </div>\r\n            <div className=\"flex-1 overflow-y-auto font-mono text-[10px]\">\r\n              <table className=\"w-full text-left border-collapse\">\r\n                <thead className=\"bg-slate-950/50 sticky top-0 text-slate-500 border-b border-slate-800\">\r\n                  <tr>\r\n                    <th className=\"p-3 pl-6\">TIME</th>\r\n                    <th className=\"p-3\">SOURCE</th>\r\n                    <th className=\"p-3\">TYPE</th>\r\n                    <th className=\"p-3\">PAYLOAD</th>\r\n                    <th className=\"p-3 pr-6 text-right\">ACTION</th>\r\n                  </tr>\r\n                </thead>\r\n                <tbody className=\"divide-y divide-slate-800/50\">\r\n                  {events.map((event) => (\r\n                    <tr key={event.id} className=\"hover:bg-slate-800/30 group transition-colors\">\r\n                      <td className=\"p-3 pl-6 text-slate-500\">{new Date(event.ts).toLocaleTimeString()}</td>\r\n                      <td className=\"p-3\">\r\n                        <span className={`px-1.5 py-0.5 rounded text-[9px] font-bold uppercase ${\r\n                          event.source === 'prod' ? 'bg-blue-500/10 text-blue-400' : 'bg-cyan-500/10 text-cyan-400'\r\n                        }`}>\r\n                          {event.source}\r\n                        </span>\r\n                      </td>\r\n                      <td className=\"p-3 font-bold\">\r\n                        <span className={\r\n                          event.type.includes('fail') ? 'text-red-400' :\r\n                          event.type.includes('cancel') ? 'text-rose-400' :\r\n                          'text-slate-300'\r\n                        }>\r\n                          {event.type}\r\n                        </span>\r\n                      </td>\r\n                      <td className=\"p-3 text-slate-500 max-w-md truncate group-hover:whitespace-normal group-hover:text-slate-400 transition-all\">\r\n                        {JSON.stringify(event.payload)}\r\n                      </td>\r\n                      <td className=\"p-3 pr-6 text-right\">\r\n                        <Button \r\n                          variant=\"ghost\" \r\n                          size=\"icon\" \r\n                          className=\"h-6 w-6 opacity-0 group-hover:opacity-100\"\r\n                          onClick={() => setSelectedEvent(event)}\r\n                        >\r\n                          <ArrowRight className=\"w-3 h-3\" />\r\n                        </Button>\r\n                      </td>\r\n                    </tr>\r\n                  ))}\r\n                </tbody>\r\n              </table>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n      <EventDetailModal event={selectedEvent} onClose={() => setSelectedEvent(null)} />\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\app\\admin\\users\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'UserX' is defined but never used. Allowed unused vars must match /^_/u.","line":5,"column":43,"nodeType":null,"messageId":"unusedVar","endLine":5,"endColumn":48}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'filterUsers'. Either include it or remove the dependency array.","line":41,"column":6,"nodeType":"ArrayExpression","endLine":41,"endColumn":38,"suggestions":[{"desc":"Update the dependencies array to be: [users, searchQuery, roleFilter, filterUsers]","fix":{"range":[1277,1309],"text":"[users, searchQuery, roleFilter, filterUsers]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useState, useEffect } from 'react'\nimport { motion, AnimatePresence } from 'framer-motion'\nimport { Search, User, Shield, UserCheck, UserX, Edit, Save, X, AlertCircle } from 'lucide-react'\n\ninterface UserProfile {\n  id: string\n  email: string\n  full_name: string | null\n  username: string | null\n  role: 'customer' | 'vendor' | 'admin'\n  created_at: string\n  phone: string | null\n}\n\nexport default function UsersManagementPage() {\n  const [users, setUsers] = useState<UserProfile[]>([])\n  const [filteredUsers, setFilteredUsers] = useState<UserProfile[]>([])\n  const [loading, setLoading] = useState(true)\n  const [searchQuery, setSearchQuery] = useState('')\n  const [roleFilter, setRoleFilter] = useState<'all' | 'customer' | 'vendor' | 'admin'>('all')\n  \n  // Editing state\n  const [editingUserId, setEditingUserId] = useState<string | null>(null)\n  const [editForm, setEditForm] = useState<{\n    role: 'customer' | 'vendor' | 'admin'\n    username: string\n  }>({ role: 'customer', username: '' })\n  \n  const [saving, setSaving] = useState(false)\n  const [error, setError] = useState<string | null>(null)\n\n  useEffect(() => {\n    loadUsers()\n  }, [])\n\n  useEffect(() => {\n    filterUsers()\n  // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [users, searchQuery, roleFilter])\n\n  const loadUsers = async () => {\n    try {\n      setLoading(true)\n      const response = await fetch('/api/admin/users/list', {\n        method: 'GET',\n        credentials: 'include'\n      })\n\n      if (!response.ok) {\n        if (response.status === 401) {\n          window.location.href = '/login'\n          return\n        }\n        const errorData = await response.json()\n        throw new Error(errorData.error || 'Failed to load users')\n      }\n\n      const { data } = await response.json()\n      setUsers(data || [])\n    } catch (error) {\n      console.error('Error loading users:', error)\n      setError(error instanceof Error ? error.message : 'Unknown error')\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  const filterUsers = () => {\n    let filtered = users\n\n    // Filter by role\n    if (roleFilter !== 'all') {\n      filtered = filtered.filter(user => user.role === roleFilter)\n    }\n\n    // Filter by search query\n    if (searchQuery) {\n      const query = searchQuery.toLowerCase()\n      filtered = filtered.filter(user =>\n        user.email?.toLowerCase().includes(query) ||\n        user.full_name?.toLowerCase().includes(query) ||\n        user.username?.toLowerCase().includes(query) ||\n        user.phone?.toLowerCase().includes(query)\n      )\n    }\n\n    setFilteredUsers(filtered)\n  }\n\n  const handleEdit = (user: UserProfile) => {\n    setEditingUserId(user.id)\n    setEditForm({\n      role: user.role,\n      username: user.username || ''\n    })\n    setError(null)\n  }\n\n  const handleCancelEdit = () => {\n    setEditingUserId(null)\n    setEditForm({ role: 'customer', username: '' })\n    setError(null)\n  }\n\n  const handleSave = async (userId: string) => {\n    try {\n      setSaving(true)\n      setError(null)\n\n      const response = await fetch('/api/admin/users/update', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        credentials: 'include',\n        body: JSON.stringify({ \n          userId, \n          role: editForm.role,\n          username: editForm.username \n        })\n      })\n\n      if (!response.ok) {\n        const errorData = await response.json()\n        throw new Error(errorData.error || 'Failed to update user')\n      }\n\n      // Update local state\n      setUsers(users.map(user =>\n        user.id === userId ? { \n          ...user, \n          role: editForm.role,\n          username: editForm.username || null \n        } : user\n      ))\n      setEditingUserId(null)\n    } catch (error) {\n      console.error('Error saving user:', error)\n      setError(error instanceof Error ? error.message : 'Failed to save')\n    } finally {\n      setSaving(false)\n    }\n  }\n\n  const getRoleBadgeColor = (role: string) => {\n    switch (role) {\n      case 'admin':\n        return 'bg-purple-100 text-purple-700 border-purple-200'\n      case 'vendor':\n        return 'bg-blue-100 text-blue-700 border-blue-200'\n      case 'customer':\n        return 'bg-green-100 text-green-700 border-green-200'\n      default:\n        return 'bg-gray-100 text-gray-700 border-gray-200'\n    }\n  }\n\n  const roleCounts = {\n    all: users.length,\n    customer: users.filter(u => u.role === 'customer').length,\n    vendor: users.filter(u => u.role === 'vendor').length,\n    admin: users.filter(u => u.role === 'admin').length,\n  }\n\n  if (loading) {\n    return (\n      <div className=\"flex items-center justify-center min-h-screen\">\n        <div className=\"animate-spin w-8 h-8 border-2 border-blue-600 border-t-transparent rounded-full\"></div>\n      </div>\n    )\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Page Header */}\n      <motion.div\n        initial={{ opacity: 0, y: -20 }}\n        animate={{ opacity: 1, y: 0 }}\n        transition={{ duration: 0.6 }}\n        className=\"mb-8\"\n      >\n        <h1 className=\"text-3xl font-bold text-gray-900 mb-2\">User Management</h1>\n        <p className=\"text-gray-600\">Manage user accounts, roles, and usernames</p>\n      </motion.div>\n\n      {/* Stats Cards */}\n      <motion.div\n        initial={{ opacity: 0, y: 20 }}\n        animate={{ opacity: 1, y: 0 }}\n        transition={{ duration: 0.6, delay: 0.2 }}\n        className=\"grid grid-cols-1 md:grid-cols-4 gap-6 mb-8\"\n      >\n        <div className=\"bg-white rounded-2xl p-6 shadow-sm border border-gray-100\">\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <p className=\"text-sm font-medium text-gray-600 mb-1\">Total Users</p>\n              <p className=\"text-2xl font-bold text-gray-900\">{roleCounts.all}</p>\n            </div>\n            <div className=\"w-12 h-12 bg-gray-100 rounded-2xl flex items-center justify-center\">\n              <User className=\"text-gray-600\" size={20} />\n            </div>\n          </div>\n        </div>\n        {/* ... (other stats cards remain same) ... */}\n        <div className=\"bg-white rounded-2xl p-6 shadow-sm border border-gray-100\">\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <p className=\"text-sm font-medium text-gray-600 mb-1\">Customers</p>\n              <p className=\"text-2xl font-bold text-green-600\">{roleCounts.customer}</p>\n            </div>\n            <div className=\"w-12 h-12 bg-green-100 rounded-2xl flex items-center justify-center\">\n              <UserCheck className=\"text-green-600\" size={20} />\n            </div>\n          </div>\n        </div>\n        <div className=\"bg-white rounded-2xl p-6 shadow-sm border border-gray-100\">\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <p className=\"text-sm font-medium text-gray-600 mb-1\">Vendors</p>\n              <p className=\"text-2xl font-bold text-blue-600\">{roleCounts.vendor}</p>\n            </div>\n            <div className=\"w-12 h-12 bg-blue-100 rounded-2xl flex items-center justify-center\">\n              <UserCheck className=\"text-blue-600\" size={20} />\n            </div>\n          </div>\n        </div>\n        <div className=\"bg-white rounded-2xl p-6 shadow-sm border border-gray-100\">\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <p className=\"text-sm font-medium text-gray-600 mb-1\">Admins</p>\n              <p className=\"text-2xl font-bold text-purple-600\">{roleCounts.admin}</p>\n            </div>\n            <div className=\"w-12 h-12 bg-purple-100 rounded-2xl flex items-center justify-center\">\n              <Shield className=\"text-purple-600\" size={20} />\n            </div>\n          </div>\n        </div>\n      </motion.div>\n\n      {/* Error Banner */}\n      <AnimatePresence>\n        {error && (\n          <motion.div\n            initial={{ opacity: 0, height: 0 }}\n            animate={{ opacity: 1, height: 'auto' }}\n            exit={{ opacity: 0, height: 0 }}\n            className=\"bg-red-50 border border-red-200 rounded-xl p-4 flex items-center gap-3 text-red-700\"\n          >\n            <AlertCircle size={20} />\n            <p>{error}</p>\n            <button onClick={() => setError(null)} className=\"ml-auto\">\n              <X size={16} />\n            </button>\n          </motion.div>\n        )}\n      </AnimatePresence>\n\n      {/* Filters */}\n      <motion.div\n        initial={{ opacity: 0, y: 20 }}\n        animate={{ opacity: 1, y: 0 }}\n        transition={{ duration: 0.6, delay: 0.4 }}\n        className=\"bg-white rounded-2xl p-6 shadow-sm border border-gray-100\"\n      >\n        <div className=\"flex flex-col md:flex-row gap-4\">\n          <div className=\"flex-1 relative\">\n            <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400\" size={20} />\n            <input\n              type=\"text\"\n              placeholder=\"Search by name, email, username or phone...\"\n              value={searchQuery}\n              onChange={(e) => setSearchQuery(e.target.value)}\n              className=\"w-full pl-10 pr-4 py-2 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500\"\n            />\n          </div>\n          <div className=\"flex gap-2\">\n            {(['all', 'customer', 'vendor', 'admin'] as const).map((role) => (\n              <button\n                key={role}\n                onClick={() => setRoleFilter(role)}\n                className={`px-4 py-2 rounded-xl font-medium transition-colors duration-200 ${\n                  roleFilter === role\n                    ? 'bg-blue-600 text-white'\n                    : 'bg-gray-100 text-gray-700 hover:bg-gray-200'\n                }`}\n              >\n                {role.charAt(0).toUpperCase() + role.slice(1)} ({roleCounts[role]})\n              </button>\n            ))}\n          </div>\n        </div>\n      </motion.div>\n\n      {/* Users Table */}\n      <motion.div\n        initial={{ opacity: 0, y: 20 }}\n        animate={{ opacity: 1, y: 0 }}\n        transition={{ duration: 0.6, delay: 0.6 }}\n        className=\"bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden\"\n      >\n        <div className=\"overflow-x-auto\">\n          <table className=\"w-full\">\n            <thead className=\"bg-gray-50 border-b border-gray-200\">\n              <tr>\n                <th className=\"px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider\">User</th>\n                <th className=\"px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider\">Email</th>\n                <th className=\"px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider\">Username</th>\n                <th className=\"px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider\">Role</th>\n                <th className=\"px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider\">Joined</th>\n                <th className=\"px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider\">Actions</th>\n              </tr>\n            </thead>\n            <tbody className=\"divide-y divide-gray-200\">\n              {filteredUsers.length === 0 ? (\n                <tr>\n                  <td colSpan={6} className=\"px-6 py-12 text-center text-gray-500\">\n                    {searchQuery || roleFilter !== 'all' ? 'No users found matching your filters' : 'No users found'}\n                  </td>\n                </tr>\n              ) : (\n                filteredUsers.map((user) => (\n                  <tr key={user.id} className=\"hover:bg-gray-50 transition-colors\">\n                    {/* User Column */}\n                    <td className=\"px-6 py-4 whitespace-nowrap\">\n                      <div className=\"flex items-center\">\n                        <div className=\"w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center mr-3\">\n                          <span className=\"text-white font-semibold text-sm\">\n                            {user.full_name?.charAt(0).toUpperCase() || user.email?.charAt(0).toUpperCase() || 'U'}\n                          </span>\n                        </div>\n                        <div>\n                          <div className=\"text-sm font-medium text-gray-900\">{user.full_name || 'No name'}</div>\n                          <div className=\"text-xs text-gray-500\">{user.id.substring(0, 8)}...</div>\n                        </div>\n                      </div>\n                    </td>\n                    \n                    {/* Email Column */}\n                    <td className=\"px-6 py-4 whitespace-nowrap\">\n                      <div className=\"text-sm text-gray-900\">{user.email}</div>\n                    </td>\n\n                    {/* Username Column (Editable) */}\n                    <td className=\"px-6 py-4 whitespace-nowrap\">\n                      {editingUserId === user.id ? (\n                        <input\n                          type=\"text\"\n                          value={editForm.username}\n                          onChange={(e) => setEditForm({...editForm, username: e.target.value})}\n                          placeholder=\"Set username\"\n                          className=\"px-3 py-1 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 w-32\"\n                          disabled={saving}\n                        />\n                      ) : (\n                        <div className=\"text-sm text-gray-900\">{user.username || '-'}</div>\n                      )}\n                    </td>\n\n                    {/* Role Column (Editable) */}\n                    <td className=\"px-6 py-4 whitespace-nowrap\">\n                      {editingUserId === user.id ? (\n                        <select\n                          value={editForm.role}\n                          onChange={(e) => setEditForm({...editForm, role: e.target.value as 'customer' | 'vendor' | 'admin'})}\n                          className=\"px-3 py-1 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500\"\n                          disabled={saving}\n                        >\n                          <option value=\"customer\">Customer</option>\n                          <option value=\"vendor\">Vendor</option>\n                          <option value=\"admin\">Admin</option>\n                        </select>\n                      ) : (\n                        <span className={`inline-flex items-center px-3 py-1 rounded-full text-xs font-medium border ${getRoleBadgeColor(user.role)}`}>\n                          {user.role === 'vendor' ? 'Provider' : user.role.charAt(0).toUpperCase() + user.role.slice(1)}\n                        </span>\n                      )}\n                    </td>\n\n                    {/* Joined Column */}\n                    <td className=\"px-6 py-4 whitespace-nowrap\">\n                      <div className=\"text-sm text-gray-900\">\n                        {new Date(user.created_at).toLocaleDateString()}\n                      </div>\n                    </td>\n\n                    {/* Actions Column */}\n                    <td className=\"px-6 py-4 whitespace-nowrap\">\n                      {editingUserId === user.id ? (\n                        <div className=\"flex gap-2\">\n                          <button\n                            onClick={() => handleSave(user.id)}\n                            disabled={saving}\n                            className=\"p-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors disabled:opacity-50\"\n                            title=\"Save\"\n                          >\n                            <Save size={16} />\n                          </button>\n                          <button\n                            onClick={handleCancelEdit}\n                            disabled={saving}\n                            className=\"p-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors disabled:opacity-50\"\n                            title=\"Cancel\"\n                          >\n                            <X size={16} />\n                          </button>\n                        </div>\n                      ) : (\n                        <button\n                          onClick={() => handleEdit(user)}\n                          className=\"p-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors\"\n                          title=\"Edit User\"\n                        >\n                          <Edit size={16} />\n                        </button>\n                      )}\n                    </td>\n                  </tr>\n                ))\n              )}\n            </tbody>\n          </table>\n        </div>\n      </motion.div>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\app\\admin\\vendors\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Link' is defined but never used. Allowed unused vars must match /^_/u.","line":5,"column":8,"nodeType":null,"messageId":"unusedVar","endLine":5,"endColumn":12}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport React, { useState } from 'react'\nimport { motion, AnimatePresence } from 'framer-motion'\nimport Link from 'next/link'\nimport { useRouter } from 'next/navigation'\nimport DataTable from '@/components/admin/DataTable'\nimport { vendors } from '@/lib/mockData'\nimport { exportToCSV, exportToJSON } from '@/lib/admin/exportUtils'\nimport { X } from 'lucide-react'\n\nexport default function VendorsPage() {\n  const router = useRouter()\n  const [_showAddModal, _setShowAddModal] = useState(false)\n  const [showBulkModal, setShowBulkModal] = useState(false)\n  const [showNewsletterModal, setShowNewsletterModal] = useState(false)\n  const [selectedVendors, setSelectedVendors] = useState<Set<string>>(new Set())\n  const [exportFormat, setExportFormat] = useState<'csv' | 'json'>('csv')\n  \n  const columns = [\n    { key: 'name', label: 'Name', sortable: true },\n    { key: 'category', label: 'Category', sortable: true },\n    { key: 'status', label: 'Status', sortable: true },\n    { key: 'email', label: 'Email', sortable: true },\n    { key: 'location', label: 'Location', sortable: true },\n    { key: 'joinDate', label: 'Join Date', sortable: true }\n  ]\n\n  const handleExport = () => {\n    if (exportFormat === 'csv') {\n      exportToCSV(vendors, 'vendors')\n    } else {\n      exportToJSON(vendors, 'vendors')\n    }\n  }\n\n  const handleBulkAction = async (action: 'approve' | 'reject' | 'suspend') => {\n    if (selectedVendors.size === 0) {\n      alert('Please select vendors first')\n      return\n    }\n    \n    try {\n      const response = await fetch('/api/admin/vendors/bulk', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({ \n          action, \n          vendorIds: Array.from(selectedVendors) \n        })\n      })\n      \n      const data = await response.json()\n      if (data.success) {\n        alert(`Successfully ${action}d ${selectedVendors.size} vendor(s)`)\n        setSelectedVendors(new Set())\n        setShowBulkModal(false)\n        router.refresh()\n      } else {\n        alert(data.error || 'Action failed')\n      }\n    } catch (error) {\n      console.error('Bulk action error:', error)\n      alert('Error performing bulk action')\n    }\n  }\n\n  const handleSendNewsletter = async (subject: string, message: string) => {\n    try {\n      const response = await fetch('/api/admin/newsletter', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({ \n          subject, \n          message,\n          recipientType: 'vendors'\n        })\n      })\n      \n      const data = await response.json()\n      if (data.success) {\n        alert(`Newsletter sent to ${data.recipientCount} vendors`)\n        setShowNewsletterModal(false)\n      } else {\n        alert(data.error || 'Failed to send newsletter')\n      }\n    } catch (error) {\n      console.error('Newsletter error:', error)\n      alert('Error sending newsletter')\n    }\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Page Header */}\n      <motion.div\n        initial={{ opacity: 0, y: -20 }}\n        animate={{ opacity: 1, y: 0 }}\n        transition={{ duration: 0.6 }}\n        className=\"mb-8\"\n      >\n        <h1 className=\"text-3xl font-bold text-gray-900 mb-2\">Vendors</h1>\n        <p className=\"text-gray-600\">Manage and monitor all service providers on your platform.</p>\n      </motion.div>\n\n      {/* Stats Cards */}\n      <motion.div\n        initial={{ opacity: 0, y: 20 }}\n        animate={{ opacity: 1, y: 0 }}\n        transition={{ duration: 0.6, delay: 0.2 }}\n        className=\"grid grid-cols-1 md:grid-cols-4 gap-6 mb-8\"\n      >\n        <div className=\"bg-white rounded-2xl p-6 shadow-sm border border-gray-100\">\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <p className=\"text-sm font-medium text-gray-600 mb-1\">Total Vendors</p>\n              <p className=\"text-2xl font-bold text-blue-600\">{vendors.length}</p>\n            </div>\n            <div className=\"w-12 h-12 bg-blue-100 rounded-2xl flex items-center justify-center\">\n              <span className=\"text-blue-600 font-semibold\">ðŸ‘¥</span>\n            </div>\n          </div>\n        </div>\n\n        <div className=\"bg-white rounded-2xl p-6 shadow-sm border border-gray-100\">\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <p className=\"text-sm font-medium text-gray-600 mb-1\">Active</p>\n              <p className=\"text-2xl font-bold text-green-600\">\n                {vendors.filter(v => v.status === 'active').length}\n              </p>\n            </div>\n            <div className=\"w-12 h-12 bg-green-100 rounded-2xl flex items-center justify-center\">\n              <span className=\"text-green-600 font-semibold\">âœ…</span>\n            </div>\n          </div>\n        </div>\n\n        <div className=\"bg-white rounded-2xl p-6 shadow-sm border border-gray-100\">\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <p className=\"text-sm font-medium text-gray-600 mb-1\">Pending</p>\n              <p className=\"text-2xl font-bold text-yellow-600\">\n                {vendors.filter(v => v.status === 'pending').length}\n              </p>\n            </div>\n            <div className=\"w-12 h-12 bg-yellow-100 rounded-2xl flex items-center justify-center\">\n              <span className=\"text-yellow-600 font-semibold\">â³</span>\n            </div>\n          </div>\n        </div>\n\n        <div className=\"bg-white rounded-2xl p-6 shadow-sm border border-gray-100\">\n          <div className=\"flex items-center justify-between\">\n            <div>\n              <p className=\"text-sm font-medium text-gray-600 mb-1\">Suspended</p>\n              <p className=\"text-2xl font-bold text-red-600\">\n                {vendors.filter(v => v.status === 'suspended').length}\n              </p>\n            </div>\n            <div className=\"w-12 h-12 bg-red-100 rounded-2xl flex items-center justify-center\">\n              <span className=\"text-red-600 font-semibold\">ðŸš«</span>\n            </div>\n          </div>\n        </div>\n      </motion.div>\n\n      {/* Vendors Table */}\n      <motion.div\n        initial={{ opacity: 0, y: 20 }}\n        animate={{ opacity: 1, y: 0 }}\n        transition={{ duration: 0.6, delay: 0.4 }}\n      >\n        <DataTable\n          columns={columns}\n          data={vendors}\n          title=\"Vendor Management\"\n        />\n      </motion.div>\n\n      {/* Quick Actions */}\n      <motion.div\n        initial={{ opacity: 0, y: 20 }}\n        animate={{ opacity: 1, y: 0 }}\n        transition={{ duration: 0.6, delay: 0.6 }}\n        className=\"bg-white rounded-2xl p-6 shadow-sm border border-gray-100\"\n      >\n        <h3 className=\"text-lg font-semibold text-gray-900 mb-4\">Quick Actions</h3>\n        <div className=\"flex flex-wrap gap-4\">\n          <button \n            onClick={() => router.push('/vendor/onboarding')}\n            className=\"px-6 py-3 bg-blue-600 text-white rounded-2xl hover:bg-blue-700 transition-colors duration-200 font-medium\"\n          >\n            + Add New Vendor\n          </button>\n          <div className=\"flex gap-2\">\n            <select \n              value={exportFormat}\n              onChange={(e) => setExportFormat(e.target.value as 'csv' | 'json')}\n              className=\"px-3 py-3 bg-gray-100 rounded-2xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500\"\n            >\n              <option value=\"csv\">CSV</option>\n              <option value=\"json\">JSON</option>\n            </select>\n            <button \n              onClick={handleExport}\n              className=\"px-6 py-3 bg-green-600 text-white rounded-2xl hover:bg-green-700 transition-colors duration-200 font-medium\"\n            >\n              Export Data\n            </button>\n          </div>\n          <button \n            onClick={() => setShowBulkModal(true)}\n            className=\"px-6 py-3 bg-purple-600 text-white rounded-2xl hover:bg-purple-700 transition-colors duration-200 font-medium\"\n          >\n            Bulk Actions\n          </button>\n          <button \n            onClick={() => setShowNewsletterModal(true)}\n            className=\"px-6 py-3 bg-gray-600 text-white rounded-2xl hover:bg-gray-700 transition-colors duration-200 font-medium\"\n          >\n            Send Newsletter\n          </button>\n        </div>\n      </motion.div>\n\n      {/* Bulk Actions Modal */}\n      <AnimatePresence>\n        {showBulkModal && (\n          <motion.div\n            initial={{ opacity: 0 }}\n            animate={{ opacity: 1 }}\n            exit={{ opacity: 0 }}\n            className=\"fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4\"\n            onClick={() => setShowBulkModal(false)}\n          >\n            <motion.div\n              initial={{ scale: 0.95, opacity: 0 }}\n              animate={{ scale: 1, opacity: 1 }}\n              exit={{ scale: 0.95, opacity: 0 }}\n              onClick={(e: React.MouseEvent<HTMLDivElement>) => e.stopPropagation()}\n              className=\"bg-white rounded-2xl p-6 max-w-md w-full\"\n            >\n              <div className=\"flex items-center justify-between mb-4\">\n                <h3 className=\"text-xl font-bold\">Bulk Actions</h3>\n                <button onClick={() => setShowBulkModal(false)}>\n                  <X className=\"w-5 h-5\" />\n                </button>\n              </div>\n              <p className=\"text-sm text-gray-600 mb-4\">\n                Select vendors from the table, then choose an action below.\n              </p>\n              <div className=\"space-y-2\">\n                <button\n                  onClick={() => handleBulkAction('approve')}\n                  className=\"w-full px-4 py-2 bg-green-600 text-white rounded-xl hover:bg-green-700\"\n                >\n                  Approve Selected ({selectedVendors.size})\n                </button>\n                <button\n                  onClick={() => handleBulkAction('reject')}\n                  className=\"w-full px-4 py-2 bg-red-600 text-white rounded-xl hover:bg-red-700\"\n                >\n                  Reject Selected ({selectedVendors.size})\n                </button>\n                <button\n                  onClick={() => handleBulkAction('suspend')}\n                  className=\"w-full px-4 py-2 bg-yellow-600 text-white rounded-xl hover:bg-yellow-700\"\n                >\n                  Suspend Selected ({selectedVendors.size})\n                </button>\n              </div>\n            </motion.div>\n          </motion.div>\n        )}\n      </AnimatePresence>\n\n      {/* Newsletter Modal */}\n      <AnimatePresence>\n        {showNewsletterModal && (\n          <NewsletterModal\n            onClose={() => setShowNewsletterModal(false)}\n            onSend={handleSendNewsletter}\n          />\n        )}\n      </AnimatePresence>\n    </div>\n  )\n}\n\nfunction NewsletterModal({ onClose, onSend }: { onClose: () => void; onSend: (subject: string, message: string) => void }) {\n  const [subject, setSubject] = useState('')\n  const [message, setMessage] = useState('')\n  const [sending, setSending] = useState(false)\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault()\n    if (!subject || !message) {\n      alert('Please fill in all fields')\n      return\n    }\n    setSending(true)\n    await onSend(subject, message)\n    setSending(false)\n  }\n\n  return (\n    <motion.div\n      initial={{ opacity: 0 }}\n      animate={{ opacity: 1 }}\n      exit={{ opacity: 0 }}\n      className=\"fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4\"\n      onClick={onClose}\n    >\n      <motion.div\n        initial={{ scale: 0.95, opacity: 0 }}\n        animate={{ scale: 1, opacity: 1 }}\n        exit={{ scale: 0.95, opacity: 0 }}\n        onClick={(e: React.MouseEvent<HTMLDivElement>) => e.stopPropagation()}\n        className=\"bg-white rounded-2xl p-6 max-w-lg w-full\"\n      >\n        <div className=\"flex items-center justify-between mb-4\">\n          <h3 className=\"text-xl font-bold\">Send Newsletter</h3>\n          <button onClick={onClose}>\n            <X className=\"w-5 h-5\" />\n          </button>\n        </div>\n        <form onSubmit={handleSubmit} className=\"space-y-4\">\n          <div>\n            <label className=\"block text-sm font-medium mb-1\">Subject</label>\n            <input\n              type=\"text\"\n              value={subject}\n              onChange={(e) => setSubject(e.target.value)}\n              className=\"w-full px-4 py-2 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-gray-500\"\n              required\n            />\n          </div>\n          <div>\n            <label className=\"block text-sm font-medium mb-1\">Message</label>\n            <textarea\n              value={message}\n              onChange={(e) => setMessage(e.target.value)}\n              rows={6}\n              className=\"w-full px-4 py-2 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-gray-500\"\n              required\n            />\n          </div>\n          <div className=\"flex gap-2\">\n            <button\n              type=\"button\"\n              onClick={onClose}\n              className=\"flex-1 px-4 py-2 border border-gray-300 rounded-xl hover:bg-gray-50\"\n            >\n              Cancel\n            </button>\n            <button\n              type=\"submit\"\n              disabled={sending}\n              className=\"flex-1 px-4 py-2 bg-gray-600 text-white rounded-xl hover:bg-gray-700 disabled:opacity-50\"\n            >\n              {sending ? 'Sending...' : 'Send Newsletter'}\n            </button>\n          </div>\n        </form>\n      </motion.div>\n    </motion.div>\n  )\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\app\\api\\admin\\resilience-metrics\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'createClient' is defined but never used. Allowed unused vars must match /^_/u.","line":2,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":2,"endColumn":22}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server'\nimport { createClient } from '@supabase/supabase-js'\nimport { resilienceAlertManager, type Alert } from '@/lib/alerting/resilienceAlerts'\n\n// Initialize Supabase client\nimport { supabaseAdmin as supabase } from '@/lib/supabaseProxies';\n\nexport async function GET() {\n  try {\n    // Check if user is admin (you can implement your own admin check here)\n    // For now, we'll use the service role key which has admin access\n    \n    // Get resilience metrics using the database function\n    const { data: metrics, error } = await supabase\n      .rpc('get_resilience_metrics', {\n        start_time: new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString(), // Last 24 hours\n        end_time: new Date().toISOString()\n      })\n\n    if (error) {\n      console.error('Failed to fetch resilience metrics:', error)\n      return NextResponse.json(\n        { error: 'Failed to fetch metrics' },\n        { status: 500 }\n      )\n    }\n\n    // Get additional real-time metrics\n    const { data: hourlyMetrics, error: hourlyError } = await supabase\n      .from('resilience_metrics_hourly')\n      .select('*')\n      .gte('hour', new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString())\n      .order('hour', { ascending: false })\n\n    if (hourlyError) {\n      console.error('Failed to fetch hourly metrics:', error)\n    }\n\n    // Calculate additional derived metrics\n    const additionalMetrics = calculateAdditionalMetrics(hourlyMetrics || [])\n\n    // Evaluate metrics for alerts\n    let alerts: Alert[] = []\n    if (metrics && metrics.length > 0) {\n      try {\n        alerts = await resilienceAlertManager.evaluateMetrics(metrics)\n      } catch (alertError) {\n        console.error('Failed to evaluate alerts:', alertError)\n        // Don't fail the request if alerting fails\n      }\n    }\n\n    return NextResponse.json({\n      success: true,\n      metrics: metrics || [],\n      additional_metrics: additionalMetrics,\n      alerts: alerts,\n      last_updated: new Date().toISOString()\n    })\n\n  } catch (error) {\n    console.error('Resilience metrics endpoint error:', error)\n    return NextResponse.json(\n      { error: 'Internal server error' },\n      { status: 500 }\n    )\n  }\n}\n\ninterface HourlyMetric {\n  signal?: string\n  component?: string\n  count?: number\n  hour?: string\n  [key: string]: unknown\n}\n\nfunction calculateAdditionalMetrics(hourlyMetrics: HourlyMetric[]) {\n  if (hourlyMetrics.length === 0) {\n    return {}\n  }\n\n  // Calculate total signals by type\n  interface SignalCounts {\n    [signal: string]: number\n  }\n  const signalCounts = hourlyMetrics.reduce((acc: SignalCounts, metric: HourlyMetric) => {\n    const signal = metric.signal || 'unknown'\n    const count = typeof metric.count === 'number' ? metric.count : 0\n    acc[signal] = (acc[signal] || 0) + count\n    return acc\n  }, {})\n\n  // Calculate component health\n  interface ComponentHealth {\n    [component: string]: {\n      total: number\n      errors: number\n      health_percentage?: number\n    }\n  }\n  const componentHealth = hourlyMetrics.reduce((acc: ComponentHealth, metric: HourlyMetric) => {\n    const component = metric.component || 'unknown'\n    if (!acc[component]) {\n      acc[component] = { total: 0, errors: 0 }\n    }\n    const count = typeof metric.count === 'number' ? metric.count : 0\n    acc[component].total += count\n    \n    // Count error signals\n    const signal = metric.signal || ''\n    if (signal.includes('error') || signal.includes('rollback') || signal.includes('failure')) {\n      acc[component].errors += count\n    }\n    \n    return acc\n  }, {})\n\n  // Calculate health percentages\n  Object.keys(componentHealth).forEach(component => {\n    const { total, errors } = componentHealth[component]\n    componentHealth[component].health_percentage = total > 0 ? ((total - errors) / total * 100) : 100\n  })\n\n  return {\n    signal_counts: signalCounts,\n    component_health: componentHealth,\n    total_signals: hourlyMetrics.reduce((sum: number, m: HourlyMetric) => sum + (typeof m.count === 'number' ? m.count : 0), 0),\n    unique_components: new Set(hourlyMetrics.map((m: HourlyMetric) => m.component).filter(Boolean)).size,\n    time_range: {\n      start: hourlyMetrics[hourlyMetrics.length - 1]?.hour,\n      end: hourlyMetrics[0]?.hour\n    }\n  }\n}\n\n// POST endpoint for acknowledging alerts\nexport async function POST(request: NextRequest) {\n  try {\n    const { alertId, acknowledgedBy } = await request.json()\n    \n    if (!alertId || !acknowledgedBy) {\n      return NextResponse.json(\n        { error: 'Missing required fields' },\n        { status: 400 }\n      )\n    }\n\n    // Acknowledge the alert\n    resilienceAlertManager.acknowledgeAlert(alertId, acknowledgedBy)\n\n    return NextResponse.json({\n      success: true,\n      message: 'Alert acknowledged successfully'\n    })\n\n  } catch (error) {\n    console.error('Failed to acknowledge alert:', error)\n    return NextResponse.json(\n      { error: 'Failed to acknowledge alert' },\n      { status: 500 }\n    )\n  }\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\app\\api\\admin\\reviews\\moderation\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'createClient' is defined but never used. Allowed unused vars must match /^_/u.","line":2,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":2,"endColumn":22}],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":42,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":42,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1255,1258],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1255,1258],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\nimport { createClient } from '@supabase/supabase-js';\n\nimport { supabaseAdmin as supabase } from '@/lib/supabaseProxies';\n\nexport async function POST(request: NextRequest) {\n  try {\n    const { reviewId, action, reason, moderatorId } = await request.json();\n\n    if (!reviewId || !action || !moderatorId) {\n      return NextResponse.json(\n        { error: 'Missing required fields: reviewId, action, moderatorId' },\n        { status: 400 }\n      );\n    }\n\n    // Validate action\n    const validActions = ['approve', 'reject', 'remove', 'restore'];\n    if (!validActions.includes(action)) {\n      return NextResponse.json(\n        { error: 'Invalid action. Must be one of: approve, reject, remove, restore' },\n        { status: 400 }\n      );\n    }\n\n    // Get the review\n    const { data: review, error: fetchError } = await supabase\n      .from('reviews')\n      .select('*')\n      .eq('id', reviewId)\n      .single();\n\n    if (fetchError || !review) {\n      return NextResponse.json(\n        { error: 'Review not found' },\n        { status: 404 }\n      );\n    }\n\n    // Determine update data based on action\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    const updateData: any = {\n      moderation_status: action === 'approve' ? 'approved' : \n                         action === 'reject' ? 'rejected' : \n                         action === 'remove' ? 'removed' : 'pending',\n      moderated_at: new Date().toISOString(),\n      moderated_by: moderatorId\n    };\n\n    if (action === 'approve' || action === 'restore') {\n      updateData.status = 'active';\n      updateData.moderation_status = 'approved';\n    } else if (action === 'reject' || action === 'remove') {\n      updateData.status = 'hidden';\n      updateData.moderation_status = action === 'reject' ? 'rejected' : 'removed';\n    }\n\n    // Update the review\n    const { error: updateError } = await supabase\n      .from('reviews')\n      .update(updateData)\n      .eq('id', reviewId)\n\n    if (updateError) {\n      console.error('Review update error:', updateError)\n      return NextResponse.json(\n        { error: 'Failed to update review' },\n        { status: 500 }\n      )\n    }\n\n    // Log the moderation action\n    await supabase\n      .from('review_moderation_log')\n      .insert({\n        review_id: reviewId,\n        moderator_id: moderatorId,\n        action,\n        reason: reason || null,\n        details: {\n          previous_status: review.status,\n          previous_moderation_status: review.moderation_status,\n          new_status: updateData.status,\n          new_moderation_status: updateData.moderation_status\n        },\n        created_at: new Date().toISOString()\n      })\n\n    // Send notifications if needed\n    if (action === 'approve' || action === 'restore') {\n      // Notify customer that their review was approved\n      await supabase\n        .from('notifications')\n        .insert({\n          user_id: review.reviewer_id,\n          type: 'review_approved',\n          title: 'Your Review Was Approved',\n          message: 'Your review has been approved and is now visible',\n          data: {\n            review_id: reviewId,\n            provider_id: review.provider_id\n          },\n          created_at: new Date().toISOString()\n        })\n    } else if (action === 'reject' || action === 'remove') {\n      // Notify customer that their review was removed\n      await supabase\n        .from('notifications')\n        .insert({\n          user_id: review.reviewer_id,\n          type: 'review_rejected',\n          title: 'Your Review Was Removed',\n          message: reason ? `Your review was removed: ${reason}` : 'Your review was removed',\n          data: {\n            review_id: reviewId,\n            provider_id: review.provider_id,\n            reason\n          },\n          created_at: new Date().toISOString()\n        })\n    }\n\n    // Track analytics\n    await fetch('/api/analytics/track', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({\n        event_type: 'review_moderated',\n        user_id: moderatorId,\n        session_id: 'server-side',\n        page_url: '/api/admin/reviews/moderation',\n        properties: {\n          review_id: reviewId,\n          action,\n          reason,\n          provider_id: review.provider_id,\n          reviewer_id: review.reviewer_id\n        }\n      })\n    })\n\n    return NextResponse.json({\n      success: true,\n      message: `Review ${action}d successfully`\n    })\n\n  } catch (error) {\n    console.error('Review moderation error:', error)\n    return NextResponse.json(\n      { error: 'Internal server error' },\n      { status: 500 }\n    )\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\app\\api\\admin\\vendors\\bulk\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'status' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":27,"column":9,"nodeType":null,"messageId":"unusedVar","endLine":27,"endColumn":15}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server'\r\nimport { getServerSupabase } from '@/lib/supabaseServer'\r\nimport { getAuthenticatedUserId } from '@/app/api/_utils/auth'\r\n\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const userId = await getAuthenticatedUserId(request)\r\n    if (!userId) {\r\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })\r\n    }\r\n\r\n    const { action, vendorIds } = await request.json()\r\n\r\n    if (!action || !vendorIds || !Array.isArray(vendorIds) || vendorIds.length === 0) {\r\n      return NextResponse.json({ error: 'Invalid request' }, { status: 400 })\r\n    }\r\n\r\n    const supabase = getServerSupabase()\r\n    \r\n    // Update vendor statuses based on action\r\n    let status: string\r\n    switch (action) {\r\n      case 'approve':\r\n        status = 'active'\r\n        break\r\n      case 'reject':\r\n        status = 'suspended'\r\n        break\r\n      case 'suspend':\r\n        _status = 'suspended'\r\n        break\r\n      default:\r\n        return NextResponse.json({ error: 'Invalid action' }, { status: 400 })\r\n    }\r\n\r\n    const { error } = await supabase\r\n      .from('profiles')\r\n      .update({ \r\n        role: 'vendor',\r\n        updated_at: new Date().toISOString()\r\n      })\r\n      .in('id', vendorIds)\r\n      .eq('role', 'vendor')\r\n\r\n    if (error) {\r\n      console.error('Bulk update error:', error)\r\n      return NextResponse.json({ error: 'Failed to update vendors' }, { status: 500 })\r\n    }\r\n\r\n    return NextResponse.json({ \r\n      success: true, \r\n      message: `Successfully ${action}d ${vendorIds.length} vendor(s)` \r\n    })\r\n  } catch (error) {\r\n    console.error('Bulk action error:', error)\r\n    return NextResponse.json({ error: 'Internal server error' }, { status: 500 })\r\n  }\r\n}\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\app\\api\\analytics\\performance\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'createClient' is defined but never used. Allowed unused vars must match /^_/u.","line":2,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":2,"endColumn":22}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server'\nimport { createClient } from '@supabase/supabase-js'\n\nimport { supabaseAdmin as supabase } from '@/lib/supabaseProxies';\n\nexport async function GET(request: NextRequest) {\n  try {\n    const { searchParams } = new URL(request.url)\n    const timeRange = searchParams.get('timeRange') || '24h'\n    const endpoint = searchParams.get('endpoint')\n    const method = searchParams.get('method')\n\n    // Calculate date range\n    const now = new Date()\n    let startDate: Date\n    \n    switch (timeRange) {\n      case '1h':\n        startDate = new Date(now.getTime() - 60 * 60 * 1000)\n        break\n      case '6h':\n        startDate = new Date(now.getTime() - 6 * 60 * 60 * 1000)\n        break\n      case '24h':\n        startDate = new Date(now.getTime() - 24 * 60 * 60 * 1000)\n        break\n      case '7d':\n        startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000)\n        break\n      case '30d':\n        startDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000)\n        break\n      default:\n        startDate = new Date(now.getTime() - 24 * 60 * 60 * 1000)\n    }\n\n    // Get performance metrics from materialized view\n    const { data: performanceData, error: performanceError } = await supabase\n      .from('performance_analytics_hourly')\n      .select('*')\n      .gte('hour', startDate.toISOString())\n      .order('hour', { ascending: true })\n\n    if (performanceError) {\n      console.error('Performance analytics error:', performanceError)\n      return NextResponse.json({ error: 'Failed to fetch performance data' }, { status: 500 })\n    }\n\n    // Get real-time metrics for the last hour\n    const { data: _realtimeMetrics, error: realtimeError } = await supabase\n      .from('performance_metrics')\n      .select('*')\n      .gte('created_at', new Date(now.getTime() - 60 * 60 * 1000).toISOString())\n      .order('created_at', { ascending: false })\n\n    if (realtimeError) {\n      console.error('Realtime metrics error:', realtimeError)\n      return NextResponse.json({ error: 'Failed to fetch realtime data' }, { status: 500 })\n    }\n\n    // Calculate summary statistics\n    const summary = calculatePerformanceSummary(performanceData || [])\n    \n    // Get endpoint-specific performance if requested\n    let endpointPerformance = null\n    if (endpoint) {\n      endpointPerformance = await getEndpointPerformance(endpoint, method, startDate)\n    }\n\n    // Get top slow endpoints\n    const topSlowEndpoints = await getTopSlowEndpoints(startDate)\n\n    // Get error analysis\n    const errorAnalysis = await getErrorAnalysis(startDate)\n\n    return NextResponse.json({\n      success: true,\n      timeRange,\n      summary,\n      endpointPerformance,\n      topSlowEndpoints,\n      errorAnalysis,\n      dataPoints: performanceData?.length || 0\n    })\n\n  } catch (error) {\n    console.error('Performance analytics API error:', error)\n    return NextResponse.json({ error: 'Internal server error' }, { status: 500 })\n  }\n}\n\ninterface PerformanceDataItem {\n  request_count?: number\n  error_count?: number\n  avg_response_time_ms?: number\n  p95_response_time_ms?: number\n  endpoint?: string\n  [key: string]: unknown\n}\n\nfunction calculatePerformanceSummary(performanceData: PerformanceDataItem[]) {\n  if (performanceData.length === 0) {\n    return {\n      totalRequests: 0,\n      avgResponseTime: 0,\n      p95ResponseTime: 0,\n      errorRate: 0,\n      activeEndpoints: 0\n    }\n  }\n\n  const totalRequests = performanceData.reduce((sum, hour) => sum + (hour.request_count || 0), 0)\n  const totalErrors = performanceData.reduce((sum, hour) => sum + (hour.error_count || 0), 0)\n  const avgResponseTime = performanceData.reduce((sum, hour) => sum + (hour.avg_response_time_ms || 0), 0) / performanceData.length\n  const p95ResponseTime = Math.max(...performanceData.map(hour => hour.p95_response_time_ms || 0))\n  const errorRate = totalRequests > 0 ? (totalErrors / totalRequests) * 100 : 0\n  const activeEndpoints = new Set(performanceData.map(hour => hour.endpoint).filter(Boolean)).size\n\n  return {\n    totalRequests,\n    avgResponseTime: Math.round(avgResponseTime),\n    p95ResponseTime,\n    errorRate: Math.round(errorRate * 100) / 100,\n    activeEndpoints\n  }\n}\n\nasync function getEndpointPerformance(endpoint: string, method: string | null, startDate: Date) {\n  try {\n    let query = supabase\n      .from('performance_metrics')\n      .select('*')\n      .eq('endpoint', endpoint)\n      .gte('created_at', startDate.toISOString())\n\n    if (method) {\n      query = query.eq('method', method)\n    }\n\n    const { data, error } = await query\n      .order('created_at', { ascending: true })\n\n    if (error) {\n      console.error('Endpoint performance error:', error)\n      return null\n    }\n\n    if (!data || data.length === 0) {\n      return null\n    }\n\n    // Group by hour for trend analysis\n    const hourlyData = data.reduce((acc, metric) => {\n      const hour = new Date(metric.created_at).toISOString().slice(0, 13) + ':00:00Z'\n      if (!acc[hour]) {\n        acc[hour] = {\n          hour,\n          request_count: 0,\n          total_response_time: 0,\n          error_count: 0,\n          status_codes: {}\n        }\n      }\n      \n      acc[hour].request_count++\n      acc[hour].total_response_time += metric.response_time_ms\n      if (metric.status_code >= 400) {\n        acc[hour].error_count++\n      }\n      \n      const statusKey = Math.floor(metric.status_code / 100) + 'xx'\n      acc[hour].status_codes[statusKey] = (acc[hour].status_codes[statusKey] || 0) + 1\n      \n      return acc\n    }, {} as Record<string, {\n      hour: string\n      request_count: number\n      total_response_time: number\n      error_count: number\n      status_codes: Record<string, number>\n    }>)\n\n    // Convert to array and calculate averages\n    interface HourlyDataItem {\n      hour: string\n      request_count: number\n      total_response_time: number\n      error_count: number\n      status_codes: Record<string, number>\n    }\n    const hourlyArray = (Object.values(hourlyData) as HourlyDataItem[]).map((hour: HourlyDataItem) => ({\n      hour: hour.hour,\n      request_count: hour.request_count,\n      avg_response_time_ms: Math.round(hour.total_response_time / hour.request_count),\n      error_rate_percent: Math.round((hour.error_count / hour.request_count) * 100 * 100) / 100,\n      status_codes: hour.status_codes\n    }))\n\n    return {\n      endpoint,\n      method,\n      total_requests: data.length,\n      avg_response_time_ms: Math.round(data.reduce((sum, m) => sum + m.response_time_ms, 0) / data.length),\n      p95_response_time_ms: calculatePercentile(data.map(m => m.response_time_ms), 95),\n      error_rate_percent: Math.round((data.filter(m => m.status_code >= 400).length / data.length) * 100 * 100) / 100,\n      hourly_trends: hourlyArray\n    }\n  } catch (error) {\n    console.error('Endpoint performance calculation error:', error)\n    return null\n  }\n}\n\nasync function getTopSlowEndpoints(startDate: Date) {\n  try {\n    const { data, error } = await supabase\n      .from('performance_metrics')\n      .select('endpoint, method, response_time_ms')\n      .gte('created_at', startDate.toISOString())\n      .order('response_time_ms', { ascending: false })\n      .limit(10)\n\n    if (error) {\n      console.error('Top slow endpoints error:', error)\n      return []\n    }\n\n    if (!data) return []\n\n    // Group by endpoint and calculate average response time\n    const endpointStats = data.reduce((acc, metric) => {\n      const key = `${metric.method} ${metric.endpoint}`\n      if (!acc[key]) {\n        acc[key] = {\n          endpoint: metric.endpoint,\n          method: metric.method,\n          total_time: 0,\n          count: 0,\n          max_time: 0\n        }\n      }\n      \n      acc[key].total_time += metric.response_time_ms\n      acc[key].count++\n      acc[key].max_time = Math.max(acc[key].max_time, metric.response_time_ms)\n      \n      return acc\n    }, {} as Record<string, {\n      endpoint: string\n      method: string\n      total_time: number\n      count: number\n      max_time: number\n    }>)\n\n    // Convert to array and sort by average response time\n    interface EndpointStat {\n      endpoint: string\n      method: string\n      total_time: number\n      count: number\n      max_time: number\n    }\n    return Object.values(endpointStats)\n      .map((stat: EndpointStat) => ({\n        endpoint: stat.endpoint,\n        method: stat.method,\n        avg_response_time_ms: Math.round(stat.total_time / stat.count),\n        max_response_time_ms: stat.max_time,\n        request_count: stat.count\n      }))\n      .sort((a, b) => b.avg_response_time_ms - a.avg_response_time_ms)\n      .slice(0, 10)\n\n  } catch (error) {\n    console.error('Top slow endpoints error:', error)\n    return []\n  }\n}\n\nasync function getErrorAnalysis(startDate: Date) {\n  try {\n    const { data, error } = await supabase\n      .from('performance_metrics')\n      .select('endpoint, method, status_code, response_time_ms, created_at')\n      .gte('created_at', startDate.toISOString())\n      .gte('status_code', 400)\n      .order('created_at', { ascending: false })\n\n    if (error) {\n      console.error('Error analysis error:', error)\n      return null\n    }\n\n    if (!data || data.length === 0) {\n      return {\n        total_errors: 0,\n        error_rate_percent: 0,\n        status_code_distribution: {},\n        error_trends: []\n      }\n    }\n\n    // Group errors by status code\n    const statusCodeDistribution = data.reduce((acc, metric) => {\n      const statusKey = Math.floor(metric.status_code / 100) + 'xx'\n      acc[statusKey] = (acc[statusKey] || 0) + 1\n      return acc\n    }, {} as Record<string, number>)\n\n    // Group errors by hour for trend analysis\n    const hourlyErrors = data.reduce((acc, metric) => {\n      const hour = new Date(metric.created_at).toISOString().slice(0, 13) + ':00:00Z'\n      acc[hour] = (acc[hour] || 0) + 1\n      return acc\n    }, {} as Record<string, number>)\n\n    const errorTrends = Object.entries(hourlyErrors)\n      .map(([hour, count]) => ({ hour, error_count: count }))\n      .sort((a, b) => a.hour.localeCompare(b.hour))\n\n    // Get total requests for error rate calculation\n    const { count: totalRequests } = await supabase\n      .from('performance_metrics')\n      .select('*', { count: 'exact', head: true })\n      .gte('created_at', startDate.toISOString())\n\n    const errorRate = totalRequests ? (data.length / totalRequests) * 100 : 0\n\n    return {\n      total_errors: data.length,\n      error_rate_percent: Math.round(errorRate * 100) / 100,\n      status_code_distribution: statusCodeDistribution,\n      error_trends: errorTrends,\n      top_error_endpoints: getTopErrorEndpoints(data)\n    }\n\n  } catch (error) {\n    console.error('Error analysis calculation error:', error)\n    return null\n  }\n}\n\ninterface ErrorDataItem {\n  endpoint?: string\n  method?: string\n  error_count?: number\n  [key: string]: unknown\n}\n\nfunction getTopErrorEndpoints(errorData: ErrorDataItem[]) {\n  const endpointErrors = errorData.reduce((acc, metric) => {\n    const key = `${metric.method} ${metric.endpoint}`\n    acc[key] = (acc[key] || 0) + 1\n    return acc\n  }, {} as Record<string, number>)\n\n      return Object.entries(endpointErrors)\n      .map(([endpoint, count]) => {\n        const [method, path] = endpoint.split(' ', 2)\n        return { endpoint: path, method, error_count: count as number }\n      })\n      .sort((a, b) => (b.error_count as number) - (a.error_count as number))\n      .slice(0, 10)\n}\n\nfunction calculatePercentile(values: number[], percentile: number): number {\n  if (values.length === 0) return 0\n  \n  const sorted = values.sort((a, b) => a - b)\n  const index = Math.ceil((percentile / 100) * sorted.length) - 1\n  return sorted[Math.max(0, index)]\n}\n\n// POST endpoint to record performance metrics\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json()\n    const { endpoint, method, responseTimeMs, statusCode, userId, ipAddress, userAgent } = body\n\n    if (!endpoint || !method || !responseTimeMs || !statusCode) {\n      return NextResponse.json({ error: 'Missing required fields' }, { status: 400 })\n    }\n\n    // Insert performance metric\n    const { error } = await supabase\n      .from('performance_metrics')\n      .insert({\n        endpoint,\n        method,\n        response_time_ms: responseTimeMs,\n        status_code: statusCode,\n        user_id: userId || null,\n        ip_address: ipAddress || null,\n        user_agent: userAgent || null\n      })\n\n    if (error) {\n      console.error('Performance metric insert error:', error)\n      return NextResponse.json({ error: 'Failed to record metric' }, { status: 500 })\n    }\n\n    return NextResponse.json({ success: true })\n\n  } catch (error) {\n    console.error('Performance metric recording error:', error)\n    return NextResponse.json({ error: 'Internal server error' }, { status: 500 })\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\app\\api\\analytics\\specialties\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'createClient' is defined but never used. Allowed unused vars must match /^_/u.","line":2,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":2,"endColumn":22}],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":18,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":18,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[727,730],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[727,730],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":184,"column":37,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":184,"endColumn":40,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5351,5354],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5351,5354],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":219,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":219,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6311,6314],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6311,6314],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":231,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":231,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6666,6669],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6666,6669],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\nimport { createClient } from \"@supabase/supabase-js\";\n\nimport { supabaseAdmin as supabase } from '@/lib/supabaseProxies';\n\nexport async function GET(req: NextRequest) {\n  try {\n    const { searchParams } = new URL(req.url);\n    const timeRange = searchParams.get(\"timeRange\") || \"30d\";\n    const specialtyId = searchParams.get(\"specialtyId\");\n    \n    // Calculate date range\n    const now = new Date();\n    const days = timeRange === \"7d\" ? 7 : timeRange === \"30d\" ? 30 : timeRange === \"90d\" ? 90 : 365;\n    const startDate = new Date(now.getTime() - (days * 24 * 60 * 60 * 1000));\n\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    let analytics: any = {};\n\n    if (specialtyId) {\n      // Single specialty analytics\n      analytics = await getSpecialtyAnalytics(specialtyId, startDate);\n    } else {\n      // Overall specialty analytics\n      analytics = await getAllSpecialtiesAnalytics(startDate);\n    }\n\n    return NextResponse.json({\n      success: true,\n      analytics,\n      timeRange,\n      generatedAt: new Date().toISOString()\n    });\n\n  } catch (error) {\n    console.error(\"Specialty analytics error:\", error);\n    return NextResponse.json({ error: \"Internal server error\" }, { status: 500 });\n  }\n}\n\nasync function getSpecialtyAnalytics(specialtyId: string, startDate: Date) {\n  // Get specialty details\n  const { data: specialty } = await supabase\n    .from(\"specialties\")\n    .select(\"id, name, parent_id, path\")\n    .eq(\"id\", specialtyId)\n    .single();\n\n  if (!specialty) {\n    throw new Error(\"Specialty not found\");\n  }\n\n  // Get vendor count for this specialty\n  const { count: vendorCount } = await supabase\n    .from(\"vendor_specialties\")\n    .select(\"*\", { count: \"exact\", head: true })\n    .eq(\"specialty_id\", specialtyId);\n\n  // Get booking analytics for this specialty\n  const { data: bookings } = await supabase\n    .from(\"bookings\")\n    .select(`\n      *,\n      services!inner(*),\n      profiles!inner(\n        vendor_specialties!inner(\n          specialty_id\n        )\n      )\n    `)\n    .eq(\"profiles.vendor_specialties.specialty_id\", specialtyId)\n    .gte(\"created_at\", startDate.toISOString());\n\n  // Get revenue analytics\n  const totalRevenue = bookings?.reduce((sum, booking) => \n    sum + (booking.total_amount_cents || 0), 0) || 0;\n\n  // Get booking trends over time\n  const bookingTrends = getBookingTrends(bookings || [], startDate);\n\n  // Get top performing vendors in this specialty\n  const { data: topVendors } = await supabase\n    .from(\"profiles\")\n    .select(`\n      id,\n      full_name,\n      business_name,\n      average_rating,\n      total_bookings,\n      vendor_specialties!inner(\n        specialty_id,\n        is_primary\n      )\n    `)\n    .eq(\"vendor_specialties.specialty_id\", specialtyId)\n    .eq(\"role\", \"vendor\")\n    .order(\"total_bookings\", { ascending: false })\n    .limit(10);\n\n  // Get geographic distribution\n  const { data: locations } = await supabase\n    .from(\"provider_locations\")\n    .select(`\n      latitude,\n      longitude,\n      profiles!inner(\n        vendor_specialties!inner(\n          specialty_id\n        )\n      )\n    `)\n    .eq(\"profiles.vendor_specialties.specialty_id\", specialtyId);\n\n  const geographicDistribution = getGeographicDistribution(locations || []);\n\n  return {\n    specialty,\n    metrics: {\n      vendorCount: vendorCount || 0,\n      totalBookings: bookings?.length || 0,\n      totalRevenue: Math.round(totalRevenue / 100), // Convert to dollars\n      averageRating: calculateAverageRating(bookings || []),\n      bookingTrends,\n      topVendors: topVendors || [],\n      geographicDistribution\n    }\n  };\n}\n\nasync function getAllSpecialtiesAnalytics(startDate: Date) {\n  // Get all specialties with their metrics\n  const { data: specialties } = await supabase\n    .from(\"specialties\")\n    .select(\"id, name, parent_id, path\")\n    .eq(\"is_active\", true)\n    .order(\"name\");\n\n  const specialtyMetrics = await Promise.all(\n    (specialties || []).map(async (specialty) => {\n      const { count: vendorCount } = await supabase\n        .from(\"vendor_specialties\")\n        .select(\"*\", { count: \"exact\", head: true })\n        .eq(\"specialty_id\", specialty.id);\n\n      const { count: bookingCount } = await supabase\n        .from(\"bookings\")\n        .select(\"*\", { count: \"exact\", head: true })\n        .gte(\"created_at\", startDate.toISOString());\n\n      return {\n        ...specialty,\n        vendorCount: vendorCount || 0,\n        bookingCount: bookingCount || 0\n      };\n    })\n  );\n\n  // Get overall trends\n  const { data: allBookings } = await supabase\n    .from(\"bookings\")\n    .select(\"created_at, total_amount_cents\")\n    .gte(\"created_at\", startDate.toISOString());\n\n  const overallTrends = getBookingTrends(allBookings || [], startDate);\n\n  // Get specialty popularity ranking\n  const popularityRanking = specialtyMetrics\n    .sort((a, b) => b.bookingCount - a.bookingCount)\n    .slice(0, 10);\n\n  return {\n    overview: {\n      totalSpecialties: specialties?.length || 0,\n      totalVendors: specialtyMetrics.reduce((sum, s) => sum + s.vendorCount, 0),\n      totalBookings: allBookings?.length || 0,\n      overallTrends\n    },\n    specialtyMetrics,\n    popularityRanking\n  };\n}\n\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nfunction getBookingTrends(bookings: any[], startDate: Date) {\n  const trends: Record<string, { count: number; revenue: number }> = {};\n  \n  // Group by day\n  bookings.forEach(booking => {\n    const date = new Date(booking.created_at).toISOString().split('T')[0];\n    if (!trends[date]) {\n      trends[date] = { count: 0, revenue: 0 };\n    }\n    trends[date].count++;\n    trends[date].revenue += booking.total_amount_cents || 0;\n  });\n\n  // Fill in missing dates\n  const dates = [];\n  const current = new Date(startDate);\n  const end = new Date();\n  \n  while (current <= end) {\n    const dateStr = current.toISOString().split('T')[0];\n    if (!trends[dateStr]) {\n      trends[dateStr] = { count: 0, revenue: 0 };\n    }\n    dates.push(dateStr);\n    current.setDate(current.getDate() + 1);\n  }\n\n  // Convert to sorted array\n  return dates.map(date => ({\n    date,\n    ...trends[date]\n  }));\n}\n\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nfunction calculateAverageRating(bookings: any[]) {\n  const ratings = bookings\n    .map(b => b.rating)\n    .filter(r => r && r > 0);\n  \n  if (ratings.length === 0) return 0;\n  \n  const sum = ratings.reduce((acc, r) => acc + r, 0);\n  return Math.round((sum / ratings.length) * 10) / 10;\n}\n\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nfunction getGeographicDistribution(locations: any[]) {\n  const countries: Record<string, number> = {};\n  const cities: Record<string, number> = {};\n  \n  locations.forEach(location => {\n    if (location.latitude && location.longitude) {\n      // This is a simplified approach - in production you'd use a geocoding service\n      // to get actual country/city from coordinates\n      const country = \"Unknown\"; // Placeholder\n      const city = \"Unknown\"; // Placeholder\n      \n      countries[country] = (countries[country] || 0) + 1;\n      cities[city] = (cities[city] || 0) + 1;\n    }\n  });\n\n  return {\n    countries: Object.entries(countries).map(([name, count]) => ({ name, count })),\n    cities: Object.entries(cities).map(([name, count]) => ({ name, count }))\n  };\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\app\\api\\bookings\\confirm\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'createClient' is defined but never used. Allowed unused vars must match /^_/u.","line":2,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":2,"endColumn":22}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server'\nimport { createClient } from '@supabase/supabase-js'\nimport { withSLOProbe } from '@/middleware/sloProbe'\nimport { featureFlags } from '@/config/featureFlags'\n\nimport { supabaseAdmin as supabase } from '@/lib/supabaseProxies';\n\ninterface BookingConfirmRequest {\n  quote_id: string\n  provider_id: string\n  stripe_payment_intent_id: string\n  idempotency_key: string\n  special_instructions?: string\n}\n\ninterface BookingConfirmResponse {\n  booking_id: string\n  state: string\n  payment_status: string\n  expires_at: string\n}\n\nasync function confirmHandler(req: NextRequest): Promise<NextResponse> {\n  if (!featureFlags.beta.core_booking_flow) {\n    return NextResponse.json(\n      { error: 'Core booking flow not enabled' },\n      { status: 403 }\n    )\n  }\n\n  try {\n    const body: BookingConfirmRequest = await req.json()\n    \n    // Validate required fields\n    if (!body.quote_id || !body.provider_id || !body.stripe_payment_intent_id || !body.idempotency_key) {\n      return NextResponse.json(\n        { error: 'Missing required fields: quote_id, provider_id, stripe_payment_intent_id, idempotency_key' },\n        { status: 400 }\n      )\n    }\n\n    // Check idempotency - if this key was already processed, return the existing booking\n    const { data: existingBooking } = await supabase\n      .from('bookings')\n      .select('*')\n      .eq('idempotency_key', body.idempotency_key)\n      .single()\n\n    if (existingBooking) {\n      console.log(`Idempotency key already processed: ${body.idempotency_key}`)\n      return NextResponse.json(\n        { \n          error: 'IDEMPOTENT_DUPLICATE',\n          message: 'This request has already been processed',\n          data: { booking_id: existingBooking.id }\n        },\n        { status: 409 }\n      )\n    }\n\n    // Verify quote exists and is still valid\n    const { data: quote, error: quoteError } = await supabase\n      .from('quotes')\n      .select('*')\n      .eq('id', body.quote_id)\n      .gt('expires_at', new Date().toISOString())\n      .single()\n\n    if (quoteError || !quote) {\n      return NextResponse.json(\n        { error: 'Quote expired or not found' },\n        { status: 400 }\n      )\n    }\n\n    // Verify provider is in the quote candidates\n    interface QuoteCandidate {\n      id: string\n      [key: string]: unknown\n    }\n    const candidates = (quote.candidates || []) as QuoteCandidate[]\n    const selectedProvider = candidates.find((c: QuoteCandidate) => c.id === body.provider_id)\n    \n    if (!selectedProvider) {\n      return NextResponse.json(\n        { error: 'Selected provider not found in quote candidates' },\n        { status: 400 }\n      )\n    }\n\n    // Create booking with hold_placed state\n    const { data: booking, error: bookingError } = await supabase\n      .from('bookings')\n      .insert({\n        customer_id: quote.user_id === 'system' ? 'system' : quote.user_id, // Will be updated when user is authenticated\n        provider_id: body.provider_id,\n        quote_id: body.quote_id,\n        state: 'hold_placed',\n        price_cents: quote.price_cents,\n        stripe_payment_intent_id: body.stripe_payment_intent_id,\n        idempotency_key: body.idempotency_key,\n        confirmed_at: new Date().toISOString()\n      })\n      .select()\n      .single()\n\n    if (bookingError) {\n      console.error('Failed to create booking:', bookingError)\n      return NextResponse.json(\n        { error: 'Failed to create booking' },\n        { status: 500 }\n      )\n    }\n\n    // Insert into payments outbox for async processing\n    const { error: outboxError } = await supabase\n      .from('payments_outbox')\n      .insert({\n        id: crypto.randomUUID(),\n        event_type: 'hold_created',\n        event_data: {\n          booking_id: booking.id,\n          payment_intent_id: body.stripe_payment_intent_id,\n          amount_cents: featureFlags.payments.hold_amount_cents,\n          provider_id: body.provider_id,\n          quote_id: body.quote_id\n        },\n        status: 'pending',\n        retry_count: 0,\n        created_at: new Date().toISOString()\n      })\n\n    if (outboxError) {\n      console.error('Failed to insert into payments outbox:', outboxError)\n      // Don't fail the request - the booking was created successfully\n    }\n\n    // Log the state transition\n    const { error: auditError } = await supabase\n      .from('booking_audit_log')\n      .insert({\n        booking_id: booking.id,\n        from_state: null,\n        to_state: 'hold_placed',\n        action: 'state_change',\n        actor_type: 'user',\n        actor_id: 'system', // Will be updated when user is authenticated\n        metadata: {\n          payment_intent: body.stripe_payment_intent_id,\n          idempotency_key: body.idempotency_key,\n          provider_id: body.provider_id,\n          special_instructions: body.special_instructions\n        }\n      })\n\n    if (auditError) {\n      console.error('Failed to log audit entry:', auditError)\n      // Don't fail the request - the booking was created successfully\n    }\n\n    const response: BookingConfirmResponse = {\n      booking_id: booking.id,\n      state: booking.state,\n      payment_status: 'hold_placed',\n      expires_at: new Date(Date.now() + featureFlags.payments.hold_timeout_minutes * 60 * 1000).toISOString()\n    }\n\n    return NextResponse.json({ ok: true, data: response })\n\n  } catch (error) {\n    console.error('Booking confirmation error:', error)\n    return NextResponse.json(\n      { error: 'Internal server error' },\n      { status: 500 }\n    )\n  }\n}\n\nexport const POST = withSLOProbe(confirmHandler, 'booking_confirm_endpoint')\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\app\\api\\fix-profiles-recursion\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'createClient' is defined but never used. Allowed unused vars must match /^_/u.","line":1,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":1,"endColumn":22}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createClient } from '@supabase/supabase-js'\nimport { NextResponse } from 'next/server'\nimport { supabaseAdmin as supabase } from '@/lib/supabaseProxies';\n\nexport async function POST() {\n  try {\n    console.log('ðŸš¨ Emergency fix: Removing profiles table recursion...')\n    \n    // 1. Drop all problematic recursive policies\n    const dropPolicies = `\n      DROP POLICY IF EXISTS \"profiles_public_read\" ON profiles;\n      DROP POLICY IF EXISTS \"profiles_own_update\" ON profiles;\n      DROP POLICY IF EXISTS \"Public profiles are viewable by everyone\" ON profiles;\n      DROP POLICY IF EXISTS \"Users can insert their own profile\" ON profiles;\n      DROP POLICY IF EXISTS \"Users can update own profile\" ON profiles;\n    `\n\n    // 2. Create simple, non-recursive policies\n    const createSimplePolicies = `\n      CREATE POLICY \"profiles_simple_select\" ON profiles\n        FOR SELECT USING (\n          id = auth.uid() OR true\n        );\n    \n      CREATE POLICY \"profiles_simple_insert\" ON profiles\n        FOR INSERT WITH CHECK (\n          id = auth.uid()\n        );\n    \n      CREATE POLICY \"profiles_simple_update\" ON profiles\n        FOR UPDATE USING (\n          id = auth.uid()\n        );\n    `\n\n    // 3. Fix other tables with similar issues\n    const fixOtherTables = `\n      DROP POLICY IF EXISTS \"security_logs_admin_read\" ON security_logs;\n      CREATE POLICY \"security_logs_admin_read\" ON security_logs\n        FOR SELECT USING (auth.uid() IS NOT NULL);\n    \n      DROP POLICY IF EXISTS \"rate_limits_user_read\" ON rate_limits;\n      CREATE POLICY \"rate_limits_user_read\" ON rate_limits\n        FOR SELECT USING (\n          identifier = auth.uid()::text OR auth.uid() IS NOT NULL\n        );\n    \n      DROP POLICY IF EXISTS \"admin_permissions_read\" ON admin_permissions;\n      CREATE POLICY \"admin_permissions_read\" ON admin_permissions\n        FOR SELECT USING (\n          user_id = auth.uid() OR auth.uid() IS NOT NULL\n        );\n    `\n\n    // Execute the fixes\n    const { error: dropError } = await supabase.rpc('exec_sql', { sql: dropPolicies })\n    if (dropError) console.log('Drop policies result:', dropError)\n\n    const { error: createError } = await supabase.rpc('exec_sql', { sql: createSimplePolicies })\n    if (createError) console.log('Create policies result:', createError)\n\n    const { error: fixError } = await supabase.rpc('exec_sql', { sql: fixOtherTables })\n    if (fixError) console.log('Fix other tables result:', fixError)\n\n    // Test if the fix worked\n    const { data: testData, error: testError } = await supabase\n      .from('profiles')\n      .select('id')\n      .limit(1)\n\n    if (testError) {\n      console.error('âŒ Fix failed:', testError)\n      return NextResponse.json({ \n        success: false, \n        error: 'Fix failed - manual intervention required',\n        details: testError\n      }, { status: 500 })\n    }\n\n    console.log('âœ… Profiles table recursion fixed successfully!')\n    return NextResponse.json({ \n      success: true, \n      message: 'Profiles table recursion fixed',\n      testResult: testData\n    })\n\n  } catch (error) {\n    console.error('âŒ Emergency fix failed:', error)\n    return NextResponse.json({ \n      success: false, \n      error: 'Emergency fix failed',\n      details: error instanceof Error ? error.message : 'Unknown error'\n    }, { status: 500 })\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\app\\api\\ops\\baseline\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'createClient' is defined but never used. Allowed unused vars must match /^_/u.","line":2,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":2,"endColumn":22}],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":124,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":124,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3460,3463],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3460,3463],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":126,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":126,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3633,3636],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3633,3636],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":173,"column":54,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":173,"endColumn":57,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5890,5893],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5890,5893],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":180,"column":57,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":180,"endColumn":60,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6176,6179],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6176,6179],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":187,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":187,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6429,6432],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6429,6432],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server'\nimport { createClient } from '@supabase/supabase-js'\nimport { loadBaselines, saveBaseline, getLatestBaseline, deleteBaseline } from '../../../../../scripts/ops-baseline-store'\nimport type { BaselineData } from '@/lib/regression/regressionAI'\n\nimport { supabaseAdmin as supabase } from '@/lib/supabaseProxies';\n\n/**\n * GET /ops/baseline\n * \n * List all baselines or get a specific baseline\n */\nexport async function GET(request: NextRequest) {\n  try {\n    const { searchParams } = new URL(request.url)\n    const metricType = searchParams.get('metricType')\n    const endpoint = searchParams.get('endpoint')\n    const period = searchParams.get('period') as 'normal' | 'peak' | 'low' | null\n\n    if (metricType && period) {\n      // Get specific baseline\n      const baseline = getLatestBaseline(metricType, endpoint || undefined, period)\n      if (!baseline) {\n        return NextResponse.json({\n          success: false,\n          error: 'Baseline not found'\n        }, { status: 404 })\n      }\n      return NextResponse.json({\n        success: true,\n        baseline\n      })\n    }\n\n    // List all baselines\n    const baselines = loadBaselines(metricType || undefined, endpoint || undefined)\n    \n    return NextResponse.json({\n      success: true,\n      baselines,\n      count: baselines.length\n    })\n\n  } catch (error) {\n    console.error('Baseline GET endpoint error:', error)\n    return NextResponse.json(\n      { error: 'Internal server error' },\n      { status: 500 }\n    )\n  }\n}\n\n/**\n * POST /ops/baseline\n * \n * Create a new baseline from current metrics\n */\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json()\n    const { \n      metricType, \n      endpoint, \n      period = 'normal',\n      timeRange = '24h',\n      deployId,\n      commitSha,\n      notes\n    } = body\n\n    if (!metricType) {\n      return NextResponse.json({\n        success: false,\n        error: 'metricType is required'\n      }, { status: 400 })\n    }\n\n    if (!['p95', 'booking', 'error', 'system'].includes(metricType)) {\n      return NextResponse.json({\n        success: false,\n        error: 'metricType must be one of: p95, booking, error, system'\n      }, { status: 400 })\n    }\n\n    // Calculate time range\n    const now = new Date()\n    let startTime: Date\n\n    switch (timeRange) {\n      case '1h':\n        startTime = new Date(now.getTime() - 60 * 60 * 1000)\n        break\n      case '6h':\n        startTime = new Date(now.getTime() - 6 * 60 * 60 * 1000)\n        break\n      case '24h':\n        startTime = new Date(now.getTime() - 24 * 60 * 60 * 1000)\n        break\n      case '7d':\n        startTime = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000)\n        break\n      default:\n        startTime = new Date(now.getTime() - 24 * 60 * 60 * 1000)\n    }\n\n    // Fetch metrics and calculate baseline data\n    const baselineData: BaselineData = {}\n\n    if (metricType === 'p95') {\n      let query = supabase\n        .from('api_metrics_5m')\n        .select('endpoint, method, p95_ms, p99_ms, reqs')\n        .gte('bucket', startTime.toISOString())\n        .order('bucket', { ascending: true })\n\n      if (endpoint) {\n        query = query.eq('endpoint', endpoint)\n      }\n\n      const { data: metrics } = await query\n\n      if (metrics && metrics.length > 0) {\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\n        const p95Values = metrics.map((m: any) => m.p95_ms).filter((v: number) => v != null && v > 0)\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\n        const p99Values = metrics.map((m: any) => m.p99_ms).filter((v: number) => v != null && v > 0)\n\n        if (p95Values.length > 0) {\n          baselineData.p95_latency_ms = p95Values.reduce((sum: number, v: number) => sum + v, 0) / p95Values.length\n        }\n        if (p99Values.length > 0) {\n          baselineData.p99_latency_ms = p99Values.reduce((sum: number, v: number) => sum + v, 0) / p99Values.length\n        }\n      }\n    } else if (metricType === 'booking') {\n      const { data: bookings } = await supabase\n        .from('bookings')\n        .select('id, status, created_at, confirmed_at, total_amount_cents, price_cents')\n        .gte('created_at', startTime.toISOString())\n\n      if (bookings && bookings.length > 0) {\n        const hours = (now.getTime() - startTime.getTime()) / (1000 * 60 * 60)\n        baselineData.bookings_per_hour = bookings.length / hours\n\n        const confirmed = bookings.filter(b => b.status === 'confirmed' || b.confirmed_at).length\n        baselineData.conversion_rate = bookings.length > 0 ? (confirmed / bookings.length) * 100 : 0\n      }\n    } else if (metricType === 'error') {\n      const { data: errors } = await supabase\n        .from('performance_metrics')\n        .select('status_code, created_at')\n        .gte('created_at', startTime.toISOString())\n        .gte('status_code', 400)\n\n      const { count: totalRequests } = await supabase\n        .from('performance_metrics')\n        .select('*', { count: 'exact', head: true })\n        .gte('created_at', startTime.toISOString())\n\n      if (errors && totalRequests) {\n        const hours = (now.getTime() - startTime.getTime()) / (1000 * 60 * 60)\n        baselineData.error_count_per_hour = errors.length / hours\n        baselineData.error_rate_percent = totalRequests > 0 ? (errors.length / totalRequests) * 100 : 0\n      }\n    } else if (metricType === 'system') {\n      const { data: performanceData } = await supabase\n        .from('performance_analytics_5min')\n        .select('cache_hit_rate_percent, avg_database_queries, request_count')\n        .gte('five_minute_bucket', startTime.toISOString())\n\n      if (performanceData && performanceData.length > 0) {\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\n        const cpuValues = performanceData.map((item: any) => {\n          return Math.min(100,\n            (item.request_count || 0) * 0.1 +\n            (item.avg_database_queries || 0) * 2\n          )\n        })\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\n        const memoryValues = performanceData.map((item: any) => {\n          return Math.min(100,\n            30 + (item.request_count || 0) * 0.05\n          )\n        })\n        const cacheValues = performanceData\n          // eslint-disable-next-line @typescript-eslint/no-explicit-any\n          .map((item: any) => item.cache_hit_rate_percent)\n          .filter((v: number) => v != null && !isNaN(v))\n\n        if (cpuValues.length > 0) {\n          baselineData.cpu_percent = cpuValues.reduce((sum: number, v: number) => sum + v, 0) / cpuValues.length\n        }\n        if (memoryValues.length > 0) {\n          baselineData.memory_percent = memoryValues.reduce((sum: number, v: number) => sum + v, 0) / memoryValues.length\n        }\n        if (cacheValues.length > 0) {\n          baselineData.cache_hit_rate = cacheValues.reduce((sum: number, v: number) => sum + v, 0) / cacheValues.length\n        }\n      }\n    }\n\n    // Create baseline\n    const baseline = saveBaseline({\n      metric_type: metricType as 'p95' | 'booking' | 'error' | 'system',\n      endpoint: endpoint || undefined,\n      period: period as 'normal' | 'peak' | 'low',\n      data: baselineData,\n      metadata: {\n        deploy_id: deployId,\n        commit_sha: commitSha,\n        notes\n      }\n    })\n\n    return NextResponse.json({\n      success: true,\n      baseline,\n      message: `Baseline created for ${metricType}${endpoint ? ` (${endpoint})` : ''}`\n    })\n\n  } catch (error) {\n    console.error('Baseline POST endpoint error:', error)\n    return NextResponse.json(\n      { error: 'Internal server error', details: error instanceof Error ? error.message : 'Unknown error' },\n      { status: 500 }\n    )\n  }\n}\n\n/**\n * DELETE /ops/baseline\n * \n * Delete a baseline by ID\n */\nexport async function DELETE(request: NextRequest) {\n  try {\n    const { searchParams } = new URL(request.url)\n    const id = searchParams.get('id')\n\n    if (!id) {\n      return NextResponse.json({\n        success: false,\n        error: 'id parameter is required'\n      }, { status: 400 })\n    }\n\n    const deleted = deleteBaseline(id)\n\n    if (!deleted) {\n      return NextResponse.json({\n        success: false,\n        error: 'Baseline not found'\n      }, { status: 404 })\n    }\n\n    return NextResponse.json({\n      success: true,\n      message: 'Baseline deleted'\n    })\n\n  } catch (error) {\n    console.error('Baseline DELETE endpoint error:', error)\n    return NextResponse.json(\n      { error: 'Internal server error' },\n      { status: 500 }\n    )\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\app\\api\\ops\\controlplane\\_lib\\simcity-evaluator.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'stableHash' is defined but never used. Allowed unused vars must match /^_/u.","line":8,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":8,"endColumn":20}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * SimCity Phase 6: Evaluator\r\n *\r\n * Computes metric deltas and evaluates dials to determine if a variant is allowed.\r\n * All functions are deterministic and pure.\r\n */\r\n\r\nimport { stableHash } from './simcity-hash'\r\nimport type {\r\n  MetricDelta,\r\n  DialStatus,\r\n  DialDefinition,\r\n  EvaluationResult,\r\n  MetricId,\r\n  SimCityEventEnvelope,\r\n} from './simcity-types'\r\nimport { METRICS_REGISTRY } from './simcity-metrics'\r\nimport { computeMetricsFromEvents } from './simcity-metric-extractors'\r\n\r\n/**\r\n * Compute metric deltas between base and variant metrics.\r\n */\r\nexport function computeMetricDeltas(\r\n  baseMetrics: Record<MetricId, number>,\r\n  variantMetrics: Record<MetricId, number>\r\n): MetricDelta[] {\r\n  const deltas: MetricDelta[] = []\r\n\r\n  for (const metricId of Object.keys(METRICS_REGISTRY) as MetricId[]) {\r\n    const base = baseMetrics[metricId] ?? 0\r\n    const variant = variantMetrics[metricId] ?? 0\r\n    const delta = variant - base\r\n\r\n    const metric = METRICS_REGISTRY[metricId]\r\n    let direction: 'improved' | 'degraded' | 'neutral'\r\n\r\n    // Determine direction based on metric direction and delta\r\n    if (Math.abs(delta) < 1e-9) {\r\n      direction = 'neutral'\r\n    } else if (metric.direction === 'higher-is-better') {\r\n      direction = delta > 0 ? 'improved' : 'degraded'\r\n    } else {\r\n      // lower-is-better\r\n      direction = delta < 0 ? 'improved' : 'degraded'\r\n    }\r\n\r\n    deltas.push({\r\n      id: metricId,\r\n      base,\r\n      variant,\r\n      delta,\r\n      direction,\r\n    })\r\n  }\r\n\r\n  // Sort deterministically by metric ID\r\n  deltas.sort((a, b) => a.id.localeCompare(b.id))\r\n\r\n  return deltas\r\n}\r\n\r\n/**\r\n * Evaluate dials against metrics and classify zones.\r\n */\r\nexport function evalDials(\r\n  metrics: Record<MetricId, number>,\r\n  dials: DialDefinition[]\r\n): DialStatus[] {\r\n  const statuses: DialStatus[] = []\r\n\r\n  for (const dial of dials) {\r\n    const value = metrics[dial.metric] ?? 0\r\n    const metric = METRICS_REGISTRY[dial.metric]\r\n\r\n    if (!metric) {\r\n      // Skip dials for unknown metrics\r\n      continue\r\n    }\r\n\r\n    let zone: 'green' | 'yellow' | 'red'\r\n\r\n    const [greenMin, greenMax] = dial.green\r\n    const [yellowMin, yellowMax] = dial.yellow\r\n    const [_redMin, _redMax] = dial.red\r\n\r\n    // Classify zone based on metric direction\r\n    if (metric.direction === 'lower-is-better') {\r\n      // Lower values are better: green is lowest range\r\n      if (value >= greenMin && value <= greenMax) {\r\n        zone = 'green'\r\n      } else if (value >= yellowMin && value <= yellowMax) {\r\n        zone = 'yellow'\r\n      } else {\r\n        zone = 'red'\r\n      }\r\n    } else {\r\n      // Higher values are better: green is highest range\r\n      if (value >= greenMin && value <= greenMax) {\r\n        zone = 'green'\r\n      } else if (value >= yellowMin && value <= yellowMax) {\r\n        zone = 'yellow'\r\n      } else {\r\n        zone = 'red'\r\n      }\r\n    }\r\n\r\n    statuses.push({\r\n      metric: dial.metric,\r\n      value,\r\n      zone,\r\n    })\r\n  }\r\n\r\n  // Sort deterministically by metric ID\r\n  statuses.sort((a, b) => a.metric.localeCompare(b.metric))\r\n\r\n  return statuses\r\n}\r\n\r\n/**\r\n * Generate deterministic summary string.\r\n */\r\nfunction generateSummary(\r\n  dialStatuses: DialStatus[],\r\n  deltas?: MetricDelta[]\r\n): string {\r\n  const redCount = dialStatuses.filter((s) => s.zone === 'red').length\r\n  const yellowCount = dialStatuses.filter((s) => s.zone === 'yellow').length\r\n  const greenCount = dialStatuses.filter((s) => s.zone === 'green').length\r\n\r\n  const parts: string[] = []\r\n\r\n  parts.push(`Status: ${redCount} red, ${yellowCount} yellow, ${greenCount} green`)\r\n\r\n  // Add top 3 worst red/yellow by magnitude\r\n  const worst = [...dialStatuses]\r\n    .filter((s) => s.zone === 'red' || s.zone === 'yellow')\r\n    .sort((a, b) => {\r\n      // Sort by zone (red first) then by value magnitude\r\n      if (a.zone !== b.zone) {\r\n        return a.zone === 'red' ? -1 : 1\r\n      }\r\n      return Math.abs(b.value) - Math.abs(a.value)\r\n    })\r\n    .slice(0, 3)\r\n\r\n  if (worst.length > 0) {\r\n    parts.push('Top issues:')\r\n    for (const status of worst) {\r\n      const metric = METRICS_REGISTRY[status.metric]\r\n      parts.push(`  ${status.metric}: ${status.value.toFixed(3)} ${metric.unit} (${status.zone})`)\r\n    }\r\n  }\r\n\r\n  // Add top deltas if provided\r\n  if (deltas && deltas.length > 0) {\r\n    const topDeltas = [...deltas]\r\n      .filter((d) => d.direction !== 'neutral')\r\n      .sort((a, b) => Math.abs(b.delta) - Math.abs(a.delta))\r\n      .slice(0, 3)\r\n\r\n    if (topDeltas.length > 0) {\r\n      parts.push('Top changes:')\r\n      for (const delta of topDeltas) {\r\n        const sign = delta.delta > 0 ? '+' : ''\r\n        parts.push(`  ${delta.id}: ${sign}${delta.delta.toFixed(3)} (${delta.direction})`)\r\n      }\r\n    }\r\n  }\r\n\r\n  return parts.join('\\n')\r\n}\r\n\r\n/**\r\n * Evaluate a replay variant against dials.\r\n */\r\nexport function evaluateReplayVariant({\r\n  reportHash,\r\n  baseEvents,\r\n  variantEvents,\r\n  dials,\r\n  variantId,\r\n}: {\r\n  reportHash: string\r\n  baseEvents: SimCityEventEnvelope[]\r\n  variantEvents: SimCityEventEnvelope[]\r\n  dials: DialDefinition[]\r\n  variantId?: string\r\n}): EvaluationResult {\r\n  // Compute metrics\r\n  const baseMetrics = computeMetricsFromEvents(baseEvents)\r\n  const variantMetrics = computeMetricsFromEvents(variantEvents)\r\n\r\n  // Evaluate dials for variant\r\n  const dialStatuses = evalDials(variantMetrics, dials)\r\n\r\n  // Compute deltas if variant is not base\r\n  const deltas = variantId && variantId !== 'base' ? computeMetricDeltas(baseMetrics, variantMetrics) : undefined\r\n\r\n  // Determine allowed status\r\n  const violated = dialStatuses.filter((s) => s.zone === 'red')\r\n  const warnings = dialStatuses.filter((s) => s.zone === 'yellow')\r\n  const allowed = violated.length === 0\r\n\r\n  // Generate summary\r\n  const summary = generateSummary(dialStatuses, deltas)\r\n\r\n  return {\r\n    allowed,\r\n    violated,\r\n    warnings,\r\n    summary,\r\n    reportHash,\r\n    variantId,\r\n  }\r\n}\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\app\\api\\ops\\controlplane\\_lib\\simcity-governance-rules.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'METRICS_REGISTRY' is defined but never used. Allowed unused vars must match /^_/u.","line":15,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":15,"endColumn":26}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * SimCity Phase 7: Governance Rules\r\n *\r\n * Deterministic rules that evaluate proposals and produce governance decisions.\r\n * Rules never throw; they return null if inputs are missing.\r\n */\r\n\r\nimport type {\r\n  GovernanceContext,\r\n  GovernanceVerdict,\r\n  GovernanceReason,\r\n  OverrideRequirement,\r\n  _MetricDelta,\r\n} from './simcity-types'\r\nimport { METRICS_REGISTRY } from './simcity-metrics'\r\n\r\nexport type GovernanceRuleResult = {\r\n  verdict?: GovernanceVerdict\r\n  reason?: GovernanceReason\r\n  override?: OverrideRequirement\r\n} | null\r\n\r\nexport type GovernanceRule = {\r\n  id: string\r\n  description: string\r\n  evaluate: (ctx: GovernanceContext) => GovernanceRuleResult\r\n}\r\n\r\n// Thresholds (constants, documented)\r\nconst TRUST_VIOLATION_RATE_THRESHOLD = 0.01 // Block if trust violation rate increases by more than 1%\r\nconst LATENCY_REGRESSION_THRESHOLD = 0.05 // Warn if latency p95 increases by more than 5%\r\nconst ERROR_RATE_REGRESSION_THRESHOLD = 0.02 // Block if error rate increases by more than 2%\r\n\r\n/**\r\n * Rule: Block if any dial status is red.\r\n */\r\nfunction blockOnRedDial(ctx: GovernanceContext): GovernanceRuleResult {\r\n  if (!ctx.dialsSnapshot || ctx.dialsSnapshot.length === 0) {\r\n    return null // Missing input, let fail-closed handle it\r\n  }\r\n\r\n  const redDials = ctx.dialsSnapshot.filter((d) => d.zone === 'red')\r\n\r\n  if (redDials.length > 0) {\r\n    return {\r\n      verdict: 'block',\r\n      reason: {\r\n        ruleId: 'block-on-red-dial',\r\n        severity: 'block',\r\n        message: `${redDials.length} dial(s) in red zone`,\r\n        evidence: {\r\n          redDials: redDials.map((d) => ({ metric: d.metric, value: d.value })),\r\n        },\r\n      },\r\n    }\r\n  }\r\n\r\n  return null\r\n}\r\n\r\n/**\r\n * Rule: Warn if any dial status is yellow (unless already blocked).\r\n */\r\nfunction warnOnYellowDial(ctx: GovernanceContext): GovernanceRuleResult {\r\n  if (!ctx.dialsSnapshot || ctx.dialsSnapshot.length === 0) {\r\n    return null\r\n  }\r\n\r\n  const yellowDials = ctx.dialsSnapshot.filter((d) => d.zone === 'yellow')\r\n\r\n  if (yellowDials.length > 0) {\r\n    return {\r\n      verdict: 'warn',\r\n      reason: {\r\n        ruleId: 'warn-on-yellow-dial',\r\n        severity: 'warn',\r\n        message: `${yellowDials.length} dial(s) in yellow zone`,\r\n        evidence: {\r\n          yellowDials: yellowDials.map((d) => ({ metric: d.metric, value: d.value })),\r\n        },\r\n      },\r\n    }\r\n  }\r\n\r\n  return null\r\n}\r\n\r\n/**\r\n * Rule: Block if trust violation rate regression exceeds threshold.\r\n */\r\nfunction blockOnTrustRegression(ctx: GovernanceContext): GovernanceRuleResult {\r\n  if (!ctx.replayEvaluation?.deltas) {\r\n    return null\r\n  }\r\n\r\n  const trustDelta = ctx.replayEvaluation.deltas.find((d) => d.id === 'trust.violation_rate')\r\n\r\n  if (!trustDelta || trustDelta.direction === 'neutral') {\r\n    return null\r\n  }\r\n\r\n  // Check if trust violation rate worsened (increased for lower-is-better metric)\r\n  if (trustDelta.direction === 'degraded' && trustDelta.delta !== null) {\r\n    const absoluteDelta = Math.abs(trustDelta.delta)\r\n    if (absoluteDelta > TRUST_VIOLATION_RATE_THRESHOLD) {\r\n      return {\r\n        verdict: 'block',\r\n        reason: {\r\n          ruleId: 'block-on-trust-regression',\r\n          severity: 'block',\r\n          message: `Trust violation rate regression exceeds threshold (delta: ${trustDelta.delta.toFixed(4)})`,\r\n          evidence: {\r\n            base: trustDelta.base,\r\n            variant: trustDelta.variant,\r\n            delta: trustDelta.delta,\r\n            threshold: TRUST_VIOLATION_RATE_THRESHOLD,\r\n          },\r\n        },\r\n      }\r\n    }\r\n  }\r\n\r\n  return null\r\n}\r\n\r\n/**\r\n * Rule: Warn if latency p95 regression exceeds threshold.\r\n */\r\nfunction warnOnLatencyRegression(ctx: GovernanceContext): GovernanceRuleResult {\r\n  if (!ctx.replayEvaluation?.deltas) {\r\n    return null\r\n  }\r\n\r\n  const latencyDelta = ctx.replayEvaluation.deltas.find((d) => d.id === 'latency.p95')\r\n\r\n  if (!latencyDelta || latencyDelta.direction === 'neutral' || latencyDelta.base === null || latencyDelta.base === 0) {\r\n    return null\r\n  }\r\n\r\n  // Calculate percentage increase\r\n  if (latencyDelta.direction === 'degraded' && latencyDelta.delta !== null) {\r\n    const percentIncrease = Math.abs(latencyDelta.delta / latencyDelta.base)\r\n\r\n    if (percentIncrease > LATENCY_REGRESSION_THRESHOLD) {\r\n      return {\r\n        verdict: 'warn',\r\n        reason: {\r\n          ruleId: 'warn-on-latency-regression',\r\n          severity: 'warn',\r\n          message: `Latency p95 regression exceeds threshold (${(percentIncrease * 100).toFixed(1)}% increase)`,\r\n          evidence: {\r\n            base: latencyDelta.base,\r\n            variant: latencyDelta.variant,\r\n            delta: latencyDelta.delta,\r\n            percentIncrease,\r\n            threshold: LATENCY_REGRESSION_THRESHOLD,\r\n          },\r\n        },\r\n      }\r\n    }\r\n  }\r\n\r\n  return null\r\n}\r\n\r\n/**\r\n * Rule: Block if error rate regression exceeds threshold.\r\n */\r\nfunction blockOnErrorRateRegression(ctx: GovernanceContext): GovernanceRuleResult {\r\n  if (!ctx.replayEvaluation?.deltas) {\r\n    return null\r\n  }\r\n\r\n  const errorDelta = ctx.replayEvaluation.deltas.find((d) => d.id === 'error.rate')\r\n\r\n  if (!errorDelta || errorDelta.direction === 'neutral') {\r\n    return null\r\n  }\r\n\r\n  // Check if error rate worsened (increased for lower-is-better metric)\r\n  if (errorDelta.direction === 'degraded' && errorDelta.delta !== null) {\r\n    const absoluteDelta = Math.abs(errorDelta.delta)\r\n    if (absoluteDelta > ERROR_RATE_REGRESSION_THRESHOLD) {\r\n      return {\r\n        verdict: 'block',\r\n        reason: {\r\n          ruleId: 'block-on-error-rate-regression',\r\n          severity: 'block',\r\n          message: `Error rate regression exceeds threshold (delta: ${errorDelta.delta.toFixed(4)})`,\r\n          evidence: {\r\n            base: errorDelta.base,\r\n            variant: errorDelta.variant,\r\n            delta: errorDelta.delta,\r\n            threshold: ERROR_RATE_REGRESSION_THRESHOLD,\r\n          },\r\n        },\r\n      }\r\n    }\r\n  }\r\n\r\n  return null\r\n}\r\n\r\n/**\r\n * Rule: Require override for apply/promote actions.\r\n */\r\nfunction requireOverrideForApply(ctx: GovernanceContext): GovernanceRuleResult {\r\n  const action = ctx.proposal.action.toLowerCase()\r\n\r\n  if (action.includes('apply') || action.includes('promote') || action.includes('execute')) {\r\n    return {\r\n      verdict: 'warn', // Downgrade to warn with override requirement\r\n      reason: {\r\n        ruleId: 'require-override-for-apply',\r\n        severity: 'warn',\r\n        message: 'Action suggests apply/promote/execute - override required',\r\n        evidence: {\r\n          action: ctx.proposal.action,\r\n        },\r\n      },\r\n      override: {\r\n        reason: 'Action requires explicit approval for apply/promote/execute operations',\r\n        roleRequired: 'admin',\r\n        expiresAfterTicks: 100, // Expires after 100 ticks\r\n      },\r\n    }\r\n  }\r\n\r\n  return null\r\n}\r\n\r\n/**\r\n * Default governance rules registry.\r\n * Rules are evaluated in order; first block wins, then warn.\r\n */\r\nexport const DEFAULT_GOVERNANCE_RULES: GovernanceRule[] = [\r\n  {\r\n    id: 'block-on-red-dial',\r\n    description: 'Block if any dial status is red',\r\n    evaluate: blockOnRedDial,\r\n  },\r\n  {\r\n    id: 'block-on-trust-regression',\r\n    description: 'Block if trust violation rate regression exceeds threshold',\r\n    evaluate: blockOnTrustRegression,\r\n  },\r\n  {\r\n    id: 'block-on-error-rate-regression',\r\n    description: 'Block if error rate regression exceeds threshold',\r\n    evaluate: blockOnErrorRateRegression,\r\n  },\r\n  {\r\n    id: 'warn-on-yellow-dial',\r\n    description: 'Warn if any dial status is yellow',\r\n    evaluate: warnOnYellowDial,\r\n  },\r\n  {\r\n    id: 'warn-on-latency-regression',\r\n    description: 'Warn if latency p95 regression exceeds threshold',\r\n    evaluate: warnOnLatencyRegression,\r\n  },\r\n  {\r\n    id: 'require-override-for-apply',\r\n    description: 'Require override for apply/promote/execute actions',\r\n    evaluate: requireOverrideForApply,\r\n  },\r\n]\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\app\\api\\ops\\controlplane\\_lib\\simcity-metric-extractors.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'METRICS_REGISTRY' is defined but never used. Allowed unused vars must match /^_/u.","line":9,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":9,"endColumn":26}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * SimCity Phase 6: Metric Extractors\r\n *\r\n * Pure functions that compute metrics from event streams.\r\n * All functions are deterministic: same input -> same output.\r\n */\r\n\r\nimport type { SimCityEventEnvelope, MetricId } from './simcity-types'\r\nimport { METRICS_REGISTRY } from './simcity-metrics'\r\n\r\n/**\r\n * Compute p95 percentile deterministically from a sorted numeric array.\r\n */\r\nfunction computeP95(values: number[]): number {\r\n  if (values.length === 0) {\r\n    return 0\r\n  }\r\n\r\n  const sorted = [...values].sort((a, b) => a - b)\r\n  const index = Math.ceil(0.95 * sorted.length) - 1\r\n  return sorted[Math.max(0, Math.min(index, sorted.length - 1))]\r\n}\r\n\r\n/**\r\n * Extract latency values from events.\r\n * Looks for latency_jitter events or payload.latency fields.\r\n */\r\nfunction extractLatencies(events: SimCityEventEnvelope[]): number[] {\r\n  const latencies: number[] = []\r\n\r\n  for (const envelope of events) {\r\n    const { type, payload } = envelope.event\r\n\r\n    // Check for latency_jitter events\r\n    if (type === 'latency_jitter' && typeof payload.ms === 'number') {\r\n      latencies.push(payload.ms)\r\n    }\r\n\r\n    // Check for latency in payload\r\n    if (typeof payload.latency === 'number') {\r\n      latencies.push(payload.latency)\r\n    }\r\n    if (typeof payload.latencyMs === 'number') {\r\n      latencies.push(payload.latencyMs)\r\n    }\r\n  }\r\n\r\n  return latencies\r\n}\r\n\r\n/**\r\n * Count error events.\r\n * Events with type containing 'error' or payload.error === true.\r\n */\r\nfunction countErrors(events: SimCityEventEnvelope[]): number {\r\n  let count = 0\r\n\r\n  for (const envelope of events) {\r\n    const { type, payload } = envelope.event\r\n\r\n    if (type.includes('error') || type.includes('failure') || type.includes('fault')) {\r\n      count++\r\n    } else if (payload.error === true || payload.failed === true) {\r\n      count++\r\n    }\r\n  }\r\n\r\n  return count\r\n}\r\n\r\n/**\r\n * Extract capacity/utilization signals from booking-load events.\r\n */\r\nfunction extractCapacityUtilization(events: SimCityEventEnvelope[]): number {\r\n  // Look for booking-load events with utilization signals\r\n  for (const envelope of events) {\r\n    if (envelope.event.domain === 'booking-load') {\r\n      const { payload } = envelope.event\r\n\r\n      if (typeof payload.utilization === 'number') {\r\n        return Math.max(0, Math.min(1, payload.utilization))\r\n      }\r\n      if (typeof payload.pressure === 'number') {\r\n        // Approximate utilization from pressure (0-1 scale)\r\n        return Math.max(0, Math.min(1, payload.pressure))\r\n      }\r\n      if (typeof payload.load === 'number') {\r\n        // Approximate utilization from load (normalize to 0-1)\r\n        return Math.max(0, Math.min(1, payload.load / 10))\r\n      }\r\n    }\r\n  }\r\n\r\n  // Default: no utilization signal found\r\n  return 0\r\n}\r\n\r\n/**\r\n * Extract booking success/drop signals.\r\n * Since we may not have explicit booking.success events yet, approximate from booking-load signals.\r\n */\r\nfunction extractBookingMetrics(events: SimCityEventEnvelope[]): {\r\n  successRate: number\r\n  dropRate: number\r\n} {\r\n  let totalBookingSignals = 0\r\n  let successSignals = 0\r\n  let dropSignals = 0\r\n\r\n  for (const envelope of events) {\r\n    const { domain, type, payload } = envelope.event\r\n\r\n    // Count booking-related events\r\n    if (domain === 'booking-load' || domain === 'booking') {\r\n      totalBookingSignals++\r\n\r\n      // Success indicators\r\n      if (type.includes('success') || type.includes('completed') || payload.success === true) {\r\n        successSignals++\r\n      }\r\n\r\n      // Drop indicators\r\n      if (type.includes('drop') || type.includes('reject') || payload.dropped === true) {\r\n        dropSignals++\r\n      }\r\n    }\r\n  }\r\n\r\n  // If no booking signals, return defaults\r\n  if (totalBookingSignals === 0) {\r\n    return { successRate: 0, dropRate: 0 }\r\n  }\r\n\r\n  // Compute rates\r\n  const successRate = successSignals / totalBookingSignals\r\n  const dropRate = dropSignals / totalBookingSignals\r\n\r\n  // If no explicit success/drop signals, approximate from load spikes (high load = lower success)\r\n  if (successSignals === 0 && dropSignals === 0) {\r\n    const loadSpikes = events.filter(\r\n      (e) => e.event.domain === 'booking-load' && e.event.type === 'load_spike'\r\n    ).length\r\n\r\n    // Approximate: more load spikes = lower success rate\r\n    const estimatedSuccessRate = Math.max(0, Math.min(1, 1 - loadSpikes / Math.max(1, totalBookingSignals) * 0.1))\r\n    return { successRate: estimatedSuccessRate, dropRate: 1 - estimatedSuccessRate }\r\n  }\r\n\r\n  return { successRate, dropRate }\r\n}\r\n\r\n/**\r\n * Extract trust violation rate.\r\n * Look for trust domain events or violation indicators.\r\n */\r\nfunction extractTrustViolationRate(events: SimCityEventEnvelope[]): number {\r\n  let violations = 0\r\n  let trustEvents = 0\r\n\r\n  for (const envelope of events) {\r\n    const { domain, type, payload } = envelope.event\r\n\r\n    if (domain === 'trust' || domain === 'safety') {\r\n      trustEvents++\r\n      if (type.includes('violation') || payload.violation === true) {\r\n        violations++\r\n      }\r\n    }\r\n  }\r\n\r\n  if (trustEvents === 0) {\r\n    return 0 // No trust domain events yet\r\n  }\r\n\r\n  return violations / trustEvents\r\n}\r\n\r\n/**\r\n * Compute all metrics from an event stream.\r\n * Returns a record with all metric IDs and their computed values.\r\n * Missing signals return explicit defaults (0 or neutral values).\r\n */\r\nexport function computeMetricsFromEvents(\r\n  events: SimCityEventEnvelope[]\r\n): Record<MetricId, number> {\r\n  const metrics: Partial<Record<MetricId, number>> = {}\r\n\r\n  // Extract latencies and compute p95\r\n  const latencies = extractLatencies(events)\r\n  metrics['latency.p95'] = computeP95(latencies)\r\n\r\n  // Count errors\r\n  const errorCount = countErrors(events)\r\n  const totalEvents = events.length\r\n  metrics['error.rate'] = totalEvents > 0 ? errorCount / totalEvents : 0\r\n\r\n  // Extract capacity utilization\r\n  metrics['capacity.utilization'] = extractCapacityUtilization(events)\r\n\r\n  // Extract booking metrics\r\n  const bookingMetrics = extractBookingMetrics(events)\r\n  metrics['booking.success_rate'] = bookingMetrics.successRate\r\n  metrics['booking.drop_rate'] = bookingMetrics.dropRate\r\n\r\n  // Extract trust violation rate\r\n  metrics['trust.violation_rate'] = extractTrustViolationRate(events)\r\n\r\n  // Ensure all metrics are present (fill missing with 0)\r\n  const allMetrics: Record<MetricId, number> = {\r\n    'booking.success_rate': metrics['booking.success_rate'] ?? 0,\r\n    'booking.drop_rate': metrics['booking.drop_rate'] ?? 0,\r\n    'capacity.utilization': metrics['capacity.utilization'] ?? 0,\r\n    'trust.violation_rate': metrics['trust.violation_rate'] ?? 0,\r\n    'latency.p95': metrics['latency.p95'] ?? 0,\r\n    'error.rate': metrics['error.rate'] ?? 0,\r\n  }\r\n\r\n  return allMetrics\r\n}\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\app\\api\\ops\\controlplane\\_lib\\simcity-shadow-comparison.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'DEFAULT_DIALS' is defined but never used. Allowed unused vars must match /^_/u.","line":18,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":18,"endColumn":23}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * SimCity Phase 10: Shadow Comparison\r\n *\r\n * Compares SimCity shadow simulation with actual production metrics.\r\n * Generates comparison report with hypothetical verdict.\r\n */\r\n\r\nimport { hashStableJson } from './simcity-governance-hash'\r\nimport { evaluateProposal } from './simcity-governance'\r\nimport type {\r\n  ShadowComparisonReport,\r\n  ShadowEvent,\r\n  _DialStatus,\r\n  GovernanceVerdict,\r\n  SimCityProposal,\r\n  GovernanceContext,\r\n} from './simcity-types'\r\nimport { DEFAULT_DIALS } from './simcity-dials'\r\nimport { simulateShadow } from './simcity-shadow-simulate'\r\n\r\n/**\r\n * Generate shadow comparison report.\r\n * \r\n * Compares:\r\n * - SimCity simulated metrics (from shadow events)\r\n * - Production actual metrics (from production data source)\r\n * \r\n * Computes hypothetical verdict based on SimCity simulation.\r\n * \r\n * @param window Time window for comparison\r\n * @param shadowEvents Events collected from production\r\n * @param prodMetrics Actual production metrics\r\n * @returns Shadow comparison report\r\n */\r\nexport function generateShadowComparisonReport(\r\n  window: string,\r\n  shadowEvents: ShadowEvent[],\r\n  prodMetrics: Record<string, number>\r\n): ShadowComparisonReport {\r\n  // Simulate shadow events\r\n  const { simulatedMetrics, simulatedDials } = simulateShadow(shadowEvents)\r\n\r\n  // Build a dummy proposal for hypothetical verdict evaluation\r\n  // The verdict will be based on the simulated dials, not on a real proposal\r\n  const dummyProposal: SimCityProposal = {\r\n    id: 'shadow-dummy',\r\n    tick: 0,\r\n    domain: 'shadow',\r\n    action: 'shadow-comparison',\r\n    description: 'Shadow mode comparison',\r\n    confidence: 1.0,\r\n    evidenceEventIds: [],\r\n    source: 'rules',\r\n  }\r\n\r\n  // Evaluate hypothetical verdict based on simulated dials\r\n  const ctx: GovernanceContext = {\r\n    tick: 0,\r\n    proposal: dummyProposal,\r\n    dialsSnapshot: simulatedDials,\r\n  }\r\n\r\n  const hypotheticalDecision = evaluateProposal(ctx)\r\n  const hypotheticalVerdict: GovernanceVerdict = hypotheticalDecision.verdict\r\n\r\n  // Compute deltas between SimCity and production\r\n  const deltas: Array<{\r\n    metric: string\r\n    simcityValue: number\r\n    prodValue: number\r\n    delta: number\r\n  }> = []\r\n\r\n  // Compare metrics (using keys from both sources)\r\n  const allMetricKeys = new Set([\r\n    ...Object.keys(simulatedMetrics),\r\n    ...Object.keys(prodMetrics),\r\n  ])\r\n\r\n  for (const metric of allMetricKeys) {\r\n    const simcityValue = simulatedMetrics[metric as keyof typeof simulatedMetrics] ?? 0\r\n    const prodValue = prodMetrics[metric] ?? 0\r\n    const delta = simcityValue - prodValue\r\n\r\n    deltas.push({\r\n      metric,\r\n      simcityValue,\r\n      prodValue,\r\n      delta,\r\n    })\r\n  }\r\n\r\n  // Sort deltas by metric name for determinism\r\n  deltas.sort((a, b) => a.metric.localeCompare(b.metric))\r\n\r\n  // Identify divergence flags\r\n  const divergenceFlags: string[] = []\r\n  \r\n  // Flag significant divergences (threshold: 10% difference)\r\n  for (const delta of deltas) {\r\n    const threshold = Math.abs(delta.prodValue) * 0.1\r\n    if (Math.abs(delta.delta) > threshold && Math.abs(delta.delta) > 0.01) {\r\n      divergenceFlags.push(\r\n        `${delta.metric}: ${delta.delta > 0 ? '+' : ''}${delta.delta.toFixed(3)} difference`\r\n      )\r\n    }\r\n  }\r\n\r\n  // Build report (without reportHash for hashing)\r\n  const reportWithoutHash: Omit<ShadowComparisonReport, 'reportHash'> = {\r\n    window,\r\n    simcityMetrics: simulatedMetrics,\r\n    prodMetrics,\r\n    deltas,\r\n    hypotheticalVerdict,\r\n    divergenceFlags,\r\n  }\r\n\r\n  // Compute report hash\r\n  const reportHash = hashStableJson(reportWithoutHash)\r\n\r\n  return {\r\n    ...reportWithoutHash,\r\n    reportHash,\r\n  }\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\app\\api\\ops\\controlplane\\simcity\\dials\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'DialDefinition' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":15,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":29}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextResponse } from 'next/server'\r\nimport { ensureSimCityAllowed } from '../../_lib/simcity'\r\nimport { DEFAULT_DIALS } from '../../_lib/simcity-dials'\r\nimport type { DialDefinition } from '../../_lib/simcity-types'\r\n\r\n/**\r\n * GET /api/ops/controlplane/simcity/dials\r\n *\r\n * Returns all default dial definitions.\r\n * Read-only, guarded by SimCity allowlist.\r\n */\r\nexport async function GET() {\r\n  try {\r\n    ensureSimCityAllowed()\r\n  } catch (error) {\r\n    const message = error instanceof Error ? error.message : 'SimCity is not allowed'\r\n    return NextResponse.json({ error: message }, { status: 403 })\r\n  }\r\n\r\n  try {\r\n    return NextResponse.json({\r\n      success: true,\r\n      dials: DEFAULT_DIALS,\r\n    })\r\n  } catch (error) {\r\n    const message = error instanceof Error ? error.message : 'Failed to fetch dials'\r\n    return NextResponse.json({ error: message }, { status: 500 })\r\n  }\r\n}\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\app\\api\\ops\\controlplane\\simcity\\override\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'OverrideVerdict' is defined but never used. Allowed unused vars must match /^_/u.","line":11,"column":50,"nodeType":null,"messageId":"unusedVar","endLine":11,"endColumn":65}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server'\r\nimport { ensureSimCityAllowed } from '@/app/api/ops/controlplane/_lib/simcity'\r\nimport { simCityStatus, simCityGetProposals } from '@/app/api/ops/controlplane/_lib/simcity'\r\nimport { DEFAULT_DIALS } from '@/app/api/ops/controlplane/_lib/simcity-dials'\r\nimport { evalDials } from '@/app/api/ops/controlplane/_lib/simcity-evaluator'\r\nimport { computeMetricsFromEvents } from '@/app/api/ops/controlplane/_lib/simcity-metric-extractors'\r\nimport { evaluateProposal } from '@/app/api/ops/controlplane/_lib/simcity-governance'\r\nimport { hashOverrideRecord } from '@/app/api/ops/controlplane/_lib/simcity-governance-hash'\r\nimport { validateOverride, convertToOverrideVerdict } from '@/app/api/ops/controlplane/_lib/simcity-overrides'\r\nimport { appendOverride } from '@/app/api/ops/controlplane/_lib/simcity-overrides-store'\r\nimport type { GovernanceContext, OverrideRecord, OverrideVerdict } from '@/app/api/ops/controlplane/_lib/simcity-types'\r\nimport { randomUUID } from 'node:crypto'\r\n\r\n/**\r\n * POST /api/ops/controlplane/simcity/override\r\n *\r\n * Creates a human override record.\r\n * Append-only: never modifies existing decisions.\r\n * Read-only, guarded by SimCity allowlist.\r\n */\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    ensureSimCityAllowed()\r\n  } catch (error) {\r\n    const message = error instanceof Error ? error.message : 'SimCity is not allowed'\r\n    return NextResponse.json({ error: message }, { status: 403 })\r\n  }\r\n\r\n  try {\r\n    const body = await request.json()\r\n    const { proposalId, decisionHash, verdictAfter, justification, actor } = body\r\n\r\n    // Validate required fields\r\n    if (!proposalId || !decisionHash || !verdictAfter || !justification || !actor) {\r\n      return NextResponse.json(\r\n        { error: 'Missing required fields: proposalId, decisionHash, verdictAfter, justification, actor' },\r\n        { status: 400 }\r\n      )\r\n    }\r\n\r\n    // Validate actor structure\r\n    if (!actor.userId || !actor.role) {\r\n      return NextResponse.json(\r\n        { error: 'Actor must have userId and role' },\r\n        { status: 400 }\r\n      )\r\n    }\r\n\r\n    const status = simCityStatus()\r\n\r\n    if (!status.running) {\r\n      return NextResponse.json({ error: 'SimCity is not running' }, { status: 400 })\r\n    }\r\n\r\n    // Get proposal\r\n    const proposals = simCityGetProposals()\r\n    const proposal = proposals.find((p) => p.id === proposalId)\r\n\r\n    if (!proposal) {\r\n      return NextResponse.json({ error: `Proposal ${proposalId} not found` }, { status: 404 })\r\n    }\r\n\r\n    // Load decision (re-evaluate to get current decision)\r\n    const metrics = computeMetricsFromEvents(status.events)\r\n    const dialsSnapshot = evalDials(metrics, DEFAULT_DIALS)\r\n\r\n    const ctx: GovernanceContext = {\r\n      tick: status.tick,\r\n      proposal,\r\n      dialsSnapshot,\r\n    }\r\n\r\n    const decision = evaluateProposal(ctx)\r\n\r\n    // Validate decisionHash matches\r\n    if (decisionHash !== decision.decisionHash) {\r\n      return NextResponse.json(\r\n        { error: 'DECISION_HASH_MISMATCH', message: 'Decision hash does not match current decision' },\r\n        { status: 400 }\r\n      )\r\n    }\r\n\r\n    // Validate override\r\n    try {\r\n      validateOverride({\r\n        proposal,\r\n        decision,\r\n        override: {\r\n          proposalId,\r\n          decisionHash,\r\n          verdictAfter: convertToOverrideVerdict(verdictAfter),\r\n          justification,\r\n          actor,\r\n        },\r\n      })\r\n    } catch (validationError) {\r\n      const message = validationError instanceof Error ? validationError.message : 'Validation failed'\r\n      return NextResponse.json(\r\n        { error: message, message: `Override validation failed: ${message}` },\r\n        { status: 400 }\r\n      )\r\n    }\r\n\r\n    // Build override record\r\n    const overrideVerdictAfter = convertToOverrideVerdict(verdictAfter)\r\n    const overrideVerdictBefore = convertToOverrideVerdict(decision.verdict.toUpperCase())\r\n\r\n    const overrideRecord: Omit<OverrideRecord, 'overrideHash'> = {\r\n      overrideId: randomUUID(),\r\n      proposalId,\r\n      decisionHash,\r\n      verdictBefore: overrideVerdictBefore,\r\n      verdictAfter: overrideVerdictAfter,\r\n      actor,\r\n      justification: justification.trim(),\r\n      timestamp: new Date().toISOString(),\r\n    }\r\n\r\n    // Compute overrideHash\r\n    const overrideHash = hashOverrideRecord(overrideRecord)\r\n\r\n    // Append to store\r\n    const completeRecord: OverrideRecord = {\r\n      ...overrideRecord,\r\n      overrideHash,\r\n    }\r\n\r\n    appendOverride(completeRecord)\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n      override: completeRecord,\r\n    })\r\n  } catch (error) {\r\n    const message = error instanceof Error ? error.message : 'Failed to create override'\r\n    return NextResponse.json({ error: message }, { status: 500 })\r\n  }\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\app\\api\\ops\\controlplane\\simcity\\replay\\[runId]\\evaluation\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'EvaluationResult' is defined but never used. Allowed unused vars must match /^_/u.","line":8,"column":28,"nodeType":null,"messageId":"unusedVar","endLine":8,"endColumn":44}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server'\nimport { ensureSimCityAllowed } from '@/app/api/ops/controlplane/_lib/simcity'\nimport { getReplay } from '@/app/api/ops/controlplane/_lib/simcity-replay-store'\nimport { DEFAULT_DIALS } from '@/app/api/ops/controlplane/_lib/simcity-dials'\nimport { evaluateReplayVariant, computeMetricDeltas, evalDials } from '@/app/api/ops/controlplane/_lib/simcity-evaluator'\nimport { computeMetricsFromEvents } from '@/app/api/ops/controlplane/_lib/simcity-metric-extractors'\nimport { stableHash } from '@/app/api/ops/controlplane/_lib/simcity-hash'\nimport type { MetricDelta, EvaluationResult } from '@/app/api/ops/controlplane/_lib/simcity-types'\n\n/**\n * GET /api/ops/controlplane/simcity/replay/[runId]/evaluation?variant=base|<variantId>\n *\n * Evaluates a replay variant against dials and returns metrics, deltas, and evaluation result.\n * Read-only, guarded by SimCity allowlist.\n */\nexport async function GET(\n  request: NextRequest,\n  { params }: { params: Promise<{ runId: string }> }\n) {\n  try {\n    ensureSimCityAllowed()\n  } catch (error) {\n    const message = error instanceof Error ? error.message : 'SimCity is not allowed'\n    return NextResponse.json({ error: message }, { status: 403 })\n  }\n\n  try {\n    const { runId } = await params\n    const entry = getReplay(runId)\n\n    if (!entry) {\n      return NextResponse.json({ error: `Replay ${runId} not found` }, { status: 404 })\n    }\n\n    if (entry.status !== 'completed') {\n      return NextResponse.json(\n        { error: `Replay ${runId} is not completed (status: ${entry.status})` },\n        { status: 400 }\n      )\n    }\n\n    // Get variant from query param\n    const searchParams = request.nextUrl.searchParams\n    const variantParam = searchParams.get('variant') || 'base'\n\n    // Get base events\n    const baseEvents = entry.response.baseline?.events || []\n\n    // Get variant events\n    let variantEvents: typeof baseEvents\n    let variantId: string\n\n    if (variantParam === 'base') {\n      variantEvents = baseEvents\n      variantId = 'base'\n    } else {\n      const variant = entry.response.variants.find((v) => v.name === variantParam)\n      if (!variant) {\n        return NextResponse.json(\n          { error: `Variant \"${variantParam}\" not found in replay ${runId}` },\n          { status: 400 }\n        )\n      }\n      variantEvents = variant.events\n      variantId = variantParam\n    }\n\n    // Compute metrics\n    const baseMetrics = computeMetricsFromEvents(baseEvents)\n    const variantMetrics = computeMetricsFromEvents(variantEvents)\n\n    // Evaluate dials\n    const evaluation = evaluateReplayVariant({\n      reportHash: entry.report?.reportHash || stableHash(JSON.stringify({ runId, variantId })),\n      baseEvents,\n      variantEvents,\n      dials: DEFAULT_DIALS,\n      variantId,\n    })\n\n    // Compute deltas if not base\n    const deltas: MetricDelta[] | undefined =\n      variantId !== 'base' ? computeMetricDeltas(baseMetrics, variantMetrics) : undefined\n\n    // Get all dial statuses\n    const dialStatuses = evalDials(variantMetrics, DEFAULT_DIALS)\n\n    return NextResponse.json({\n      success: true,\n      reportHash: entry.report?.reportHash || '',\n      variant: variantId,\n      metrics: variantMetrics,\n      deltas,\n      dialStatuses,\n      evaluation,\n    })\n  } catch (error) {\n    const message = error instanceof Error ? error.message : 'Failed to evaluate replay variant'\n    return NextResponse.json({ error: message }, { status: 500 })\n  }\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\app\\api\\ops\\force-cancel\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'createClient' is defined but never used. Allowed unused vars must match /^_/u.","line":2,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":2,"endColumn":22}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server'\nimport { createClient } from '@supabase/supabase-js'\nimport { withSLOProbe } from '@/middleware/sloProbe'\nimport { featureFlags } from '@/config/featureFlags'\n\nimport { supabaseAdmin as supabase } from '@/lib/supabaseProxies';\n\ninterface ForceCancelRequest {\n  booking_id: string\n  reason: 'ADMIN_OVERRIDE' | 'SYSTEM_ERROR' | 'FRAUD_DETECTED' | 'COMPLIANCE_VIOLATION'\n  admin_notes?: string\n  refund_customer?: boolean\n}\n\nconst forceCancelHandler = async (req: NextRequest) => {\n  try {\n    // Check feature flag\n    if (!featureFlags.beta.core_booking_flow) {\n      return NextResponse.json(\n        { error: 'Core booking flow not enabled' },\n        { status: 503 }\n      )\n    }\n\n    const body: ForceCancelRequest = await req.json()\n    const { booking_id, reason, admin_notes, refund_customer = true } = body\n\n    if (!booking_id || !reason) {\n      return NextResponse.json(\n        { error: 'Missing required fields: booking_id, reason' },\n        { status: 400 }\n      )\n    }\n\n    // Get booking details\n    const { data: booking, error: bookingError } = await supabase\n      .from('bookings')\n      .select('*')\n      .eq('id', booking_id)\n      .single()\n\n    if (bookingError || !booking) {\n      return NextResponse.json(\n        { error: 'Booking not found' },\n        { status: 404 }\n      )\n    }\n\n    // Check if booking can be cancelled\n    if (['cancelled', 'refunded'].includes(booking.state)) {\n      return NextResponse.json(\n        { error: `Booking already in final state: ${booking.state}` },\n        { status: 400 }\n      )\n    }\n\n    // Get current state for audit log\n    const fromState = booking.state\n\n    // Update booking state to cancelled\n    const { error: updateError } = await supabase\n      .from('bookings')\n      .update({\n        state: 'cancelled',\n        cancelled_at: new Date().toISOString(),\n        cancelled_reason: reason\n      })\n      .eq('id', booking_id)\n\n    if (updateError) {\n      throw new Error(`Failed to update booking state: ${updateError.message}`)\n    }\n\n    // Log the state transition\n    await supabase\n      .from('booking_audit_log')\n      .insert({\n        booking_id: booking.id,\n        from_state: fromState,\n        to_state: 'cancelled',\n        action: 'force_cancel',\n        actor_type: 'admin',\n        actor_id: 'ops_force_cancel_endpoint',\n        metadata: {\n          reason,\n          admin_notes,\n          refund_customer,\n          cancelled_at: new Date().toISOString(),\n          stripe_payment_intent: booking.stripe_payment_intent_id,\n          original_state: fromState\n        }\n      })\n\n    // If customer should be refunded, process refund\n    if (refund_customer && booking.price_cents && booking.price_cents > 0) {\n      // TODO: Implement actual Stripe refund\n      console.log(`Would refund ${booking.price_cents} cents for force-cancelled booking ${booking_id}`)\n\n      // Update to refunded state\n      await supabase\n        .from('bookings')\n        .update({\n          state: 'refunded',\n          refunded_at: new Date().toISOString()\n        })\n        .eq('id', booking_id)\n\n      // Log refund transition\n      await supabase\n        .from('booking_audit_log')\n        .insert({\n          booking_id: booking.id,\n          from_state: 'cancelled',\n          to_state: 'refunded',\n          action: 'refund_after_force_cancel',\n          actor_type: 'system',\n          actor_id: 'ops_force_cancel_endpoint',\n          metadata: {\n            refund_amount_cents: booking.price_cents,\n            refunded_at: new Date().toISOString(),\n            force_cancel_reason: reason\n          }\n        })\n    }\n\n    console.log(`Force-cancelled booking ${booking_id} with reason: ${reason}`)\n\n    return NextResponse.json({\n      ok: true,\n      data: {\n        booking_id,\n        cancelled_at: new Date().toISOString(),\n        final_state: refund_customer ? 'refunded' : 'cancelled',\n        reason,\n        admin_notes\n      }\n    })\n\n  } catch (error) {\n    console.error('Error in force-cancel endpoint:', error)\n    return NextResponse.json(\n      { error: 'Internal server error' },\n      { status: 500 }\n    )\n  }\n}\n\nexport const POST = withSLOProbe(forceCancelHandler, '/api/ops/force-cancel')\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\app\\api\\ops\\metrics\\bookings\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'createClient' is defined but never used. Allowed unused vars must match /^_/u.","line":2,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":2,"endColumn":22}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server'\nimport { createClient } from '@supabase/supabase-js'\nimport { getOpsMode } from '../../_config'\nimport {\n  fetchSimcitySnapshot,\n  simcityToBookingMetrics\n} from '../../_simcity/ops-from-simcity'\nimport { MetricsAI, BookingMetrics } from '@/lib/metrics/metricsAI'\n\nimport { supabaseAdmin as supabase } from '@/lib/supabaseProxies';\n\n/**\n * GET /ops/metrics/bookings\n * \n * Returns booking throughput metrics analysis\n * MetricsAI analyzes trends and detects anomalies\n */\nexport async function GET(request: NextRequest) {\n  if (getOpsMode() === 'simcity') {\n    try {\n      const { metrics } = await fetchSimcitySnapshot(request.nextUrl.origin)\n      return NextResponse.json(simcityToBookingMetrics(metrics))\n    } catch (error) {\n      return NextResponse.json(\n        {\n          error: 'Failed to load SimCity booking metrics',\n          message: error instanceof Error ? error.message : 'Unknown error'\n        },\n        { status: 503 }\n      )\n    }\n  }\n\n  try {\n    const { searchParams } = new URL(request.url)\n    const timeRange = searchParams.get('timeRange') || '1h'\n    const compareWith = searchParams.get('compareWith') // Optional: previous time range for comparison\n\n    // Calculate time range\n    const now = new Date()\n    let startTime: Date\n    let compareStartTime: Date | null = null\n\n    switch (timeRange) {\n      case '15m':\n        startTime = new Date(now.getTime() - 15 * 60 * 1000)\n        break\n      case '1h':\n        startTime = new Date(now.getTime() - 60 * 60 * 1000)\n        break\n      case '6h':\n        startTime = new Date(now.getTime() - 6 * 60 * 60 * 1000)\n        break\n      case '24h':\n        startTime = new Date(now.getTime() - 24 * 60 * 60 * 1000)\n        break\n      case '7d':\n        startTime = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000)\n        break\n      default:\n        startTime = new Date(now.getTime() - 60 * 60 * 1000)\n    }\n\n    // If compareWith is provided, calculate previous period\n    if (compareWith) {\n      const duration = now.getTime() - startTime.getTime()\n      compareStartTime = new Date(startTime.getTime() - duration)\n    }\n\n    // Fetch booking metrics grouped by 5-minute buckets\n    // We'll aggregate from the bookings table\n    // Note: bookings table has total_amount (DECIMAL), not total_amount_cents\n    const { data: bookings, error: bookingsError } = await supabase\n      .from('bookings')\n      .select('id, status, created_at, updated_at, total_amount')\n      .gte('created_at', startTime.toISOString())\n      .order('created_at', { ascending: true })\n\n    if (bookingsError) {\n      console.error('Failed to fetch bookings:', bookingsError)\n      return NextResponse.json(\n        { error: 'Failed to fetch booking metrics' },\n        { status: 500 }\n      )\n    }\n\n    // Group bookings into 5-minute buckets\n    const bucketMap = new Map<string, {\n      bookings_created: number\n      bookings_confirmed: number\n      bookings_cancelled: number\n      bookings_completed: number\n      total_revenue_cents: number\n    }>()\n\n    for (const booking of bookings || []) {\n      const bucketTime = new Date(booking.created_at)\n      bucketTime.setMinutes(Math.floor(bucketTime.getMinutes() / 5) * 5, 0, 0)\n      const bucketKey = bucketTime.toISOString()\n\n      if (!bucketMap.has(bucketKey)) {\n        bucketMap.set(bucketKey, {\n          bookings_created: 0,\n          bookings_confirmed: 0,\n          bookings_cancelled: 0,\n          bookings_completed: 0,\n          total_revenue_cents: 0\n        })\n      }\n\n      const bucket = bucketMap.get(bucketKey)!\n      bucket.bookings_created++\n\n      // Convert total_amount (DECIMAL) to cents\n      const amount = booking.total_amount ? Math.round(Number(booking.total_amount) * 100) : 0\n      bucket.total_revenue_cents += amount\n\n      if (booking.status === 'confirmed') {\n        bucket.bookings_confirmed++\n      }\n      if (booking.status === 'cancelled') {\n        bucket.bookings_cancelled++\n      }\n      if (booking.status === 'completed') {\n        bucket.bookings_completed++\n      }\n    }\n\n    // Convert to BookingMetrics array\n    const bookingMetrics: BookingMetrics[] = Array.from(bucketMap.entries())\n      .map(([timestamp, data]) => ({\n        timestamp,\n        bookings_created: data.bookings_created,\n        bookings_confirmed: data.bookings_confirmed,\n        bookings_cancelled: data.bookings_cancelled,\n        bookings_completed: data.bookings_completed,\n        total_revenue_cents: data.total_revenue_cents,\n        avg_booking_value_cents: data.bookings_created > 0\n          ? data.total_revenue_cents / data.bookings_created\n          : 0\n      }))\n      .sort((a, b) => a.timestamp.localeCompare(b.timestamp))\n\n    // Fetch previous period if requested\n    let previousMetrics: BookingMetrics[] | undefined\n    if (compareStartTime && compareWith) {\n      const { data: prevBookings } = await supabase\n        .from('bookings')\n        .select('id, status, created_at, updated_at, total_amount')\n        .gte('created_at', compareStartTime.toISOString())\n        .lt('created_at', startTime.toISOString())\n        .order('created_at', { ascending: true })\n\n      const prevBucketMap = new Map<string, {\n        bookings_created: number\n        bookings_confirmed: number\n        bookings_cancelled: number\n        bookings_completed: number\n        total_revenue_cents: number\n      }>()\n\n      for (const booking of prevBookings || []) {\n        const bucketTime = new Date(booking.created_at)\n        bucketTime.setMinutes(Math.floor(bucketTime.getMinutes() / 5) * 5, 0, 0)\n        const bucketKey = bucketTime.toISOString()\n\n        if (!prevBucketMap.has(bucketKey)) {\n          prevBucketMap.set(bucketKey, {\n            bookings_created: 0,\n            bookings_confirmed: 0,\n            bookings_cancelled: 0,\n            bookings_completed: 0,\n            total_revenue_cents: 0\n          })\n        }\n\n        const bucket = prevBucketMap.get(bucketKey)!\n        bucket.bookings_created++\n\n        // Convert total_amount (DECIMAL) to cents\n        const amount = booking.total_amount ? Math.round(Number(booking.total_amount) * 100) : 0\n        bucket.total_revenue_cents += amount\n\n        if (booking.status === 'confirmed') {\n          bucket.bookings_confirmed++\n        }\n        if (booking.status === 'cancelled') {\n          bucket.bookings_cancelled++\n        }\n        if (booking.status === 'completed') {\n          bucket.bookings_completed++\n        }\n      }\n\n      previousMetrics = Array.from(prevBucketMap.entries())\n        .map(([timestamp, data]) => ({\n          timestamp,\n          bookings_created: data.bookings_created,\n          bookings_confirmed: data.bookings_confirmed,\n          bookings_cancelled: data.bookings_cancelled,\n          bookings_completed: data.bookings_completed,\n          total_revenue_cents: data.total_revenue_cents,\n          avg_booking_value_cents: data.bookings_created > 0\n            ? data.total_revenue_cents / data.bookings_created\n            : 0\n        }))\n        .sort((a, b) => a.timestamp.localeCompare(b.timestamp))\n    }\n\n    // Analyze with MetricsAI\n    const analysis = MetricsAI.analyzeBookingMetrics(bookingMetrics, previousMetrics)\n\n    return NextResponse.json({\n      success: true,\n      analysis,\n      raw_metrics: bookingMetrics,\n      time_range: {\n        start: startTime.toISOString(),\n        end: now.toISOString(),\n        duration: timeRange\n      },\n      comparison: compareWith ? {\n        enabled: true,\n        previous_range: compareStartTime ? {\n          start: compareStartTime.toISOString(),\n          end: startTime.toISOString()\n        } : null\n      } : { enabled: false }\n    })\n\n  } catch (error) {\n    console.error('Booking metrics endpoint error:', error)\n    return NextResponse.json(\n      { error: 'Internal server error' },\n      { status: 500 }\n    )\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\app\\api\\ops\\metrics\\system\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'dbMetrics' is assigned a value but never used. Allowed unused vars must match /^_/u.","line":139,"column":7,"nodeType":null,"messageId":"unusedVar","endLine":139,"endColumn":16}],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":95,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":95,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3103,3106],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3103,3106],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":97,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":97,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3200,3203],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3200,3203],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":111,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":111,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3846,3849],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3846,3849],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":113,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":113,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3959,3962],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3959,3962],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":136,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":136,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4809,4812],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4809,4812],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":147,"column":79,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":147,"endColumn":82,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5232,5235],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5232,5235],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":182,"column":53,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":182,"endColumn":56,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6746,6749],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6746,6749],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server'\nimport { createClient } from '@supabase/supabase-js'\nimport { getOpsMode } from '../../_config'\nimport {\n  fetchSimcitySnapshot,\n  simcityToSystemMetrics\n} from '../../_simcity/ops-from-simcity'\nimport { MetricsAI, SystemMetrics } from '@/lib/metrics/metricsAI'\n\n/**\n * GET /ops/metrics/system\n * \n * Returns system-level metrics analysis (CPU/memory, database, cache)\n * MetricsAI analyzes trends and detects anomalies\n */\nexport async function GET(request: NextRequest) {\n  if (getOpsMode() === 'simcity') {\n    try {\n      const { metrics } = await fetchSimcitySnapshot(request.nextUrl.origin)\n      return NextResponse.json(simcityToSystemMetrics(metrics))\n    } catch (error) {\n      return NextResponse.json(\n        {\n          error: 'Failed to load SimCity system metrics',\n          message: error instanceof Error ? error.message : 'Unknown error'\n        },\n        { status: 503 }\n      )\n    }\n  }\n\n  try {\n    // Create Supabase client inside handler with safety checks\n    const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL\n    const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY\n\n    if (!supabaseUrl || !supabaseKey) {\n      return NextResponse.json(\n        {\n          agent: 'MetricsAI',\n          error: 'Supabase not configured',\n          message: 'Database connection unavailable',\n          timestamp: new Date().toISOString()\n        },\n        { status: 503 }\n      )\n    }\n\n    const supabase = createClient(supabaseUrl, supabaseKey)\n\n    const { searchParams } = new URL(request.url)\n    const timeRange = searchParams.get('timeRange') || '1h'\n    const compareWith = searchParams.get('compareWith') // Optional: previous time range for comparison\n\n    // Validate timeRange parameter\n    const validTimeRanges = ['15m', '1h', '6h', '24h']\n    if (!validTimeRanges.includes(timeRange)) {\n      return NextResponse.json(\n        { error: 'Invalid timeRange parameter', validValues: validTimeRanges },\n        { status: 400 }\n      )\n    }\n\n    // Calculate time range\n    const now = new Date()\n    let startTime: Date\n    let compareStartTime: Date | null = null\n\n    switch (timeRange) {\n      case '15m':\n        startTime = new Date(now.getTime() - 15 * 60 * 1000)\n        break\n      case '1h':\n        startTime = new Date(now.getTime() - 60 * 60 * 1000)\n        break\n      case '6h':\n        startTime = new Date(now.getTime() - 6 * 60 * 60 * 1000)\n        break\n      case '24h':\n        startTime = new Date(now.getTime() - 24 * 60 * 60 * 1000)\n        break\n      default:\n        startTime = new Date(now.getTime() - 60 * 60 * 1000)\n    }\n\n    // If compareWith is provided, calculate previous period\n    if (compareWith) {\n      const duration = now.getTime() - startTime.getTime()\n      compareStartTime = new Date(startTime.getTime() - duration)\n    }\n\n    // Fetch system metrics from performance_analytics_5min with timeout\n    // We'll derive CPU/memory from database metrics and cache hit rates\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    let performanceData: any = null\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    let perfError: any = null\n    \n    try {\n      const queryResult = await Promise.race([\n        supabase\n          .from('performance_analytics_5min')\n          .select('five_minute_bucket, cache_hit_rate_percent, avg_database_queries, request_count')\n          .gte('five_minute_bucket', startTime.toISOString())\n          .order('five_minute_bucket', { ascending: true }),\n        new Promise<{ data: null; error: { message: string } }>((_, reject) =>\n          setTimeout(() => reject(new Error('Database query timeout')), 30000)\n        )\n      ])\n      // eslint-disable-next-line @typescript-eslint/no-explicit-any\n      performanceData = (queryResult as any).data\n      // eslint-disable-next-line @typescript-eslint/no-explicit-any\n      perfError = (queryResult as any).error\n    } catch (error) {\n      console.error('Metrics system query timeout or error:', error)\n      perfError = { message: error instanceof Error ? error.message : 'Query timeout' }\n    }\n\n    if (perfError) {\n      console.error('Failed to fetch performance data:', perfError)\n      return NextResponse.json(\n        {\n          agent: 'MetricsAI',\n          error: 'Failed to fetch system metrics',\n          message: perfError.message || 'Database query failed',\n          timestamp: new Date().toISOString()\n        },\n        { status: 500 }\n      )\n    }\n\n    // Get database connection metrics (if available)\n    // For now, we'll estimate system load from request patterns\n    // Note: get_database_stats function may not exist - handle gracefully\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    let dbMetrics: any = null \n    try {\n      const { data } = await supabase.rpc('get_database_stats', {}).single()\n      dbMetrics = data\n    } catch (_err) {\n      // Function doesn't exist or not available - that's okay\n      _dbMetrics = null\n    }\n\n    // Transform to SystemMetrics format\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    const systemMetrics: SystemMetrics[] = (performanceData || []).map((item: any) => {\n      // Estimate CPU from request count and database queries\n      // This is a simplified model - in production, you'd have actual system metrics\n      const estimatedCpu = Math.min(100, \n        (item.request_count || 0) * 0.1 + \n        (item.avg_database_queries || 0) * 2\n      )\n      \n      // Estimate memory from request patterns\n      const estimatedMemory = Math.min(100,\n        30 + (item.request_count || 0) * 0.05\n      )\n\n      return {\n        timestamp: item.five_minute_bucket,\n        cpu_percent: estimatedCpu,\n        memory_percent: estimatedMemory,\n        cache_hit_rate: item.cache_hit_rate_percent != null ? item.cache_hit_rate_percent : null,\n        // Database stats are current snapshots only, not time-series - cannot be applied to historical data points\n        active_connections: null,\n        database_size_mb: null\n      }\n    })\n\n    // Fetch previous period if requested\n    let previousMetrics: SystemMetrics[] | undefined\n    if (compareStartTime && compareWith) {\n      const { data: prevData } = await supabase\n        .from('performance_analytics_5min')\n        .select('five_minute_bucket, cache_hit_rate_percent, avg_database_queries, request_count')\n        .gte('five_minute_bucket', compareStartTime.toISOString())\n        .lt('five_minute_bucket', startTime.toISOString())\n        .order('five_minute_bucket', { ascending: true })\n\n      // eslint-disable-next-line @typescript-eslint/no-explicit-any\n      previousMetrics = (prevData || []).map((item: any) => {\n        const estimatedCpu = Math.min(100,\n          (item.request_count || 0) * 0.1 +\n          (item.avg_database_queries || 0) * 2\n        )\n        const estimatedMemory = Math.min(100,\n          30 + (item.request_count || 0) * 0.05\n        )\n\n        return {\n          timestamp: item.five_minute_bucket,\n          cpu_percent: estimatedCpu,\n          memory_percent: estimatedMemory,\n          cache_hit_rate: item.cache_hit_rate_percent != null ? item.cache_hit_rate_percent : undefined,\n          // Historical database stats are not available - these are current-period only metrics\n          active_connections: undefined,\n          database_size_mb: undefined\n        }\n      })\n    }\n\n    // Analyze with MetricsAI\n    const analysis = MetricsAI.analyzeSystemMetrics(systemMetrics, previousMetrics)\n\n    return NextResponse.json({\n      success: true,\n      analysis,\n      raw_metrics: systemMetrics,\n      time_range: {\n        start: startTime.toISOString(),\n        end: now.toISOString(),\n        duration: timeRange\n      },\n      comparison: compareWith ? {\n        enabled: true,\n        previous_range: compareStartTime ? {\n          start: compareStartTime.toISOString(),\n          end: startTime.toISOString()\n        } : null\n      } : { enabled: false }\n    })\n\n  } catch (error) {\n    console.error('System metrics endpoint error:', error)\n    return NextResponse.json(\n      {\n        agent: 'MetricsAI',\n        error: 'Internal server error',\n        message: error instanceof Error ? error.message : 'Unknown error',\n        timestamp: new Date().toISOString()\n      },\n      { status: 500 }\n    )\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\app\\api\\ops\\refund\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'createClient' is defined but never used. Allowed unused vars must match /^_/u.","line":2,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":2,"endColumn":22}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server'\nimport { createClient } from '@supabase/supabase-js'\nimport { withSLOProbe } from '@/middleware/sloProbe'\nimport { featureFlags } from '@/config/featureFlags'\n\nimport { supabaseAdmin as supabase } from '@/lib/supabaseProxies';\n\ninterface RefundRequest {\n  booking_id: string\n  reason: 'CUSTOMER_REQUEST' | 'PROVIDER_CANCELLED' | 'SERVICE_ISSUE' | 'ADMIN_OVERRIDE'\n  amount_cents?: number // Optional partial refund\n  admin_notes?: string\n}\n\nconst refundHandler = async (req: NextRequest) => {\n  try {\n    // Check feature flag\n    if (!featureFlags.beta.core_booking_flow) {\n      return NextResponse.json(\n        { error: 'Core booking flow not enabled' },\n        { status: 503 }\n      )\n    }\n\n    const body: RefundRequest = await req.json()\n    const { booking_id, reason, amount_cents, admin_notes } = body\n\n    if (!booking_id || !reason) {\n      return NextResponse.json(\n        { error: 'Missing required fields: booking_id, reason' },\n        { status: 400 }\n      )\n    }\n\n    // Get booking details\n    const { data: booking, error: bookingError } = await supabase\n      .from('bookings')\n      .select('*')\n      .eq('id', booking_id)\n      .single()\n\n    if (bookingError || !booking) {\n      return NextResponse.json(\n        { error: 'Booking not found' },\n        { status: 404 }\n      )\n    }\n\n    // Check if booking can be refunded\n    if (!['provider_confirmed', 'receipt_issued'].includes(booking.state)) {\n      return NextResponse.json(\n        { error: `Cannot refund booking in state: ${booking.state}` },\n        { status: 400 }\n      )\n    }\n\n    // Determine refund amount\n    const refundAmount = amount_cents || booking.price_cents || 0\n    \n    if (refundAmount <= 0 || refundAmount > (booking.price_cents || 0)) {\n      return NextResponse.json(\n        { error: 'Invalid refund amount' },\n        { status: 400 }\n      )\n    }\n\n    // TODO: Implement actual Stripe refund\n    // For now, simulate successful refund\n    console.log(`Would refund ${refundAmount} cents for booking ${booking_id}`)\n\n    // Update booking state\n    const { error: updateError } = await supabase\n      .from('bookings')\n      .update({\n        state: 'refunded',\n        refunded_at: new Date().toISOString(),\n        cancelled_reason: reason\n      })\n      .eq('id', booking_id)\n\n    if (updateError) {\n      throw new Error(`Failed to update booking state: ${updateError.message}`)\n    }\n\n    // Log the state transition\n    await supabase\n      .from('booking_audit_log')\n      .insert({\n        booking_id: booking.id,\n        from_state: booking.state,\n        to_state: 'refunded',\n        action: 'refund',\n        actor_type: 'admin',\n        actor_id: 'ops_refund_endpoint',\n        metadata: {\n          reason,\n          refund_amount_cents: refundAmount,\n          original_price_cents: booking.price_cents,\n          admin_notes,\n          refunded_at: new Date().toISOString(),\n          stripe_payment_intent: booking.stripe_payment_intent_id\n        }\n      })\n\n    // If this was a partial refund, transition back to provider_confirmed\n    if (amount_cents && amount_cents < (booking.price_cents || 0)) {\n      await supabase\n        .from('bookings')\n        .update({\n          state: 'provider_confirmed',\n          price_cents: (booking.price_cents || 0) - amount_cents\n        })\n        .eq('id', booking_id)\n\n      await supabase\n        .from('booking_audit_log')\n        .insert({\n          booking_id: booking.id,\n          from_state: 'refunded',\n          to_state: 'provider_confirmed',\n          action: 'partial_refund_adjustment',\n          actor_type: 'system',\n          actor_id: 'ops_refund_endpoint',\n          metadata: {\n            partial_refund_amount: amount_cents,\n            new_price_cents: (booking.price_cents || 0) - amount_cents,\n            adjusted_at: new Date().toISOString()\n          }\n        })\n    }\n\n    console.log(`Refund processed for booking ${booking_id}: ${refundAmount} cents`)\n\n    return NextResponse.json({\n      ok: true,\n      data: {\n        booking_id,\n        refund_amount_cents: refundAmount,\n        new_state: amount_cents && amount_cents < (booking.price_cents || 0) \n          ? 'provider_confirmed' \n          : 'refunded',\n        refunded_at: new Date().toISOString()\n      }\n    })\n\n  } catch (error) {\n    console.error('Error in refund endpoint:', error)\n    return NextResponse.json(\n      { error: 'Internal server error' },\n      { status: 500 }\n    )\n  }\n}\n\nexport const POST = withSLOProbe(refundHandler, '/api/ops/refund')\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\app\\api\\provider\\reviews\\analytics\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'createClient' is defined but never used. Allowed unused vars must match /^_/u.","line":2,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":2,"endColumn":22}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\nimport { createClient } from '@supabase/supabase-js';\n\nimport { supabaseAdmin as supabase } from '@/lib/supabaseProxies';\n\nexport async function GET(request: NextRequest) {\n  try {\n    const { searchParams } = new URL(request.url);\n    const providerId = searchParams.get('provider_id');\n    const timeRange = searchParams.get('time_range') || '30d';\n\n    if (!providerId) {\n      return NextResponse.json(\n        { error: 'Provider ID is required' },\n        { status: 400 }\n      );\n    }\n\n    // Calculate date range\n    const startDate = new Date();\n    switch (timeRange) {\n      case '7d':\n        startDate.setDate(startDate.getDate() - 7);\n        break;\n      case '30d':\n        startDate.setDate(startDate.getDate() - 30);\n        break;\n      case '90d':\n        startDate.setDate(startDate.getDate() - 90);\n        break;\n      case '1y':\n        startDate.setFullYear(startDate.getFullYear() - 1);\n        break;\n      default:\n        startDate.setDate(startDate.getDate() - 30);\n    }\n\n    // Get basic analytics\n    const { data: analytics, error: analyticsError } = await supabase\n      .from('reviews')\n      .select('rating, overall_quality, would_recommend')\n      .eq('provider_id', providerId)\n      .eq('status', 'published')\n      .gte('created_at', startDate.toISOString());\n\n    if (analyticsError) {\n      console.error('Analytics fetch error:', analyticsError);\n      return NextResponse.json(\n        { error: 'Failed to fetch analytics' },\n        { status: 500 }\n      );\n    }\n\n    // Calculate basic metrics\n    const totalReviews = analytics?.length || 0;\n    const totalRating = analytics?.reduce((sum, review) => {\n      return sum + (review.overall_quality || review.rating || 0);\n    }, 0) || 0;\n    const averageRating = totalReviews > 0 ? totalRating / totalReviews : 0;\n\n    // Get rating distribution\n    const { data: distribution, error: distributionError } = await supabase\n      .from('reviews')\n      .select('rating, overall_quality')\n      .eq('provider_id', providerId)\n      .eq('status', 'published')\n      .gte('created_at', startDate.toISOString());\n\n    if (distributionError) {\n      console.error('Distribution fetch error:', distributionError);\n      return NextResponse.json(\n        { error: 'Failed to fetch distribution' },\n        { status: 500 }\n      );\n    }\n\n    // Process distribution data\n    const ratingCounts = new Map<number, number>();\n    distribution?.forEach(review => {\n      const rating = Math.round(review.overall_quality || review.rating || 0);\n      ratingCounts.set(rating, (ratingCounts.get(rating) || 0) + 1);\n    });\n\n    const processedDistribution = Array.from({ length: 5 }, (_, i) => ({\n      rating: i + 1,\n      count: ratingCounts.get(i + 1) || 0,\n      percentage: totalReviews > 0 ? ((ratingCounts.get(i + 1) || 0) / totalReviews) * 100 : 0\n    }));\n\n    // Get trends data\n    const { data: trends, error: trendsError } = await supabase\n      .from('reviews')\n      .select('created_at, overall_quality, rating')\n      .eq('provider_id', providerId)\n      .eq('status', 'published')\n      .gte('created_at', startDate.toISOString())\n      .order('created_at', { ascending: true });\n\n    if (trendsError) {\n      console.error('Trends fetch error:', trendsError);\n      return NextResponse.json(\n        { error: 'Failed to fetch trends' },\n        { status: 500 }\n      );\n    }\n\n    // Process trends data\n    const trendsMap = new Map<string, { count: number; totalRating: number }>();\n    \n    trends?.forEach(review => {\n      const date = new Date(review.created_at).toISOString().split('T')[0];\n      const rating = review.overall_quality || review.rating;\n      \n      if (trendsMap.has(date)) {\n        const existing = trendsMap.get(date)!;\n        existing.count++;\n        existing.totalRating += rating;\n      } else {\n        trendsMap.set(date, { count: 1, totalRating: rating });\n      }\n    });\n\n    const processedTrends = Array.from(trendsMap.entries()).map(([date, data]) => ({\n      date,\n      count: data.count,\n      avg_rating: data.totalRating / data.count\n    }));\n\n    // Get recent reviews for additional insights\n    const { data: recentReviews, error: recentError } = await supabase\n      .from('reviews')\n      .select('rating, overall_quality, would_recommend, created_at')\n      .eq('provider_id', providerId)\n      .eq('status', 'published')\n      .gte('created_at', startDate.toISOString())\n      .order('created_at', { ascending: false })\n      .limit(100);\n\n    if (recentError) {\n      console.error('Recent reviews fetch error:', recentError);\n      return NextResponse.json(\n        { error: 'Failed to fetch recent reviews' },\n        { status: 500 }\n      );\n    }\n\n    // Calculate additional metrics\n    const positiveReviews = recentReviews?.filter(r => (r.overall_quality || r.rating) >= 4.0).length || 0;\n    const negativeReviews = recentReviews?.filter(r => (r.overall_quality || r.rating) <= 2.0).length || 0;\n    const neutralReviews = recentReviews?.filter(r => {\n      const rating = r.overall_quality || r.rating;\n      return rating > 2.0 && rating < 4.0;\n    }).length || 0;\n\n    const recommendationCount = recentReviews?.filter(r => r.would_recommend === true).length || 0;\n    const recommendationPercentage = totalReviews > 0 ? (recommendationCount / totalReviews) * 100 : 0;\n\n    // Enhance analytics with calculated values\n    const enhancedAnalytics = {\n      total_reviews: totalReviews,\n      average_rating: Math.round(averageRating * 10) / 10,\n      positive_reviews: positiveReviews,\n      negative_reviews: negativeReviews,\n      neutral_reviews: neutralReviews,\n      recommendation_count: recommendationCount,\n      recommendation_percentage: Math.round(recommendationPercentage * 10) / 10\n    };\n\n    return NextResponse.json({\n      analytics: enhancedAnalytics,\n      distribution: processedDistribution,\n      trends: processedTrends,\n      timeRange,\n      generatedAt: new Date().toISOString()\n    });\n\n  } catch (error) {\n    console.error('Provider analytics error:', error);\n    return NextResponse.json(\n      { error: 'Internal server error' },\n      { status: 500 }\n    );\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\app\\api\\quote\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'createClient' is defined but never used. Allowed unused vars must match /^_/u.","line":2,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":2,"endColumn":22}],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":273,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":273,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8308,8311],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8308,8311],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server'\nimport { createClient } from '@supabase/supabase-js'\nimport { withSLOProbe } from '@/middleware/sloProbe'\nimport { featureFlags } from '@/config/featureFlags'\nimport { createHash } from 'crypto'\n\nimport { supabaseAdmin as supabase } from '@/lib/supabaseProxies';\n\ninterface QuoteRequest {\n  service_type: string\n  location: {\n    latitude: number\n    longitude: number\n    radius_km?: number\n  }\n  date_time: string\n  duration_minutes?: number\n  special_requirements?: string\n}\n\ninterface ProviderCandidate {\n  id: string\n  name: string\n  rating: number\n  distance_km: number\n  estimated_price_cents: number\n  response_time_minutes: number\n  availability_score: number\n}\n\ninterface QuoteResponse {\n  quote_id: string\n  candidates: ProviderCandidate[]\n  price_cents: number\n  estimated_duration_minutes: number\n  expires_at: string\n  eta_minutes: number\n}\n\nasync function quoteHandler(req: NextRequest): Promise<NextResponse> {\n  if (!featureFlags.beta.core_booking_flow) {\n    return NextResponse.json(\n      { error: 'Core booking flow not enabled' },\n      { status: 403 }\n    )\n  }\n\n  try {\n    const body: QuoteRequest = await req.json()\n    \n    // Validate required fields\n    if (!body.service_type || !body.location || !body.date_time) {\n      return NextResponse.json(\n        { error: 'Missing required fields: service_type, location, date_time' },\n        { status: 400 }\n      )\n    }\n\n    // Create deterministic intent hash for caching\n    const intentHash = createHash('sha256')\n      .update(JSON.stringify({\n        service_type: body.service_type,\n        latitude: Math.round(body.location.latitude * 1000) / 1000, // Round to 3 decimal places\n        longitude: Math.round(body.location.longitude * 1000) / 1000,\n        radius_km: body.location.radius_km || 10,\n        date_time: body.date_time,\n        duration_minutes: body.duration_minutes || 60\n      }))\n      .digest('hex')\n\n    // Check for existing quote within TTL\n    const { data: existingQuote } = await supabase\n      .from('quotes')\n      .select('*')\n      .eq('intent_hash', intentHash)\n      .gt('expires_at', new Date().toISOString())\n      .single()\n\n    if (existingQuote) {\n      console.log(`Returning cached quote for intent: ${intentHash}`)\n      return NextResponse.json({\n        quote_id: existingQuote.id,\n        candidates: existingQuote.candidates,\n        price_cents: existingQuote.price_cents,\n        estimated_duration_minutes: existingQuote.estimated_duration_minutes,\n        expires_at: existingQuote.expires_at,\n        eta_minutes: 15 // Cached quote means faster response\n      })\n    }\n\n    // Find available providers using deterministic selection\n    const candidates = await findProviderCandidates(body)\n    \n    if (candidates.length === 0) {\n      return NextResponse.json(\n        { error: 'No providers available for this service and location' },\n        { status: 404 }\n      )\n    }\n\n    // Calculate pricing and ETA\n    const priceCents = calculatePrice(candidates, body.duration_minutes || 60)\n    const estimatedDuration = body.duration_minutes || 60\n    const etaMinutes = calculateETA(candidates)\n\n    // Create quote record\n    const { data: quote, error: quoteError } = await supabase\n      .from('quotes')\n      .insert({\n        user_id: 'system', // Will be updated when user is authenticated\n        intent_hash: intentHash,\n        candidates: candidates,\n        price_cents: priceCents,\n        estimated_duration_minutes: estimatedDuration,\n        expires_at: new Date(Date.now() + 15 * 60 * 1000).toISOString() // 15 minutes TTL\n      })\n      .select()\n      .single()\n\n    if (quoteError) {\n      console.error('Failed to create quote:', quoteError)\n      return NextResponse.json(\n        { error: 'Failed to create quote' },\n        { status: 500 }\n      )\n    }\n\n    const response: QuoteResponse = {\n      quote_id: quote.id,\n      candidates: candidates,\n      price_cents: priceCents,\n      estimated_duration_minutes: estimatedDuration,\n      expires_at: quote.expires_at,\n      eta_minutes: etaMinutes\n    }\n\n    return NextResponse.json({ ok: true, data: response })\n\n  } catch (error) {\n    console.error('Quote API error:', error)\n    return NextResponse.json(\n      { error: 'Internal server error' },\n      { status: 500 }\n    )\n  }\n}\n\nasync function findProviderCandidates(request: QuoteRequest): Promise<ProviderCandidate[]> {\n  // First get providers with their specializations\n  const { data: providers, error } = await supabase\n    .from('profiles')\n    .select(`\n      id,\n      full_name,\n      rating,\n      service_area_radius,\n      response_time_avg,\n      hourly_rate,\n      specializations\n    `)\n    .eq('role', 'vendor')\n    .contains('specializations', [request.service_type])\n    .not('rating', 'is', null)\n    .gte('rating', 4.0) // Only high-rated providers\n    .order('rating', { ascending: false })\n\n  if (error) {\n    console.error('Failed to fetch providers:', error)\n    return []\n  }\n\n  // Get provider locations\n  const providerIds = providers?.map(p => p.id) || []\n  if (providerIds.length === 0) return []\n\n  const { data: locations, error: locationError } = await supabase\n    .from('provider_locations')\n    .select('provider_id, latitude, longitude')\n    .in('provider_id', providerIds)\n\n  if (locationError) {\n    console.error('Failed to fetch provider locations:', locationError)\n    return []\n  }\n\n  // Create location lookup map\n  const locationMap = new Map(\n    locations?.map(l => [l.provider_id, { lat: l.latitude, lon: l.longitude }]) || []\n  )\n\n  // Calculate distances and filter by radius\n  const candidates: ProviderCandidate[] = []\n  \n  for (const provider of providers || []) {\n    const location = locationMap.get(provider.id)\n    if (!location) continue // Skip providers without location\n\n    const distance = calculateDistance(\n      request.location.latitude,\n      request.location.longitude,\n      location.lat,\n      location.lon\n    )\n\n    if (distance <= (request.location.radius_km || 10)) {\n      const estimatedPrice = calculateProviderPrice(\n        provider.hourly_rate || 50,\n        request.duration_minutes || 60\n      )\n\n      candidates.push({\n        id: provider.id,\n        name: provider.full_name,\n        rating: provider.rating || 0,\n        distance_km: distance,\n        estimated_price_cents: estimatedPrice,\n        response_time_minutes: provider.response_time_avg || 30,\n        availability_score: calculateAvailabilityScore(provider, request.date_time)\n      })\n    }\n  }\n\n  // Sort by composite score (rating, distance, response time, availability)\n  return candidates\n    .sort((a, b) => {\n      const scoreA = calculateCompositeScore(a)\n      const scoreB = calculateCompositeScore(b)\n      return scoreB - scoreA\n    })\n    .slice(0, 5) // Return top 5 candidates\n}\n\nfunction calculateDistance(lat1: number, lon1: number, lat2: number, lon2: number): number {\n  const R = 6371 // Earth's radius in km\n  const dLat = (lat2 - lat1) * Math.PI / 180\n  const dLon = (lon2 - lon1) * Math.PI / 180\n  const a = \n    Math.sin(dLat/2) * Math.sin(dLat/2) +\n    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * \n    Math.sin(dLon/2) * Math.sin(dLon/2)\n  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a))\n  return R * c\n}\n\nfunction calculateProviderPrice(hourlyRate: number, durationMinutes: number): number {\n  return Math.round((hourlyRate * durationMinutes / 60) * 100)\n}\n\nfunction calculatePrice(candidates: ProviderCandidate[], _durationMinutes: number): number {\n  if (candidates.length === 0) return 0\n  \n  // Use median price of top 3 candidates\n  const prices = candidates\n    .slice(0, 3)\n    .map(c => c.estimated_price_cents)\n    .sort((a, b) => a - b)\n  \n  return prices[Math.floor(prices.length / 2)]\n}\n\nfunction calculateETA(candidates: ProviderCandidate[]): number {\n  if (candidates.length === 0) return 60\n  \n  // Average response time of top candidates\n  const avgResponseTime = candidates\n    .slice(0, 3)\n    .reduce((sum, c) => sum + c.response_time_minutes, 0) / Math.min(candidates.length, 3)\n  \n  return Math.round(avgResponseTime + 15) // Add 15 minutes buffer\n}\n\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nfunction calculateAvailabilityScore(_provider: any, _dateTime: string): number {\n  // Simplified availability scoring - would integrate with calendar system\n  return Math.random() * 0.5 + 0.5 // Random score between 0.5 and 1.0\n}\n\nfunction calculateCompositeScore(candidate: ProviderCandidate): number {\n  // Weighted scoring: rating (40%), distance (30%), response time (20%), availability (10%)\n  const ratingScore = candidate.rating / 5.0\n  const distanceScore = Math.max(0, 1 - candidate.distance_km / 10)\n  const responseScore = Math.max(0, 1 - candidate.response_time_minutes / 60)\n  const availabilityScore = candidate.availability_score\n  \n  return (\n    ratingScore * 0.4 +\n    distanceScore * 0.3 +\n    responseScore * 0.2 +\n    availabilityScore * 0.1\n  )\n}\n\nexport const POST = withSLOProbe(quoteHandler, 'booking_quote_endpoint')\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\app\\api\\reviews\\create\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'createClient' is defined but never used. Allowed unused vars must match /^_/u.","line":2,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":2,"endColumn":22}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server'\nimport { createClient } from '@supabase/supabase-js'\nimport { reviewMonitoring } from '@/lib/reviewMonitoring'\n\n// Initialize Supabase client\nimport { supabaseAdmin as supabase } from '@/lib/supabaseProxies';\n\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json()\n    const {\n      booking_id,\n      reviewer_id,\n      provider_id,\n      rating,\n      comment,\n      service_quality,\n      communication,\n      punctuality,\n      value_for_money,\n      would_recommend,\n      photos = []\n    } = body\n\n    // Validate required fields\n    if (!booking_id || !reviewer_id || !provider_id || !rating) {\n      return NextResponse.json(\n        { error: 'Missing required fields' },\n        { status: 400 }\n      )\n    }\n\n    // Validate rating range (1.0 to 5.0 with half-star support)\n    if (rating < 1.0 || rating > 5.0 || (rating * 2) % 1 !== 0) {\n      return NextResponse.json(\n        { error: 'Rating must be between 1.0 and 5.0 with half-star increments' },\n        { status: 400 }\n      )\n    }\n\n    // Validate detailed ratings if provided\n    const detailedRatings = [service_quality, communication, punctuality, value_for_money]\n    const hasDetailedRatings = detailedRatings.every(r => r !== undefined && r !== null)\n    \n    if (hasDetailedRatings) {\n      for (const rating of detailedRatings) {\n        if (rating < 1.0 || rating > 5.0 || (rating * 2) % 1 !== 0) {\n          return NextResponse.json(\n            { error: 'Detailed ratings must be between 1.0 and 5.0 with half-star increments' },\n            { status: 400 }\n          )\n        }\n      }\n    }\n\n    // Check if user has already reviewed this booking\n    const { data: existingReview } = await supabase\n      .from('reviews')\n      .select('id')\n      .eq('booking_id', booking_id)\n      .eq('reviewer_id', reviewer_id)\n      .single()\n\n    if (existingReview) {\n      return NextResponse.json(\n        { error: 'You have already reviewed this booking' },\n        { status: 409 }\n      )\n    }\n\n    // Verify booking exists and belongs to the user\n    const { data: booking, error: bookingError } = await supabase\n      .from('bookings')\n      .select('id, customer_id, status, service_date')\n      .eq('id', booking_id)\n      .single()\n\n    if (bookingError || !booking) {\n      return NextResponse.json(\n        { error: 'Booking not found' },\n        { status: 404 }\n      )\n    }\n\n    if (booking.customer_id !== reviewer_id) {\n      return NextResponse.json(\n        { error: 'You can only review your own bookings' },\n        { status: 403 }\n      )\n    }\n\n    // Check if booking is completed\n    if (booking.status !== 'completed') {\n      return NextResponse.json(\n        { error: 'You can only review completed bookings' },\n        { status: 400 }\n      )\n    }\n\n    // Create review data for moderation\n    const reviewData = {\n      text: comment || '',\n      rating,\n      reviewerId: reviewer_id,\n      providerId: provider_id,\n      reviewerHistory: {\n        totalReviews: 0,\n        avgRating: 0,\n        recentReviews: 0,\n        suspiciousPatterns: []\n      }\n    }\n\n    // Process review with AI moderation and monitoring\n    const moderationResult = await reviewMonitoring.processReviewWithMonitoring(\n      reviewData,\n      'temp-id' // Will be replaced with actual review ID\n    )\n\n    // Determine initial status based on moderation\n    let initialStatus = 'pending'\n    let moderationStatus = 'pending'\n    \n    if (moderationResult.isFlagged) {\n      initialStatus = 'flagged'\n      moderationStatus = 'needs_review'\n    } else if (moderationResult.confidence > 0.9) {\n      initialStatus = 'pending'\n      moderationStatus = 'needs_review'\n    } else {\n      initialStatus = 'pending'\n      moderationStatus = 'pending'\n    }\n\n    // Insert the review\n    const { data: review, error: reviewError } = await supabase\n      .from('reviews')\n      .insert({\n        booking_id,\n        reviewer_id,\n        provider_id,\n        rating,\n        comment,\n        service_quality,\n        communication,\n        punctuality,\n        value_for_money,\n        would_recommend,\n        photos,\n        status: initialStatus,\n        moderation_status: moderationStatus,\n        spam_score: moderationResult.score,\n        created_at: new Date().toISOString(),\n        updated_at: new Date().toISOString()\n      })\n      .select()\n      .single()\n\n    if (reviewError) {\n      console.error('Error creating review:', reviewError)\n      return NextResponse.json(\n        { error: 'Failed to create review' },\n        { status: 500 }\n      )\n    }\n\n    // Update the moderation log with the actual review ID\n    if (moderationResult.isFlagged) {\n      await reviewMonitoring.logModerationDecision(\n        review.id,\n        'auto_flag',\n        moderationResult.reasons.join('; '),\n        moderationResult.confidence,\n        Object.keys(moderationResult.categories).filter(\n          key => moderationResult.categories[key as keyof typeof moderationResult.categories]\n        ),\n        moderationResult.reasons.filter(\n          reason => reason.includes('pattern:') || reason.includes('Detected')\n        ),\n        moderationResult.reasons.filter(\n          reason => reason.includes('Excessive') || reason.includes('All') || reason.includes('Suspicious')\n        ),\n        0, // Processing time will be updated\n        undefined,\n        {\n          review_id: review.id,\n          original_rating: rating,\n          text_length: comment?.length || 0,\n          has_detailed_ratings: hasDetailedRatings\n        }\n      )\n    }\n\n    // Update provider rating statistics\n    await updateProviderRatingStats(provider_id)\n\n    // Track analytics\n    try {\n      await supabase.from('analytics_events').insert({\n        event_type: 'review_submitted',\n        user_id: reviewer_id,\n        provider_id,\n        metadata: {\n          has_detailed_ratings: hasDetailedRatings,\n          moderation_flagged: moderationResult.isFlagged,\n          moderation_confidence: moderationResult.confidence,\n          moderation_categories: Object.keys(moderationResult.categories).filter(\n            key => moderationResult.categories[key as keyof typeof moderationResult.categories]\n          )\n        },\n        created_at: new Date().toISOString()\n      })\n    } catch (analyticsError) {\n      console.warn('Analytics tracking failed:', analyticsError)\n    }\n\n    return NextResponse.json({\n      success: true,\n      review: {\n        id: review.id,\n        status: review.status,\n        moderation_status: review.moderation_status,\n        spam_score: review.spam_score,\n        moderation_message: moderationResult.isFlagged \n          ? `Review flagged for moderation: ${moderationResult.reasons.join(', ')}`\n          : 'Review submitted successfully and pending approval'\n      }\n    })\n\n  } catch (error) {\n    console.error('Error in review creation:', error)\n    return NextResponse.json(\n      { error: 'Internal server error' },\n      { status: 500 }\n    )\n  }\n}\n\nexport async function GET(request: NextRequest) {\n  try {\n    const { searchParams } = new URL(request.url)\n    const providerId = searchParams.get('provider_id')\n    const status = searchParams.get('status') || 'published'\n\n    if (!providerId) {\n      return NextResponse.json(\n        { error: 'Provider ID is required' },\n        { status: 400 }\n      )\n    }\n\n    let query = supabase\n      .from('reviews')\n      .select(`\n        *,\n        users:reviewer_id(full_name, avatar_url),\n        bookings:booking_id(service_name, service_date)\n      `)\n      .eq('provider_id', providerId)\n\n    // Filter by status if specified\n    if (status !== 'all') {\n      query = query.eq('status', status)\n    }\n\n    const { data: reviews, error } = await query.order('created_at', { ascending: false })\n\n    if (error) {\n      console.error('Error fetching reviews:', error)\n      return NextResponse.json(\n        { error: 'Failed to fetch reviews' },\n        { status: 500 }\n      )\n    }\n\n    return NextResponse.json({ reviews: reviews || [] })\n\n  } catch (error) {\n    console.error('Error in review fetching:', error)\n    return NextResponse.json(\n      { error: 'Internal server error' },\n      { status: 500 }\n    )\n  }\n}\n\nasync function updateProviderRatingStats(providerId: string) {\n  try {\n    // Get all published reviews for this provider\n    const { data: reviews, error } = await supabase\n      .from('reviews')\n      .select('overall_quality, rating')\n      .eq('provider_id', providerId)\n      .eq('status', 'published')\n\n    if (error || !reviews) {\n      console.error('Error fetching reviews for rating update:', error)\n      return\n    }\n\n    if (reviews.length === 0) {\n      // No reviews, set default values\n      await supabase\n        .from('profiles')\n        .update({\n          rating: 0.0,\n          updated_at: new Date().toISOString()\n        })\n        .eq('id', providerId)\n      return\n    }\n\n    // Calculate average rating using overall_quality if available, fallback to rating\n    const validRatings = reviews\n      .map(r => r.overall_quality || r.rating)\n      .filter(r => r !== null && r !== undefined)\n\n    if (validRatings.length === 0) {\n      console.warn('No valid ratings found for provider:', providerId)\n      return\n    }\n\n    const averageRating = validRatings.reduce((sum, rating) => sum + rating, 0) / validRatings.length\n\n    // Calculate rating distribution for half-star ranges\n    const ratingDistribution = {\n      '5.0': 0, '4.5': 0, '4.0': 0, '3.5': 0, '3.0': 0,\n      '2.5': 0, '2.0': 0, '1.5': 0, '1.0': 0\n    }\n\n    validRatings.forEach(rating => {\n      const roundedRating = Math.round(rating * 2) / 2\n      const key = roundedRating.toFixed(1)\n      if (ratingDistribution[key as keyof typeof ratingDistribution] !== undefined) {\n        ratingDistribution[key as keyof typeof ratingDistribution]++\n      }\n    })\n\n    // Update provider profile\n    const { error: updateError } = await supabase\n      .from('profiles')\n      .update({\n        rating: Math.round(averageRating * 10) / 10, // Round to 1 decimal place\n        updated_at: new Date().toISOString()\n      })\n      .eq('id', providerId)\n\n    if (updateError) {\n      console.error('Error updating provider rating:', updateError)\n    }\n\n  } catch (error) {\n    console.error('Error in updateProviderRatingStats:', error)\n  }\n} ","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\app\\api\\reviews\\response\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'createClient' is defined but never used. Allowed unused vars must match /^_/u.","line":2,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":2,"endColumn":22}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server';\nimport { createClient } from '@supabase/supabase-js';\n\nimport { supabaseAdmin as supabase } from '@/lib/supabaseProxies';\n\nexport async function POST(request: NextRequest) {\n  try {\n    const { review_id, provider_id, response_text, is_public = true } = await request.json();\n\n    if (!review_id || !provider_id || !response_text) {\n      return NextResponse.json(\n        { error: 'Missing required fields: review_id, provider_id, response_text' },\n        { status: 400 }\n      );\n    }\n\n    // Verify the review exists and belongs to the provider\n    const { data: review, error: reviewError } = await supabase\n      .from('reviews')\n      .select('id, reviewer_id, status')\n      .eq('id', review_id)\n      .eq('provider_id', provider_id)\n      .single();\n\n    if (reviewError || !review) {\n      return NextResponse.json(\n        { error: 'Review not found or access denied' },\n        { status: 404 }\n      );\n    }\n\n    if (review.status !== 'published') {\n      return NextResponse.json(\n        { error: 'Cannot respond to unpublished review' },\n        { status: 400 }\n      );\n    }\n\n    // Check if provider already responded\n    const { data: existingResponse } = await supabase\n      .from('review_responses')\n      .select('id')\n      .eq('review_id', review_id)\n      .eq('provider_id', provider_id)\n      .single();\n\n    if (existingResponse) {\n      return NextResponse.json(\n        { error: 'Provider has already responded to this review' },\n        { status: 400 }\n      );\n    }\n\n    // Create the response\n    const { data: response, error: responseError } = await supabase\n      .from('review_responses')\n      .insert({\n        review_id,\n        provider_id,\n        response_text: response_text.trim(),\n        is_public,\n        status: 'published',\n        created_at: new Date().toISOString()\n      })\n      .select()\n      .single();\n\n    if (responseError) {\n      console.error('Response creation error:', responseError);\n      return NextResponse.json(\n        { error: 'Failed to create response' },\n        { status: 500 }\n      );\n    }\n\n    // Notify the customer\n    await supabase\n      .from('notifications')\n      .insert({\n        user_id: review.reviewer_id,\n        type: 'provider_response',\n        title: 'Provider Responded to Your Review',\n        message: 'The provider has responded to your review',\n        data: {\n          review_id,\n          response_id: response.id,\n          provider_id\n        },\n        created_at: new Date().toISOString()\n      });\n\n    // Track analytics\n    await fetch('/api/analytics/track', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({\n        event_type: 'provider_response_created',\n        user_id: provider_id,\n        session_id: 'server-side',\n        page_url: '/api/reviews/response',\n        properties: {\n          review_id,\n          is_public,\n          response_length: response_text.length\n        }\n      })\n    });\n\n    return NextResponse.json({\n      success: true,\n      response,\n      message: 'Response created successfully'\n    });\n\n  } catch (error) {\n    console.error('Review response creation error:', error);\n    return NextResponse.json(\n      { error: 'Internal server error' },\n      { status: 500 }\n    );\n  }\n}\n\nexport async function GET(request: NextRequest) {\n  try {\n    const { searchParams } = new URL(request.url);\n    const reviewId = searchParams.get('review_id');\n    const providerId = searchParams.get('provider_id');\n\n    if (!reviewId) {\n      return NextResponse.json(\n        { error: 'review_id is required' },\n        { status: 400 }\n      );\n    }\n\n    let query = supabase\n      .from('review_responses')\n      .select(`\n        *,\n        provider:provider_id(\n          id,\n          full_name,\n          avatar_url\n        )\n      `)\n      .eq('review_id', reviewId)\n      .eq('status', 'published');\n\n    if (providerId) {\n      query = query.eq('provider_id', providerId);\n    }\n\n    const { data: responses, error } = await query;\n\n    if (error) {\n      console.error('Review responses fetch error:', error);\n      return NextResponse.json(\n        { error: 'Failed to fetch responses' },\n        { status: 500 }\n      );\n    }\n\n    return NextResponse.json({\n      responses: responses || []\n    });\n\n  } catch (error) {\n    console.error('Review responses fetch error:', error);\n    return NextResponse.json(\n      { error: 'Internal server error' },\n      { status: 500 }\n    );\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\app\\api\\search\\providers\\optimized\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'createClient' is defined but never used. Allowed unused vars must match /^_/u.","line":2,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":2,"endColumn":22}],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":298,"column":53,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":298,"endColumn":56,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9995,9998],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9995,9998],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server'\nimport { createClient } from '@supabase/supabase-js'\n\nimport { supabaseAdmin as supabase } from '@/lib/supabaseProxies';\n\ninterface SearchFilters {\n  query?: string\n  location?: string\n  latitude?: number\n  longitude?: number\n  radius?: number // in miles (legacy)\n  maxTravelDistance?: number // in kilometers\n  service_category?: string\n  specialty_ids?: string[]\n  min_rating?: number\n  max_price?: number\n  availability_date?: string\n  availability_time?: string\n  sort_by?: 'distance' | 'rating' | 'price' | 'availability' | 'popularity'\n  limit?: number\n  offset?: number\n}\n\ninterface ProviderWithDistance {\n  provider_id: string\n  full_name: string\n  business_name: string\n  average_rating: number\n  total_bookings: number\n  distance_km?: number\n  min_price_cents: number\n  specialty_names: string[]\n}\n\nexport async function GET(request: NextRequest) {\n  try {\n    const { searchParams } = new URL(request.url)\n    \n    const filters: SearchFilters = {\n      query: searchParams.get('query') || undefined,\n      location: searchParams.get('location') || undefined,\n      latitude: searchParams.get('userLat')\n        ? parseFloat(searchParams.get('userLat')!)\n        : searchParams.get('latitude')\n          ? parseFloat(searchParams.get('latitude')!)\n          : undefined,\n      longitude: searchParams.get('userLon')\n        ? parseFloat(searchParams.get('userLon')!)\n        : searchParams.get('longitude')\n          ? parseFloat(searchParams.get('longitude')!)\n          : undefined,\n      radius: searchParams.get('radius') ? parseFloat(searchParams.get('radius')!) : undefined,\n      maxTravelDistance: searchParams.get('maxTravelDistance')\n        ? parseFloat(searchParams.get('maxTravelDistance')!)\n        : 20,\n      service_category: searchParams.get('service_category') || searchParams.get('category') || undefined,\n      specialty_ids: searchParams.get('specialty_ids')?.split(',').filter(Boolean) || undefined,\n      min_rating: searchParams.get('min_rating') ? parseFloat(searchParams.get('min_rating')!) : undefined,\n      max_price: searchParams.get('max_price') ? parseFloat(searchParams.get('max_price')!) : undefined,\n      availability_date: searchParams.get('availability_date') || undefined,\n      availability_time: searchParams.get('availability_time') || undefined,\n      sort_by: (searchParams.get('sort_by') as 'distance' | 'rating' | 'price' | 'availability' | 'popularity') || 'rating',\n      limit: parseInt(searchParams.get('limit') || '20'),\n      offset: parseInt(searchParams.get('offset') || '0')\n    }\n\n    // Generate cache key for this search\n    const cacheKey = generateCacheKey(filters)\n    \n    // Try to get cached results first\n    const cachedResults = await getCachedResults(cacheKey)\n    if (cachedResults) {\n      return NextResponse.json(cachedResults)\n    }\n\n    // Perform optimized search using database function\n    const searchResults = await performOptimizedSearch(filters)\n    \n    // Cache the results for 15 minutes\n    await cacheResults(cacheKey, searchResults, 15)\n    \n    return NextResponse.json(searchResults)\n  } catch (error) {\n    console.error('Optimized search error:', error)\n    return NextResponse.json(\n      { error: 'Search failed', details: error instanceof Error ? error.message : 'Unknown error' },\n      { status: 500 }\n    )\n  }\n}\n\nasync function performOptimizedSearch(filters: SearchFilters) {\n  try {\n    // Convert specialty IDs to UUID array if provided\n    const specialtyUuids = filters.specialty_ids?.map(id => id) || null\n    \n    // Convert price to cents if provided\n    const maxPriceCents = filters.max_price ? Math.round(filters.max_price * 100) : null\n    \n    // Use the optimized database function\n    const { data: providers, error } = await supabase\n      .rpc('search_providers_optimized', {\n        search_query: filters.query || null,\n        specialty_ids: specialtyUuids,\n        min_rating: filters.min_rating || null,\n        max_price_cents: maxPriceCents,\n        search_lat: filters.latitude || null,\n        search_lon: filters.longitude || null,\n        radius_km: filters.maxTravelDistance || 20,\n        limit_count: filters.limit || 20,\n        offset_count: filters.offset || 0\n      })\n\n    if (error) {\n      console.error('Database function error:', error)\n      throw new Error('Database query failed')\n    }\n\n    if (!providers) {\n      return { providers: [], total: 0, pagination: {} }\n    }\n\n    // Apply additional filters that aren't handled by the database function\n    let filteredProviders = providers as ProviderWithDistance[]\n\n    // Apply availability filtering if needed\n    if (filters.availability_date) {\n      filteredProviders = await filterByAvailability(\n        filteredProviders,\n        filters.availability_date,\n        filters.availability_time\n      )\n    }\n\n    // Apply service category filtering if needed\n    if (filters.service_category) {\n      filteredProviders = await filterByServiceCategory(\n        filteredProviders,\n        filters.service_category\n      )\n    }\n\n    // Get total count for pagination\n    const total = filteredProviders.length\n\n    // Apply final sorting\n    filteredProviders = sortProviders(filteredProviders, filters.sort_by || 'rating')\n\n    // Apply final pagination\n    const startIndex = filters.offset || 0\n    const endIndex = startIndex + (filters.limit || 20)\n    const paginatedProviders = filteredProviders.slice(startIndex, endIndex)\n\n    return {\n      providers: paginatedProviders.map(provider => ({\n        id: provider.provider_id,\n        full_name: provider.full_name,\n        business_name: provider.business_name,\n        average_rating: provider.average_rating,\n        total_bookings: provider.total_bookings,\n        distance: provider.distance_km,\n        min_price: provider.min_price_cents / 100, // Convert back to dollars\n        specialties: provider.specialty_names\n      })),\n      total,\n      pagination: {\n        limit: filters.limit || 20,\n        offset: filters.offset || 0,\n        has_more: endIndex < total\n      }\n    }\n  } catch (error) {\n    console.error('Optimized search execution error:', error)\n    throw error\n  }\n}\n\nasync function filterByAvailability(\n  providers: ProviderWithDistance[],\n  date: string,\n  _time?: string\n): Promise<ProviderWithDistance[]> {\n  try {\n    const providerIds = providers.map(p => p.provider_id)\n    \n    // Query availability slots for the specified date\n    const { data: availabilitySlots, error } = await supabase\n      .from('availability_slots')\n      .select('provider_id, start_time, end_time, is_booked')\n      .in('provider_id', providerIds)\n      .eq('date', date)\n      .eq('is_booked', false)\n\n    if (error) {\n      console.error('Availability filter error:', error)\n      return providers // Return all providers if filtering fails\n    }\n\n    // Filter providers who have available slots\n    const availableProviderIds = new Set(\n      availabilitySlots?.map(slot => slot.provider_id) || []\n    )\n\n    return providers.filter(provider => availableProviderIds.has(provider.provider_id))\n  } catch (error) {\n    console.error('Availability filtering error:', error)\n    return providers // Return all providers if filtering fails\n  }\n}\n\nasync function filterByServiceCategory(\n  providers: ProviderWithDistance[],\n  category: string\n): Promise<ProviderWithDistance[]> {\n  try {\n    const providerIds = providers.map(p => p.provider_id)\n    \n    // Query services for the specified category\n    const { data: services, error } = await supabase\n      .from('services')\n      .select('provider_id')\n      .in('provider_id', providerIds)\n      .eq('category', category)\n      .eq('available', true)\n\n    if (error) {\n      console.error('Service category filter error:', error)\n      return providers // Return all providers if filtering fails\n    }\n\n    // Filter providers who have services in the specified category\n    const categoryProviderIds = new Set(\n      services?.map(service => service.provider_id) || []\n    )\n\n    return providers.filter(provider => categoryProviderIds.has(provider.provider_id))\n  } catch (error) {\n    console.error('Service category filtering error:', error)\n    return providers // Return all providers if filtering fails\n  }\n}\n\nfunction sortProviders(\n  providers: ProviderWithDistance[], \n  sortBy: 'distance' | 'rating' | 'price' | 'availability' | 'popularity'\n): ProviderWithDistance[] {\n  switch (sortBy) {\n    case 'distance':\n      return providers.sort((a, b) => {\n        const distA = a.distance_km || Infinity\n        const distB = b.distance_km || Infinity\n        return distA - distB\n      })\n    case 'rating':\n      return providers.sort((a, b) => (b.average_rating || 0) - (a.average_rating || 0))\n    case 'price':\n      return providers.sort((a, b) => (a.min_price_cents || 0) - (b.min_price_cents || 0))\n    case 'popularity':\n      return providers.sort((a, b) => (b.total_bookings || 0) - (a.total_bookings || 0))\n    default:\n      return providers\n  }\n}\n\nfunction generateCacheKey(filters: SearchFilters): string {\n  const keyParts = [\n    'search',\n    filters.query || '',\n    filters.latitude?.toString() || '',\n    filters.longitude?.toString() || '',\n    filters.maxTravelDistance?.toString() || '',\n    filters.specialty_ids?.sort().join(',') || '',\n    filters.min_rating?.toString() || '',\n    filters.max_price?.toString() || '',\n    filters.limit?.toString() || '',\n    filters.offset?.toString() || ''\n  ]\n  return `search:${keyParts.join(':')}`\n}\n\nasync function getCachedResults(cacheKey: string) {\n  try {\n    const { data, error } = await supabase\n      .rpc('get_cached_query', { cache_key: cacheKey })\n\n    if (error || !data) {\n      return null\n    }\n\n    return data\n  } catch (error) {\n    console.error('Cache retrieval error:', error)\n    return null\n  }\n}\n\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nasync function cacheResults(cacheKey: string, data: any, ttlMinutes: number) {\n  try {\n    await supabase\n      .rpc('set_cached_query', {\n        cache_key: cacheKey,\n        cache_data: data,\n        ttl_minutes: ttlMinutes\n      })\n  } catch (error) {\n    console.error('Cache storage error:', error)\n    // Don't fail the request if caching fails\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\app\\api\\specialties\\[id]\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'createClient' is defined but never used. Allowed unused vars must match /^_/u.","line":2,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":2,"endColumn":22}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\nimport { createClient } from \"@supabase/supabase-js\";\n\nimport { supabaseAdmin as supabase } from '@/lib/supabaseProxies';\n\nexport async function GET(\n  req: NextRequest,\n  context: { params: Promise<Record<string, string>> }\n) {\n  const { id } = await context.params\n  try {\n    const { data, error } = await supabase\n      .from(\"specialties\")\n      .select(\"id,name,slug,parent_id,path,is_active,created_at,updated_at\")\n      .eq(\"id\", id)\n      .single();\n\n    if (error) {\n      console.error(\"Specialty fetch error:\", error);\n      return NextResponse.json({ error: \"Failed to fetch specialty\" }, { status: 500 });\n    }\n\n    if (!data) {\n      return NextResponse.json({ error: \"Specialty not found\" }, { status: 404 });\n    }\n\n    return NextResponse.json(data);\n  } catch (error) {\n    console.error(\"Specialty API error:\", error);\n    return NextResponse.json({ error: \"Internal server error\" }, { status: 500 });\n  }\n}\n\nexport async function PUT(\n  req: NextRequest,\n  context: { params: Promise<Record<string, string>> }\n) {\n  const { id } = await context.params\n  try {\n    const { name, parent_id, is_active } = await req.json();\n\n    if (!name) {\n      return NextResponse.json({ error: \"Name is required\" }, { status: 400 });\n    }\n\n    const { data, error } = await supabase\n      .from(\"specialties\")\n      .update({ \n        name, \n        parent_id: parent_id || null, \n        is_active: is_active !== undefined ? is_active : true,\n        updated_at: new Date().toISOString()\n      })\n      .eq(\"id\", id)\n      .select()\n      .single();\n\n    if (error) {\n      console.error(\"Specialty update error:\", error);\n      return NextResponse.json({ error: \"Failed to update specialty\" }, { status: 500 });\n    }\n\n    return NextResponse.json(data);\n  } catch (error) {\n    console.error(\"Specialty update API error:\", error);\n    return NextResponse.json({ error: \"Internal server error\" }, { status: 500 });\n  }\n}\n\nexport async function DELETE(\n  req: NextRequest,\n  context: { params: Promise<Record<string, string>> }\n) {\n  const { id } = await context.params\n  try {\n    // Check if specialty has children\n    const { data: children, error: childrenError } = await supabase\n      .from(\"specialties\")\n      .select(\"id\")\n      .eq(\"parent_id\", id);\n\n    if (childrenError) {\n      console.error(\"Children check error:\", childrenError);\n      return NextResponse.json({ error: \"Failed to check specialty dependencies\" }, { status: 500 });\n    }\n\n    if (children && children.length > 0) {\n      return NextResponse.json({ \n        error: \"Cannot delete specialty with child categories. Please delete or move child categories first.\" \n      }, { status: 400 });\n    }\n\n    // Check if specialty is used by vendors\n    const { data: vendorUsage, error: vendorError } = await supabase\n      .from(\"vendor_specialties\")\n      .select(\"id\")\n      .eq(\"specialty_id\", id)\n      .limit(1);\n\n    if (vendorError) {\n      console.error(\"Vendor usage check error:\", vendorError);\n      return NextResponse.json({ error: \"Failed to check specialty usage\" }, { status: 500 });\n    }\n\n    if (vendorUsage && vendorUsage.length > 0) {\n      return NextResponse.json({ \n        error: \"Cannot delete specialty that is currently used by vendors. Please reassign vendors first.\" \n      }, { status: 400 });\n    }\n\n    // Delete the specialty\n    const { error } = await supabase\n      .from(\"specialties\")\n      .delete()\n      .eq(\"id\", id);\n\n    if (error) {\n      console.error(\"Specialty deletion error:\", error);\n      return NextResponse.json({ error: \"Failed to delete specialty\" }, { status: 500 });\n    }\n\n    return NextResponse.json({ success: true, message: \"Specialty deleted successfully\" });\n  } catch (error) {\n    console.error(\"Specialty deletion API error:\", error);\n    return NextResponse.json({ error: \"Internal server error\" }, { status: 500 });\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\app\\api\\specialties\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'createClient' is defined but never used. Allowed unused vars must match /^_/u.","line":2,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":2,"endColumn":22}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\nimport { createClient } from \"@supabase/supabase-js\";\n\nimport { supabaseAdmin as supabase } from '@/lib/supabaseProxies';\n\nexport async function GET(req: NextRequest) {\n  const q = req.nextUrl.searchParams.get(\"q\")?.trim();\n  const parent = req.nextUrl.searchParams.get(\"parent\");\n  \n  try {\n    let query = supabase\n      .from(\"specialties\")\n      .select(\"id,name,slug,parent_id,path,is_active\")\n      .eq(\"is_active\", true)\n      .order(\"name\");\n      \n    if (parent === \"root\") {\n      query = query.is(\"parent_id\", null);\n    } else if (parent && parent !== \"root\") {\n      query = query.eq(\"parent_id\", parent);\n    }\n    \n    if (q) {\n      // Search across names and aliases\n      const { data: aliasResults } = await supabase\n        .from(\"specialty_aliases\")\n        .select(\"specialty_id\")\n        .ilike(\"alias\", `%${q}%`);\n      \n      const aliasIds = aliasResults?.map(r => r.specialty_id) || [];\n      \n      query = query.or(`name.ilike.%${q}%,id.in.(${aliasIds.join(\",\")})`);\n    }\n    \n    const { data, error } = await query;\n    \n    if (error) {\n      console.error(\"Specialties query error:\", error);\n      return NextResponse.json({ error: \"Failed to fetch specialties\" }, { status: 500 });\n    }\n    \n    return NextResponse.json({ items: data || [] });\n  } catch (error) {\n    console.error(\"Specialties API error:\", error);\n    return NextResponse.json({ error: \"Internal server error\" }, { status: 500 });\n  }\n}\n\nexport async function POST(req: NextRequest) {\n  try {\n    const { name, parent_id } = await req.json();\n    \n    if (!name) {\n      return NextResponse.json({ error: \"Name is required\" }, { status: 400 });\n    }\n    \n    const { data, error } = await supabase\n      .from(\"specialties\")\n      .insert({ name, parent_id: parent_id || null })\n      .select()\n      .single();\n      \n    if (error) {\n      console.error(\"Specialty creation error:\", error);\n      return NextResponse.json({ error: \"Failed to create specialty\" }, { status: 500 });\n    }\n    \n    return NextResponse.json(data);\n  } catch (error) {\n    console.error(\"Specialty creation API error:\", error);\n    return NextResponse.json({ error: \"Internal server error\" }, { status: 500 });\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\app\\api\\specialties\\suggest\\[id]\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'createClient' is defined but never used. Allowed unused vars must match /^_/u.","line":2,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":2,"endColumn":22}],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":32,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":32,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1056,1059],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1056,1059],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\nimport { createClient } from \"@supabase/supabase-js\";\n\nimport { supabaseAdmin as supabase } from '@/lib/supabaseProxies';\n\nexport async function PUT(\n  req: NextRequest,\n  context: { params: Promise<Record<string, string>> }\n) {\n  const { id } = await context.params\n  try {\n    const { status, admin_notes, parent_id } = await req.json();\n\n    if (!status || !['approved', 'rejected'].includes(status)) {\n      return NextResponse.json({ error: \"Invalid status\" }, { status: 400 });\n    }\n\n    // Get the suggestion details\n    const { data: suggestion, error: fetchError } = await supabase\n      .from(\"specialty_suggestions\")\n      .select(\"*\")\n      .eq(\"id\", id)\n      .single();\n\n    if (fetchError || !suggestion) {\n      console.error(\"Suggestion fetch error:\", fetchError);\n      return NextResponse.json({ error: \"Suggestion not found\" }, { status: 404 });\n    }\n\n    // Update the suggestion status\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    const updateData: any = {\n      status,\n      reviewed_at: new Date().toISOString(),\n      reviewer_id: 'admin', // TODO: Get actual admin user ID\n    };\n\n    if (admin_notes) {\n      updateData.admin_notes = admin_notes;\n    }\n\n    const { error: updateError } = await supabase\n      .from(\"specialty_suggestions\")\n      .update(updateData)\n      .eq(\"id\", id);\n\n    if (updateError) {\n      console.error(\"Suggestion update error:\", updateError);\n      return NextResponse.json({ error: \"Failed to update suggestion\" }, { status: 500 });\n    }\n\n    // If approved, create the new specialty\n    if (status === 'approved') {\n      const { data: newSpecialty, error: createError } = await supabase\n        .from(\"specialties\")\n        .insert({\n          name: suggestion.proposed_name,\n          parent_id: parent_id || suggestion.parent_id,\n          is_active: true\n        })\n        .select()\n        .single();\n\n      if (createError) {\n        console.error(\"Specialty creation error:\", createError);\n        return NextResponse.json({ \n          error: \"Suggestion approved but failed to create specialty\" \n        }, { status: 500 });\n      }\n\n      return NextResponse.json({\n        success: true,\n        message: \"Suggestion approved and specialty created\",\n        specialty: newSpecialty\n      });\n    }\n\n    return NextResponse.json({\n      success: true,\n      message: \"Suggestion rejected\"\n    });\n\n  } catch (error) {\n    console.error(\"Suggestion review API error:\", error);\n    return NextResponse.json({ error: \"Internal server error\" }, { status: 500 });\n  }\n}\n\nexport async function GET(\n  req: NextRequest,\n  context: { params: Promise<Record<string, string>> }\n) {\n  const { id } = await context.params\n  try {\n    const { data, error } = await supabase\n      .from(\"specialty_suggestions\")\n      .select(`\n        *,\n        specialties!specialty_suggestions_parent_id_fkey(name),\n        app_users!specialty_suggestions_app_user_id_fkey(display_name)\n      `)\n      .eq(\"id\", id)\n      .single();\n\n    if (error) {\n      console.error(\"Suggestion fetch error:\", error);\n      return NextResponse.json({ error: \"Failed to fetch suggestion\" }, { status: 500 });\n    }\n\n    if (!data) {\n      return NextResponse.json({ error: \"Suggestion not found\" }, { status: 404 });\n    }\n\n    return NextResponse.json(data);\n  } catch (error) {\n    console.error(\"Suggestion API error:\", error);\n    return NextResponse.json({ error: \"Internal server error\" }, { status: 500 });\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\app\\api\\specialties\\suggest\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'createClient' is defined but never used. Allowed unused vars must match /^_/u.","line":2,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":2,"endColumn":22}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from \"next/server\";\nimport { createClient } from \"@supabase/supabase-js\";\n\nimport { supabaseAdmin as supabase } from '@/lib/supabaseProxies';\n\nexport async function POST(req: NextRequest) {\n  try {\n    const body = await req.json();\n    const { app_user_id, proposed_name, parent_id, details } = body;\n    \n    if (!proposed_name) {\n      return NextResponse.json({ error: \"proposed_name required\" }, { status: 400 });\n    }\n    \n    const { data, error } = await supabase\n      .from(\"specialty_suggestions\")\n      .insert({ \n        app_user_id: app_user_id || null, \n        proposed_name, \n        parent_id: parent_id || null, \n        details: details || null \n      })\n      .select()\n      .single();\n      \n    if (error) {\n      console.error(\"Suggestion creation error:\", error);\n      return NextResponse.json({ error: \"Failed to create suggestion\" }, { status: 500 });\n    }\n    \n    return NextResponse.json(data, { status: 201 });\n  } catch (error) {\n    console.error(\"Suggestion API error:\", error);\n    return NextResponse.json({ error: \"Internal server error\" }, { status: 500 });\n  }\n}\n\nexport async function GET(req: NextRequest) {\n  try {\n    const status = req.nextUrl.searchParams.get(\"status\");\n    const app_user_id = req.nextUrl.searchParams.get(\"user_id\");\n    \n    let query = supabase\n      .from(\"specialty_suggestions\")\n      .select(`\n        *,\n        specialties!specialty_suggestions_parent_id_fkey(name),\n        app_users!specialty_suggestions_app_user_id_fkey(display_name)\n      `)\n      .order(\"created_at\", { ascending: false });\n      \n    if (status) {\n      query = query.eq(\"status\", status);\n    }\n    \n    if (app_user_id) {\n      query = query.eq(\"app_user_id\", app_user_id);\n    }\n    \n    const { data, error } = await query;\n    \n    if (error) {\n      console.error(\"Suggestions query error:\", error);\n      return NextResponse.json({ error: \"Failed to fetch suggestions\" }, { status: 500 });\n    }\n    \n    return NextResponse.json({ items: data || [] });\n  } catch (error) {\n    console.error(\"Suggestions API error:\", error);\n    return NextResponse.json({ error: \"Internal server error\" }, { status: 500 });\n  }\n}\n\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\app\\api\\telemetry\\resilience\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'createClient' is defined but never used. Allowed unused vars must match /^_/u.","line":2,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":2,"endColumn":22}],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":23,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":23,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[718,721],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[718,721],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server'\nimport { createClient } from '@supabase/supabase-js'\n\n// Initialize Supabase client\nimport { supabaseAdmin as supabase } from '@/lib/supabaseProxies';\n\nexport async function POST(request: NextRequest) {\n  try {\n    const { signals } = await request.json()\n\n    if (!signals || !Array.isArray(signals)) {\n      return NextResponse.json(\n        { error: 'Invalid signals format' },\n        { status: 400 }\n      )\n    }\n\n    // Store signals in resilience_metrics table\n    const { _data, error } = await supabase\n      .from('resilience_metrics')\n      .insert(\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\n        signals.map((signal: any) => ({\n          id: signal.id,\n          ts: new Date(signal.timestamp).toISOString(),\n          user_id: signal.user_id,\n          session_id: signal.session_id,\n          component: signal.component,\n          signal: signal.signal_type,\n          data: signal.data\n        }))\n      )\n\n    if (error) {\n      console.error('Failed to store resilience telemetry:', error)\n      return NextResponse.json(\n        { error: 'Failed to store telemetry' },\n        { status: 500 }\n      )\n    }\n\n    return NextResponse.json({ \n      success: true, \n      stored: signals.length \n    })\n\n  } catch (error) {\n    console.error('Resilience telemetry endpoint error:', error)\n    return NextResponse.json(\n      { error: 'Internal server error' },\n      { status: 500 }\n    )\n  }\n}\n\n// Health check endpoint\nexport async function GET() {\n  return NextResponse.json({ \n    status: 'healthy',\n    endpoint: 'resilience-telemetry',\n    timestamp: new Date().toISOString()\n  })\n}\n\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\app\\api\\webhooks\\stripe\\route.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'createClient' is defined but never used. Allowed unused vars must match /^_/u.","line":2,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":2,"endColumn":22}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server'\nimport { createClient } from '@supabase/supabase-js'\nimport { headers } from 'next/headers'\nimport Stripe from 'stripe'\nimport { featureFlags } from '@/config/featureFlags'\n\nimport { supabaseAdmin as supabase } from '@/lib/supabaseProxies';\n\nasync function webhookHandler(req: NextRequest): Promise<NextResponse> {\n  const stripeSecretKey = process.env.STRIPE_SECRET_KEY\n  const endpointSecret = process.env.STRIPE_WEBHOOK_SECRET\n\n  if (!stripeSecretKey) {\n    console.error('STRIPE_SECRET_KEY is not configured')\n    return new NextResponse('Server Configuration Error', { status: 500 })\n  }\n\n  if (!endpointSecret) {\n    console.error('STRIPE_WEBHOOK_SECRET is not configured')\n    return new NextResponse('Server Configuration Error', { status: 500 })\n  }\n\n  const stripe = new Stripe(stripeSecretKey, {\n    apiVersion: '2024-06-20'\n  })\n\n  if (!featureFlags.beta.core_booking_flow) {\n    return NextResponse.json(\n      { error: 'Core booking flow not enabled' },\n      { status: 403 }\n    )\n  }\n\n  try {\n    const body = await req.text()\n    const headersList = await headers()\n    const sig = headersList.get('stripe-signature')\n\n    if (!sig) {\n      return NextResponse.json(\n        { error: 'Missing stripe signature' },\n        { status: 400 }\n      )\n    }\n\n    let event: Stripe.Event\n\n    try {\n      event = stripe.webhooks.constructEvent(body, sig, endpointSecret)\n    } catch (err) {\n      console.error('Webhook signature verification failed:', err)\n      return NextResponse.json(\n        { error: 'Invalid signature' },\n        { status: 400 }\n      )\n    }\n\n    console.log(`Processing webhook: ${event.type}`)\n\n    // Handle the event\n    switch (event.type) {\n      case 'payment_intent.succeeded':\n        await handlePaymentSuccess(event.data.object as Stripe.PaymentIntent)\n        break\n      \n      case 'payment_intent.payment_failed':\n        await handlePaymentFailure(event.data.object as Stripe.PaymentIntent)\n        break\n      \n      case 'payment_intent.canceled':\n        await handlePaymentCanceled(event.data.object as Stripe.PaymentIntent)\n        break\n      \n      default:\n        console.log(`Unhandled event type: ${event.type}`)\n    }\n\n    return NextResponse.json({ received: true })\n\n  } catch (error) {\n    console.error('Webhook error:', error)\n    return NextResponse.json(\n      { error: 'Internal server error' },\n      { status: 500 }\n    )\n  }\n}\n\nasync function handlePaymentSuccess(paymentIntent: Stripe.PaymentIntent): Promise<void> {\n  try {\n    // Find the booking for this payment intent\n    const { data: booking, error: bookingError } = await supabase\n      .from('bookings')\n      .select('*')\n      .eq('stripe_payment_intent_id', paymentIntent.id)\n      .eq('state', 'hold_placed')\n      .single()\n\n    if (bookingError || !booking) {\n      console.error('Booking not found for payment intent:', paymentIntent.id)\n      return\n    }\n\n    // Check if this payment intent was already processed (idempotency)\n    const { data: existingOutbox } = await supabase\n      .from('payments_outbox')\n      .select('*')\n      .eq('event_data->>payment_intent_id', paymentIntent.id)\n      .eq('status', 'committed')\n      .single()\n\n    if (existingOutbox) {\n      console.log(`Payment intent ${paymentIntent.id} already processed, skipping`)\n      return\n    }\n\n    // Update booking state to provider_confirmed\n    const { error: updateError } = await supabase\n      .from('bookings')\n      .update({\n        state: 'provider_confirmed',\n        confirmed_at: new Date().toISOString()\n      })\n      .eq('id', booking.id)\n\n    if (updateError) {\n      console.error('Failed to update booking state:', updateError)\n      return\n    }\n\n    // Mark outbox entry as committed\n    const { error: outboxError } = await supabase\n      .from('payments_outbox')\n      .update({\n        status: 'committed',\n        processed_at: new Date().toISOString()\n      })\n      .eq('event_data->>payment_intent_id', paymentIntent.id)\n      .eq('status', 'pending')\n\n    if (outboxError) {\n      console.error('Failed to update outbox status:', outboxError)\n    }\n\n    // Log the state transition\n    await supabase\n      .from('booking_audit_log')\n      .insert({\n        booking_id: booking.id,\n        from_state: 'hold_placed',\n        to_state: 'provider_confirmed',\n        action: 'state_change',\n        actor_type: 'webhook',\n        actor_id: 'stripe',\n        metadata: {\n          payment_intent: paymentIntent.id,\n          amount_received: paymentIntent.amount,\n          customer_id: paymentIntent.customer,\n          webhook_event: 'payment_intent.succeeded'\n        }\n      })\n\n    console.log(`Booking ${booking.id} confirmed via payment success`)\n\n  } catch (error) {\n    console.error('Error handling payment success:', error)\n  }\n}\n\nasync function handlePaymentFailure(paymentIntent: Stripe.PaymentIntent): Promise<void> {\n  try {\n    // Find the booking for this payment intent\n    const { data: booking, error: bookingError } = await supabase\n      .from('bookings')\n      .select('*')\n      .eq('stripe_payment_intent_id', paymentIntent.id)\n      .eq('state', 'hold_placed')\n      .single()\n\n    if (bookingError || !booking) {\n      console.error('Booking not found for payment intent:', paymentIntent.id)\n      return\n    }\n\n    // Update booking state to cancelled\n    const { error: updateError } = await supabase\n      .from('bookings')\n      .update({\n        state: 'cancelled',\n        cancelled_at: new Date().toISOString(),\n        cancelled_reason: 'Payment failed'\n      })\n      .eq('id', booking.id)\n\n    if (updateError) {\n      console.error('Failed to update booking state:', updateError)\n      return\n    }\n\n    // Mark outbox entry as failed\n    const { error: outboxError } = await supabase\n      .from('payments_outbox')\n      .update({\n        status: 'failed',\n        processed_at: new Date().toISOString(),\n        error_message: 'Payment failed'\n      })\n      .eq('event_data->>payment_intent_id', paymentIntent.id)\n      .eq('status', 'pending')\n\n    if (outboxError) {\n      console.error('Failed to update outbox status:', outboxError)\n    }\n\n    // Log the state transition\n    await supabase\n      .from('booking_audit_log')\n      .insert({\n        booking_id: booking.id,\n        from_state: 'hold_placed',\n        to_state: 'cancelled',\n        action: 'state_change',\n        actor_type: 'webhook',\n        actor_id: 'stripe',\n        metadata: {\n          payment_intent: paymentIntent.id,\n          failure_reason: paymentIntent.last_payment_error?.message || 'Unknown payment failure',\n          webhook_event: 'payment_intent.payment_failed'\n        }\n      })\n\n    console.log(`Booking ${booking.id} cancelled due to payment failure`)\n\n  } catch (error) {\n    console.error('Error handling payment failure:', error)\n  }\n}\n\nasync function handlePaymentCanceled(paymentIntent: Stripe.PaymentIntent): Promise<void> {\n  try {\n    // Find the booking for this payment intent\n    const { data: booking, error: bookingError } = await supabase\n      .from('bookings')\n      .select('*')\n      .eq('stripe_payment_intent_id', paymentIntent.id)\n      .eq('state', 'hold_placed')\n      .single()\n\n    if (bookingError || !booking) {\n      console.error('Booking not found for payment intent:', paymentIntent.id)\n      return\n    }\n\n    // Update booking state to cancelled\n    const { error: updateError } = await supabase\n      .from('bookings')\n      .update({\n        state: 'cancelled',\n        cancelled_at: new Date().toISOString(),\n        cancelled_reason: 'Payment cancelled'\n      })\n      .eq('id', booking.id)\n\n    if (updateError) {\n      console.error('Failed to update booking state:', updateError)\n      return\n    }\n\n    // Mark outbox entry as failed\n    const { error: outboxError } = await supabase\n      .from('payments_outbox')\n      .update({\n        status: 'failed',\n        processed_at: new Date().toISOString(),\n        error_message: 'Payment cancelled'\n      })\n      .eq('event_data->>payment_intent_id', paymentIntent.id)\n      .eq('status', 'pending')\n\n    if (outboxError) {\n      console.error('Failed to update outbox status:', outboxError)\n    }\n\n    // Log the state transition\n    await supabase\n      .from('booking_audit_log')\n      .insert({\n        booking_id: booking.id,\n        from_state: 'hold_placed',\n        to_state: 'cancelled',\n        action: 'state_change',\n        actor_type: 'webhook',\n        actor_id: 'stripe',\n        metadata: {\n          payment_intent: paymentIntent.id,\n          cancellation_reason: 'Payment cancelled by customer or system',\n          webhook_event: 'payment_intent.canceled'\n        }\n      })\n\n    console.log(`Booking ${booking.id} cancelled due to payment cancellation`)\n\n  } catch (error) {\n    console.error('Error handling payment cancellation:', error)\n  }\n}\n\nexport const POST = webhookHandler\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\app\\customer\\credits\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'DollarSign' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":35,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":45}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\r\n\r\nimport { useState, useEffect } from 'react'\r\nimport { CreditCard, Plus, Minus, DollarSign, History } from 'lucide-react'\r\nimport Link from 'next/link'\r\n\r\ninterface CreditBalance {\r\n  balance_cents: number\r\n  balance_dollars: number\r\n}\r\n\r\ninterface CreditTransaction {\r\n  id: string\r\n  amount_cents: number\r\n  type: 'purchase' | 'usage' | 'refund' | 'bonus'\r\n  description: string\r\n  date: string\r\n}\r\n\r\nexport default function CustomerCreditsPage() {\r\n  const [balance, setBalance] = useState<CreditBalance | null>(null)\r\n  const [transactions, setTransactions] = useState<CreditTransaction[]>([])\r\n  const [loading, setLoading] = useState(true)\r\n\r\n  useEffect(() => {\r\n    const loadCredits = async () => {\r\n      try {\r\n        const response = await fetch('/api/credits/balance')\r\n        if (response.ok) {\r\n          const data = await response.json()\r\n          if (data.success) {\r\n            setBalance(data.credits)\r\n            setTransactions(data.credits.recent_transactions || [])\r\n          }\r\n        }\r\n      } catch (error) {\r\n        console.error('Error loading credits:', error)\r\n      } finally {\r\n        setLoading(false)\r\n      }\r\n    }\r\n\r\n    loadCredits()\r\n  }, [])\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"flex items-center justify-center min-h-[400px]\">\r\n        <div className=\"animate-spin w-8 h-8 border-2 border-blue-600 border-t-transparent rounded-full\"></div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  const currentBalance = balance?.balance_dollars || 0\r\n\r\n  return (\r\n    <div className=\"max-w-4xl mx-auto\">\r\n      <div className=\"mb-6\">\r\n        <h1 className=\"text-3xl font-bold text-gray-900 mb-2\">Credits</h1>\r\n        <p className=\"text-gray-600\">Manage your account balance</p>\r\n      </div>\r\n\r\n      {/* Balance Card */}\r\n      <div className=\"bg-gradient-to-r from-blue-600 to-purple-600 rounded-lg shadow-lg p-8 text-white mb-6\">\r\n        <div className=\"flex items-center justify-between mb-4\">\r\n          <div>\r\n            <p className=\"text-blue-100 text-sm mb-1\">Available Balance</p>\r\n            <p className=\"text-4xl font-bold\">${currentBalance.toFixed(2)}</p>\r\n          </div>\r\n          <CreditCard className=\"w-16 h-16 text-blue-200\" />\r\n        </div>\r\n        <Link\r\n          href=\"/demo/credits\"\r\n          className=\"inline-flex items-center gap-2 px-6 py-3 bg-white text-blue-600 rounded-lg font-medium hover:bg-blue-50 transition-colors\"\r\n        >\r\n          <Plus className=\"w-5 h-5\" />\r\n          Purchase Credits\r\n        </Link>\r\n      </div>\r\n\r\n      {/* Transactions */}\r\n      <div className=\"bg-white rounded-lg shadow-sm p-6\">\r\n        <div className=\"flex items-center justify-between mb-6\">\r\n          <h2 className=\"text-xl font-semibold text-gray-900 flex items-center gap-2\">\r\n            <History className=\"w-5 h-5\" />\r\n            Transaction History\r\n          </h2>\r\n        </div>\r\n\r\n        {transactions.length === 0 ? (\r\n          <div className=\"text-center py-12\">\r\n            <History className=\"w-16 h-16 text-gray-400 mx-auto mb-4\" />\r\n            <p className=\"text-gray-600\">No transactions yet</p>\r\n          </div>\r\n        ) : (\r\n          <div className=\"space-y-4\">\r\n            {transactions.map((transaction) => (\r\n              <div\r\n                key={transaction.id}\r\n                className=\"flex items-center justify-between p-4 border rounded-lg\"\r\n              >\r\n                <div className=\"flex items-center gap-4\">\r\n                  {transaction.type === 'purchase' || transaction.type === 'bonus' ? (\r\n                    <Plus className=\"w-5 h-5 text-green-500\" />\r\n                  ) : (\r\n                    <Minus className=\"w-5 h-5 text-red-500\" />\r\n                  )}\r\n                  <div>\r\n                    <p className=\"font-medium text-gray-900\">{transaction.description}</p>\r\n                    <p className=\"text-sm text-gray-500\">\r\n                      {new Date(transaction.date).toLocaleDateString()}\r\n                    </p>\r\n                  </div>\r\n                </div>\r\n                <div className=\"text-right\">\r\n                  <p\r\n                    className={`font-semibold ${\r\n                      transaction.type === 'purchase' || transaction.type === 'bonus'\r\n                        ? 'text-green-600'\r\n                        : 'text-red-600'\r\n                    }`}\r\n                  >\r\n                    {transaction.type === 'purchase' || transaction.type === 'bonus' ? '+' : '-'}\r\n                    ${Math.abs(transaction.amount_cents / 100).toFixed(2)}\r\n                  </p>\r\n                </div>\r\n              </div>\r\n            ))}\r\n          </div>\r\n        )}\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\app\\customer\\favorites\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Phone' is defined but never used. Allowed unused vars must match /^_/u.","line":5,"column":31,"nodeType":null,"messageId":"unusedVar","endLine":5,"endColumn":36},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Mail' is defined but never used. Allowed unused vars must match /^_/u.","line":5,"column":38,"nodeType":null,"messageId":"unusedVar","endLine":5,"endColumn":42}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\r\n\r\nimport { useState, useEffect } from 'react'\r\nimport { supabaseBrowserClient } from '@/lib/supabaseClient'\r\nimport { Heart, Star, MapPin, Phone, Mail } from 'lucide-react'\r\nimport Link from 'next/link'\r\nimport Image from 'next/image'\r\n\r\ninterface Provider {\r\n  id: string\r\n  business_name: string\r\n  avatar_url?: string\r\n  rating: number\r\n  total_reviews: number\r\n  specialties: string[]\r\n  location?: string\r\n}\r\n\r\nexport default function CustomerFavoritesPage() {\r\n  const [favorites, setFavorites] = useState<Provider[]>([])\r\n  const [loading, setLoading] = useState(true)\r\n\r\n  useEffect(() => {\r\n    const loadFavorites = async () => {\r\n      const supabase = supabaseBrowserClient()\r\n      if (!supabase) return\r\n\r\n      try {\r\n        const { data: { session } } = await supabase.auth.getSession()\r\n        if (!session?.user) return\r\n\r\n        const { data, error } = await supabase\r\n          .from('favorite_providers')\r\n          .select('provider_id, providers(*)')\r\n          .eq('user_id', session.user.id)\r\n\r\n        if (error) throw error\r\n\r\n        const providers = (data || [])\r\n          .map(fp => fp.providers)\r\n          .filter(Boolean) as unknown as Provider[]\r\n        \r\n        setFavorites(providers)\r\n      } catch (error) {\r\n        console.error('Error loading favorites:', error)\r\n      } finally {\r\n        setLoading(false)\r\n      }\r\n    }\r\n\r\n    loadFavorites()\r\n  }, [])\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"flex items-center justify-center min-h-[400px]\">\r\n        <div className=\"animate-spin w-8 h-8 border-2 border-blue-600 border-t-transparent rounded-full\"></div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  return (\r\n    <div className=\"max-w-7xl mx-auto\">\r\n      <div className=\"mb-6\">\r\n        <h1 className=\"text-3xl font-bold text-gray-900 mb-2\">Favorite Providers</h1>\r\n        <p className=\"text-gray-600\">Your saved service providers</p>\r\n      </div>\r\n\r\n      {favorites.length === 0 ? (\r\n        <div className=\"bg-white rounded-lg shadow-sm p-12 text-center\">\r\n          <Heart className=\"w-16 h-16 text-gray-400 mx-auto mb-4\" />\r\n          <h3 className=\"text-lg font-semibold text-gray-900 mb-2\">No favorites yet</h3>\r\n          <p className=\"text-gray-600 mb-6\">\r\n            Start exploring providers and add them to your favorites for quick access.\r\n          </p>\r\n          <Link\r\n            href=\"/get-started\"\r\n            className=\"inline-block px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700\"\r\n          >\r\n            Find Providers\r\n          </Link>\r\n        </div>\r\n      ) : (\r\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\r\n          {favorites.map((provider) => (\r\n            <div key={provider.id} className=\"bg-white rounded-lg shadow-sm p-6 hover:shadow-md transition-shadow\">\r\n              <div className=\"flex items-start gap-4 mb-4\">\r\n                {provider.avatar_url ? (\r\n                  <Image\r\n                    src={provider.avatar_url}\r\n                    alt={provider.business_name}\r\n                    width={64}\r\n                    height={64}\r\n                    className=\"rounded-full\"\r\n                  />\r\n                ) : (\r\n                  <div className=\"w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center\">\r\n                    <span className=\"text-2xl font-bold text-gray-400\">\r\n                      {provider.business_name.charAt(0)}\r\n                    </span>\r\n                  </div>\r\n                )}\r\n                <div className=\"flex-1\">\r\n                  <h3 className=\"text-lg font-semibold text-gray-900 mb-1\">{provider.business_name}</h3>\r\n                  <div className=\"flex items-center gap-1 mb-2\">\r\n                    <Star className=\"w-4 h-4 fill-yellow-400 text-yellow-400\" />\r\n                    <span className=\"text-sm font-medium text-gray-900\">{provider.rating}</span>\r\n                    <span className=\"text-sm text-gray-500\">({provider.total_reviews} reviews)</span>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n\r\n              {provider.specialties && provider.specialties.length > 0 && (\r\n                <div className=\"mb-4\">\r\n                  <div className=\"flex flex-wrap gap-2\">\r\n                    {provider.specialties.slice(0, 3).map((specialty, idx) => (\r\n                      <span\r\n                        key={idx}\r\n                        className=\"px-2 py-1 bg-blue-50 text-blue-700 text-xs rounded-full\"\r\n                      >\r\n                        {specialty}\r\n                      </span>\r\n                    ))}\r\n                  </div>\r\n                </div>\r\n              )}\r\n\r\n              {provider.location && (\r\n                <div className=\"flex items-center gap-2 text-sm text-gray-600 mb-4\">\r\n                  <MapPin className=\"w-4 h-4\" />\r\n                  {provider.location}\r\n                </div>\r\n              )}\r\n\r\n              <div className=\"flex gap-2\">\r\n                <Link\r\n                  href={`/book/${provider.id}`}\r\n                  className=\"flex-1 px-4 py-2 bg-blue-600 text-white text-center rounded-lg hover:bg-blue-700 text-sm font-medium\"\r\n                >\r\n                  Book Now\r\n                </Link>\r\n                <Link\r\n                  href={`/providers/${provider.id}`}\r\n                  className=\"px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 text-sm font-medium\"\r\n                >\r\n                  View\r\n                </Link>\r\n              </div>\r\n            </div>\r\n          ))}\r\n        </div>\r\n      )}\r\n    </div>\r\n  )\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\app\\provider\\analytics\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'useState' is defined but never used. Allowed unused vars must match /^_/u.","line":3,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":18}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useState } from 'react';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';\nimport { MapPin, TrendingUp, Users, DollarSign } from 'lucide-react';\nimport HeatmapVisualization from '@/components/HeatmapVisualization';\n\nexport default function ProviderAnalytics() {\n  return (\n    <div className=\"container mx-auto p-6 space-y-6\">\n      <div className=\"flex justify-between items-center\">\n        <h1 className=\"text-3xl font-bold\">Provider Analytics</h1>\n      </div>\n\n      <Tabs defaultValue=\"heatmap\" className=\"w-full\">\n        <TabsList>\n          <TabsTrigger value=\"heatmap\">Booking Heatmap</TabsTrigger>\n          <TabsTrigger value=\"demand\">Demand Analysis</TabsTrigger>\n          <TabsTrigger value=\"competition\">Competition</TabsTrigger>\n          <TabsTrigger value=\"performance\">Performance</TabsTrigger>\n        </TabsList>\n\n        <TabsContent value=\"heatmap\" className=\"space-y-6\">\n          <div className=\"grid grid-cols-1 gap-6\">\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"flex items-center space-x-2\">\n                  <MapPin className=\"h-5 w-5\" />\n                  <span>Booking Density Analysis</span>\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                <p className=\"text-gray-600 mb-4\">\n                  Analyze booking patterns and density across different areas to identify high-demand locations \n                  and optimize your service coverage.\n                </p>\n                <HeatmapVisualization \n                  height={500}\n                  defaultTimeRange=\"30d\"\n                  className=\"w-full\"\n                />\n              </CardContent>\n            </Card>\n          </div>\n        </TabsContent>\n\n        <TabsContent value=\"demand\" className=\"space-y-6\">\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center space-x-2\">\n                <TrendingUp className=\"h-5 w-5\" />\n                <span>Service Demand Patterns</span>\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-center py-12 text-gray-500\">\n                <TrendingUp className=\"h-12 w-12 mx-auto mb-4 opacity-50\" />\n                <h3 className=\"text-lg font-medium mb-2\">Demand Analysis Coming Soon</h3>\n                <p>Track search patterns, conversion rates, and seasonal demand trends.</p>\n              </div>\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"competition\" className=\"space-y-6\">\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center space-x-2\">\n                <Users className=\"h-5 w-5\" />\n                <span>Competition Analysis</span>\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-center py-12 text-gray-500\">\n                <Users className=\"h-12 w-12 mx-auto mb-4 opacity-50\" />\n                <h3 className=\"text-lg font-medium mb-2\">Competition Analysis Coming Soon</h3>\n                <p>Compare your performance with other providers in your area and service category.</p>\n              </div>\n            </CardContent>\n          </Card>\n        </TabsContent>\n\n        <TabsContent value=\"performance\" className=\"space-y-6\">\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center space-x-2\">\n                <DollarSign className=\"h-5 w-5\" />\n                <span>Performance Metrics</span>\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"text-center py-12 text-gray-500\">\n                <DollarSign className=\"h-12 w-12 mx-auto mb-4 opacity-50\" />\n                <h3 className=\"text-lg font-medium mb-2\">Performance Analytics Coming Soon</h3>\n                <p>Track your earnings, booking rates, customer satisfaction, and growth metrics.</p>\n              </div>\n            </CardContent>\n          </Card>\n        </TabsContent>\n      </Tabs>\n    </div>\n  );\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\app\\provider\\profile\\page.tsx","messages":[{"ruleId":"react/jsx-no-comment-textnodes","severity":2,"message":"Comments inside children section of tag should be placed inside braces","line":220,"column":54,"nodeType":"JSXText","messageId":"putCommentInBraces","endLine":222,"endColumn":17},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":222,"column":17,"nodeType":"JSXOpeningElement","endLine":226,"endColumn":19}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'mockProfile'. Either include it or remove the dependency array.","line":133,"column":6,"nodeType":"ArrayExpression","endLine":133,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [mockProfile]","fix":{"range":[4496,4498],"text":"[mockProfile]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useState, useEffect } from 'react';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Button } from '@/components/ui/button';\nimport { Badge } from '@/components/ui/badge';\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';\nimport { \n  User, \n  Award, \n  GraduationCap, \n  _Briefcase, \n  Globe, \n  Star,\n  MapPin,\n  Clock,\n  DollarSign,\n  CheckCircle,\n  AlertCircle,\n  _Edit,\n  _Save\n} from 'lucide-react';\nimport ProfileEditor from '@/components/provider/ProfileEditor';\nimport { RichProviderProfile, ProviderProfileUpdate } from '@/types/provider';\n\nexport default function ProviderProfilePage() {\n  const [profile, setProfile] = useState<RichProviderProfile | null>(null);\n  const [isLoading, setIsLoading] = useState(true);\n  const [_isSaving, setIsSaving] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n\n  // Mock profile data for development\n  const mockProfile: RichProviderProfile = {\n    id: '1',\n    full_name: 'John Doe',\n    email: 'john.doe@example.com',\n    bio: 'Experienced web developer with 5+ years building modern applications.',\n    portfolio_images: ['/api/placeholder/400/300'],\n    certifications: [\n      {\n        id: '1',\n        provider_id: '1',\n        certification_name: 'AWS Certified Developer',\n        issuing_organization: 'Amazon Web Services',\n        issue_date: '2023-01-15',\n        expiry_date: '2026-01-15',\n        certificate_number: 'AWS-123456',\n        verification_status: 'verified',\n        certificate_url: 'https://aws.amazon.com/certification',\n        created_at: '2023-01-15T00:00:00Z',\n        updated_at: '2023-01-15T00:00:00Z'\n      }\n    ],\n    languages: ['English', 'Spanish'],\n    specializations: ['React', 'Node.js', 'TypeScript', 'AWS'],\n    experience_years: 5,\n    hourly_rate: 75,\n    availability_schedule: {\n      monday: { isAvailable: true, timeSlots: [{ start: '09:00', end: '17:00' }] },\n      tuesday: { isAvailable: true, timeSlots: [{ start: '09:00', end: '17:00' }] },\n      wednesday: { isAvailable: true, timeSlots: [{ start: '09:00', end: '17:00' }] },\n      thursday: { isAvailable: true, timeSlots: [{ start: '09:00', end: '17:00' }] },\n      friday: { isAvailable: true, timeSlots: [{ start: '09:00', end: '17:00' }] }\n    },\n    education: [\n      {\n        id: '1',\n        provider_id: '1',\n        institution_name: 'University of Technology',\n        degree_type: 'bachelor',\n        field_of_study: 'Computer Science',\n        start_year: 2015,\n        end_year: 2019,\n        is_current: false,\n        description: 'Focused on software engineering and web development',\n        created_at: '2015-09-01T00:00:00Z',\n        updated_at: '2019-06-01T00:00:00Z'\n      }\n    ],\n    professional_summary: 'Full-stack developer specializing in modern web technologies with a passion for clean, maintainable code.',\n    service_area_radius: 25,\n    verified_at: '2023-06-01T00:00:00Z',\n    verification_documents: ['/api/placeholder/400/300'],\n    social_links: {\n      website: 'https://johndoe.dev',\n      linkedin: 'https://linkedin.com/in/johndoe'\n    },\n    response_time_avg: 15,\n    completion_rate: 98,\n    profile_completion_score: 85,\n    rating: 4.8,\n    avatar_url: '/api/placeholder/150/150',\n    created_at: '2020-01-01T00:00:00Z',\n    updated_at: '2024-01-01T00:00:00Z',\n    total_bookings: 127,\n    completed_bookings: 125,\n    total_reviews: 89,\n    avg_review_rating: 4.8,\n    certification_count: 1,\n    education_count: 1,\n    portfolio_count: 0,\n    language_count: 2,\n    last_booking_date: '2024-01-15T00:00:00Z',\n    last_review_date: '2024-01-10T00:00:00Z',\n    service_types: ['Web Development', 'API Development', 'Database Design'],\n    avg_service_price: 150,\n    active_services: 3\n  };\n\n  useEffect(() => {\n    // Simulate API call\n    const loadProfile = async () => {\n      try {\n        setIsLoading(true);\n        // In real app, this would be an API call\n        // const response = await fetch('/api/provider/profile');\n        // const data = await response.json();\n        // setProfile(data.data);\n        \n        // For now, use mock data\n        setTimeout(() => {\n          setProfile(mockProfile);\n          setIsLoading(false);\n        }, 1000);\n      } catch (_err) {\n        setError('Failed to load profile');\n        setIsLoading(false);\n      }\n    };\n\n    loadProfile();\n  // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, []);\n\n  const handleSaveProfile = async (profileData: ProviderProfileUpdate) => {\n    try {\n      setIsSaving(true);\n      // In real app, this would be an API call\n      // const response = await fetch('/api/provider/profile', {\n      //   method: 'PUT',\n      //   headers: { 'Content-Type': 'application/json' },\n      //   body: JSON.stringify(profileData)\n      // });\n      \n      // Simulate API delay\n      await new Promise(resolve => setTimeout(resolve, 1000));\n      \n      // Update local state\n      if (profile) {\n        setProfile({\n          ...profile,\n          ...profileData\n        });\n      }\n      \n      // Show success message\n      console.log('Profile saved successfully');\n    } catch (err) {\n      setError('Failed to save profile');\n      console.error('Save error:', err);\n    } finally {\n      setIsSaving(false);\n    }\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"container mx-auto px-4 py-8\">\n        <div className=\"animate-pulse space-y-6\">\n          <div className=\"h-8 bg-gray-200 rounded w-1/4\"></div>\n          <div className=\"h-64 bg-gray-200 rounded\"></div>\n        </div>\n      </div>\n    );\n  }\n\n  if (error) {\n    return (\n      <div className=\"container mx-auto px-4 py-8\">\n        <Card>\n          <CardContent className=\"pt-6\">\n            <div className=\"text-center\">\n              <AlertCircle className=\"h-12 w-12 text-red-500 mx-auto mb-4\" />\n              <h2 className=\"text-xl font-semibold mb-2\">Error Loading Profile</h2>\n              <p className=\"text-gray-600 mb-4\">{error}</p>\n              <Button onClick={() => window.location.reload()}>\n                Try Again\n              </Button>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  if (!profile) {\n    return (\n      <div className=\"container mx-auto px-4 py-8\">\n        <Card>\n          <CardContent className=\"pt-6\">\n            <div className=\"text-center\">\n              <User className=\"h-12 w-12 text-gray-400 mx-auto mb-4\" />\n              <h2 className=\"text-xl font-semibold mb-2\">Profile Not Found</h2>\n              <p className=\"text-gray-600\">Unable to load your profile information.</p>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"container mx-auto px-4 py-8\">\n      <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-8\">\n        {/* Profile Overview Sidebar */}\n        <div className=\"lg:col-span-1 space-y-6\">\n          {/* Profile Card */}\n          <Card>\n            <CardHeader className=\"text-center\">\n              <div className=\"relative mx-auto mb-4\">\n                // eslint-disable-next-line @next/next/no-img-element\n                <img\n                  src={profile.avatar_url || '/api/placeholder/150/150'}\n                  alt={profile.full_name}\n                  className=\"w-32 h-32 rounded-full object-cover mx-auto\"\n                />\n                {profile.verified_at && (\n                  <div className=\"absolute -bottom-2 -right-2 bg-blue-500 text-white rounded-full p-1\">\n                    <CheckCircle className=\"h-5 w-5\" />\n                  </div>\n                )}\n              </div>\n              <CardTitle className=\"text-xl\">{profile.full_name}</CardTitle>\n              <p className=\"text-gray-600\">{profile.email}</p>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              {/* Rating */}\n              <div className=\"flex items-center justify-center space-x-2\">\n                <div className=\"flex items-center space-x-1\">\n                  {[...Array(5)].map((_, i) => (\n                    <Star\n                      key={i}\n                      className={`h-4 w-4 ${\n                        i < Math.floor(profile.rating)\n                          ? 'text-yellow-400 fill-current'\n                          : 'text-gray-300'\n                      }`}\n                    />\n                  ))}\n                </div>\n                <span className=\"text-sm text-gray-600\">\n                  {profile.rating} ({profile.total_reviews} reviews)\n                </span>\n              </div>\n\n              {/* Stats */}\n              <div className=\"grid grid-cols-2 gap-4 text-center\">\n                <div>\n                  <div className=\"text-2xl font-bold text-blue-600\">\n                    {profile.completed_bookings}\n                  </div>\n                  <div className=\"text-sm text-gray-600\">Completed</div>\n                </div>\n                <div>\n                  <div className=\"text-2xl font-bold text-green-600\">\n                    {profile.completion_rate}%\n                  </div>\n                  <div className=\"text-sm text-gray-600\">Success Rate</div>\n                </div>\n              </div>\n\n              {/* Quick Info */}\n              <div className=\"space-y-2 text-sm\">\n                <div className=\"flex items-center space-x-2\">\n                  <MapPin className=\"h-4 w-4 text-gray-400\" />\n                  <span>Service Area: {profile.service_area_radius}km</span>\n                </div>\n                <div className=\"flex items-center space-x-2\">\n                  <Clock className=\"h-4 w-4 text-gray-400\" />\n                  <span>Response: {profile.response_time_avg}min avg</span>\n                </div>\n                <div className=\"flex items-center space-x-2\">\n                  <DollarSign className=\"h-4 w-4 text-gray-400\" />\n                  <span>${profile.hourly_rate}/hr</span>\n                </div>\n              </div>\n\n              {/* Profile Completion */}\n              <div className=\"pt-4 border-t\">\n                <div className=\"flex items-center justify-between mb-2\">\n                  <span className=\"text-sm font-medium\">Profile Completion</span>\n                  <span className=\"text-sm text-blue-600 font-bold\">\n                    {profile.profile_completion_score}%\n                  </span>\n                </div>\n                <div className=\"w-full bg-gray-200 rounded-full h-2\">\n                  <div\n                    className=\"bg-blue-600 h-2 rounded-full transition-all duration-300\"\n                    style={{ width: `${profile.profile_completion_score}%` }}\n                  ></div>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* Specializations */}\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"text-lg\">Specializations</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"flex flex-wrap gap-2\">\n                {profile.specializations.map((spec, index) => (\n                  <Badge key={index} variant=\"secondary\">\n                    {spec}\n                  </Badge>\n                ))}\n              </div>\n            </CardContent>\n          </Card>\n\n          {/* Languages */}\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"text-lg flex items-center space-x-2\">\n                <Globe className=\"h-5 w-5\" />\n                <span>Languages</span>\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              <div className=\"space-y-2\">\n                {profile.languages.map((lang, index) => (\n                  <div key={index} className=\"flex items-center space-x-2\">\n                    <div className=\"w-2 h-2 bg-blue-500 rounded-full\"></div>\n                    <span className=\"text-sm\">{lang}</span>\n                  </div>\n                ))}\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n\n        {/* Main Content */}\n        <div className=\"lg:col-span-2\">\n          <Tabs defaultValue=\"overview\" className=\"w-full\">\n            <TabsList className=\"grid w-full grid-cols-4\">\n              <TabsTrigger value=\"overview\">Overview</TabsTrigger>\n              <TabsTrigger value=\"certifications\">Certifications</TabsTrigger>\n              <TabsTrigger value=\"education\">Education</TabsTrigger>\n              <TabsTrigger value=\"edit\">Edit Profile</TabsTrigger>\n            </TabsList>\n\n            {/* Overview Tab */}\n            <TabsContent value=\"overview\" className=\"space-y-6\">\n              {/* Professional Summary */}\n              <Card>\n                <CardHeader>\n                  <CardTitle>Professional Summary</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  <p className=\"text-gray-700 leading-relaxed\">\n                    {profile.professional_summary || 'No professional summary available.'}\n                  </p>\n                </CardContent>\n              </Card>\n\n              {/* Bio */}\n              <Card>\n                <CardHeader>\n                  <CardTitle>About Me</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  <p className=\"text-gray-700 leading-relaxed\">\n                    {profile.bio || 'No bio available.'}\n                  </p>\n                </CardContent>\n              </Card>\n\n              {/* Experience & Stats */}\n              <Card>\n                <CardHeader>\n                  <CardTitle>Experience & Performance</CardTitle>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6\">\n                    <div className=\"text-center\">\n                      <div className=\"text-3xl font-bold text-blue-600\">\n                        {profile.experience_years}+\n                      </div>\n                      <div className=\"text-sm text-gray-600\">Years Experience</div>\n                    </div>\n                    <div className=\"text-center\">\n                      <div className=\"text-3xl font-bold text-green-600\">\n                        {profile.total_bookings}\n                      </div>\n                      <div className=\"text-sm text-gray-600\">Total Bookings</div>\n                    </div>\n                    <div className=\"text-center\">\n                      <div className=\"text-3xl font-bold text-purple-600\">\n                        {profile.avg_service_price}\n                      </div>\n                      <div className=\"text-sm text-gray-600\">Avg Service Price</div>\n                    </div>\n                  </div>\n                </CardContent>\n              </Card>\n            </TabsContent>\n\n            {/* Certifications Tab */}\n            <TabsContent value=\"certifications\" className=\"space-y-6\">\n              <Card>\n                <CardHeader>\n                  <CardTitle className=\"flex items-center space-x-2\">\n                    <Award className=\"h-5 w-5\" />\n                    <span>Certifications</span>\n                  </CardTitle>\n                </CardHeader>\n                <CardContent>\n                  {profile.certifications.length > 0 ? (\n                    <div className=\"space-y-4\">\n                      {profile.certifications.map((cert) => (\n                        <div key={cert.id} className=\"border rounded-lg p-4\">\n                          <div className=\"flex items-start justify-between\">\n                            <div>\n                              <h4 className=\"font-semibold text-lg\">{cert.certification_name}</h4>\n                              <p className=\"text-gray-600\">{cert.issuing_organization}</p>\n                              <div className=\"flex items-center space-x-4 mt-2 text-sm text-gray-500\">\n                                {cert.issue_date && (\n                                  <span>Issued: {new Date(cert.issue_date).toLocaleDateString()}</span>\n                                )}\n                                {cert.expiry_date && (\n                                  <span>Expires: {new Date(cert.expiry_date).toLocaleDateString()}</span>\n                                )}\n                              </div>\n                            </div>\n                            <Badge\n                              variant={cert.verification_status === 'verified' ? 'default' : 'secondary'}\n                              className=\"capitalize\"\n                            >\n                              {cert.verification_status}\n                            </Badge>\n                          </div>\n                        </div>\n                      ))}\n                    </div>\n                  ) : (\n                    <p className=\"text-gray-500 text-center py-8\">\n                      No certifications added yet.\n                    </p>\n                  )}\n                </CardContent>\n              </Card>\n            </TabsContent>\n\n            {/* Education Tab */}\n            <TabsContent value=\"education\" className=\"space-y-6\">\n              <Card>\n                <CardHeader>\n                  <CardTitle className=\"flex items-center space-x-2\">\n                    <GraduationCap className=\"h-5 w-5\" />\n                    <span>Education</span>\n                  </CardTitle>\n                </CardHeader>\n                <CardContent>\n                  {profile.education.length > 0 ? (\n                    <div className=\"space-y-4\">\n                      {profile.education.map((edu) => (\n                        <div key={edu.id} className=\"border rounded-lg p-4\">\n                          <h4 className=\"font-semibold text-lg\">{edu.institution_name}</h4>\n                          <p className=\"text-gray-600\">\n                            {edu.degree_type && (\n                              <span className=\"capitalize\">{edu.degree_type}</span>\n                            )}\n                            {edu.field_of_study && ` in ${edu.field_of_study}`}\n                          </p>\n                          <p className=\"text-sm text-gray-500 mt-1\">\n                            {edu.start_year} - {edu.is_current ? 'Present' : edu.end_year}\n                          </p>\n                          {edu.description && (\n                            <p className=\"text-gray-700 mt-2\">{edu.description}</p>\n                          )}\n                        </div>\n                      ))}\n                    </div>\n                  ) : (\n                    <p className=\"text-gray-500 text-center py-8\">\n                      No education information added yet.\n                    </p>\n                  )}\n                </CardContent>\n              </Card>\n            </TabsContent>\n\n            {/* Edit Profile Tab */}\n            <TabsContent value=\"edit\" className=\"space-y-6\">\n              <ProfileEditor\n                profile={profile}\n                onSave={handleSaveProfile}\n              />\n            </TabsContent>\n          </Tabs>\n        </div>\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\app\\settings\\page.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'supabaseBrowserClient' is defined but never used. Allowed unused vars must match /^_/u.","line":5,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":5,"endColumn":31}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { useEffect } from 'react';\r\nimport { useRouter } from 'next/navigation';\r\nimport { supabaseBrowserClient } from '@/lib/supabaseClient';\r\n\r\nexport default function SettingsPage() {\r\n  const router = useRouter();\r\n\r\n  useEffect(() => {\r\n    // Redirect to notifications page as the default settings page\r\n    router.replace('/settings/notifications');\r\n  }, [router]);\r\n\r\n  return (\r\n    <div className=\"container mx-auto py-10 max-w-2xl\">\r\n      <div className=\"flex items-center justify-center min-h-[400px]\">\r\n        <div className=\"text-center\">\r\n          <div className=\"animate-spin w-8 h-8 border-2 border-blue-600 border-t-transparent rounded-full mx-auto mb-4\"></div>\r\n          <p className=\"text-muted-foreground\">Loading settings...</p>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\audit\\diff.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'AnalyticsEnvelope' is defined but never used. Allowed unused vars must match /^_/u.","line":1,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":1,"endColumn":27}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { AnalyticsEnvelope } from \"@/contracts/analytics/AnalyticsEnvelope\";\nimport { AuditFrame, AuditTimeline, DiffExplanation, TimelineDiff } from \"./types\";\nimport {\n  computeP95,\n  deepFreeze,\n  deriveDomain,\n  extractLatencyCandidate,\n  governanceFallback,\n} from \"./utils\";\n\ninterface TimelineSummary {\n  eventCounts: Record<string, number>;\n  trustSafetySignals: Set<string>;\n  latencies: number[];\n  bookings: number;\n  cancellations: number;\n  byDomain: Map<string, AuditFrame>;\n}\n\nfunction summarizeTimeline(timeline: AuditTimeline): TimelineSummary {\n  const eventCounts: Record<string, number> = {};\n  const trustSafetySignals = new Set<string>();\n  const latencies: number[] = [];\n  let bookings = 0;\n  let cancellations = 0;\n  const byDomain = new Map<string, AuditFrame>();\n\n  timeline.frames.forEach((frame) => {\n    const type = frame.envelope.event.type;\n    eventCounts[type] = (eventCounts[type] ?? 0) + 1;\n    if (type === \"booking.created\") bookings += 1;\n    if (type === \"booking.cancelled\") cancellations += 1;\n\n    frame.trustSafety?.signals.forEach((signal) => trustSafetySignals.add(signal));\n\n    const latency = extractLatencyCandidate(frame.envelope.metadata as Record<string, unknown>);\n    if (typeof latency === \"number\") {\n      latencies.push(latency);\n    }\n\n    if (!byDomain.has(frame.governance.domain)) {\n      byDomain.set(frame.governance.domain, frame);\n    }\n  });\n\n  return { eventCounts, trustSafetySignals, latencies, bookings, cancellations, byDomain };\n}\n\nfunction diffIds(left: readonly AuditFrame[], right: readonly AuditFrame[]): string[] {\n  const rightIds = new Set(right.map((frame) => frame.id));\n  return left.filter((frame) => !rightIds.has(frame.id)).map((frame) => frame.id);\n}\n\nfunction createExplanation(input: {\n  description: string;\n  signals: string[];\n  frame?: AuditFrame;\n  fallbackDomain: string;\n}): DiffExplanation {\n  const governance =\n    input.frame?.governance ??\n    governanceFallback(input.fallbackDomain);\n\n  return deepFreeze({\n    description: input.description,\n    signals: input.signals,\n    governance,\n    evolution: input.frame?.evolution,\n    syntheticContext: input.frame?.syntheticContext,\n  });\n}\n\nfunction normalizeDeltas(base: Record<string, number>, variant: Record<string, number>): Record<string, number> {\n  const keys = Array.from(new Set([...Object.keys(base), ...Object.keys(variant)])).sort();\n  const result: Record<string, number> = {};\n  keys.forEach((key) => {\n    result[key] = (variant[key] ?? 0) - (base[key] ?? 0);\n  });\n  return result;\n}\n\nfunction selectFrameForDomain(timeline: AuditTimeline, domain: string): AuditFrame | undefined {\n  return timeline.frames.find((frame) => frame.governance.domain === domain);\n}\n\nexport function diffTimelines(baseline: AuditTimeline, comparison: AuditTimeline): TimelineDiff {\n  const baselineSummary = summarizeTimeline(baseline);\n  const comparisonSummary = summarizeTimeline(comparison);\n\n  const missingInComparison = diffIds(baseline.frames, comparison.frames);\n  const missingInBaseline = diffIds(comparison.frames, baseline.frames);\n  const metricDivergence = normalizeDeltas(baselineSummary.eventCounts, comparisonSummary.eventCounts);\n\n  const trustSafetyChanges: string[] = [];\n  comparisonSummary.trustSafetySignals.forEach((signal) => {\n    if (!baselineSummary.trustSafetySignals.has(signal)) {\n      trustSafetyChanges.push(`Added trust-safety signal \"${signal}\"`);\n    }\n  });\n  baselineSummary.trustSafetySignals.forEach((signal) => {\n    if (!comparisonSummary.trustSafetySignals.has(signal)) {\n      trustSafetyChanges.push(`Missing trust-safety signal \"${signal}\"`);\n    }\n  });\n\n  const sloImpacts = {\n    latencyP95Delta: computeP95(comparisonSummary.latencies) - computeP95(baselineSummary.latencies),\n    bookingDelta: comparisonSummary.bookings - baselineSummary.bookings,\n    cancellationDelta: comparisonSummary.cancellations - baselineSummary.cancellations,\n  };\n\n  const explanations: DiffExplanation[] = [];\n\n  Object.entries(metricDivergence)\n    .filter(([, delta]) => delta !== 0)\n    .forEach(([eventType, delta]) => {\n      const domain = deriveDomain(eventType);\n      const frame = selectFrameForDomain(comparison, domain) ?? selectFrameForDomain(baseline, domain);\n      explanations.push(\n        createExplanation({\n          description: `${eventType} diverged by ${delta} events`,\n          signals: [eventType],\n          frame,\n          fallbackDomain: domain,\n        })\n      );\n    });\n\n  trustSafetyChanges.forEach((change) => {\n    const frame = comparison.frames.find((candidate) => candidate.trustSafety?.signals.length);\n    const domain = frame?.governance.domain ?? \"unknown\";\n    explanations.push(\n      createExplanation({\n        description: change,\n        signals: frame?.trustSafety?.signals ? [...frame.trustSafety.signals] : [],\n        frame,\n        fallbackDomain: domain,\n      })\n    );\n  });\n\n  missingInComparison.forEach((id) => {\n    const frame = baseline.frames.find((candidate) => candidate.id === id);\n    const domain = frame?.governance.domain ?? \"unknown\";\n    explanations.push(\n      createExplanation({\n        description: `Event ${id} missing in comparison timeline`,\n        signals: [frame?.envelope.event.type ?? \"unknown\"],\n        frame,\n        fallbackDomain: domain,\n      })\n    );\n  });\n\n  missingInBaseline.forEach((id) => {\n    const frame = comparison.frames.find((candidate) => candidate.id === id);\n    const domain = frame?.governance.domain ?? \"unknown\";\n    explanations.push(\n      createExplanation({\n        description: `Event ${id} missing in baseline timeline`,\n        signals: [frame?.envelope.event.type ?? \"unknown\"],\n        frame,\n        fallbackDomain: domain,\n      })\n    );\n  });\n\n  const sortedExplanations = explanations.sort((a, b) => a.description.localeCompare(b.description));\n\n  return deepFreeze({\n    baselineId: baseline.id,\n    comparisonId: comparison.id,\n    missingInComparison,\n    missingInBaseline,\n    metricDivergence,\n    trustSafetyChanges,\n    sloImpacts,\n    explanations: sortedExplanations,\n  });\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\components\\HeatmapVisualization.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Badge' is defined but never used. Allowed unused vars must match /^_/u.","line":7,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":7,"endColumn":15},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Users' is defined but never used. Allowed unused vars must match /^_/u.","line":9,"column":30,"nodeType":null,"messageId":"unusedVar","endLine":9,"endColumn":35}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchHeatmapData'. Either include it or remove the dependency array.","line":76,"column":6,"nodeType":"ArrayExpression","endLine":76,"endColumn":43,"suggestions":[{"desc":"Update the dependencies array to be: [timeRange, serviceType, minBookings, fetchHeatmapData]","fix":{"range":[2326,2363],"text":"[timeRange, serviceType, minBookings, fetchHeatmapData]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\n\nimport { useState, useEffect, useRef } from 'react';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Button } from '@/components/ui/button';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { Badge } from '@/components/ui/badge';\n// import { Slider } from '@/components/ui/slider';\nimport { MapPin, TrendingUp, Users, DollarSign, Calendar, RefreshCw } from 'lucide-react';\n\ninterface HeatmapDataPoint {\n  postal_code: string;\n  latitude: number;\n  longitude: number;\n  booking_count: number;\n  revenue: number;\n  avg_rating: number;\n  unique_providers: number;\n  last_booking: string;\n}\n\ninterface HeatmapProps {\n  userId?: string;\n  className?: string;\n  height?: number;\n  showControls?: boolean;\n  defaultTimeRange?: '7d' | '30d' | '90d' | '1y';\n}\n\nexport default function HeatmapVisualization({ \n  _userId, \n  className = '', \n  height = 400,\n  showControls = true,\n  defaultTimeRange = '30d'\n}: HeatmapProps) {\n  const [data, setData] = useState<HeatmapDataPoint[]>([]);\n  const [loading, setLoading] = useState(false);\n  const [error, setError] = useState<string | null>(null);\n  const [timeRange, setTimeRange] = useState(defaultTimeRange);\n  const [serviceType, setServiceType] = useState<string>('');\n  const [minBookings, setMinBookings] = useState([1]);\n  const [selectedPoint, setSelectedPoint] = useState<HeatmapDataPoint | null>(null);\n  const mapRef = useRef<HTMLDivElement>(null);\n\n  const fetchHeatmapData = async () => {\n    setLoading(true);\n    setError(null);\n    \n    try {\n      const params = new URLSearchParams({\n        timeRange,\n        minBookings: minBookings[0].toString(),\n        ...(serviceType && { serviceType })\n      });\n\n      const response = await fetch(`/api/analytics/heatmap?${params}`);\n      const result = await response.json();\n\n      if (result.success) {\n        setData(result.data || []);\n      } else {\n        setError(result.error || 'Failed to fetch heatmap data');\n      }\n    } catch (err) {\n      console.error('Heatmap fetch error:', err);\n      setError('Error loading heatmap data');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  useEffect(() => {\n    fetchHeatmapData();\n  // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [timeRange, serviceType, minBookings]);\n\n  // Calculate color intensity based on booking count\n  const getHeatColor = (bookingCount: number, maxBookings: number): string => {\n    const intensity = bookingCount / maxBookings;\n    const red = Math.min(255, Math.floor(255 * intensity));\n    const blue = Math.max(0, Math.floor(255 * (1 - intensity)));\n    return `rgb(${red}, 100, ${blue})`;\n  };\n\n  // Get statistics\n  const stats = data.length > 0 ? {\n    totalBookings: data.reduce((sum, point) => sum + point.booking_count, 0),\n    totalRevenue: data.reduce((sum, point) => sum + point.revenue, 0),\n    avgRating: data.reduce((sum, point) => sum + point.avg_rating, 0) / data.length,\n    uniqueAreas: data.length,\n    maxBookings: Math.max(...data.map(point => point.booking_count))\n  } : {\n    totalBookings: 0,\n    totalRevenue: 0,\n    avgRating: 0,\n    uniqueAreas: 0,\n    maxBookings: 0\n  };\n\n  const serviceTypes = [\n    { value: '', label: 'All Services' },\n    { value: 'haircut', label: 'Haircut' },\n    { value: 'massage', label: 'Massage' },\n    { value: 'cleaning', label: 'Cleaning' },\n    { value: 'tutoring', label: 'Tutoring' },\n    { value: 'photography', label: 'Photography' },\n    { value: 'fitness', label: 'Fitness Training' },\n    { value: 'beauty', label: 'Beauty Services' },\n    { value: 'handyman', label: 'Handyman' },\n    { value: 'catering', label: 'Catering' },\n    { value: 'other', label: 'Other' }\n  ];\n\n  return (\n    <div className={`space-y-4 ${className}`}>\n      {/* Controls */}\n      {showControls && (\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center space-x-2\">\n              <MapPin className=\"h-5 w-5\" />\n              <span>Booking Heatmap Controls</span>\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n              <div>\n                <label className=\"block text-sm font-medium mb-2\">Time Range</label>\n                <Select value={timeRange} onValueChange={(value: string) => setTimeRange(value as typeof timeRange)}>\n                  <SelectTrigger>\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"7d\">Last 7 Days</SelectItem>\n                    <SelectItem value=\"30d\">Last 30 Days</SelectItem>\n                    <SelectItem value=\"90d\">Last 90 Days</SelectItem>\n                    <SelectItem value=\"1y\">Last Year</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n              \n              <div>\n                <label className=\"block text-sm font-medium mb-2\">Service Type</label>\n                <Select value={serviceType} onValueChange={setServiceType}>\n                  <SelectTrigger>\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {serviceTypes.map(type => (\n                      <SelectItem key={type.value} value={type.value}>\n                        {type.label}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n\n              <div>\n                <label className=\"block text-sm font-medium mb-2\">\n                  Min Bookings: {minBookings[0]}\n                </label>\n                <input\n                  type=\"range\"\n                  value={minBookings[0]}\n                  onChange={(e) => setMinBookings([parseInt(e.target.value)])}\n                  max={20}\n                  min={1}\n                  step={1}\n                  className=\"w-full mt-2\"\n                />\n              </div>\n\n              <div className=\"flex items-end\">\n                <Button onClick={fetchHeatmapData} disabled={loading} className=\"w-full\">\n                  <RefreshCw className={`h-4 w-4 mr-2 ${loading ? 'animate-spin' : ''}`} />\n                  Refresh\n                </Button>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      )}\n\n      {/* Statistics */}\n      <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n        <Card>\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-center space-x-2\">\n              <Calendar className=\"h-4 w-4 text-blue-500\" />\n              <div>\n                <p className=\"text-sm text-gray-600\">Total Bookings</p>\n                <p className=\"text-xl font-bold\">{stats.totalBookings.toLocaleString()}</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-center space-x-2\">\n              <DollarSign className=\"h-4 w-4 text-green-500\" />\n              <div>\n                <p className=\"text-sm text-gray-600\">Total Revenue</p>\n                <p className=\"text-xl font-bold\">${stats.totalRevenue.toLocaleString()}</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-center space-x-2\">\n              <TrendingUp className=\"h-4 w-4 text-purple-500\" />\n              <div>\n                <p className=\"text-sm text-gray-600\">Avg Rating</p>\n                <p className=\"text-xl font-bold\">{stats.avgRating.toFixed(1)}â­</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-center space-x-2\">\n              <MapPin className=\"h-4 w-4 text-orange-500\" />\n              <div>\n                <p className=\"text-sm text-gray-600\">Areas Covered</p>\n                <p className=\"text-xl font-bold\">{stats.uniqueAreas}</p>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Main Heatmap Display */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Booking Density Heatmap</CardTitle>\n        </CardHeader>\n        <CardContent>\n          {loading ? (\n            <div className=\"flex items-center justify-center h-64\">\n              <div className=\"text-center\">\n                <RefreshCw className=\"h-8 w-8 animate-spin mx-auto mb-2\" />\n                <p>Loading heatmap data...</p>\n              </div>\n            </div>\n          ) : error ? (\n            <div className=\"flex items-center justify-center h-64\">\n              <div className=\"text-center text-red-500\">\n                <p>{error}</p>\n                <Button onClick={fetchHeatmapData} className=\"mt-2\">\n                  Try Again\n                </Button>\n              </div>\n            </div>\n          ) : data.length === 0 ? (\n            <div className=\"flex items-center justify-center h-64\">\n              <div className=\"text-center text-gray-500\">\n                <MapPin className=\"h-12 w-12 mx-auto mb-2 opacity-50\" />\n                <p>No booking data available for the selected criteria</p>\n                <p className=\"text-sm\">Try adjusting the filters above</p>\n              </div>\n            </div>\n          ) : (\n            <div className=\"space-y-4\">\n              {/* Simple heatmap representation using a grid */}\n              <div \n                ref={mapRef}\n                className=\"border rounded-lg p-4 bg-gray-50\"\n                style={{ height: `${height}px` }}\n              >\n                <div className=\"h-full overflow-auto\">\n                  <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-2\">\n                    {data.map((point, _index) => (\n                      <div\n                        key={point.postal_code}\n                        className=\"border rounded p-3 cursor-pointer transition-all hover:shadow-lg\"\n                        style={{\n                          backgroundColor: getHeatColor(point.booking_count, stats.maxBookings),\n                          color: point.booking_count > stats.maxBookings * 0.5 ? 'white' : 'black'\n                        }}\n                        onClick={() => setSelectedPoint(point)}\n                      >\n                        <div className=\"text-sm font-bold\">{point.postal_code}</div>\n                        <div className=\"text-xs\">\n                          <div>{point.booking_count} bookings</div>\n                          <div>${point.revenue.toFixed(0)}</div>\n                          <div>{point.avg_rating.toFixed(1)}â­</div>\n                        </div>\n                      </div>\n                    ))}\n                  </div>\n                </div>\n              </div>\n\n              {/* Legend */}\n              <div className=\"flex items-center space-x-4 text-sm\">\n                <span>Heat Intensity:</span>\n                <div className=\"flex items-center space-x-1\">\n                  <div className=\"w-4 h-4 bg-blue-500\" title=\"Low activity\"></div>\n                  <span>Low</span>\n                </div>\n                <div className=\"flex items-center space-x-1\">\n                  <div className=\"w-4 h-4 bg-purple-500\" title=\"Medium activity\"></div>\n                  <span>Medium</span>\n                </div>\n                <div className=\"flex items-center space-x-1\">\n                  <div className=\"w-4 h-4 bg-red-500\" title=\"High activity\"></div>\n                  <span>High</span>\n                </div>\n              </div>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Selected Point Details */}\n      {selectedPoint && (\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center justify-between\">\n              <span>Area Details: {selectedPoint.postal_code}</span>\n              <Button variant=\"outline\" size=\"sm\" onClick={() => setSelectedPoint(null)}>\n                Close\n              </Button>\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n              <div>\n                <p className=\"text-sm text-gray-600\">Bookings</p>\n                <p className=\"text-xl font-bold\">{selectedPoint.booking_count}</p>\n              </div>\n              <div>\n                <p className=\"text-sm text-gray-600\">Revenue</p>\n                <p className=\"text-xl font-bold\">${selectedPoint.revenue.toFixed(2)}</p>\n              </div>\n              <div>\n                <p className=\"text-sm text-gray-600\">Avg Rating</p>\n                <p className=\"text-xl font-bold\">{selectedPoint.avg_rating.toFixed(1)}â­</p>\n              </div>\n              <div>\n                <p className=\"text-sm text-gray-600\">Providers</p>\n                <p className=\"text-xl font-bold\">{selectedPoint.unique_providers}</p>\n              </div>\n            </div>\n            <div className=\"mt-4\">\n              <p className=\"text-sm text-gray-600\">Location</p>\n              <p className=\"font-medium\">\n                {selectedPoint.latitude.toFixed(6)}, {selectedPoint.longitude.toFixed(6)}\n              </p>\n              <p className=\"text-sm text-gray-500 mt-2\">\n                Last booking: {new Date(selectedPoint.last_booking).toLocaleDateString()}\n              </p>\n            </div>\n          </CardContent>\n        </Card>\n      )}\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\components\\ImageAttachment.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Badge' is defined but never used. Allowed unused vars must match /^_/u.","line":6,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":6,"endColumn":15},{"ruleId":"react/jsx-no-comment-textnodes","severity":2,"message":"Comments inside children section of tag should be placed inside braces","line":245,"column":71,"nodeType":"JSXText","messageId":"putCommentInBraces","endLine":247,"endColumn":21},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":247,"column":21,"nodeType":"JSXOpeningElement","endLine":251,"endColumn":23},{"ruleId":"react/jsx-no-comment-textnodes","severity":2,"message":"Comments inside children section of tag should be placed inside braces","line":365,"column":74,"nodeType":"JSXText","messageId":"putCommentInBraces","endLine":367,"endColumn":13},{"ruleId":"jsx-a11y/alt-text","severity":1,"message":"Image elements must have an alt prop, either with meaningful text, or an empty string for decorative images.","line":367,"column":13,"nodeType":"JSXOpeningElement","endLine":367,"endColumn":69}],"suppressedMessages":[{"ruleId":"jsx-a11y/alt-text","severity":1,"message":"Image elements must have an alt prop, either with meaningful text, or an empty string for decorative images.","line":167,"column":43,"nodeType":"JSXOpeningElement","endLine":167,"endColumn":72,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":2,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useState, useRef, useCallback } from 'react'\nimport { Button } from '@/components/ui/button'\nimport { Card, CardContent } from '@/components/ui/card'\nimport { Badge } from '@/components/ui/badge'\nimport { Input } from '@/components/ui/input'\nimport { Label } from '@/components/ui/label'\nimport { Textarea } from '@/components/ui/textarea'\nimport { Image, Upload, X, Eye, Download, FileText, Sparkles } from 'lucide-react'\nimport { cn } from '@/lib/utils'\n\ninterface ImageAttachmentProps {\n  images: File[];\n  onImagesChangeAction: (images: File[]) => void;\n  maxImages?: number;\n  maxSizeMB?: number;\n  acceptedTypes?: string[];\n  className?: string;\n}\n\nexport function ImageAttachment({\n  images,\n  onImagesChangeAction,\n  maxImages = 5,\n  maxSizeMB = 10,\n  acceptedTypes = ['image/jpeg', 'image/png', 'image/webp'],\n  className = ''\n}: ImageAttachmentProps) {\n  const [isDragOver, setIsDragOver] = useState(false)\n  const [isProcessing, setIsProcessing] = useState(false)\n  const [summary, setSummary] = useState('')\n  const [error, setError] = useState<string | null>(null)\n  \n  const fileInputRef = useRef<HTMLInputElement>(null)\n  const dropZoneRef = useRef<HTMLDivElement>(null)\n\n  // Handle file selection\n  const handleFileSelect = useCallback((files: FileList | null) => {\n    if (!files) return\n\n    const newImages: File[] = []\n    const errors: string[] = []\n\n    Array.from(files).forEach((file) => {\n      // Validate file type\n      if (!acceptedTypes.includes(file.type)) {\n        errors.push(`${file.name} is not a supported image type`)\n        return\n      }\n\n      // Validate file size\n      if (file.size > maxSizeMB * 1024 * 1024) {\n        errors.push(`${file.name} is too large (max ${maxSizeMB}MB)`)\n        return\n      }\n\n      // Check if we've reached max files\n      if (images.length + newImages.length >= maxImages) {\n        errors.push(`Maximum ${maxImages} images allowed`)\n        return\n      }\n\n      newImages.push(file)\n    })\n\n    // Show errors if any\n    if (errors.length > 0) {\n      setError(errors.join(', '))\n      setTimeout(() => setError(null), 5000)\n    }\n\n    // Add new images\n    if (newImages.length > 0) {\n      const updatedImages = [...images, ...newImages]\n      onImagesChangeAction(updatedImages)\n    }\n  }, [images, maxImages, maxSizeMB, acceptedTypes, onImagesChangeAction])\n\n  // Handle drag and drop\n  const handleDragOver = useCallback((e: React.DragEvent) => {\n    e.preventDefault()\n    setIsDragOver(true)\n  }, [])\n\n  const handleDragLeave = useCallback((e: React.DragEvent) => {\n    e.preventDefault()\n    setIsDragOver(false)\n  }, [])\n\n  const handleDrop = useCallback((e: React.DragEvent) => {\n    e.preventDefault()\n    setIsDragOver(false)\n    \n    const files = e.dataTransfer.files\n    handleFileSelect(files)\n  }, [handleFileSelect])\n\n  // Remove image\n  const removeImage = useCallback((id: string) => {\n    const updatedImages = images.filter(img => img.name !== id) // Assuming name is unique for now\n    onImagesChangeAction(updatedImages)\n  }, [images, onImagesChangeAction])\n\n  // Generate AI summary\n  const generateSummary = useCallback(async () => {\n    if (images.length === 0) return\n\n    setIsProcessing(true)\n    setError(null)\n\n    try {\n      // Create FormData with images\n      const formData = new FormData()\n      images.forEach((img, index) => {\n        formData.append(`image_${index}`, img)\n      })\n\n      // Call AI summarization API\n      const response = await fetch('/api/ai/summarize-images', {\n        method: 'POST',\n        body: formData\n      })\n\n      if (!response.ok) {\n        throw new Error('Failed to generate summary')\n      }\n\n      const data = await response.json()\n      const aiSummary = data.summary\n\n      setSummary(aiSummary)\n      // onSummaryChange?.(aiSummary) // This prop was removed from interface\n\n      // Update images with summaries\n      // This part of the logic needs to be adapted to the new ImageFile interface\n      // For now, we'll just update the summary in the state\n      const updatedImages = images.map((img, index) => ({\n        ...img,\n        summary: data.imageSummaries?.[index] || '',\n        isProcessing: false\n      }))\n\n      // onImagesChange(updatedImages) // This prop was removed from interface\n      onImagesChangeAction(updatedImages) // Use the new prop\n\n    } catch (err) {\n      console.error('Failed to generate summary:', err)\n      setError('Failed to generate AI summary. Please try again.')\n    } finally {\n      setIsProcessing(false)\n    }\n  }, [images, onImagesChangeAction])\n\n  // Format file size\n  const formatFileSize = (bytes: number): string => {\n    if (bytes === 0) return '0 Bytes'\n    const k = 1024\n    const sizes = ['Bytes', 'KB', 'MB', 'GB']\n    const i = Math.floor(Math.log(bytes) / Math.log(k))\n    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i]\n  }\n\n  // Get file type icon\n  const getFileTypeIcon = (type: string) => {\n    // eslint-disable-next-line jsx-a11y/alt-text\n    if (type.startsWith('image/')) return <Image className=\"h-4 w-4\" />\n    return <FileText className=\"h-4 w-4\" />\n  }\n\n  return (\n    <div className={cn(\"space-y-4\", className)}>\n      {/* File Input */}\n      <div className=\"space-y-2\">\n        <Label htmlFor=\"image-upload\">Attach Images</Label>\n        <Input\n          id=\"image-upload\"\n          ref={fileInputRef}\n          type=\"file\"\n          multiple\n          accept={acceptedTypes.join(',')}\n          onChange={(e) => handleFileSelect(e.target.files)}\n          disabled={images.length >= maxImages}\n          className=\"hidden\"\n        />\n        \n        {/* Drop Zone */}\n        <div\n          ref={dropZoneRef}\n          className={cn(\n            \"border-2 border-dashed rounded-lg p-6 text-center transition-colors cursor-pointer\",\n            isDragOver \n              ? \"border-blue-500 bg-blue-50\" \n              : \"border-gray-300 hover:border-gray-400 hover:bg-gray-50\",\n            // disabled && \"opacity-50 cursor-not-allowed\" // This prop was removed from interface\n          )}\n          onDragOver={handleDragOver}\n          onDragLeave={handleDragLeave}\n          onDrop={handleDrop}\n          onClick={() => fileInputRef.current?.click()}\n        >\n          <Upload className=\"h-8 w-8 mx-auto mb-2 text-gray-400\" />\n          <p className=\"text-sm text-gray-600\">\n            {isDragOver \n              ? \"Drop images here\" \n              : \"Drag & drop images here or click to browse\"\n            }\n          </p>\n          <p className=\"text-xs text-gray-500 mt-1\">\n            Max {maxImages} files, {maxSizeMB}MB each. Supported: JPEG, PNG, WebP\n          </p>\n        </div>\n      </div>\n\n      {/* Error Display */}\n      {error && (\n        <Card className=\"border-red-200 bg-red-50\">\n          <CardContent className=\"p-3\">\n            <p className=\"text-sm text-red-700\">{error}</p>\n          </CardContent>\n        </Card>\n      )}\n\n      {/* Image Grid */}\n      {images.length > 0 && (\n        <div className=\"space-y-4\">\n          <div className=\"flex justify-between items-center\">\n            <h4 className=\"font-medium\">Attached Images ({images.length}/{maxImages})</h4>\n            <Button\n              onClick={generateSummary}\n              disabled={isProcessing}\n              size=\"sm\"\n              className=\"flex items-center gap-2\"\n            >\n              <Sparkles className=\"h-4 w-4\" />\n              {isProcessing ? 'Processing...' : 'Generate AI Summary'}\n            </Button>\n          </div>\n\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n            {images.map((image) => (\n              <Card key={image.name} className=\"overflow-hidden\">\n                <CardContent className=\"p-0\">\n                  {/* Image Preview */}\n                  <div className=\"relative aspect-square bg-gray-100\">\n                    // eslint-disable-next-line @next/next/no-img-element\n                    <img\n                      src={URL.createObjectURL(image)}\n                      alt={image.name}\n                      className=\"w-full h-full object-cover\"\n                    />\n                    \n                    {/* Remove Button */}\n                    <Button\n                      onClick={() => removeImage(image.name)}\n                      variant=\"destructive\"\n                      size=\"sm\"\n                      className=\"absolute top-2 right-2 h-6 w-6 p-0\"\n                      // disabled={disabled} // This prop was removed from interface\n                    >\n                      <X className=\"h-3 w-3\" />\n                    </Button>\n\n                    {/* Processing Indicator */}\n                    {/* This part of the logic needs to be adapted to the new ImageFile interface */}\n                    {/* For now, we'll just show a placeholder */}\n                    {/* {image.isProcessing && (\n                      <div className=\"absolute inset-0 bg-black/50 flex items-center justify-center\">\n                        <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-white\" />\n                      </div>\n                    )} */}\n                  </div>\n\n                  {/* Image Info */}\n                  <div className=\"p-3 space-y-2\">\n                    <div className=\"flex items-center gap-2\">\n                      {getFileTypeIcon(image.type)}\n                      <span className=\"text-sm font-medium truncate\" title={image.name}>\n                        {image.name}\n                      </span>\n                    </div>\n                    \n                    <div className=\"flex items-center justify-between text-xs text-gray-500\">\n                      <span>{formatFileSize(image.size)}</span>\n                      <span>{new Date().toLocaleDateString()}</span> {/* Placeholder for uploadedAt */}\n                    </div>\n\n                    {/* Individual Image Summary */}\n                    {/* This part of the logic needs to be adapted to the new ImageFile interface */}\n                    {/* For now, we'll just show a placeholder */}\n                    {/* {image.summary && (\n                      <div className=\"text-xs text-gray-600 bg-gray-50 p-2 rounded\">\n                        <strong>AI Summary:</strong> {image.summary}\n                      </div>\n                    )} */}\n\n                    {/* Actions */}\n                    <div className=\"flex gap-1\">\n                      <Button\n                        variant=\"outline\"\n                        size=\"sm\"\n                        className=\"flex-1 h-8 text-xs\"\n                        onClick={() => window.open(URL.createObjectURL(image), '_blank')}\n                        // disabled={disabled} // This prop was removed from interface\n                      >\n                        <Eye className=\"h-3 w-3 mr-1\" />\n                        Preview\n                      </Button>\n                      \n                      <Button\n                        variant=\"outline\"\n                        size=\"sm\"\n                        className=\"flex-1 h-8 text-xs\"\n                        onClick={() => {\n                          const link = document.createElement('a')\n                          link.href = URL.createObjectURL(image)\n                          link.download = image.name\n                          link.click()\n                        }}\n                        // disabled={disabled} // This prop was removed from interface\n                      >\n                        <Download className=\"h-3 w-3 mr-1\" />\n                        Download\n                      </Button>\n                    </div>\n                  </div>\n                </CardContent>\n              </Card>\n            ))}\n          </div>\n        </div>\n      )}\n\n      {/* AI Summary */}\n      {summary && (\n        <Card>\n          <CardContent className=\"p-4\">\n            <div className=\"flex items-center gap-2 mb-3\">\n              <Sparkles className=\"h-5 w-5 text-blue-500\" />\n              <h4 className=\"font-medium\">AI-Generated Summary</h4>\n            </div>\n            \n            <Textarea\n              value={summary}\n              onChange={(e: React.ChangeEvent<HTMLTextAreaElement>) => {\n                setSummary(e.target.value)\n                // onSummaryChange?.(e.target.value) // This prop was removed from interface\n              }}\n              placeholder=\"AI summary will appear here...\"\n              className=\"min-h-[100px]\"\n              // disabled={disabled} // This prop was removed from interface\n            />\n            \n            <p className=\"text-xs text-gray-500 mt-2\">\n              This summary was generated by AI based on your attached images. \n              You can edit it to better describe your service request.\n            </p>\n          </CardContent>\n        </Card>\n      )}\n\n      {/* Instructions */}\n      {images.length === 0 && (\n        <Card className=\"border-dashed\">\n          <CardContent className=\"p-4 text-center text-muted-foreground\">\n            // eslint-disable-next-line jsx-a11y/alt-text\n            <Image className=\"h-8 w-8 mx-auto mb-2 text-gray-400\" />\n            <p>No images attached yet</p>\n            <p className=\"text-sm mt-1\">\n              Attach images to help providers understand your service request better\n            </p>\n          </CardContent>\n        </Card>\n      )}\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\components\\ResilientRescheduleButton.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Clock' is defined but never used. Allowed unused vars must match /^_/u.","line":9,"column":20,"nodeType":null,"messageId":"unusedVar","endLine":9,"endColumn":25}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport React, { useState } from 'react'\nimport { Button } from '@/components/ui/button'\nimport { LoadingSkeleton, ButtonSkeleton } from '@/components/ui/LoadingSkeleton'\nimport { useOptimisticActionWithTelemetry } from '@/hooks/useOptimisticActionWithTelemetry'\nimport { useDebouncedClickWithTelemetry } from '@/hooks/useDebouncedClickWithTelemetry'\nimport { useResilientQuery } from '@/hooks/useResilientQuery'\nimport { Calendar, Clock, CheckCircle, AlertCircle, Loader2, RotateCcw } from 'lucide-react'\n\ninterface RescheduleDetails {\n  bookingId: string\n  newSlotStart: string\n  newSlotEnd: string\n  reason?: string\n}\n\ninterface ResilientRescheduleButtonProps {\n  onRescheduleSuccessAction: (rescheduleId: string) => void\n  onRescheduleErrorAction: (error: Error) => void\n  onRollbackAction: () => void\n  rescheduleDetails: RescheduleDetails\n  className?: string\n  disabled?: boolean\n}\n\nexport function ResilientRescheduleButton({\n  onRescheduleSuccessAction,\n  onRescheduleErrorAction,\n  onRollbackAction,\n  rescheduleDetails,\n  className = '',\n  disabled = false\n}: ResilientRescheduleButtonProps) {\n  const [rescheduleStatus, setRescheduleStatus] = useState<'idle' | 'processing' | 'success' | 'failed'>('idle')\n  const [rescheduleId, setRescheduleId] = useState<string | null>(null)\n  const [_oldSlot, setOldSlot] = useState<{ start: string; end: string } | null>(null)\n\n  // 1. OPTIMISTIC RESCHEDULE ACTION with TELEMETRY\n  const { execute: executeReschedule, status, error, rollback } = useOptimisticActionWithTelemetry({\n    action: async () => {\n      // Simulate reschedule processing\n      const response = await fetch('/api/bookings/reschedule', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify(rescheduleDetails)\n      })\n\n      if (!response.ok) {\n        throw new Error('Reschedule failed')\n      }\n\n      const result = await response.json()\n      return result.rescheduleId\n    },\n    onOptimistic: () => {\n      setRescheduleStatus('processing')\n      setRescheduleId(null)\n      // Store old slot for potential rollback\n      setOldSlot({\n        start: rescheduleDetails.newSlotStart,\n        end: rescheduleDetails.newSlotEnd\n      })\n    },\n    onSuccess: (rescheduleId: string) => {\n      setRescheduleStatus('success')\n      setRescheduleId(rescheduleId)\n      onRescheduleSuccessAction(rescheduleId)\n    },\n    onError: (error: Error) => {\n      setRescheduleStatus('failed')\n      onRescheduleErrorAction(error)\n    },\n    onRollback: () => {\n      setRescheduleStatus('idle')\n      setRescheduleId(null)\n      setOldSlot(null)\n      onRollbackAction()\n    },\n    component: 'ResilientRescheduleButton' // Required for telemetry\n  })\n\n  // 2. DEBOUNCED CLICK (prevents duplicate reschedules) with TELEMETRY\n  const debouncedReschedule = useDebouncedClickWithTelemetry(() => executeReschedule(), {\n    delay: 300,\n    onDuplicate: () => {\n      console.log('Reschedule already in progress, ignoring duplicate click')\n    },\n    component: 'ResilientRescheduleButton' // Required for telemetry\n  })\n\n  // 3. RESILIENT QUERY for reschedule confirmation\n  const { data: confirmedReschedule, isLoading: isConfirming } = useResilientQuery({\n    key: ['reschedule-confirmation', rescheduleId || ''],\n    fetcher: async () => {\n      if (!rescheduleId) throw new Error('No reschedule ID')\n      \n      const response = await fetch(`/api/bookings/reschedule/${rescheduleId}/status`)\n      if (!response.ok) throw new Error('Failed to confirm reschedule')\n      \n      return response.json()\n    },\n    enabled: !!rescheduleId && rescheduleStatus === 'success',\n    retry: { attempts: 3, backoff: 'exponential', delay: 1000 },\n    staleTime: 5000\n  })\n\n  // 4. LOADING SKELETONS for different states\n  if (status === 'optimistic' || rescheduleStatus === 'processing') {\n    return (\n      <div className=\"space-y-2\">\n        <ButtonSkeleton size=\"lg\" className=\"w-full\" />\n        <div className=\"text-center\">\n          <LoadingSkeleton width={140} height={14} />\n        </div>\n      </div>\n    )\n  }\n\n  // 5. SUCCESS STATE with confirmation\n  if (rescheduleStatus === 'success') {\n    return (\n      <div className=\"space-y-3\">\n        <Button disabled className=\"w-full bg-green-600 text-white\">\n          <CheckCircle className=\"w-4 h-4 mr-2\" />\n          Rescheduled Successfully!\n        </Button>\n        \n        {isConfirming && (\n          <div className=\"text-center text-sm text-gray-600\">\n            <Loader2 className=\"w-4 h-4 inline animate-spin mr-2\" />\n            Confirming new slot...\n          </div>\n        )}\n        \n        {confirmedReschedule && (\n          <div className=\"text-center text-sm text-green-600\">\n            âœ“ New slot confirmed and locked\n          </div>\n        )}\n        \n        <div className=\"text-xs text-gray-500 text-center\">\n          New $1 commitment fee applied\n        </div>\n      </div>\n    )\n  }\n\n  // 6. ERROR STATE with retry and rollback\n  if (rescheduleStatus === 'failed' || error) {\n    return (\n      <div className=\"space-y-3\">\n        <Button \n          onClick={() => debouncedReschedule()}\n          variant=\"destructive\"\n          className=\"w-full\"\n        >\n          <AlertCircle className=\"w-4 h-4 mr-2\" />\n          Reschedule Failed - Try Again\n        </Button>\n        \n        <div className=\"text-center text-sm text-red-600\">\n          {error?.message || 'Something went wrong. Your original booking is intact.'}\n        </div>\n        \n        <div className=\"flex gap-2\">\n          <Button \n            onClick={() => rollback()}\n            variant=\"outline\"\n            size=\"sm\"\n            className=\"flex-1\"\n          >\n            <RotateCcw className=\"w-4 h-4 mr-2\" />\n            Restore Original\n          </Button>\n          \n          <Button \n            onClick={() => setRescheduleStatus('idle')}\n            variant=\"outline\"\n            size=\"sm\"\n            className=\"flex-1\"\n          >\n            Try Again\n          </Button>\n        </div>\n      </div>\n    )\n  }\n\n  // 7. DEFAULT STATE - Reschedule button\n  return (\n    <Button\n      onClick={() => debouncedReschedule()}\n      disabled={disabled || status === 'loading'}\n      className={`w-full ${className}`}\n      size=\"lg\"\n      variant=\"outline\"\n    >\n      <Calendar className=\"w-4 h-4 mr-2\" />\n      Reschedule Appointment\n    </Button>\n  )\n}\n\n// Specialized reschedule button for Bookiji's non-refundable $1 rule\nexport function BookijiRescheduleButton({\n  onSuccessAction,\n  onErrorAction,\n  onRollbackAction,\n  rescheduleDetails,\n  className = ''\n}: {\n  onSuccessAction: (rescheduleId: string) => void\n  onErrorAction: (error: Error) => void\n  onRollbackAction: () => void\n  rescheduleDetails: RescheduleDetails\n  className?: string\n}) {\n  return (\n    <ResilientRescheduleButton\n      rescheduleDetails={rescheduleDetails}\n      onRescheduleSuccessAction={onSuccessAction}\n      onRescheduleErrorAction={onErrorAction}\n      onRollbackAction={onRollbackAction}\n      className={className}\n    />\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\components\\ResilientVendorInbox.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'CardSkeleton' is defined but never used. Allowed unused vars must match /^_/u.","line":5,"column":27,"nodeType":null,"messageId":"unusedVar","endLine":5,"endColumn":39}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport React, { useState, useEffect } from 'react'\nimport { Button } from '@/components/ui/button'\nimport { LoadingSkeleton, CardSkeleton, GridSkeleton } from '@/components/ui/LoadingSkeleton'\nimport { useOptimisticActionWithTelemetry } from '@/hooks/useOptimisticActionWithTelemetry'\nimport { useDebouncedClickWithTelemetry } from '@/hooks/useDebouncedClickWithTelemetry'\nimport { useResilientQuery } from '@/hooks/useResilientQuery'\nimport { useErrorBoundary } from '@/components/ui/ErrorBoundary'\nimport { CheckCircle, XCircle, AlertTriangle, Loader2, RefreshCw } from 'lucide-react'\n\ninterface ServiceRequest {\n  id: string\n  customer_id: string\n  customer_name: string\n  service_type: string\n  location: string\n  details?: string\n  status: 'pending' | 'accepted' | 'declined' | 'expired'\n  created_at: string\n}\n\ninterface ResilientVendorInboxProps {\n  vendorId: string\n  className?: string\n}\n\nexport function ResilientVendorInbox({\n  vendorId,\n  className = ''\n}: ResilientVendorInboxProps) {\n  const [requests, setRequests] = useState<ServiceRequest[]>([])\n  const [optimisticUpdates, setOptimisticUpdates] = useState<Map<string, Partial<ServiceRequest>>>(new Map())\n  const { error, handleError, resetError, hasError } = useErrorBoundary()\n\n  // 1. RESILIENT QUERY for fetching service requests\n  const { \n    data: fetchedRequests, \n    isLoading, \n    error: queryError, \n    refetch, \n    retry \n  } = useResilientQuery({\n    key: ['vendor-requests', vendorId],\n    fetcher: async () => {\n      const response = await fetch(`/api/vendor/requests?vendor_id=${vendorId}`)\n      if (!response.ok) throw new Error('Failed to fetch requests')\n      return response.json()\n    },\n    retry: { attempts: 3, backoff: 'exponential', delay: 1000 },\n    staleTime: 10000, // 10 seconds\n    cacheTime: 60000   // 1 minute\n  })\n\n  // 2. OPTIMISTIC ACCEPT ACTION with TELEMETRY\n  const { execute: executeAccept, status: acceptStatus } = useOptimisticActionWithTelemetry({\n    action: async (requestId: string) => {\n      const response = await fetch('/api/vendor/requests/accept', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({ requestId, vendorId })\n      })\n\n      if (!response.ok) {\n        throw new Error('Failed to accept request')\n      }\n\n      return response.json()\n    },\n    onOptimistic: (requestId: string) => {\n      // Optimistically update the request status\n      setOptimisticUpdates(prev => new Map(prev).set(requestId, { status: 'accepted' }))\n      \n      // Update local state immediately\n      setRequests(prev => prev.map(req => \n        req.id === requestId ? { ...req, status: 'accepted' } : req\n      ))\n    },\n    onSuccess: () => {\n      // Clear optimistic update\n      setOptimisticUpdates(prev => {\n        const newMap = new Map(prev)\n        newMap.clear()\n        return newMap\n      })\n      \n      // Refresh data to ensure consistency\n      refetch()\n    },\n    onError: (error: Error, requestId: string) => {\n      // Rollback optimistic update\n      setOptimisticUpdates(prev => {\n        const newMap = new Map(prev)\n        newMap.delete(requestId)\n        return newMap\n      })\n      \n      // Rollback local state\n      setRequests(prev => prev.map(req => \n        req.id === requestId ? { ...req, status: 'pending' } : req\n      ))\n      \n      handleError(error)\n    },\n    component: 'ResilientVendorInbox' // Required for telemetry\n  })\n\n  // 3. OPTIMISTIC DECLINE ACTION with TELEMETRY\n  const { execute: executeDecline, status: declineStatus } = useOptimisticActionWithTelemetry({\n    action: async (requestId: string) => {\n      const response = await fetch('/api/vendor/requests/decline', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({ requestId, vendorId })\n      })\n\n      if (!response.ok) {\n        throw new Error('Failed to decline request')\n      }\n\n      return response.json()\n    },\n    onOptimistic: (requestId: string) => {\n      // Optimistically update the request status\n      setOptimisticUpdates(prev => new Map(prev).set(requestId, { status: 'declined' }))\n      \n      // Update local state immediately\n      setRequests(prev => prev.map(req => \n        req.id === requestId ? { ...req, status: 'declined' } : req\n      ))\n    },\n    onSuccess: () => {\n      // Clear optimistic update\n      setOptimisticUpdates(prev => {\n        const newMap = new Map(prev)\n        newMap.clear()\n        return newMap\n      })\n      \n      // Refresh data to ensure consistency\n      refetch()\n    },\n    onError: (error: Error, requestId: string) => {\n      // Rollback optimistic update\n      setOptimisticUpdates(prev => {\n        const newMap = new Map(prev)\n        newMap.delete(requestId)\n        return newMap\n      })\n      \n      // Rollback local state\n      setRequests(prev => prev.map(req => \n        req.id === requestId ? { ...req, status: 'pending' } : req\n      ))\n      \n      handleError(error)\n    },\n    component: 'ResilientVendorInbox' // Required for telemetry\n  })\n\n  // 4. DEBOUNCED CLICKS (prevents duplicate actions) with TELEMETRY\n  const debouncedAccept = useDebouncedClickWithTelemetry(executeAccept, {\n    delay: 300,\n    onDuplicate: () => {\n      console.log('Accept already in progress, ignoring duplicate click')\n    },\n    component: 'ResilientVendorInbox' // Required for telemetry\n  })\n\n  const debouncedDecline = useDebouncedClickWithTelemetry(executeDecline, {\n    delay: 300,\n    onDuplicate: () => {\n      console.log('Decline already in progress, ignoring duplicate click')\n    },\n    component: 'ResilientVendorInbox' // Required for telemetry\n  })\n\n  // 5. UPDATE REQUESTS WHEN DATA CHANGES\n  useEffect(() => {\n    if (fetchedRequests?.requests) {\n      setRequests(fetchedRequests.requests)\n    }\n  }, [fetchedRequests])\n\n  // 6. ERROR HANDLING\n  useEffect(() => {\n    if (queryError) {\n      handleError(queryError)\n    }\n  }, [queryError, handleError])\n\n  // 7. LOADING STATE\n  if (isLoading) {\n    return (\n      <div className={`space-y-4 ${className}`}>\n        <div className=\"flex items-center justify-between\">\n          <h2 className=\"text-xl font-semibold\">Service Requests</h2>\n          <LoadingSkeleton width={80} height={32} />\n        </div>\n        <GridSkeleton rows={3} cols={1} />\n      </div>\n    )\n  }\n\n  // 8. ERROR STATE\n  if (hasError) {\n    return (\n      <div className={`text-center p-8 ${className}`}>\n        <AlertTriangle className=\"w-12 h-12 text-red-500 mx-auto mb-4\" />\n        <h3 className=\"text-lg font-semibold text-gray-900 mb-2\">\n          Failed to load requests\n        </h3>\n        <p className=\"text-gray-600 mb-4\">\n          {error?.message || 'Something went wrong while loading your service requests.'}\n        </p>\n        <div className=\"flex gap-3 justify-center\">\n          <Button onClick={retry} variant=\"default\">\n            <RefreshCw className=\"w-4 h-4 mr-2\" />\n            Try Again\n          </Button>\n          <Button onClick={resetError} variant=\"outline\">\n            Reset\n          </Button>\n        </div>\n      </div>\n    )\n  }\n\n  // 9. EMPTY STATE\n  if (requests.length === 0) {\n    return (\n      <div className={`text-center p-8 ${className}`}>\n        <div className=\"w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4\">\n          <Loader2 className=\"w-8 h-8 text-gray-400\" />\n        </div>\n        <h3 className=\"text-lg font-semibold text-gray-900 mb-2\">\n          No service requests yet\n        </h3>\n        <p className=\"text-gray-600\">\n          When customers request your services, they&apos;ll appear here.\n        </p>\n      </div>\n    )\n  }\n\n  // 10. REQUESTS LIST\n  return (\n    <div className={`space-y-4 ${className}`}>\n      <div className=\"flex items-center justify-between\">\n        <h2 className=\"text-xl font-semibold\">Service Requests ({requests.length})</h2>\n        <Button onClick={() => refetch()} variant=\"outline\" size=\"sm\">\n          <RefreshCw className=\"w-4 h-4 mr-2\" />\n          Refresh\n        </Button>\n      </div>\n\n      <div className=\"space-y-3\">\n        {requests.map((request) => {\n          const isOptimistic = optimisticUpdates.has(request.id)\n          const optimisticStatus = optimisticUpdates.get(request.id)?.status\n          const displayStatus = optimisticStatus || request.status\n\n          return (\n            <div\n              key={request.id}\n              className={`p-4 border rounded-lg transition-all ${\n                isOptimistic ? 'opacity-75 bg-blue-50' : 'bg-white'\n              }`}\n            >\n              <div className=\"flex items-start justify-between\">\n                <div className=\"flex-1\">\n                  <h4 className=\"font-medium text-gray-900\">\n                    {request.customer_name}\n                  </h4>\n                  <p className=\"text-sm text-gray-600\">\n                    {request.service_type} â€¢ {request.location}\n                  </p>\n                  {request.details && (\n                    <p className=\"text-sm text-gray-500 mt-1\">\n                      {request.details}\n                    </p>\n                  )}\n                  <p className=\"text-xs text-gray-400 mt-2\">\n                    {new Date(request.created_at).toLocaleDateString()}\n                  </p>\n                </div>\n\n                <div className=\"ml-4 flex gap-2\">\n                  {displayStatus === 'pending' && (\n                    <>\n                      <Button\n                        onClick={() => debouncedAccept(request.id)}\n                        disabled={acceptStatus === 'loading'}\n                        size=\"sm\"\n                        className=\"bg-green-600 hover:bg-green-700\"\n                      >\n                        {acceptStatus === 'loading' ? (\n                          <Loader2 className=\"w-4 h-4 animate-spin\" />\n                        ) : (\n                          <CheckCircle className=\"w-4 h-4\" />\n                        )}\n                      </Button>\n                      <Button\n                        onClick={() => debouncedDecline(request.id)}\n                        disabled={declineStatus === 'loading'}\n                        size=\"sm\"\n                        variant=\"outline\"\n                      >\n                        {declineStatus === 'loading' ? (\n                          <Loader2 className=\"w-4 h-4 animate-spin\" />\n                        ) : (\n                          <XCircle className=\"w-4 h-4\" />\n                        )}\n                      </Button>\n                    </>\n                  )}\n\n                  {displayStatus === 'accepted' && (\n                    <span className=\"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800\">\n                      <CheckCircle className=\"w-3 h-3 mr-1\" />\n                      Accepted\n                    </span>\n                  )}\n\n                  {displayStatus === 'declined' && (\n                    <span className=\"inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800\">\n                      <XCircle className=\"w-3 h-3 mr-1\" />\n                      Declined\n                    </span>\n                  )}\n                </div>\n              </div>\n\n              {isOptimistic && (\n                <div className=\"mt-2 text-xs text-blue-600\">\n                  Processing...\n                </div>\n              )}\n            </div>\n          )\n        })}\n      </div>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\components\\ReviewSystem.tsx","messages":[{"ruleId":"react/jsx-no-comment-textnodes","severity":2,"message":"Comments inside children section of tag should be placed inside braces","line":388,"column":59,"nodeType":"JSXText","messageId":"putCommentInBraces","endLine":390,"endColumn":23},{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":390,"column":23,"nodeType":"JSXOpeningElement","endLine":394,"endColumn":25}],"suppressedMessages":[{"ruleId":"@next/next/no-img-element","severity":1,"message":"Using `<img>` could result in slower LCP and higher bandwidth. Consider using `<Image />` from `next/image` or a custom image loader to automatically optimize images. This may incur additional usage or cost from your provider. See: https://nextjs.org/docs/messages/no-img-element","line":591,"column":25,"nodeType":"JSXOpeningElement","endLine":596,"endColumn":27,"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport React, { useState, useEffect, useCallback } from 'react'\nimport Image from 'next/image'\nimport StarRating from '@/components/ui/StarRating'\n\ninterface Review {\n  id: string\n  rating: number\n  overall_quality?: number\n  review_text?: string\n  service_quality?: number\n  communication?: number\n  punctuality?: number\n  value_for_money?: number\n  would_recommend?: boolean\n  photos?: string[]\n  created_at: string\n  status: string\n  spam_score?: number\n  helpful_count?: number\n  reported_count?: number\n  users: {\n    name: string\n    avatar_url?: string\n  }\n  bookings: {\n    service_name: string\n    service_date: string\n  }\n  responses?: ReviewResponse[]\n}\n\ninterface ReviewResponse {\n  id: string\n  response_text: string\n  is_public: boolean\n  created_at: string\n  provider: {\n    name: string\n    avatar_url?: string\n  }\n}\n\ninterface ReviewSystemProps {\n  vendorId: string\n  showSubmissionForm?: boolean\n  bookingId?: string\n  userId?: string\n  showModerationTools?: boolean\n}\n\nexport default function ReviewSystem({ \n  vendorId, \n  showSubmissionForm = false,\n  bookingId,\n  userId,\n  showModerationTools = false\n}: ReviewSystemProps) {\n  const [reviews, setReviews] = useState<Review[]>([])\n  const [loading, setLoading] = useState(true)\n  const [submitting, setSubmitting] = useState(false)\n  const [currentPage, setCurrentPage] = useState(0)\n  const [hasMore, setHasMore] = useState(true)\n  const [showForm, setShowForm] = useState(showSubmissionForm)\n  \n  // Form state\n  const [rating, setRating] = useState(0)\n  const [reviewText, setReviewText] = useState('')\n  const [serviceQuality, setServiceQuality] = useState(0)\n  const [communication, setCommunication] = useState(0)\n  const [punctuality, setPunctuality] = useState(0)\n  const [valueForMoney, setValueForMoney] = useState(0)\n  const [wouldRecommend, setWouldRecommend] = useState<boolean | null>(null)\n  const [photos, setPhotos] = useState<string[]>([])\n\n  const loadReviews = useCallback(async (page = 0) => {\n    try {\n      setLoading(true)\n      const response = await fetch(\n        `/api/reviews/create?vendor_id=${vendorId}&limit=10&offset=${page * 10}`\n      )\n      const data = await response.json()\n      \n      if (data.reviews) {\n        if (page === 0) {\n          setReviews(data.reviews)\n        } else {\n          setReviews(prev => [...prev, ...data.reviews])\n        }\n        setHasMore(data.pagination.has_more)\n      }\n    } catch (error) {\n      console.error('Failed to load reviews:', error)\n    } finally {\n      setLoading(false)\n    }\n  }, [vendorId])\n\n  // Load reviews on mount or when vendorId changes\n  useEffect(() => {\n    loadReviews()\n  }, [loadReviews])\n\n  const submitReview = async () => {\n    if (!rating || !bookingId || !userId) return\n\n    try {\n      setSubmitting(true)\n      \n      const response = await fetch('/api/reviews/create', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          booking_id: bookingId,\n          user_id: userId,\n          vendor_id: vendorId,\n          rating,\n          review_text: reviewText || null,\n          service_quality: serviceQuality || null,\n          communication: communication || null,\n          punctuality: punctuality || null,\n          value_for_money: valueForMoney || null,\n          would_recommend: wouldRecommend,\n          photos: photos.length > 0 ? photos : null\n        })\n      })\n\n      const result = await response.json()\n\n      if (result.success) {\n        // Reset form\n        setRating(0)\n        setReviewText('')\n        setServiceQuality(0)\n        setCommunication(0)\n        setPunctuality(0)\n        setValueForMoney(0)\n        setWouldRecommend(null)\n        setPhotos([])\n        setShowForm(false)\n        \n        // Reload reviews\n        loadReviews(0)\n        \n        alert('Review submitted successfully!')\n      } else {\n        alert(`Error: ${result.error}`)\n      }\n    } catch (error) {\n      console.error('Failed to submit review:', error)\n      alert('Failed to submit review. Please try again.')\n    } finally {\n      setSubmitting(false)\n    }\n  }\n\n  const handlePhotoUpload = (event: React.ChangeEvent<HTMLInputElement>) => {\n    const files = event.target.files\n    if (files) {\n      // In a real implementation, you'd upload these to a storage service\n      // For now, we'll just create placeholder URLs\n      const newPhotos = Array.from(files).map(file => URL.createObjectURL(file))\n      setPhotos(prev => [...prev, ...newPhotos])\n    }\n  }\n\n  const removePhoto = (index: number) => {\n    setPhotos(prev => prev.filter((_, i) => i !== index))\n  }\n\n  const formatDate = (dateString: string) => {\n    return new Date(dateString).toLocaleDateString('en-US', {\n      year: 'numeric',\n      month: 'short',\n      day: 'numeric'\n    })\n  }\n\n  const calculateAverageRating = () => {\n    if (reviews.length === 0) return 0\n    const publishedReviews = reviews.filter(r => r.status === 'published')\n    if (publishedReviews.length === 0) return 0\n    \n    const sum = publishedReviews.reduce((acc, review) => acc + (review.overall_quality || review.rating), 0)\n    return (sum / publishedReviews.length).toFixed(1)\n  }\n\n  const getRatingDistribution = () => {\n    const distribution = { 5: 0, 4: 0, 3: 0, 2: 0, 1: 0 }\n    const publishedReviews = reviews.filter(r => r.status === 'published')\n    \n    publishedReviews.forEach(review => {\n      const rating = Math.round(review.overall_quality || review.rating)\n      if (rating >= 1 && rating <= 5) {\n        distribution[rating as keyof typeof distribution]++\n      }\n    })\n    return distribution\n  }\n\n  const getPublishedReviews = () => {\n    return reviews.filter(review => review.status === 'published')\n  }\n\n  const getPendingReviews = () => {\n    return reviews.filter(review => review.status === 'pending')\n  }\n\n  const getFlaggedReviews = () => {\n    return reviews.filter(review => review.status === 'flagged')\n  }\n\n  return (\n    <div className=\"bg-white rounded-xl shadow-sm border border-gray-200 p-6\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between mb-6\">\n        <div>\n          <h3 className=\"text-2xl font-bold text-gray-900\">\n            Customer Reviews\n          </h3>\n          <div className=\"flex items-center gap-4 mt-2\">\n            <div className=\"flex items-center gap-2\">\n              <StarRating \n                value={Number(calculateAverageRating())} \n                readonly \n                size=\"large\" \n                allowHalfStars={true}\n              />\n              <span className=\"text-2xl font-bold text-gray-900\">\n                {calculateAverageRating()}\n              </span>\n            </div>\n            <span className=\"text-gray-600\">\n              ({getPublishedReviews().length} review{getPublishedReviews().length !== 1 ? 's' : ''})\n            </span>\n          </div>\n        </div>\n        \n        {showSubmissionForm && !showForm && (\n          <button\n            onClick={() => setShowForm(true)}\n            className=\"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors\"\n          >\n            Write Review\n          </button>\n        )}\n      </div>\n\n      {/* Rating Distribution */}\n      {getPublishedReviews().length > 0 && (\n        <div className=\"mb-8\">\n          <h4 className=\"text-lg font-semibold mb-4\">Rating Breakdown</h4>\n          <div className=\"space-y-2\">\n            {Object.entries(getRatingDistribution())\n              .reverse()\n              .map(([rating, count]) => (\n                <div key={rating} className=\"flex items-center gap-3\">\n                  <span className=\"text-sm font-medium w-8\">{rating} â˜…</span>\n                  <div className=\"flex-1 bg-gray-200 rounded-full h-2\">\n                    <div\n                      className=\"bg-yellow-400 h-2 rounded-full transition-all duration-300\"\n                      style={{\n                        width: `${getPublishedReviews().length > 0 ? (count / getPublishedReviews().length) * 100 : 0}%`\n                      }}\n                    />\n                  </div>\n                  <span className=\"text-sm text-gray-600 w-8\">{count}</span>\n                </div>\n              ))}\n          </div>\n        </div>\n      )}\n\n      {/* Moderation Summary (if enabled) */}\n      {showModerationTools && (\n        <div className=\"mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg\">\n          <h4 className=\"text-lg font-semibold text-yellow-800 mb-2\">Moderation Summary</h4>\n          <div className=\"grid grid-cols-3 gap-4 text-sm\">\n            <div>\n              <span className=\"text-yellow-700\">Pending:</span>\n              <span className=\"ml-2 font-semibold\">{getPendingReviews().length}</span>\n            </div>\n            <div>\n              <span className=\"text-yellow-700\">Flagged:</span>\n              <span className=\"ml-2 font-semibold\">{getFlaggedReviews().length}</span>\n            </div>\n            <div>\n              <span className=\"text-yellow-700\">Published:</span>\n              <span className=\"ml-2 font-semibold\">{getPublishedReviews().length}</span>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Review Submission Form */}\n      {showForm && (\n        <div className=\"bg-gray-50 rounded-xl p-6 mb-8\">\n          <h4 className=\"text-lg font-semibold mb-4\">Share Your Experience</h4>\n          \n          <div className=\"space-y-6\">\n            {/* Overall Rating */}\n            <div>\n              <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                Overall Rating *\n              </label>\n              <StarRating \n                value={rating} \n                onChange={setRating} \n                size=\"large\" \n                allowHalfStars={true}\n              />\n            </div>\n\n            {/* Detailed Ratings */}\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div>\n                <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                  Service Quality\n                </label>\n                <StarRating \n                  value={serviceQuality} \n                  onChange={setServiceQuality} \n                  allowHalfStars={true}\n                />\n              </div>\n              <div>\n                <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                  Communication\n                </label>\n                <StarRating \n                  value={communication} \n                  onChange={setCommunication} \n                  allowHalfStars={true}\n                />\n              </div>\n              <div>\n                <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                  Punctuality\n                </label>\n                <StarRating \n                  value={punctuality} \n                  onChange={setPunctuality} \n                  allowHalfStars={true}\n                />\n              </div>\n              <div>\n                <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                  Value for Money\n                </label>\n                <StarRating \n                  value={valueForMoney} \n                  onChange={setValueForMoney} \n                  allowHalfStars={true}\n                />\n              </div>\n            </div>\n\n            {/* Review Text */}\n            <div>\n              <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                Your Review\n              </label>\n              <textarea\n                value={reviewText}\n                onChange={(e) => setReviewText(e.target.value)}\n                rows={4}\n                className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n                placeholder=\"Share details about your experience...\"\n              />\n            </div>\n\n            {/* Photo Upload */}\n            <div>\n              <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                Add Photos (Optional)\n              </label>\n              <input\n                type=\"file\"\n                multiple\n                accept=\"image/*\"\n                onChange={handlePhotoUpload}\n                className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n              />\n              {photos.length > 0 && (\n                <div className=\"mt-3 flex flex-wrap gap-2\">\n                  {photos.map((photo, index) => (\n                    <div key={index} className=\"relative\">\n                      // eslint-disable-next-line @next/next/no-img-element\n                      <img\n                        src={photo}\n                        alt={`Review photo ${index + 1}`}\n                        className=\"w-20 h-20 object-cover rounded-lg\"\n                      />\n                      <button\n                        onClick={() => removePhoto(index)}\n                        className=\"absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full text-xs hover:bg-red-600\"\n                      >\n                        Ã—\n                      </button>\n                    </div>\n                  ))}\n                </div>\n              )}\n            </div>\n\n            {/* Recommendation */}\n            <div>\n              <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                Would you recommend this provider?\n              </label>\n              <div className=\"flex gap-4\">\n                <button\n                  type=\"button\"\n                  onClick={() => setWouldRecommend(true)}\n                  className={`px-4 py-2 rounded-lg border transition-colors ${\n                    wouldRecommend === true\n                      ? 'bg-green-100 border-green-500 text-green-700'\n                      : 'border-gray-300 text-gray-700 hover:bg-gray-50'\n                  }`}\n                >\n                  ðŸ‘ Yes\n                </button>\n                <button\n                  type=\"button\"\n                  onClick={() => setWouldRecommend(false)}\n                  className={`px-4 py-2 rounded-lg border transition-colors ${\n                    wouldRecommend === false\n                      ? 'bg-red-100 border-red-500 text-red-700'\n                      : 'border-gray-300 text-gray-700 hover:bg-gray-50'\n                  }`}\n                >\n                  ðŸ‘Ž No\n                </button>\n              </div>\n            </div>\n\n            {/* Submit Buttons */}\n            <div className=\"flex gap-3\">\n              <button\n                onClick={submitReview}\n                disabled={!rating || submitting}\n                className=\"px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors\"\n              >\n                {submitting ? 'Submitting...' : 'Submit Review'}\n              </button>\n              <button\n                onClick={() => setShowForm(false)}\n                className=\"px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors\"\n              >\n                Cancel\n              </button>\n            </div>\n          </div>\n        </div>\n      )}\n\n      {/* Reviews List */}\n      <div className=\"space-y-6\">\n        {loading && reviews.length === 0 ? (\n          <div className=\"text-center py-8\">\n            <div className=\"animate-spin w-8 h-8 border-2 border-blue-600 border-t-transparent rounded-full mx-auto mb-4\"></div>\n            <p className=\"text-gray-600\">Loading reviews...</p>\n          </div>\n        ) : getPublishedReviews().length === 0 ? (\n          <div className=\"text-center py-8\">\n            <p className=\"text-gray-600\">No reviews yet. Be the first to share your experience!</p>\n          </div>\n        ) : (\n          getPublishedReviews().map((review) => (\n            <div key={review.id} className=\"border-b border-gray-200 pb-6\">\n              <div className=\"flex items-start gap-4\">\n                <div className=\"w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center\">\n                  {review.users.avatar_url ? (\n                    <Image\n                      src={review.users.avatar_url}\n                      alt={review.users.name}\n                      width={40}\n                      height={40}\n                      className=\"w-10 h-10 rounded-full\"\n                    />\n                  ) : (\n                    <span className=\"text-blue-600 font-semibold\">\n                      {review.users.name.charAt(0).toUpperCase()}\n                    </span>\n                  )}\n                </div>\n                \n                <div className=\"flex-1\">\n                  <div className=\"flex items-center justify-between mb-2\">\n                    <div>\n                      <h5 className=\"font-semibold text-gray-900\">\n                        {review.users.name}\n                      </h5>\n                      <p className=\"text-sm text-gray-600\">\n                        {review.bookings.service_name} â€¢ {formatDate(review.bookings.service_date)}\n                      </p>\n                    </div>\n                    <div className=\"text-right\">\n                      <span className=\"text-sm text-gray-500\">\n                        {formatDate(review.created_at)}\n                      </span>\n                      {review.spam_score && review.spam_score > 0.7 && (\n                        <div className=\"text-xs text-red-600 mt-1\">\n                          âš ï¸ High spam score\n                        </div>\n                      )}\n                    </div>\n                  </div>\n                  \n                  <div className=\"mb-3\">\n                    <StarRating \n                      value={review.overall_quality || review.rating} \n                      readonly \n                      allowHalfStars={true}\n                    />\n                  </div>\n                  \n                  {review.review_text && (\n                    <p className=\"text-gray-700 mb-3\">{review.review_text}</p>\n                  )}\n                  \n                  {/* Detailed Ratings */}\n                  {(review.service_quality || review.communication || review.punctuality || review.value_for_money) && (\n                    <div className=\"grid grid-cols-2 gap-3 text-sm mb-3\">\n                      {review.service_quality && (\n                        <div className=\"flex items-center justify-between\">\n                          <span className=\"text-gray-600\">Service Quality:</span>\n                          <StarRating \n                            value={review.service_quality} \n                            readonly \n                            size=\"small\" \n                            allowHalfStars={true}\n                            showValue={false}\n                          />\n                        </div>\n                      )}\n                      {review.communication && (\n                        <div className=\"flex items-center justify-between\">\n                          <span className=\"text-gray-600\">Communication:</span>\n                          <StarRating \n                            value={review.communication} \n                            readonly \n                            size=\"small\" \n                            allowHalfStars={true}\n                            showValue={false}\n                          />\n                        </div>\n                      )}\n                      {review.punctuality && (\n                        <div className=\"flex items-center justify-between\">\n                          <span className=\"text-gray-600\">Punctuality:</span>\n                          <StarRating \n                            value={review.punctuality} \n                            readonly \n                            size=\"small\" \n                            allowHalfStars={true}\n                            showValue={false}\n                          />\n                        </div>\n                      )}\n                      {review.value_for_money && (\n                        <div className=\"flex items-center justify-between\">\n                          <span className=\"text-gray-600\">Value for Money:</span>\n                          <StarRating \n                            value={review.value_for_money} \n                            readonly \n                            size=\"small\" \n                            allowHalfStars={true}\n                            showValue={false}\n                          />\n                        </div>\n                      )}\n                    </div>\n                  )}\n                  \n                  {review.would_recommend !== null && (\n                    <div className=\"mt-3 flex items-center gap-2 text-sm\">\n                      <span className=\"text-gray-600\">Would recommend:</span>\n                      <span className={review.would_recommend ? 'text-green-600' : 'text-red-600'}>\n                        {review.would_recommend ? 'ðŸ‘ Yes' : 'ðŸ‘Ž No'}\n                      </span>\n                    </div>\n                  )}\n\n                  {/* Photos */}\n                  {review.photos && review.photos.length > 0 && (\n                    <div className=\"mt-3 flex gap-2\">\n                      {review.photos.map((photo, index) => (\n                        // eslint-disable-next-line @next/next/no-img-element\n                        <img\n                          key={index}\n                          src={photo}\n                          alt={`Review photo ${index + 1}`}\n                          className=\"w-16 h-16 object-cover rounded-lg\"\n                        />\n                      ))}\n                    </div>\n                  )}\n\n                  {/* Provider Response */}\n                  {review.responses && review.responses.length > 0 && (\n                    <div className=\"mt-4 pl-4 border-l-2 border-blue-200\">\n                      {review.responses.map((response) => (\n                        <div key={response.id} className=\"bg-blue-50 p-3 rounded-lg\">\n                          <div className=\"flex items-center gap-2 mb-2\">\n                            <div className=\"w-6 h-6 bg-blue-200 rounded-full flex items-center justify-center\">\n                              {response.provider.avatar_url ? (\n                                <Image\n                                  src={response.provider.avatar_url}\n                                  alt={response.provider.name}\n                                  width={24}\n                                  height={24}\n                                  className=\"w-6 h-6 rounded-full\"\n                                />\n                              ) : (\n                                <span className=\"text-blue-600 text-xs font-semibold\">\n                                  {response.provider.name.charAt(0).toUpperCase()}\n                                </span>\n                              )}\n                            </div>\n                            <span className=\"text-sm font-medium text-blue-800\">\n                              {response.provider.name} (Provider)\n                            </span>\n                            <span className=\"text-xs text-blue-600\">\n                              {formatDate(response.created_at)}\n                            </span>\n                          </div>\n                          <p className=\"text-sm text-blue-700\">{response.response_text}</p>\n                        </div>\n                      ))}\n                    </div>\n                  )}\n\n                  {/* Action Buttons */}\n                  <div className=\"mt-3 flex items-center gap-4 text-sm\">\n                    <button className=\"text-gray-600 hover:text-blue-600 transition-colors\">\n                      ðŸ‘ Helpful ({review.helpful_count || 0})\n                    </button>\n                    <button className=\"text-gray-600 hover:text-red-600 transition-colors\">\n                      âš ï¸ Report\n                    </button>\n                  </div>\n                </div>\n              </div>\n            </div>\n          ))\n        )}\n\n        {/* Load More */}\n        {hasMore && getPublishedReviews().length > 0 && (\n          <div className=\"text-center\">\n            <button\n              onClick={() => {\n                const nextPage = currentPage + 1\n                setCurrentPage(nextPage)\n                loadReviews(nextPage)\n              }}\n              disabled={loading}\n              className=\"px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 disabled:opacity-50 transition-colors\"\n            >\n              {loading ? 'Loading...' : 'Load More Reviews'}\n            </button>\n          </div>\n        )}\n      </div>\n    </div>\n  )\n} ","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\components\\SpecialtySearch.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Star' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":34,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":38},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Clock' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":40,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":45},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'DollarSign' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":47,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":57}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'performSearch'. Either include it or remove the dependency array.","line":72,"column":6,"nodeType":"ArrayExpression","endLine":72,"endColumn":15,"suggestions":[{"desc":"Update the dependencies array to be: [filters, performSearch]","fix":{"range":[1901,1910],"text":"[filters, performSearch]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\r\n\r\nimport { useState, useEffect } from 'react'\r\nimport { Search, Filter, MapPin, Star, Clock, DollarSign } from 'lucide-react'\r\nimport { Button } from '@/components/ui/button'\r\nimport { Input } from '@/components/ui/input'\r\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'\r\nimport { Badge } from '@/components/ui/badge'\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'\r\n\r\n\r\ninterface Specialty {\r\n  id: string\r\n  name: string\r\n  slug: string\r\n  parent_id: string | null\r\n  path: string\r\n}\r\n\r\ninterface Provider {\r\n  id: string\r\n  full_name: string\r\n  business_name: string\r\n  average_rating: number\r\n  total_reviews: number\r\n  business_address: string\r\n  distance?: number\r\n  specialties: Array<{\r\n    specialty_id: string\r\n    is_primary: boolean\r\n    specialty: {\r\n      name: string\r\n    }\r\n  }>\r\n}\r\n\r\ninterface SearchFilters {\r\n  query: string\r\n  location: string\r\n  specialtyIds: string[]\r\n  minRating: number\r\n  maxDistance: number\r\n  maxPrice: number\r\n  availability: string\r\n}\r\n\r\nexport default function SpecialtySearch() {\r\n  const [specialties, setSpecialties] = useState<Specialty[]>([])\r\n  const [providers, setProviders] = useState<Provider[]>([])\r\n  const [loading, setLoading] = useState(false)\r\n  const [filters, setFilters] = useState<SearchFilters>({\r\n    query: '',\r\n    location: '',\r\n    specialtyIds: [],\r\n    minRating: 0,\r\n    maxDistance: 50,\r\n    maxPrice: 1000,\r\n    availability: ''\r\n  })\r\n  const [showFilters, setShowFilters] = useState(false)\r\n  const [selectedSpecialty, setSelectedSpecialty] = useState<string>('')\r\n\r\n  useEffect(() => {\r\n    loadSpecialties()\r\n  }, [])\r\n\r\n  useEffect(() => {\r\n    if (filters.query || filters.specialtyIds.length > 0 || filters.location) {\r\n      performSearch()\r\n    }\r\n  // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [filters])\r\n\r\n  const loadSpecialties = async () => {\r\n    try {\r\n      const response = await fetch('/api/specialties')\r\n      if (response.ok) {\r\n        const data = await response.json()\r\n        setSpecialties(data.items || [])\r\n      }\r\n    } catch (error) {\r\n      console.error('Error loading specialties:', error)\r\n    }\r\n  }\r\n\r\n  const performSearch = async () => {\r\n    setLoading(true)\r\n    try {\r\n      const queryParams = new URLSearchParams()\r\n      \r\n      if (filters.query) queryParams.append('query', filters.query)\r\n      if (filters.location) queryParams.append('location', filters.location)\r\n      if (filters.specialtyIds.length > 0) queryParams.append('specialty_ids', filters.specialtyIds.join(','))\r\n      if (filters.minRating > 0) queryParams.append('min_rating', filters.minRating.toString())\r\n      if (filters.maxDistance < 50) queryParams.append('maxTravelDistance', filters.maxDistance.toString())\r\n      if (filters.maxPrice < 1000) queryParams.append('max_price', filters.maxPrice.toString())\r\n      if (filters.availability) queryParams.append('availability_date', filters.availability)\r\n\r\n      const response = await fetch(`/api/search/providers?${queryParams}`)\r\n      if (response.ok) {\r\n        const data = await response.json()\r\n        setProviders(data.providers || [])\r\n      }\r\n    } catch (error) {\r\n      console.error('Search failed:', error)\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  const handleSpecialtyToggle = (specialtyId: string) => {\r\n    setFilters(prev => ({\r\n      ...prev,\r\n      specialtyIds: prev.specialtyIds.includes(specialtyId)\r\n        ? prev.specialtyIds.filter(id => id !== specialtyId)\r\n        : [...prev.specialtyIds, specialtyId]\r\n    }))\r\n  }\r\n\r\n  const clearFilters = () => {\r\n    setFilters({\r\n      query: '',\r\n      location: '',\r\n      specialtyIds: [],\r\n      minRating: 0,\r\n      maxDistance: 50,\r\n      maxPrice: 1000,\r\n      availability: ''\r\n    })\r\n  }\r\n\r\n  const getSpecialtyPath = (specialty: Specialty): string => {\r\n    if (!specialty.parent_id) return specialty.name\r\n    \r\n    const parent = specialties.find(s => s.id === specialty.parent_id)\r\n    if (parent) {\r\n      return `${parent.name} > ${specialty.name}`\r\n    }\r\n    \r\n    return specialty.name\r\n  }\r\n\r\n  const getRatingColor = (rating: number) => {\r\n    if (rating >= 4.5) return 'text-green-600'\r\n    if (rating >= 4.0) return 'text-blue-600'\r\n    if (rating >= 3.5) return 'text-yellow-600'\r\n    return 'text-gray-600'\r\n  }\r\n\r\n  return (\r\n    <div className=\"max-w-7xl mx-auto p-6 space-y-6\">\r\n      {/* Search Header */}\r\n      <div className=\"text-center\">\r\n        <h1 className=\"text-4xl font-bold text-gray-900 mb-4\">Find the Perfect Service Provider</h1>\r\n        <p className=\"text-xl text-gray-600\">Search by specialty, location, and more to find exactly what you need</p>\r\n      </div>\r\n\r\n      {/* Search Bar */}\r\n      <Card>\r\n        <CardContent className=\"p-6\">\r\n          <div className=\"flex flex-col lg:flex-row gap-4\">\r\n            <div className=\"flex-1\">\r\n              <Input\r\n                placeholder=\"What service do you need?\"\r\n                value={filters.query}\r\n                onChange={(e) => setFilters(prev => ({ ...prev, query: e.target.value }))}\r\n                className=\"h-12 text-lg\"\r\n              />\r\n            </div>\r\n            <div className=\"flex-1\">\r\n              <Input\r\n                placeholder=\"Where are you located?\"\r\n                value={filters.location}\r\n                onChange={(e) => setFilters(prev => ({ ...prev, location: e.target.value }))}\r\n                className=\"h-12 text-lg\"\r\n              />\r\n            </div>\r\n            <Button \r\n              onClick={() => setShowFilters(!showFilters)}\r\n              variant=\"outline\"\r\n              className=\"h-12 px-6\"\r\n            >\r\n              <Filter className=\"h-5 w-5 mr-2\" />\r\n              Filters\r\n            </Button>\r\n            <Button \r\n              onClick={performSearch}\r\n              disabled={loading}\r\n              className=\"h-12 px-8\"\r\n            >\r\n              <Search className=\"h-5 w-5 mr-2\" />\r\n              {loading ? 'Searching...' : 'Search'}\r\n            </Button>\r\n          </div>\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* Filters Panel */}\r\n      {showFilters && (\r\n        <Card>\r\n          <CardHeader>\r\n            <CardTitle>Advanced Filters</CardTitle>\r\n          </CardHeader>\r\n          <CardContent>\r\n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6\">\r\n              {/* Specialty Selection */}\r\n              <div>\r\n                <label className=\"block text-sm font-medium mb-3\">Service Specialties</label>\r\n                <div className=\"space-y-2 max-h-48 overflow-y-auto\">\r\n                  {specialties.map(specialty => (\r\n                    <div key={specialty.id} className=\"flex items-center space-x-2\">\r\n                      <input\r\n                        type=\"checkbox\"\r\n                        id={specialty.id}\r\n                        checked={filters.specialtyIds.includes(specialty.id)}\r\n                        onChange={() => handleSpecialtyToggle(specialty.id)}\r\n                        className=\"rounded\"\r\n                      />\r\n                      <label htmlFor={specialty.id} className=\"text-sm\">\r\n                        {getSpecialtyPath(specialty)}\r\n                      </label>\r\n                    </div>\r\n                  ))}\r\n                </div>\r\n              </div>\r\n\r\n              {/* Rating Filter */}\r\n              <div>\r\n                <label className=\"block text-sm font-medium mb-3\">Minimum Rating</label>\r\n                <Select\r\n                  value={filters.minRating.toString()}\r\n                  onValueChange={(value) => setFilters(prev => ({ ...prev, minRating: parseInt(value) }))}\r\n                >\r\n                  <SelectTrigger>\r\n                    <SelectValue />\r\n                  </SelectTrigger>\r\n                  <SelectContent>\r\n                    <SelectItem value=\"0\">Any Rating</SelectItem>\r\n                    <SelectItem value=\"3\">3+ Stars</SelectItem>\r\n                    <SelectItem value=\"4\">4+ Stars</SelectItem>\r\n                    <SelectItem value=\"4.5\">4.5+ Stars</SelectItem>\r\n                  </SelectContent>\r\n                </Select>\r\n              </div>\r\n\r\n              {/* Distance Filter */}\r\n              <div>\r\n                <label className=\"block text-sm font-medium mb-3\">Max Distance</label>\r\n                <Select\r\n                  value={filters.maxDistance.toString()}\r\n                  onValueChange={(value) => setFilters(prev => ({ ...prev, maxDistance: parseInt(value) }))}\r\n                >\r\n                  <SelectTrigger>\r\n                    <SelectValue />\r\n                  </SelectTrigger>\r\n                  <SelectContent>\r\n                    <SelectItem value=\"5\">5 miles</SelectItem>\r\n                    <SelectItem value=\"10\">10 miles</SelectItem>\r\n                    <SelectItem value=\"25\">25 miles</SelectItem>\r\n                    <SelectItem value=\"50\">50+ miles</SelectItem>\r\n                  </SelectContent>\r\n                </Select>\r\n              </div>\r\n\r\n              {/* Price Filter */}\r\n              <div>\r\n                <label className=\"block text-sm font-medium mb-3\">Max Price</label>\r\n                <Select\r\n                  value={filters.maxPrice.toString()}\r\n                  onValueChange={(value) => setFilters(prev => ({ ...prev, maxPrice: parseInt(value) }))}\r\n                >\r\n                  <SelectTrigger>\r\n                    <SelectValue />\r\n                  </SelectTrigger>\r\n                  <SelectContent>\r\n                    <SelectItem value=\"100\">$100</SelectItem>\r\n                    <SelectItem value=\"250\">$250</SelectItem>\r\n                    <SelectItem value=\"500\">$500</SelectItem>\r\n                    <SelectItem value=\"1000\">$1000+</SelectItem>\r\n                  </SelectContent>\r\n                </Select>\r\n              </div>\r\n            </div>\r\n\r\n            <div className=\"mt-6 flex justify-end\">\r\n              <Button variant=\"outline\" onClick={clearFilters}>\r\n                Clear All Filters\r\n              </Button>\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n      )}\r\n\r\n      {/* Results */}\r\n      <div className=\"space-y-4\">\r\n        <div className=\"flex items-center justify-between\">\r\n          <h2 className=\"text-2xl font-bold text-gray-900\">\r\n            {loading ? 'Searching...' : `${providers.length} Providers Found`}\r\n          </h2>\r\n          {providers.length > 0 && (\r\n            <Select value={selectedSpecialty} onValueChange={setSelectedSpecialty}>\r\n              <SelectTrigger className=\"w-48\">\r\n                <SelectValue placeholder=\"Sort by specialty\" />\r\n              </SelectTrigger>\r\n              <SelectContent>\r\n                <SelectItem value=\"\">All Specialties</SelectItem>\r\n                {specialties.map(specialty => (\r\n                  <SelectItem key={specialty.id} value={specialty.id}>\r\n                    {specialty.name}\r\n                  </SelectItem>\r\n                ))}\r\n              </SelectContent>\r\n            </Select>\r\n          )}\r\n        </div>\r\n\r\n        {providers.length > 0 && (\r\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\r\n            {providers\r\n              .filter(provider => \r\n                !selectedSpecialty || \r\n                provider.specialties.some(s => s.specialty_id === selectedSpecialty)\r\n              )\r\n              .map(provider => (\r\n                <Card key={provider.id} className=\"hover:shadow-lg transition-shadow\">\r\n                  <CardHeader>\r\n                    <div className=\"flex items-start justify-between\">\r\n                      <div>\r\n                        <CardTitle className=\"text-lg\">\r\n                          {provider.business_name || provider.full_name}\r\n                        </CardTitle>\r\n                        <p className=\"text-sm text-gray-600\">{provider.business_address}</p>\r\n                      </div>\r\n                      <div className=\"text-right\">\r\n                        <div className={`text-lg font-bold ${getRatingColor(provider.average_rating)}`}>\r\n                          {provider.average_rating.toFixed(1)} â­\r\n                        </div>\r\n                        <p className=\"text-xs text-gray-500\">\r\n                          {provider.total_reviews} reviews\r\n                        </p>\r\n                      </div>\r\n                    </div>\r\n                  </CardHeader>\r\n                  <CardContent>\r\n                    <div className=\"space-y-3\">\r\n                      {/* Specialties */}\r\n                      <div>\r\n                        <p className=\"text-sm font-medium text-gray-700 mb-2\">Specialties:</p>\r\n                        <div className=\"flex flex-wrap gap-1\">\r\n                          {provider.specialties.map((spec, index) => (\r\n                            <Badge \r\n                              key={index} \r\n                              variant={spec.is_primary ? \"default\" : \"secondary\"}\r\n                              className=\"text-xs\"\r\n                            >\r\n                              {spec.specialty.name}\r\n                              {spec.is_primary && \" (Primary)\"}\r\n                            </Badge>\r\n                          ))}\r\n                        </div>\r\n                      </div>\r\n\r\n                      {/* Distance */}\r\n                      {provider.distance && (\r\n                        <div className=\"flex items-center text-sm text-gray-600\">\r\n                          <MapPin className=\"h-4 w-4 mr-1\" />\r\n                          {provider.distance.toFixed(1)} miles away\r\n                        </div>\r\n                      )}\r\n\r\n                      {/* Actions */}\r\n                      <div className=\"flex space-x-2 pt-2\">\r\n                        <Button size=\"sm\" className=\"flex-1\">\r\n                          View Profile\r\n                        </Button>\r\n                        <Button size=\"sm\" variant=\"outline\">\r\n                          Book Now\r\n                        </Button>\r\n                      </div>\r\n                    </div>\r\n                  </CardContent>\r\n                </Card>\r\n              ))}\r\n          </div>\r\n        )}\r\n\r\n        {!loading && providers.length === 0 && filters.query && (\r\n          <Card>\r\n            <CardContent className=\"p-8 text-center\">\r\n              <Search className=\"h-16 w-16 text-gray-400 mx-auto mb-4\" />\r\n              <h3 className=\"text-lg font-medium text-gray-900 mb-2\">No providers found</h3>\r\n              <p className=\"text-gray-600\">\r\n                Try adjusting your search criteria or expanding your search area.\r\n              </p>\r\n            </CardContent>\r\n          </Card>\r\n        )}\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\components\\SpecialtyTreeSelectOptimized.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'X' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":49,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":50},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Textarea' is defined but never used. Allowed unused vars must match /^_/u.","line":9,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":9,"endColumn":18}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'performSearch'. Either include it or remove the dependency array.","line":159,"column":6,"nodeType":"ArrayExpression","endLine":159,"endColumn":28,"suggestions":[{"desc":"Update the dependencies array to be: [debouncedSearchQuery, performSearch]","fix":{"range":[5463,5485],"text":"[debouncedSearchQuery, performSearch]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\"use client\";\r\n\r\nimport { useState, useEffect, useMemo, useRef, useCallback } from \"react\";\r\nimport { ChevronRight, ArrowLeft, Plus, Search, X, Loader2 } from \"lucide-react\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport { Card, CardContent } from \"@/components/ui/card\";\r\nimport { Badge } from \"@/components/ui/badge\";\r\nimport { Textarea } from \"@/components/ui/textarea\";\r\n\r\ntype SpecialtyNode = { \r\n  id: string; \r\n  name: string; \r\n  parent_id: string | null;\r\n  path?: string;\r\n  level?: number;\r\n  breadcrumb?: string[];\r\n  is_leaf?: boolean;\r\n};\r\n\r\ntype Breadcrumb = { id: string; name: string };\r\n\r\ninterface SpecialtyTreeSelectProps {\r\n  value?: string;\r\n  onChangeAction: (id: string, name: string) => void;\r\n  placeholder?: string;\r\n  className?: string;\r\n  maxHeight?: string;\r\n}\r\n\r\n// Cache for specialty data\r\nconst specialtyCache = new Map<string, { data: SpecialtyNode[]; timestamp: number }>();\r\nconst CACHE_TTL = 5 * 60 * 1000; // 5 minutes\r\n\r\nasync function fetchSpecialtiesWithCache(parent: string | null, searchQuery?: string): Promise<SpecialtyNode[]> {\r\n  const cacheKey = `specialties:${parent || 'root'}:${searchQuery || ''}`;\r\n  const cached = specialtyCache.get(cacheKey);\r\n  \r\n  if (cached && Date.now() - cached.timestamp < CACHE_TTL) {\r\n    return cached.data;\r\n  }\r\n\r\n  try {\r\n    let url = `/api/specialties`;\r\n    if (parent === 'root') {\r\n      url += '?parent=root';\r\n    } else if (parent) {\r\n      url += `?parent=${parent}`;\r\n    }\r\n    if (searchQuery) {\r\n      url += `${parent ? '&' : '?'}q=${encodeURIComponent(searchQuery)}`;\r\n    }\r\n\r\n    const res = await fetch(url, { cache: \"no-store\" });\r\n    if (!res.ok) throw new Error(\"Failed to fetch\");\r\n    \r\n    const json = await res.json();\r\n    const data = json.items || [];\r\n    \r\n    // Cache the results\r\n    specialtyCache.set(cacheKey, { data, timestamp: Date.now() });\r\n    \r\n    return data;\r\n  } catch (error) {\r\n    console.error(\"Failed to fetch specialties:\", error);\r\n    return [];\r\n  }\r\n}\r\n\r\nasync function searchSpecialtiesOptimized(q: string): Promise<SpecialtyNode[]> {\r\n  if (q.length < 2) return [];\r\n  \r\n  try {\r\n    const res = await fetch(`/api/specialties?q=${encodeURIComponent(q)}`, { cache: \"no-store\" });\r\n    if (!res.ok) throw new Error(\"Failed to fetch\");\r\n    const json = await res.json();\r\n    return json.items || [];\r\n  } catch (error) {\r\n    console.error(\"Failed to search specialties:\", error);\r\n    return [];\r\n  }\r\n}\r\n\r\nasync function submitSuggestion(proposedName: string, parentId?: string, details?: string): Promise<boolean> {\r\n  try {\r\n    const res = await fetch(\"/api/specialties/suggest\", {\r\n      method: \"POST\",\r\n      headers: { \"Content-Type\": \"application/json\" },\r\n      body: JSON.stringify({ name: proposedName, parent_id: parentId, details }),\r\n    });\r\n    return res.ok;\r\n  } catch (error) {\r\n    console.error(\"Failed to submit suggestion:\", error);\r\n    return false;\r\n  }\r\n}\r\n\r\nexport function SpecialtyTreeSelectOptimized({ \r\n  value, \r\n  onChangeAction, \r\n  placeholder = \"Select specialty\", \r\n  className,\r\n  maxHeight = \"max-h-96\"\r\n}: SpecialtyTreeSelectProps) {\r\n  const [isOpen, setIsOpen] = useState(false);\r\n  const [currentParent, setCurrentParent] = useState<string | undefined>(undefined);\r\n  const [breadcrumbs, setBreadcrumbs] = useState<Breadcrumb[]>([]);\r\n  const [children, setChildren] = useState<SpecialtyNode[]>([]);\r\n  const [searchQuery, setSearchQuery] = useState(\"\");\r\n  const [searchResults, setSearchResults] = useState<SpecialtyNode[]>([]);\r\n  const [isSearching, setIsSearching] = useState(false);\r\n  const [isLoading, setIsLoading] = useState(false);\r\n  const [showSuggestionForm, setShowSuggestionForm] = useState(false);\r\n  const [suggestionName, setSuggestionName] = useState(\"\");\r\n  const [suggestionDetails, setSuggestionDetails] = useState(\"\");\r\n  const [isSubmittingSuggestion, setIsSubmittingSuggestion] = useState(false);\r\n  const [virtualizedItems, setVirtualizedItems] = useState<SpecialtyNode[]>([]);\r\n  const [scrollTop, setScrollTop] = useState(0);\r\n  \r\n  // Create a debounced search query using useEffect and setTimeout\r\n  const [debouncedSearchQuery, setDebouncedSearchQuery] = useState(\"\");\r\n  const scrollContainerRef = useRef<HTMLDivElement>(null);\r\n\r\n  // Debounce the search query\r\n  useEffect(() => {\r\n    const timer = setTimeout(() => {\r\n      setDebouncedSearchQuery(searchQuery);\r\n    }, 300);\r\n\r\n    return () => clearTimeout(timer);\r\n  }, [searchQuery]);\r\n\r\n  const selectedSpecialty = useMemo(() => {\r\n    if (!value) return null;\r\n    const allSpecialties = [...children, ...searchResults];\r\n    return allSpecialties.find(s => s.id === value);\r\n  }, [value, children, searchResults]);\r\n\r\n  // Virtualization settings\r\n  const itemHeight = 48; // Height of each specialty item\r\n  const visibleItems = 10; // Number of items visible at once\r\n  const totalHeight = children.length * itemHeight;\r\n  const startIndex = Math.floor(scrollTop / itemHeight);\r\n  const endIndex = Math.min(startIndex + visibleItems, children.length);\r\n\r\n  useEffect(() => {\r\n    if (isOpen && !currentParent) {\r\n      loadRootSpecialties();\r\n    }\r\n  }, [isOpen, currentParent]);\r\n\r\n  useEffect(() => {\r\n    if (debouncedSearchQuery && debouncedSearchQuery.length >= 2) {\r\n      void performSearch();\r\n    } else {\r\n      setSearchResults([]);\r\n    }\r\n  // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [debouncedSearchQuery]);\r\n\r\n  useEffect(() => {\r\n    // Update virtualized items when children change\r\n    setVirtualizedItems(children.slice(startIndex, endIndex));\r\n  }, [children, startIndex, endIndex]);\r\n\r\n  const loadRootSpecialties = async () => {\r\n    setIsLoading(true);\r\n    const rootSpecialties = await fetchSpecialtiesWithCache(null);\r\n    setChildren(rootSpecialties);\r\n    setBreadcrumbs([]);\r\n    setCurrentParent(undefined);\r\n    setIsLoading(false);\r\n  };\r\n\r\n  const loadChildren = async (parentId: string, parentName: string) => {\r\n    setIsLoading(true);\r\n    const childSpecialties = await fetchSpecialtiesWithCache(parentId);\r\n    setChildren(childSpecialties);\r\n    setCurrentParent(parentId);\r\n    setBreadcrumbs(prev => [...prev, { id: parentId, name: parentName }]);\r\n    setIsLoading(false);\r\n  };\r\n\r\n  const navigateToParent = (targetParentId: string) => {\r\n    const targetIndex = breadcrumbs.findIndex(crumb => crumb.id === targetParentId);\r\n    if (targetIndex !== -1) {\r\n      const targetBreadcrumbs = breadcrumbs.slice(0, targetIndex + 1);\r\n      setBreadcrumbs(targetBreadcrumbs);\r\n      setCurrentParent(targetParentId);\r\n      loadChildren(targetParentId, targetBreadcrumbs[targetBreadcrumbs.length - 1].name);\r\n    }\r\n  };\r\n\r\n  const performSearch = async () => {\r\n    if (!debouncedSearchQuery || debouncedSearchQuery.length < 2) return;\r\n    \r\n    setIsSearching(true);\r\n    const results = await searchSpecialtiesOptimized(debouncedSearchQuery);\r\n    setSearchResults(results);\r\n    setIsSearching(false);\r\n  };\r\n\r\n  const handleSuggestionSubmit = async () => {\r\n    if (!suggestionName.trim()) return;\r\n    \r\n    setIsSubmittingSuggestion(true);\r\n    const success = await submitSuggestion(suggestionName, currentParent, suggestionDetails);\r\n    \r\n    if (success) {\r\n      setShowSuggestionForm(false);\r\n      setSuggestionName(\"\");\r\n      setSuggestionDetails(\"\");\r\n      // Refresh the current view\r\n      if (currentParent) {\r\n        loadChildren(currentParent, breadcrumbs[breadcrumbs.length - 1]?.name || \"\");\r\n      } else {\r\n        loadRootSpecialties();\r\n      }\r\n    }\r\n    \r\n    setIsSubmittingSuggestion(false);\r\n  };\r\n\r\n  const handleScroll = useCallback((e: React.UIEvent<HTMLDivElement>) => {\r\n    const scrollTop = e.currentTarget.scrollTop;\r\n    setScrollTop(scrollTop);\r\n  }, []);\r\n\r\n  const renderSpecialtyItem = (specialty: SpecialtyNode, index: number) => {\r\n    const _actualIndex = startIndex + index;\r\n    const hasChildren = specialty.level !== undefined && specialty.level < 5; // Assume max depth of 5\r\n    \r\n    return (\r\n      <div\r\n        key={specialty.id}\r\n        className=\"flex items-center justify-between p-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100\"\r\n        style={{ height: itemHeight }}\r\n        onClick={() => {\r\n          if (hasChildren) {\r\n            loadChildren(specialty.id, specialty.name);\r\n          } else {\r\n            onChangeAction(specialty.id, specialty.name);\r\n            setIsOpen(false);\r\n          }\r\n        }}\r\n      >\r\n        <div className=\"flex items-center space-x-2 flex-1\">\r\n          {hasChildren && (\r\n            <ChevronRight className=\"h-4 w-4 text-gray-400\" />\r\n          )}\r\n          <span className=\"text-sm font-medium\">{specialty.name}</span>\r\n          {specialty.path && (\r\n            <Badge variant=\"outline\" className=\"text-xs\">\r\n              {specialty.path.split('.').slice(-2).join(' > ')}\r\n            </Badge>\r\n          )}\r\n        </div>\r\n                 {hasChildren && (\r\n           <span className=\"text-xs text-gray-500\">\r\n             subcategories\r\n           </span>\r\n         )}\r\n      </div>\r\n    );\r\n  };\r\n\r\n  return (\r\n    <div className={`relative ${className}`}>\r\n      {/* Trigger Button */}\r\n      <Button\r\n        variant=\"outline\"\r\n        onClick={() => setIsOpen(!isOpen)}\r\n        className=\"w-full justify-between\"\r\n      >\r\n        <span className={selectedSpecialty ? \"\" : \"text-muted-foreground\"}>\r\n          {selectedSpecialty ? selectedSpecialty.name : placeholder}\r\n        </span>\r\n        <ChevronRight className={`h-4 w-4 transition-transform ${isOpen ? \"rotate-90\" : \"\"}`} />\r\n      </Button>\r\n\r\n      {/* Dropdown */}\r\n      {isOpen && (\r\n        <Card className=\"absolute top-full left-0 right-0 z-50 mt-1 overflow-hidden\" style={{ maxHeight: maxHeight }}>\r\n          <CardContent className=\"p-0\">\r\n            {/* Header with breadcrumbs */}\r\n            <div className=\"border-b p-3 bg-gray-50\">\r\n              <div className=\"flex items-center gap-2 mb-2\">\r\n                {breadcrumbs.length > 0 && (\r\n                  <Button\r\n                    variant=\"ghost\"\r\n                    size=\"sm\"\r\n                    onClick={() => loadRootSpecialties()}\r\n                    className=\"h-6 px-2\"\r\n                  >\r\n                    <ArrowLeft className=\"h-3 w-3 mr-1\" />\r\n                    Root\r\n                  </Button>\r\n                )}\r\n                {breadcrumbs.map((crumb, index) => (\r\n                  <div key={crumb.id} className=\"flex items-center gap-1\">\r\n                    <Button\r\n                      variant=\"ghost\"\r\n                      size=\"sm\"\r\n                      onClick={() => navigateToParent(crumb.id)}\r\n                      className=\"h-6 px-2 text-xs\"\r\n                    >\r\n                      {crumb.name}\r\n                    </Button>\r\n                    {index < breadcrumbs.length - 1 && <ChevronRight className=\"h-3 w-3\" />}\r\n                  </div>\r\n                ))}\r\n              </div>\r\n              \r\n              {/* Search */}\r\n              <div className=\"relative\">\r\n                <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400\" />\r\n                <Input\r\n                  placeholder=\"Search specialties...\"\r\n                  value={searchQuery}\r\n                  onChange={(e) => setSearchQuery(e.target.value)}\r\n                  className=\"pl-10 pr-4 h-8 text-sm\"\r\n                />\r\n                {isSearching && (\r\n                  <Loader2 className=\"absolute right-3 top-1/2 transform -translate-y-1/2 h-4 w-4 animate-spin text-gray-400\" />\r\n                )}\r\n              </div>\r\n            </div>\r\n\r\n            {/* Content */}\r\n            <div className=\"flex-1 overflow-hidden\">\r\n              {isLoading ? (\r\n                <div className=\"flex items-center justify-center p-8\">\r\n                  <Loader2 className=\"h-6 w-6 animate-spin text-gray-400\" />\r\n                </div>\r\n              ) : searchQuery && searchResults.length > 0 ? (\r\n                // Search results\r\n                <div className=\"max-h-80 overflow-y-auto\">\r\n                  {searchResults.map((specialty) => (\r\n                    <div\r\n                      key={specialty.id}\r\n                      className=\"flex items-center justify-between p-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100\"\r\n                      onClick={() => {\r\n                        onChangeAction(specialty.id, specialty.name);\r\n                        setIsOpen(false);\r\n                      }}\r\n                    >\r\n                      <div className=\"flex items-center space-x-2\">\r\n                        <span className=\"text-sm font-medium\">{specialty.name}</span>\r\n                        {specialty.path && (\r\n                          <Badge variant=\"outline\" className=\"text-xs\">\r\n                            {specialty.path.split('.').slice(-2).join(' > ')}\r\n                          </Badge>\r\n                        )}\r\n                      </div>\r\n                    </div>\r\n                  ))}\r\n                </div>\r\n              ) : children.length > 0 ? (\r\n                // Virtualized list for large datasets\r\n                <div \r\n                  ref={scrollContainerRef}\r\n                  className=\"overflow-y-auto\"\r\n                  style={{ height: Math.min(children.length * itemHeight, 400) }}\r\n                  onScroll={handleScroll}\r\n                >\r\n                  <div style={{ height: totalHeight, position: 'relative' }}>\r\n                    <div\r\n                      style={{\r\n                        position: 'absolute',\r\n                        top: startIndex * itemHeight,\r\n                        left: 0,\r\n                        right: 0\r\n                      }}\r\n                    >\r\n                      {virtualizedItems.map((specialty, index) => \r\n                        renderSpecialtyItem(specialty, index)\r\n                      )}\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              ) : (\r\n                // Empty state\r\n                <div className=\"p-8 text-center text-gray-500\">\r\n                  <p className=\"text-sm\">No specialties found</p>\r\n                  <Button\r\n                    variant=\"outline\"\r\n                    size=\"sm\"\r\n                    onClick={() => setShowSuggestionForm(true)}\r\n                    className=\"mt-2\"\r\n                  >\r\n                    <Plus className=\"h-4 w-4 mr-2\" />\r\n                    Suggest New\r\n                  </Button>\r\n                </div>\r\n              )}\r\n            </div>\r\n\r\n            {/* Suggestion Form */}\r\n            {showSuggestionForm && (\r\n              <div className=\"border-t p-4 bg-gray-50\">\r\n                <div className=\"space-y-3\">\r\n                  <Input\r\n                    placeholder=\"New specialty name\"\r\n                    value={suggestionName}\r\n                    onChange={(e) => setSuggestionName(e.target.value)}\r\n                  />\r\n                  <Input\r\n                    placeholder=\"Additional details (optional)\"\r\n                    value={suggestionDetails}\r\n                    onChange={(e) => setSuggestionDetails(e.target.value)}\r\n                  />\r\n                  <div className=\"flex gap-2\">\r\n                    <Button\r\n                      size=\"sm\"\r\n                      onClick={handleSuggestionSubmit}\r\n                      disabled={isSubmittingSuggestion || !suggestionName.trim()}\r\n                    >\r\n                      {isSubmittingSuggestion ? (\r\n                        <Loader2 className=\"h-4 w-4 animate-spin mr-2\" />\r\n                      ) : (\r\n                        <Plus className=\"h-4 w-4 mr-2\" />\r\n                      )}\r\n                      Submit\r\n                    </Button>\r\n                    <Button\r\n                      variant=\"outline\"\r\n                      size=\"sm\"\r\n                      onClick={() => setShowSuggestionForm(false)}\r\n                    >\r\n                      Cancel\r\n                    </Button>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            )}\r\n\r\n            {/* Footer */}\r\n            <div className=\"border-t p-3 bg-gray-50\">\r\n              <div className=\"flex items-center justify-between text-xs text-gray-500\">\r\n                <span>\r\n                  {children.length} {children.length === 1 ? 'specialty' : 'specialties'}\r\n                  {currentParent && ` in ${breadcrumbs[breadcrumbs.length - 1]?.name}`}\r\n                </span>\r\n                <Button\r\n                  variant=\"ghost\"\r\n                  size=\"sm\"\r\n                  onClick={() => setShowSuggestionForm(!showSuggestionForm)}\r\n                  className=\"h-6 px-2\"\r\n                >\r\n                  <Plus className=\"h-3 w-3 mr-1\" />\r\n                  Suggest\r\n                </Button>\r\n              </div>\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n      )}\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\components\\SupportChat.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'AnimatePresence' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":18,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":33}],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":123,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":123,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3322,3325],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3322,3325],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":164,"column":81,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":164,"endColumn":84,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4844,4847],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4844,4847],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":166,"column":79,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":166,"endColumn":82,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4999,5002],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4999,5002],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport React, { useState, useRef, useEffect } from 'react'\nimport { motion, AnimatePresence } from 'framer-motion'\nimport { Button } from '@/components/ui/button'\nimport Link from 'next/link'\n\ninterface Message {\n  id: string\n  role: 'user' | 'assistant'\n  content: string\n  timestamp: Date\n  sources?: { title: string, score: number, url?: string | null }[]\n}\n\n// Render message content with clickable markdown links\nfunction renderMessageWithLinks(content: string) {\n  // Match markdown links: [text](/path) or [text](http://url)\n  const linkRegex = /\\[([^\\]]+)\\]\\(([^)]+)\\)/g;\n  const parts: (string | JSX.Element)[] = [];\n  let lastIndex = 0;\n  let key = 0;\n  \n  // Find all matches first\n  const matches: Array<{ index: number; text: string; url: string; length: number }> = [];\n  let match;\n  \n  // Reset regex lastIndex to ensure we start from the beginning\n  linkRegex.lastIndex = 0;\n  while ((match = linkRegex.exec(content)) !== null) {\n    matches.push({\n      index: match.index,\n      text: match[1],\n      url: match[2],\n      length: match[0].length\n    });\n  }\n  \n  // If no links found, return original content\n  if (matches.length === 0) {\n    return <>{content}</>;\n  }\n  \n  // Build parts array with text and links\n  matches.forEach((m) => {\n    // Add text before the link\n    if (m.index > lastIndex) {\n      parts.push(content.substring(lastIndex, m.index));\n    }\n    \n    // Convert full URL to relative path for Next.js Link\n    let linkUrl = m.url;\n    if (linkUrl.startsWith('http')) {\n      try {\n        linkUrl = new URL(linkUrl).pathname;\n      } catch {\n        // Keep original if URL parsing fails\n      }\n    }\n    \n    // Add the link\n    parts.push(\n      <Link\n        key={key++}\n        href={linkUrl}\n        className=\"text-blue-600 hover:text-blue-800 hover:underline font-medium\"\n      >\n        {m.text}\n      </Link>\n    );\n    \n    lastIndex = m.index + m.length;\n  });\n  \n  // Add remaining text\n  if (lastIndex < content.length) {\n    parts.push(content.substring(lastIndex));\n  }\n  \n  return <>{parts}</>;\n}\n\nexport default function SupportChat({ onCloseAction }: { onCloseAction: () => void }) {\n  const [messages, setMessages] = useState<Message[]>([\n    {\n      id: '1',\n      role: 'assistant',\n      content: 'Hello! I am the Bookiji Support Bot. How can I help you today?',\n      timestamp: new Date()\n    }\n  ])\n  const [inputMessage, setInputMessage] = useState('')\n  const [isTyping, setIsTyping] = useState(false)\n  const messagesEndRef = useRef<HTMLDivElement>(null)\n\n  const scrollToBottom = () => {\n    messagesEndRef.current?.scrollIntoView({ behavior: \"smooth\" })\n  }\n\n  useEffect(() => {\n    scrollToBottom()\n  }, [messages])\n\n  const handleSendMessage = async () => {\n    if (!inputMessage.trim() || isTyping) return\n\n    const userMessage: Message = {\n      id: Date.now().toString(),\n      role: 'user',\n      content: inputMessage,\n      timestamp: new Date()\n    }\n\n    setMessages(prev => [...prev, userMessage])\n    setInputMessage('')\n    setIsTyping(true)\n\n    try {\n      // Build history from previous messages for context\n      const history = messages\n        .filter(m => m.role === 'assistant' && 'confidence' in m)\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\n        .map(m => ({ confidence: (m as any).confidence || 0 }))\n        .slice(-5); // Keep last 5 for context\n\n      // Add timeout to prevent infinite spinning\n      const controller = new AbortController();\n      const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout\n\n      let response;\n      try {\n        response = await fetch('/api/support/chat', {\n          method: 'POST',\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify({ \n            message: userMessage.content,\n            history: history\n          }),\n          signal: controller.signal\n        });\n        clearTimeout(timeoutId);\n      } catch (fetchError) {\n        clearTimeout(timeoutId);\n        if (fetchError instanceof Error && fetchError.name === 'AbortError') {\n          throw new Error('Request timed out. Please try again.');\n        }\n        throw fetchError;\n      }\n\n      if (!response.ok) {\n        const errorData = await response.json().catch(() => ({}));\n        throw new Error(errorData.error || `Failed to get response: ${response.status}`);\n      }\n\n      const data = await response.json()\n      \n      const aiMessage: Message = {\n        id: (Date.now() + 1).toString(),\n        role: 'assistant',\n        content: data.reply || \"I'm sorry, I couldn't find an answer to that.\",\n        sources: data.sources,\n        timestamp: new Date(),\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\n        ...(data.confidence !== undefined && { confidence: data.confidence } as any),\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\n        ...(data.escalated && { escalated: true, ticketId: data.ticketId } as any)\n      }\n\n      setMessages(prev => [...prev, aiMessage])\n      \n      // Show escalation message if ticket was created\n      if (data.escalated && data.ticketId) {\n        console.log('Ticket created:', data.ticketId);\n      }\n    } catch (error) {\n      console.error('Support chat error:', error)\n      const errorMsg = error instanceof Error ? error.message : 'Unknown error occurred';\n      const errorMessage: Message = {\n        id: (Date.now() + 1).toString(),\n        role: 'assistant',\n        content: errorMsg.includes('timeout') \n          ? \"The request took too long. Please try again with a shorter question.\"\n          : errorMsg.includes('Failed to get response')\n          ? \"I'm having trouble connecting to the support system right now. Please try again later.\"\n          : `Sorry, I encountered an error: ${errorMsg}. Please try again.`,\n        timestamp: new Date()\n      }\n      setMessages(prev => [...prev, errorMessage])\n    } finally {\n      setIsTyping(false)\n    }\n  }\n\n  const handleKeyPress = (e: React.KeyboardEvent) => {\n    if (e.key === 'Enter' && !e.shiftKey) {\n      e.preventDefault()\n      handleSendMessage()\n    }\n  }\n\n  return (\n    <div className=\"flex flex-col h-full bg-background\">\n      {/* Header */}\n      <div className=\"flex items-center justify-between p-4 border-b\">\n        <div className=\"flex items-center gap-2\">\n          <div className=\"w-8 h-8 rounded-full bg-fuchsia-600 flex items-center justify-center text-white\">\n            ?\n          </div>\n          <div>\n            <h3 className=\"font-semibold\">Bookiji Support</h3>\n            <span className=\"text-xs text-muted-foreground\">Powered by RAG</span>\n          </div>\n        </div>\n        <Button variant=\"ghost\" size=\"sm\" onClick={onCloseAction}>Ã—</Button>\n      </div>\n\n      {/* Messages */}\n      <div className=\"flex-1 overflow-y-auto p-4 space-y-4\">\n        {messages.map((message) => (\n          <motion.div\n            key={message.id}\n            initial={{ opacity: 0, y: 10 }}\n            animate={{ opacity: 1, y: 0 }}\n            className={`flex gap-3 ${message.role === 'user' ? 'justify-end' : ''}`}\n          >\n            {message.role === 'assistant' && (\n              <div className=\"flex-shrink-0 w-8 h-8 rounded-full bg-fuchsia-100 flex items-center justify-center text-fuchsia-600 font-bold text-xs\">\n                AI\n              </div>\n            )}\n            <div className={`rounded-2xl p-3 max-w-[85%] text-sm ${\n              message.role === 'user' \n                ? 'bg-primary text-primary-foreground rounded-br-none' \n                : 'bg-muted rounded-tl-none'\n            }`}>\n              <div className=\"whitespace-pre-wrap\">\n                {renderMessageWithLinks(message.content)}\n              </div>\n              {message.sources && message.sources.length > 0 && (\n                <div className=\"mt-2 pt-2 border-t border-muted-foreground/20\">\n                  <p className=\"text-xs font-semibold mb-1.5 opacity-70\">Sources:</p>\n                  <ul className=\"list-none pl-0 space-y-1\">\n                    {message.sources.slice(0, 3).map((s, i) => {\n                      // Convert full URL to relative path for Next.js Link\n                      const url = s.url ? (s.url.startsWith('http') ? new URL(s.url).pathname : s.url) : null;\n                      return (\n                        <li key={i} className=\"text-xs\">\n                          {url ? (\n                            <Link \n                              href={url}\n                              className=\"text-blue-600 hover:text-blue-800 hover:underline font-medium flex items-center gap-1.5 group cursor-pointer\"\n                              title={s.title}\n                            >\n                              <span className=\"group-hover:translate-x-0.5 transition-transform\">â†’</span>\n                              <span className=\"truncate max-w-[250px]\">{s.title}</span>\n                            </Link>\n                          ) : (\n                            <span className=\"text-muted-foreground truncate block max-w-[250px]\" title={s.title}>\n                              {s.title}\n                            </span>\n                          )}\n                        </li>\n                      );\n                    })}\n                  </ul>\n                </div>\n              )}\n            </div>\n          </motion.div>\n        ))}\n        {isTyping && (\n          <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} className=\"flex gap-3\">\n             <div className=\"flex-shrink-0 w-8 h-8 rounded-full bg-fuchsia-100 flex items-center justify-center text-fuchsia-600 font-bold text-xs\">\n                AI\n              </div>\n              <div className=\"bg-muted rounded-2xl rounded-tl-none p-3 flex gap-1 items-center\">\n                <span className=\"w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce\"></span>\n                <span className=\"w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce delay-100\"></span>\n                <span className=\"w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce delay-200\"></span>\n              </div>\n          </motion.div>\n        )}\n        <div ref={messagesEndRef} />\n      </div>\n\n      {/* Input */}\n      <div className=\"p-4 border-t\">\n        <div className=\"flex gap-2\">\n          <input\n            type=\"text\"\n            value={inputMessage}\n            onChange={(e) => setInputMessage(e.target.value)}\n            onKeyPress={handleKeyPress}\n            placeholder=\"Ask a question...\"\n            className=\"flex-1 px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-fuchsia-500 bg-background\"\n            disabled={isTyping}\n          />\n          <Button \n            onClick={handleSendMessage} \n            disabled={isTyping || !inputMessage.trim()}\n            className=\"rounded-full w-10 h-10 p-0 flex items-center justify-center bg-fuchsia-600 hover:bg-fuchsia-700\"\n          >\n            âž¤\n          </Button>\n        </div>\n      </div>\n    </div>\n  )\n}\n\n\n\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\components\\UserDashboard.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'useGuidedTour' is defined but never used. Allowed unused vars must match /^_/u.","line":34,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":34,"endColumn":23},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'customerDashboardSteps' is defined but never used. Allowed unused vars must match /^_/u.","line":35,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":35,"endColumn":32},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'customerDashboardTourId' is defined but never used. Allowed unused vars must match /^_/u.","line":35,"column":34,"nodeType":null,"messageId":"unusedVar","endLine":35,"endColumn":57}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useCallback has a missing dependency: 'notifications'. Either include it or remove the dependency array.","line":152,"column":6,"nodeType":"ArrayExpression","endLine":152,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [notifications]","fix":{"range":[4439,4441],"text":"[notifications]"}}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadNotifications'. Either include it or remove the dependency array.","line":282,"column":6,"nodeType":"ArrayExpression","endLine":282,"endColumn":14,"suggestions":[{"desc":"Update the dependencies array to be: [loadNotifications, router]","fix":{"range":[9235,9243],"text":"[loadNotifications, router]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useState, useEffect, useCallback } from 'react'\nimport { motion } from 'framer-motion'\nimport { supabaseBrowserClient } from '@/lib/supabaseClient'\nimport { NotificationResponse, NotificationError } from '@/types/notification'\nimport { \n  User, \n  Calendar, \n  MapPin, \n  Star, \n  Coins,\n  Plus,\n  Search,\n  Filter,\n  Clock,\n  CheckCircle,\n  AlertCircle,\n  Phone,\n  Mail,\n  Shield,\n  Award,\n  Zap\n} from 'lucide-react'\nimport Link from 'next/link'\nimport Image from 'next/image'\nimport { useRouter } from 'next/navigation'\nimport { PageLoader } from '@/components/ui/LoadingSpinner'\nimport { NetworkError } from '@/components/ui/ErrorDisplay'\nimport { SuccessMessage } from '@/components/ui/StatusMessage'\nimport { useAsyncData } from '@/hooks/useAsyncState'\nimport { cn } from '@/lib/utils'\nimport { useI18n } from '@/lib/i18n/useI18n'\nimport { useGuidedTour } from '@/components/guided-tours/GuidedTourProvider'\nimport { customerDashboardSteps, customerDashboardTourId } from '@/tours/dashboardNavigation'\nimport { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from '@/components/ui/tooltip'\n\ninterface UserProfile {\n  id: string\n  name: string\n  email: string\n  phone?: string\n  avatar_url?: string\n  member_since: string\n  verification_status: 'verified' | 'pending' | 'unverified'\n  preferences: {\n    notifications: boolean\n    marketing_emails: boolean\n    sms_alerts: boolean\n  }\n  stats: {\n    total_bookings: number\n    total_spent_cents: number\n    favorite_providers: number\n    average_rating_given: number\n  }\n}\n\ninterface Booking {\n  id: string\n  service_name: string\n  provider_name: string\n  provider_avatar?: string\n  date: string\n  time: string\n  duration_minutes: number\n  status: 'upcoming' | 'completed' | 'cancelled'\n  price_cents: number\n  location: string\n  notes?: string\n  rating?: number\n  review?: string\n}\n\ninterface CreditBalance {\n  balance_cents: number\n  balance_dollars: number\n  recent_transactions: CreditTransaction[]\n}\n\ninterface CreditTransaction {\n  id: string\n  amount_cents: number\n  type: 'purchase' | 'usage' | 'refund' | 'bonus'\n  description: string\n  date: string\n}\n\n\n\ninterface Provider {\n  id: string;\n  business_name: string;\n  avatar_url: string;\n  rating: number;\n  total_reviews: number;\n  specialties: string[];\n  distance?: number;\n  last_booked?: string;\n  location: {\n    lat: number;\n    lng: number;\n    address?: string;\n  };\n}\n\nexport default function UserDashboard() {\n  const [activeTab, setActiveTab] = useState<'overview' | 'bookings' | 'credits' | 'favorites' | 'profile'>('overview')\n  const [userProfile, setUserProfile] = useState<UserProfile | null>(null)\n  const [bookings, setBookings] = useState<Booking[]>([])\n  const [credits, setCredits] = useState<CreditBalance | null>(null)\n  const [favoriteProviders, setFavoriteProviders] = useState<Provider[]>([])\n  const [searchQuery, setSearchQuery] = useState('')\n  const [filterStatus, setFilterStatus] = useState<'all' | 'upcoming' | 'completed' | 'cancelled'>('all')\n  const router = useRouter()\n  const { t } = useI18n()\n  // Tour functionality removed - users can start tour manually via GuidedTourManager button\n  // const { startTour, hasCompletedTour } = useGuidedTour()\n\n  // Use the new async state hook for notifications\n  const notifications = useAsyncData<NotificationResponse['notifications']>({\n    autoReset: true,\n    resetDelay: 5000\n  })\n\n  const loadNotifications = useCallback(async (): Promise<void> => {\n    const supabase = supabaseBrowserClient()\n    if (!supabase) return\n    \n    try {\n      const { data: { session } } = await supabase.auth.getSession()\n      if (!session) {\n        // Don't fetch notifications if not authenticated\n        return\n      }\n      \n      const response = await fetch('/api/notifications', {\n        headers: { Authorization: `Bearer ${session.access_token}` }\n      })\n      if (!response.ok) {\n        const errorData = await response.json() as NotificationError\n        throw new Error(errorData.error || 'Failed to fetch notifications')\n      }\n      \n      const data = await response.json() as NotificationResponse\n      notifications.setData(data.notifications)\n    } catch (error) {\n      console.error('Failed to load notifications:', error)\n      notifications.setError(error instanceof Error ? error.message : 'Failed to load notifications')\n    }\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, []) // Intentionally empty - notifications object methods are stable\n\n  // Load user data (profile, bookings, credits, favorites) in parallel\n  useEffect(() => {\n    const loadUserData = async () => {\n      const supabase = supabaseBrowserClient()\n      if (!supabase) return\n      \n      try {\n        const { data: { session } } = await supabase.auth.getSession()\n        if (!session?.user) {\n          router.push('/login')\n          return\n        }\n\n        // Load all data in parallel\n        const [profileResult, bookingsResult, creditsResult, favoritesResult] = await Promise.allSettled([\n          supabase\n            .from('user_role_summary')\n            .select('*')\n            .eq('user_id', session.user.id)\n            .maybeSingle(),\n          supabase\n            .from('bookings')\n            .select('*')\n            .eq('customer_id', session.user.id)\n            .order('created_at', { ascending: false }),\n          fetch('/api/credits/balance', {\n            headers: { Authorization: `Bearer ${session.access_token}` }\n          }).then(res => res.ok ? res.json() : null).catch(() => null),\n          supabase\n            .from('favorite_providers')\n            .select('provider_id, providers(*)')\n            .eq('user_id', session.user.id)\n        ])\n\n        // Handle profile - with fallback to profiles table if user_role_summary fails\n        let profileData: UserProfile | null = null\n        if (profileResult.status === 'fulfilled' && profileResult.value.data) {\n          profileData = profileResult.value.data as UserProfile\n        } else if (profileResult.status === 'rejected' || !profileResult.value?.data) {\n          // Fallback: query profiles table directly\n          try {\n            const { data: fallbackProfile } = await supabase\n              .from('profiles')\n              .select('id, full_name, email, role, created_at, updated_at')\n              .eq('id', session.user.id)\n              .single()\n            \n            if (fallbackProfile) {\n              // Map profiles table data to UserProfile format\n              profileData = {\n                id: fallbackProfile.id,\n                name: fallbackProfile.full_name || fallbackProfile.email || 'User',\n                email: fallbackProfile.email || '',\n                phone: undefined,\n                avatar_url: undefined,\n                member_since: fallbackProfile.created_at || new Date().toISOString(),\n                verification_status: 'unverified' as const,\n                preferences: {\n                  notifications: true,\n                  marketing_emails: false,\n                  sms_alerts: false\n                },\n                stats: {\n                  total_bookings: 0,\n                  total_spent_cents: 0,\n                  favorite_providers: 0,\n                  average_rating_given: 0\n                }\n              }\n            }\n          } catch (fallbackError) {\n            console.error('Fallback profile query failed:', fallbackError)\n          }\n        }\n        \n        if (profileData) {\n          setUserProfile(profileData)\n        } else {\n          // Create minimal profile if all queries fail to prevent infinite loading\n          setUserProfile({\n            id: session.user.id,\n            name: session.user.email?.split('@')[0] || 'User',\n            email: session.user.email || '',\n            phone: undefined,\n            avatar_url: undefined,\n            member_since: new Date().toISOString(),\n            verification_status: 'unverified' as const,\n            preferences: {\n              notifications: true,\n              marketing_emails: false,\n              sms_alerts: false\n            },\n            stats: {\n              total_bookings: 0,\n              total_spent_cents: 0,\n              favorite_providers: 0,\n              average_rating_given: 0\n            }\n          })\n        }\n\n        // Handle bookings\n        if (bookingsResult.status === 'fulfilled' && bookingsResult.value.data) {\n          setBookings(bookingsResult.value.data as Booking[])\n        }\n\n        // Handle credits\n        if (creditsResult.status === 'fulfilled' && creditsResult.value?.success) {\n          setCredits(creditsResult.value.credits)\n        }\n\n        // Handle favorites\n        if (favoritesResult.status === 'fulfilled' && favoritesResult.value.data) {\n          const providers = favoritesResult.value.data\n            .map(fp => fp.providers)\n            .filter(Boolean) as unknown as Provider[]\n          setFavoriteProviders(providers)\n        }\n\n        // Load notifications\n        loadNotifications()\n      } catch (error) {\n        console.error('Error loading user data:', error)\n      }\n    }\n\n    loadUserData()\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [router]) // Only re-run if router changes\n\n  // Auto-start tour removed - users can start tour manually via GuidedTourManager button\n  // useEffect(() => {\n  //   if (!hasCompletedTour(customerDashboardTourId)) {\n  //     startTour(customerDashboardTourId, customerDashboardSteps)\n  //   }\n  // }, [hasCompletedTour, startTour])\n\n  // Helper functions\n  const getStatusColor = (status: string) => {\n    switch (status.toLowerCase()) {\n      case 'confirmed':\n        return 'bg-green-100 text-green-800'\n      case 'pending':\n        return 'bg-yellow-100 text-yellow-800'\n      case 'cancelled':\n        return 'bg-red-100 text-red-800'\n      case 'completed':\n        return 'bg-blue-100 text-blue-800'\n      default:\n        return 'bg-gray-100 text-gray-800'\n    }\n  }\n\n  const getStatusDescription = (status: string): string => {\n    switch (status.toLowerCase()) {\n      case 'confirmed':\n        return 'Your booking has been confirmed by the provider. The appointment is scheduled and ready.'\n      case 'pending':\n        return 'Your booking request is waiting for provider confirmation. You will be notified once confirmed.'\n      case 'cancelled':\n        return 'This booking has been cancelled. Contact the provider if you need to reschedule.'\n      case 'completed':\n        return 'This service has been completed. You can leave a review to help others.'\n      case 'upcoming':\n        return 'This booking is confirmed and scheduled for the future.'\n      default:\n        return `Booking status: ${status}`\n    }\n  }\n\n  const formatDate = (dateString: string) => {\n    return new Date(dateString).toLocaleDateString('en-US', {\n      weekday: 'short',\n      month: 'short',\n      day: 'numeric'\n    })\n  }\n\n  const formatCurrency = (cents: number) => {\n    return `$${(Math.abs(cents) / 100).toFixed(2)}`\n  }\n\n  const canRateBooking = (status: string) => {\n    return status === 'completed' || status === 'confirmed'\n  }\n\n  if (!userProfile) {\n    return <PageLoader text=\"Loading your dashboard...\" />\n  }\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-blue-50 to-purple-50\">\n      {/* Header */}\n      <div className=\"bg-white shadow-sm border-b\">\n        <div className=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6\">\n          <div className=\"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4\">\n            <div data-tour=\"dashboard-welcome\">\n              <h1 className=\"text-3xl font-bold text-gray-900\">\n                Welcome back, {userProfile.name.split(' ')[0]}! ðŸ‘‹\n              </h1>\n              <p className=\"mt-1 text-gray-600\">\n                Manage your bookings, credits, and favorite providers\n              </p>\n            </div>\n            \n            {/* Notifications */}\n            <div className=\"relative\">\n              <button\n                onClick={loadNotifications}\n                className=\"relative p-2 text-gray-400 hover:text-gray-600 transition-colors\"\n                disabled={notifications.loading}\n              >\n                <span className=\"text-2xl\">ðŸ””</span>\n                {notifications.data && notifications.data.length > 0 && (\n                  <span className=\"absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center\">\n                    {notifications.data.length}\n                  </span>\n                )}\n              </button>\n              \n              {/* Notifications dropdown */}\n              {notifications.data && notifications.data.length > 0 && (\n                <div className=\"absolute right-0 mt-2 w-[calc(100vw-2rem)] max-w-sm bg-white rounded-lg shadow-lg border z-10\">\n                  <div className=\"p-4\">\n                    <h3 className=\"font-medium text-gray-900 mb-3\">Recent Notifications</h3>\n                    <div className=\"space-y-2 max-h-64 overflow-y-auto\">\n                      {notifications.data.slice(0, 5).map((notification, index) => (\n                        <div key={index} className=\"text-sm text-gray-600 p-2 hover:bg-gray-50 rounded\">\n                          {notification.message}\n                        </div>\n                      ))}\n                    </div>\n                  </div>\n                </div>\n              )}\n            </div>\n          </div>\n        </div>\n      </div>\n\n      {/* Main Content */}\n      <div className=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8\">\n        {/* Status Messages */}\n        {notifications.error && (\n          <NetworkError \n            error={notifications.error} \n            onRetry={loadNotifications}\n            className=\"mb-6\"\n          />\n        )}\n        \n        {notifications.success && (\n          <SuccessMessage \n            message=\"Notifications loaded successfully\"\n            className=\"mb-6\"\n            autoDismiss\n          />\n        )}\n\n        {/* Tabs */}\n        <div className=\"bg-white rounded-lg shadow-sm border mb-8\">\n          <div className=\"border-b border-gray-200\">\n            <nav className=\"-mb-px flex flex-nowrap gap-6 px-6 overflow-x-auto overscroll-x-contain\">\n              {[\n                { id: 'overview' as const, label: 'Overview', icon: 'ðŸ“Š' },\n                { id: 'bookings' as const, label: 'Bookings', icon: 'ðŸ“…' },\n                { id: 'credits' as const, label: 'Credits', icon: 'ðŸ’°' },\n                { id: 'favorites' as const, label: 'Favorites', icon: 'â¤ï¸' },\n                { id: 'profile' as const, label: 'Profile', icon: 'ðŸ‘¤' }\n              ].map((tab) => (\n                <button\n                  key={tab.id}\n                  onClick={() => setActiveTab(tab.id)}\n                  className={cn(\n                    'py-4 px-1 border-b-2 font-medium text-sm flex items-center gap-2 whitespace-nowrap',\n                    activeTab === tab.id\n                      ? 'border-blue-500 text-blue-600'\n                      : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'\n                  )}\n                >\n                  <span>{tab.icon}</span>\n                  {tab.label}\n                </button>\n              ))}\n            </nav>\n          </div>\n\n          {/* Tab Content */}\n          <div className=\"p-6\">\n            {activeTab === 'overview' && (\n              <div className=\"space-y-6\">\n                {/* Quick Stats */}\n                <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6\">\n                  <div className=\"bg-gradient-to-r from-blue-500 to-purple-600 text-white p-6 rounded-lg\">\n                    <div className=\"flex items-center justify-between\">\n                      <div>\n                        <p className=\"text-blue-100\">Total Bookings</p>\n                        <p className=\"text-3xl font-bold\">{bookings.length}</p>\n                      </div>\n                      <span className=\"text-4xl\">ðŸ“…</span>\n                    </div>\n                  </div>\n                  \n                  <div className=\"bg-gradient-to-r from-green-500 to-emerald-600 text-white p-6 rounded-lg\">\n                    <div className=\"flex items-center justify-between\">\n                      <div>\n                        <p className=\"text-green-100\">Credits Balance</p>\n                        <p className=\"text-3xl font-bold\">\n                          ${credits ? (credits.balance_cents / 100).toFixed(2) : '0.00'}\n                        </p>\n                      </div>\n                      <span className=\"text-4xl\">ðŸ’°</span>\n                    </div>\n                  </div>\n                  \n                  <div className=\"bg-gradient-to-r from-pink-500 to-rose-600 text-white p-6 rounded-lg\">\n                    <div className=\"flex items-center justify-between\">\n                      <div>\n                        <p className=\"text-pink-100\">Favorite Providers</p>\n                        <p className=\"text-3xl font-bold\">{favoriteProviders.length}</p>\n                      </div>\n                      <span className=\"text-4xl\">â¤ï¸</span>\n                    </div>\n                  </div>\n                </div>\n\n                {/* Recent Activity */}\n                <div className=\"bg-gray-50 p-6 rounded-lg\" data-tour=\"upcoming-bookings\">\n                  <h3 className=\"text-lg font-medium text-gray-900 mb-4\">Recent Activity</h3>\n                  {bookings.length > 0 ? (\n                    <div className=\"space-y-3\">\n                      {bookings.slice(0, 3).map((booking) => (\n                        <div key={booking.id} className=\"flex items-center justify-between p-3 bg-white rounded-lg border\">\n                          <div className=\"flex items-center gap-3\">\n                            <span className=\"text-2xl\">ðŸ“‹</span>\n                            <div>\n                              <p className=\"font-medium text-gray-900\">{booking.service_name}</p>\n                              <p className=\"text-sm text-gray-500\">\n                                {new Date(booking.date).toLocaleDateString()}\n                              </p>\n                            </div>\n                          </div>\n                          <span className={cn(\n                            'px-2 py-1 text-xs font-medium rounded-full',\n                            getStatusColor(booking.status)\n                          )}>\n                            {booking.status}\n                          </span>\n                        </div>\n                      ))}\n                    </div>\n                  ) : (\n                    <p className=\"text-gray-500 text-center py-4\">No recent activity</p>\n                  )}\n                </div>\n              </div>\n            )}\n\n            {/* Bookings Tab */}\n            {activeTab === 'bookings' && (\n              <div className=\"space-y-6\" data-tour=\"booking-history\">\n                {/* Search and Filter */}\n                <div className=\"bg-white rounded-2xl shadow-sm p-6\">\n                  <div className=\"flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4\">\n                    <div className=\"flex-1 relative\">\n                      <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400\" />\n                      <input\n                        type=\"text\"\n                        placeholder=\"Search bookings...\"\n                        value={searchQuery}\n                        onChange={(e) => setSearchQuery(e.target.value)}\n                        className=\"w-full pl-10 pr-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n                      />\n                    </div>\n                    \n                    <div className=\"relative\">\n                      <Filter className=\"absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400\" />\n                      <select\n                        value={filterStatus}\n                        onChange={(e) => setFilterStatus(e.target.value as 'all' | 'upcoming' | 'completed' | 'cancelled')}\n                        className=\"pl-10 pr-8 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent appearance-none bg-white\"\n                      >\n                        <option value=\"all\">All Status</option>\n                        <option value=\"upcoming\">Upcoming</option>\n                        <option value=\"completed\">Completed</option>\n                        <option value=\"cancelled\">Cancelled</option>\n                      </select>\n                    </div>\n                  </div>\n                </div>\n\n                {/* Bookings List */}\n                <div className=\"space-y-4\">\n                  {bookings.filter(booking => {\n                    const matchesSearch = booking.service_name.toLowerCase().includes(searchQuery.toLowerCase()) ||\n                                         booking.provider_name.toLowerCase().includes(searchQuery.toLowerCase())\n                    const matchesFilter = filterStatus === 'all' || booking.status === filterStatus\n                    return matchesSearch && matchesFilter\n                  }).map((booking) => (\n                    <motion.div\n                      key={booking.id}\n                      initial={{ opacity: 0, y: 20 }}\n                      animate={{ opacity: 1, y: 0 }}\n                      whileHover={{ scale: 1.01 }}\n                      className=\"bg-white rounded-2xl shadow-sm p-6 cursor-pointer hover:shadow-md transition-shadow\"\n                    >\n                      <div className=\"flex flex-col md:flex-row md:items-start md:justify-between gap-4\">\n                        <div className=\"flex items-start gap-4\">\n                          <div className=\"w-12 h-12 bg-gray-200 rounded-xl\"></div>\n                          <div className=\"flex-1\">\n                            <h3 className=\"font-semibold text-gray-900\">{booking.service_name}</h3>\n                            <p className=\"text-gray-600\">{booking.provider_name}</p>\n                            <div className=\"flex flex-wrap items-center gap-x-4 gap-y-1 mt-2\">\n                              <div className=\"flex items-center text-sm text-gray-500\">\n                                <Calendar className=\"w-4 h-4 mr-1\" />\n                                {formatDate(booking.date)}\n                              </div>\n                              <div className=\"flex items-center text-sm text-gray-500\">\n                                <Clock className=\"w-4 h-4 mr-1\" />\n                                {booking.time}\n                              </div>\n                              <div className=\"flex items-center text-sm text-gray-500\">\n                                <MapPin className=\"w-4 h-4 mr-1\" />\n                                {booking.location}\n                              </div>\n                            </div>\n                            {booking.notes && (\n                              <p className=\"text-sm text-gray-500 mt-2\">Note: {booking.notes}</p>\n                            )}\n                          </div>\n                        </div>\n                        \n                        <div className=\"text-left md:text-right\">\n                          <TooltipProvider>\n                            <Tooltip>\n                              <TooltipTrigger asChild>\n                                <div className={`inline-flex items-center px-3 py-1 rounded-full text-sm font-medium cursor-help ${getStatusColor(booking.status)}`}>\n                                  {booking.status === 'upcoming' && <Clock className=\"w-3 h-3 mr-1\" />}\n                                  {booking.status === 'completed' && <CheckCircle className=\"w-3 h-3 mr-1\" />}\n                                  {booking.status === 'cancelled' && <AlertCircle className=\"w-3 h-3 mr-1\" />}\n                                  {booking.status.charAt(0).toUpperCase() + booking.status.slice(1)}\n                                </div>\n                              </TooltipTrigger>\n                              <TooltipContent>\n                                <p className=\"max-w-xs\">{getStatusDescription(booking.status)}</p>\n                              </TooltipContent>\n                            </Tooltip>\n                          </TooltipProvider>\n                          <p className=\"text-lg font-semibold text-gray-900 mt-2\">\n                            {formatCurrency(booking.price_cents)}\n                          </p>\n                          {booking.rating && (\n                            <div className=\"flex items-center mt-1 md:justify-end\">\n                              {[...Array(5)].map((_, i) => (\n                                <Star\n                                  key={i}\n                                  className={`w-3 h-3 ${\n                                    i < booking.rating! ? 'text-yellow-400 fill-current' : 'text-gray-300'\n                                  }`}\n                                />\n                                ))}\n                            </div>\n                          )}\n                          {canRateBooking(booking.status) && (\n                            <Link\n                              href={`/ratings/booking/${booking.id}`}\n                              className=\"mt-2 inline-flex text-sm text-blue-600 hover:text-blue-700\"\n                            >\n                              {t('rating.rate_booking')}\n                            </Link>\n                          )}\n                        </div>\n                      </div>\n                    </motion.div>\n                  ))}\n                </div>\n              </div>\n            )}\n\n            {/* Credits Tab */}\n            {activeTab === 'credits' && credits && (\n              <div className=\"space-y-6\">\n                {/* Credit Balance Card */}\n                <motion.div\n                  initial={{ opacity: 0, scale: 0.9 }}\n                  animate={{ opacity: 1, scale: 1 }}\n                  className=\"bg-gradient-to-r from-blue-600 to-purple-600 rounded-2xl p-8 text-white\"\n                >\n                  <div className=\"flex items-center justify-between\">\n                    <div>\n                      <h2 className=\"text-2xl font-bold\">Credit Balance</h2>\n                      <p className=\"text-4xl font-bold mt-2\">${credits.balance_dollars}</p>\n                      <p className=\"text-blue-100 mt-1\">Available to spend</p>\n                    </div>\n                    <div className=\"text-right\">\n                      <Coins className=\"w-16 h-16 text-white opacity-80\" />\n                      <motion.button\n                        whileHover={{ scale: 1.05 }}\n                        whileTap={{ scale: 0.95 }}\n                        className=\"mt-4 bg-white bg-opacity-20 backdrop-blur-sm px-6 py-3 rounded-xl font-medium hover:bg-opacity-30 transition-all flex items-center\"\n                      >\n                        <Plus className=\"w-4 h-4 mr-2\" />\n                        Add Credits\n                      </motion.button>\n                    </div>\n                  </div>\n                </motion.div>\n\n                {/* Recent Transactions */}\n                <div className=\"bg-white rounded-2xl shadow-sm p-6\">\n                  <h3 className=\"text-lg font-semibold text-gray-900 mb-6\">Recent Transactions</h3>\n                  <div className=\"space-y-4\">\n                    {credits.recent_transactions.map((transaction) => (\n                      <div key={transaction.id} className=\"flex items-center justify-between p-4 border border-gray-100 rounded-xl\">\n                        <div className=\"flex items-center space-x-4\">\n                          <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${\n                            transaction.type === 'purchase' ? 'bg-green-100' :\n                            transaction.type === 'usage' ? 'bg-blue-100' :\n                            transaction.type === 'bonus' ? 'bg-yellow-100' : 'bg-gray-100'\n                          }`}>\n                            {transaction.type === 'purchase' && <Plus className=\"w-5 h-5 text-green-600\" />}\n                            {transaction.type === 'usage' && <Coins className=\"w-5 h-5 text-blue-600\" />}\n                            {transaction.type === 'bonus' && <Award className=\"w-5 h-5 text-yellow-600\" />}\n                            {transaction.type === 'refund' && <Zap className=\"w-5 h-5 text-gray-600\" />}\n                          </div>\n                          <div>\n                            <p className=\"font-medium text-gray-900\">{transaction.description}</p>\n                            <p className=\"text-sm text-gray-500\">{formatDate(transaction.date)}</p>\n                          </div>\n                        </div>\n                        <div className={`font-semibold ${\n                          transaction.amount_cents > 0 ? 'text-green-600' : 'text-red-600'\n                        }`}>\n                          {transaction.amount_cents > 0 ? '+' : ''}{formatCurrency(transaction.amount_cents)}\n                        </div>\n                      </div>\n                    ))}\n                  </div>\n                </div>\n              </div>\n            )}\n\n            {/* Favorites Tab */}\n            {activeTab === 'favorites' && (\n              <div className=\"space-y-6\" data-tour=\"favorites\">\n                <div className=\"grid sm:grid-cols-2 lg:grid-cols-3 gap-6\">\n                  {favoriteProviders.map((provider, index) => (\n                    <div key={index} className=\"p-4 border rounded-lg\">\n                      <h3 className=\"font-semibold\">{provider.business_name}</h3>\n                      <Link href={`/book/${provider.business_name}`}>\n                        <Image src={provider.avatar_url} alt={provider.business_name} width={64} height={64} className=\"w-16 h-16 rounded-full\" />\n                      </Link>\n                      <div className=\"flex items-center mt-2\">\n                        <Star className=\"w-4 h-4 text-yellow-400\" />\n                        <span className=\"ml-1\">{provider.rating}</span>\n                        <span className=\"text-sm text-gray-500 ml-2\">({provider.total_reviews} reviews)</span>\n                      </div>\n                      <div className=\"mt-2\">\n                        {provider.specialties.map((specialty, i) => (\n                          <span key={i} className=\"inline-block px-2 py-1 text-xs bg-gray-100 rounded mr-1 mb-1\">\n                            {specialty}\n                          </span>\n                        ))}\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              </div>\n            )}\n\n            {/* Profile Tab */}\n            {activeTab === 'profile' && userProfile && (\n              <div className=\"space-y-6\" data-tour=\"profile-settings\">\n                <div className=\"bg-white rounded-2xl shadow-sm p-6\">\n                  <div className=\"flex items-start space-x-6\">\n                    <div className=\"w-24 h-24 bg-gradient-to-r from-blue-600 to-purple-600 rounded-2xl flex items-center justify-center\">\n                      <User className=\"w-12 h-12 text-white\" />\n                    </div>\n                    <div className=\"flex-1\">\n                      <div className=\"flex items-center space-x-3 mb-2\">\n                        <h2 className=\"text-2xl font-bold text-gray-900\">{userProfile.name}</h2>\n                        {userProfile.verification_status === 'verified' && (\n                          <div className=\"flex items-center px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm\">\n                            <Shield className=\"w-4 h-4 mr-1\" />\n                            Verified\n                          </div>\n                        )}\n                      </div>\n                      <div className=\"space-y-2\">\n                        <div className=\"flex items-center text-gray-600\">\n                          <Mail className=\"w-4 h-4 mr-2\" />\n                          {userProfile.email}\n                        </div>\n                        <div className=\"flex items-center text-gray-600\">\n                          <Phone className=\"w-4 h-4 mr-2\" />\n                          {userProfile.phone || 'No phone number'}\n                        </div>\n                        <div className=\"flex items-center text-gray-600\">\n                          <Calendar className=\"w-4 h-4 mr-2\" />\n                          Member since {formatDate(userProfile.member_since)}\n                        </div>\n                      </div>\n                    </div>\n                  </div>\n                </div>\n\n                {/* Preferences */}\n                <div className=\"bg-white rounded-2xl shadow-sm p-6\">\n                  <h3 className=\"text-lg font-semibold text-gray-900 mb-6\">Preferences</h3>\n                  <div className=\"space-y-4\">\n                    {Object.entries(userProfile.preferences).map(([key, value]) => (\n                      <div key={key} className=\"flex items-center justify-between\">\n                        <span className=\"text-gray-700 capitalize\">\n                          {key.replace('_', ' ')}\n                        </span>\n                        <motion.button\n                          whileTap={{ scale: 0.95 }}\n                          className={`w-12 h-6 rounded-full transition-colors ${\n                            value ? 'bg-blue-600' : 'bg-gray-300'\n                          }`}\n                        >\n                          <motion.div\n                            className=\"w-5 h-5 bg-white rounded-full shadow-md\"\n                            animate={{ x: value ? 24 : 2 }}\n                            transition={{ type: \"spring\", stiffness: 300, damping: 30 }}\n                          />\n                        </motion.button>\n                      </div>\n                    ))}\n                  </div>\n                </div>\n              </div>\n            )}\n          </div>\n        </div>\n      </div>\n    </div>\n  )\n} \n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\components\\admin\\PerformanceDashboard.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'TrendingDown' is defined but never used. Allowed unused vars must match /^_/u.","line":10,"column":31,"nodeType":null,"messageId":"unusedVar","endLine":10,"endColumn":43},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Database' is defined but never used. Allowed unused vars must match /^_/u.","line":10,"column":82,"nodeType":null,"messageId":"unusedVar","endLine":10,"endColumn":90}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchData'. Either include it or remove the dependency array.","line":147,"column":6,"nodeType":"ArrayExpression","endLine":147,"endColumn":27,"suggestions":[{"desc":"Update the dependencies array to be: [timeRange, endpoint, fetchData]","fix":{"range":[4343,4364],"text":"[timeRange, endpoint, fetchData]"}}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchData'. Either include it or remove the dependency array.","line":155,"column":6,"nodeType":"ArrayExpression","endLine":155,"endColumn":40,"suggestions":[{"desc":"Update the dependencies array to be: [autoRefresh, timeRange, endpoint, fetchData]","fix":{"range":[4607,4641],"text":"[autoRefresh, timeRange, endpoint, fetchData]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\r\n\r\nimport React, { useState, useEffect } from 'react'\r\nimport { useRouter } from 'next/navigation'\r\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'\r\nimport { Button } from '@/components/ui/button'\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'\r\nimport { Badge } from '@/components/ui/badge'\r\nimport { Alert, AlertDescription } from '@/components/ui/alert'\r\nimport { Loader2, TrendingUp, TrendingDown, Activity, Clock, AlertTriangle, Zap, Database, Globe } from 'lucide-react'\r\n\r\ninterface PerformanceData {\r\n  five_minute_bucket: string\r\n  endpoint: string\r\n  request_count: number\r\n  avg_response_time_ms: number\r\n  p95_response_time_ms: number\r\n  p99_response_time_ms: number\r\n  cache_hit_rate: number\r\n  database_queries: number\r\n}\r\n\r\ninterface ApiMetrics {\r\n  bucket: string\r\n  endpoint: string\r\n  reqs: number\r\n  p95_ms: number\r\n  p99_ms: number\r\n  err_rate: number\r\n}\r\n\r\ninterface CurrentMetrics {\r\n  request_id: string\r\n  endpoint: string\r\n  method: string\r\n  response_time_ms: number\r\n  status_code: number\r\n  cache_hit: boolean\r\n  database_queries: number\r\n  created_at: string\r\n}\r\n\r\ninterface Summary {\r\n  totalRequests: number\r\n  avgResponseTime: number\r\n  p95ResponseTime: number\r\n  p99ResponseTime: number\r\n  errorRate: number\r\n  cacheHitRate: number\r\n}\r\n\r\ninterface ApiResponse {\r\n  data: {\r\n    performance: PerformanceData[]\r\n    apiMetrics: ApiMetrics[]\r\n    currentMetrics: CurrentMetrics[]\r\n    summary: Summary\r\n  }\r\n  timeRange: string\r\n  startTime: string\r\n  endTime: string\r\n  error?: string\r\n  hint?: string\r\n}\r\n\r\ninterface _PerformanceDashboardProps {\r\n  onEndpointClick?: (endpoint: string, timeRange: string) => void\r\n}\r\n\r\nexport default function PerformanceDashboard() {\r\n  const router = useRouter()\r\n  const [data, setData] = useState<ApiResponse['data'] | null>(null)\r\n  const [loading, setLoading] = useState(false)\r\n  const [error, setError] = useState<string | null>(null)\r\n  const [errorHint, setErrorHint] = useState<string | null>(null)\r\n  const [timeRange, setTimeRange] = useState('1h')\r\n  const [endpoint, setEndpoint] = useState('')\r\n  const [autoRefresh, setAutoRefresh] = useState(true)\r\n  const [lastUpdated, setLastUpdated] = useState<Date | null>(null)\r\n  const [isVisible, setIsVisible] = useState(true)\r\n\r\n  // Helper function to convert time range to milliseconds\r\n  const getTimeRangeMs = (range: string): number => {\r\n    switch (range) {\r\n      case '5m': return 5 * 60 * 1000\r\n      case '15m': return 15 * 60 * 1000\r\n      case '1h': return 60 * 60 * 1000\r\n      case '6h': return 6 * 60 * 60 * 1000\r\n      case '24h': return 24 * 60 * 60 * 1000\r\n      case '7d': return 7 * 24 * 60 * 60 * 1000\r\n      default: return 60 * 60 * 1000 // 1h default\r\n    }\r\n  }\r\n\r\n  // Pause auto-refresh when tab is not visible\r\n  useEffect(() => {\r\n    const onVisibilityChange = () => {\r\n      const isVisible = document.visibilityState === 'visible'\r\n      setIsVisible(isVisible)\r\n      if (!isVisible) {\r\n        setAutoRefresh(false)\r\n      }\r\n    }\r\n\r\n    document.addEventListener('visibilitychange', onVisibilityChange)\r\n    return () => document.removeEventListener('visibilitychange', onVisibilityChange)\r\n  }, [])\r\n\r\n  const fetchData = async () => {\r\n    setLoading(true)\r\n    setError(null)\r\n    setErrorHint(null)\r\n\r\n    try {\r\n      const params = new URLSearchParams({\r\n        timeRange,\r\n        ...(endpoint && { endpoint })\r\n      })\r\n\r\n      const response = await fetch(`/api/admin/performance?${params}`)\r\n      const result: ApiResponse = await response.json()\r\n\r\n      if (!response.ok) {\r\n        if (response.status === 403) {\r\n          setError('Permission denied')\r\n          setErrorHint(result.hint || 'Check admin role and RLS policies')\r\n        } else {\r\n          setError(result.error || 'Failed to fetch performance data')\r\n          setErrorHint(result.hint || null)\r\n        }\r\n        return\r\n      }\r\n\r\n             setData(result.data)\r\n       setLastUpdated(new Date())\r\n     } catch (_err) {\r\n       setError('Network error occurred')\r\n       setErrorHint('Check network connection and try again')\r\n     } finally {\r\n       setLoading(false)\r\n     }\r\n  }\r\n\r\n  useEffect(() => {\r\n    fetchData()\r\n  // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [timeRange, endpoint])\r\n\r\n  useEffect(() => {\r\n    if (!autoRefresh) return\r\n\r\n    const interval = setInterval(fetchData, 30000) // Refresh every 30 seconds\r\n    return () => clearInterval(interval)\r\n  // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [autoRefresh, timeRange, endpoint])\r\n\r\n  const formatTime = (timeString: string) => {\r\n    return new Date(timeString).toLocaleTimeString()\r\n  }\r\n\r\n  const formatDuration = (ms: number) => {\r\n    if (ms < 1000) return `${ms.toFixed(0)}ms`\r\n    return `${(ms / 1000).toFixed(2)}s`\r\n  }\r\n\r\n  const getPerformanceColor = (value: number, threshold: number) => {\r\n    if (value <= threshold) return 'text-green-600'\r\n    if (value <= threshold * 1.5) return 'text-yellow-600'\r\n    return 'text-red-600'\r\n  }\r\n\r\n  const getStatusColor = (statusCode: number) => {\r\n    if (statusCode < 300) return 'bg-green-100 text-green-800'\r\n    if (statusCode < 400) return 'bg-yellow-100 text-yellow-800'\r\n    return 'bg-red-100 text-red-800'\r\n  }\r\n\r\n  if (error) {\r\n    return (\r\n      <Alert variant=\"destructive\">\r\n        <AlertTriangle className=\"h-4 w-4\" />\r\n        <AlertDescription>\r\n          <div className=\"font-semibold\">{error}</div>\r\n          {errorHint && (\r\n            <div className=\"mt-2 text-sm opacity-90\">\r\n              <strong>Hint:</strong> {errorHint}\r\n            </div>\r\n          )}\r\n        </AlertDescription>\r\n      </Alert>\r\n    )\r\n  }\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      {/* Header */}\r\n      <div className=\"flex items-center justify-between\">\r\n        <div>\r\n          <h2 className=\"text-2xl font-bold tracking-tight\">Performance Dashboard</h2>\r\n          <p className=\"text-muted-foreground\">\r\n            Real-time system performance metrics from 5-minute rollups\r\n          </p>\r\n        </div>\r\n                 <div className=\"flex items-center gap-4\">\r\n           <div className=\"text-sm text-muted-foreground\">\r\n             {lastUpdated && (\r\n               <span>Last updated: {lastUpdated.toLocaleTimeString()} UTC</span>\r\n             )}\r\n           </div>\r\n           <Button\r\n             variant={autoRefresh ? 'default' : 'outline'}\r\n             size=\"sm\"\r\n             onClick={() => setAutoRefresh(!autoRefresh)}\r\n             disabled={!isVisible}\r\n           >\r\n             <Activity className={`h-4 w-4 mr-2 ${autoRefresh && isVisible ? 'animate-pulse' : ''}`} />\r\n             {autoRefresh && isVisible ? 'Auto-refresh ON' : 'Auto-refresh OFF'}\r\n           </Button>\r\n           <Button variant=\"outline\" size=\"sm\" onClick={fetchData} disabled={loading}>\r\n             {loading && <Loader2 className=\"mr-2 h-4 w-4 animate-spin\" />}\r\n             Refresh Now\r\n           </Button>\r\n         </div>\r\n      </div>\r\n\r\n      {/* Controls */}\r\n      <Card>\r\n        <CardContent className=\"pt-6\">\r\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n            <div>\r\n              <label className=\"text-sm font-medium\">Time Range</label>\r\n              <Select value={timeRange} onValueChange={setTimeRange}>\r\n                <SelectTrigger>\r\n                  <SelectValue />\r\n                </SelectTrigger>\r\n                <SelectContent>\r\n                  <SelectItem value=\"1h\">Last Hour</SelectItem>\r\n                  <SelectItem value=\"6h\">Last 6 Hours</SelectItem>\r\n                  <SelectItem value=\"24h\">Last 24 Hours</SelectItem>\r\n                </SelectContent>\r\n              </Select>\r\n            </div>\r\n            <div>\r\n              <label className=\"text-sm font-medium\">Endpoint Filter</label>\r\n              <Select value={endpoint} onValueChange={setEndpoint}>\r\n                <SelectTrigger>\r\n                  <SelectValue placeholder=\"All endpoints\" />\r\n                </SelectTrigger>\r\n                <SelectContent>\r\n                  <SelectItem value=\"\">All endpoints</SelectItem>\r\n                  <SelectItem value=\"/api/search/providers\">Search API</SelectItem>\r\n                  <SelectItem value=\"/api/bookings\">Bookings API</SelectItem>\r\n                  <SelectItem value=\"/api/analytics\">Analytics API</SelectItem>\r\n                </SelectContent>\r\n              </Select>\r\n            </div>\r\n          </div>\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* Summary Cards */}\r\n      {data && (\r\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\r\n          <Card>\r\n            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n              <CardTitle className=\"text-sm font-medium\">Total Requests</CardTitle>\r\n              <Globe className=\"h-4 w-4 text-muted-foreground\" />\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className=\"text-2xl font-bold\">{data.summary.totalRequests.toLocaleString()}</div>\r\n              <p className=\"text-xs text-muted-foreground\">\r\n                Across {timeRange} time range\r\n              </p>\r\n            </CardContent>\r\n          </Card>\r\n\r\n                     <Card>\r\n             <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n               <CardTitle className=\"text-sm font-medium\">Avg Response Time</CardTitle>\r\n               <Clock className=\"h-4 w-4 text-muted-foreground\" />\r\n             </CardHeader>\r\n             <CardContent>\r\n               <div className={`text-2xl font-bold ${getPerformanceColor(data.summary.avgResponseTime, 500)}`}>\r\n                 {formatDuration(data.summary.avgResponseTime)}\r\n               </div>\r\n               <p className=\"text-xs text-muted-foreground\" title=\"Target p95 < 500ms, p99 < 1s, error-rate < 1%\">\r\n                 Target: &lt;500ms\r\n               </p>\r\n             </CardContent>\r\n           </Card>\r\n\r\n          <Card>\r\n            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n              <CardTitle className=\"text-sm font-medium\">P95 Response Time</CardTitle>\r\n              <TrendingUp className=\"h-4 w-4 text-muted-foreground\" />\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className={`text-2xl font-bold ${getPerformanceColor(data.summary.p95ResponseTime, 1000)}`}>\r\n                {formatDuration(data.summary.p95ResponseTime)}\r\n              </div>\r\n              <p className=\"text-xs text-muted-foreground\">\r\n                Target: &lt;1s\r\n              </p>\r\n            </CardContent>\r\n          </Card>\r\n\r\n          <Card>\r\n            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n              <CardTitle className=\"text-sm font-medium\">P99 Response Time</CardTitle>\r\n              <TrendingUp className=\"h-4 w-4 text-muted-foreground\" />\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className={`text-2xl font-bold ${getPerformanceColor(data.summary.p99ResponseTime, 2000)}`}>\r\n                {formatDuration(data.summary.p99ResponseTime)}\r\n              </div>\r\n              <p className=\"text-xs text-muted-foreground\">\r\n                Target: &lt;2s\r\n              </p>\r\n            </CardContent>\r\n          </Card>\r\n\r\n          <Card>\r\n            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n              <CardTitle className=\"text-sm font-medium\">Error Rate</CardTitle>\r\n              <AlertTriangle className=\"h-4 w-4 text-muted-foreground\" />\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className={`text-2xl font-bold ${getPerformanceColor(data.summary.errorRate * 100, 1)}`}>\r\n                {(data.summary.errorRate * 100).toFixed(2)}%\r\n              </div>\r\n              <p className=\"text-xs text-muted-foreground\">\r\n                Target: &lt;1%\r\n              </p>\r\n            </CardContent>\r\n          </Card>\r\n\r\n          <Card>\r\n            <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n              <CardTitle className=\"text-sm font-medium\">Cache Hit Rate</CardTitle>\r\n              <Zap className=\"h-4 w-4 text-muted-foreground\" />\r\n            </CardHeader>\r\n            <CardContent>\r\n              <div className={`text-2xl font-bold ${getPerformanceColor(data.summary.cacheHitRate * 100, 80)}`}>\r\n                {(data.summary.cacheHitRate * 100).toFixed(1)}%\r\n              </div>\r\n              <p className=\"text-xs text-muted-foreground\">\r\n                Target: &gt;80%\r\n              </p>\r\n            </CardContent>\r\n          </Card>\r\n        </div>\r\n      )}\r\n\r\n      {/* Performance Timeline */}\r\n      {data && data.performance.length > 0 && (\r\n        <Card>\r\n          <CardHeader>\r\n            <CardTitle className=\"flex items-center gap-2\">\r\n              <TrendingUp className=\"h-5 w-5\" />\r\n              Performance Timeline (5-min intervals)\r\n            </CardTitle>\r\n          </CardHeader>\r\n          <CardContent>\r\n            <div className=\"space-y-4\">\r\n              {data.performance.map((item, index) => (\r\n                <div key={index} className=\"border rounded-lg p-4\">\r\n                  <div className=\"flex items-center justify-between mb-3\">\r\n                                       <div className=\"flex items-center gap-3\">\r\n                     <Badge \r\n                       variant=\"outline\" \r\n                       className=\"cursor-pointer hover:bg-primary hover:text-primary-foreground transition-colors\"\r\n                       onClick={() => {\r\n                         // Direct navigation to audit view\r\n                         const fromISO = new Date(Date.now() - getTimeRangeMs(timeRange)).toISOString()\r\n                         const toISO = new Date().toISOString()\r\n                         router.push(`/admin/operational-insights?tab=audit&endpoint=${encodeURIComponent(item.endpoint)}&from=${fromISO}&to=${toISO}`)\r\n                         \r\n                         // Also send message for iframe scenarios\r\n                         if (window.parent && window.parent !== window) {\r\n                           window.parent.postMessage({\r\n                             type: 'PERFORMANCE_DRILL_THROUGH',\r\n                             endpoint: item.endpoint,\r\n                             timeRange: timeRange\r\n                           }, '*')\r\n                         }\r\n                       }}\r\n                     >\r\n                       {item.endpoint}\r\n                     </Badge>\r\n                     <span className=\"text-sm text-muted-foreground\">\r\n                       {formatTime(item.five_minute_bucket)}\r\n                     </span>\r\n                   </div>\r\n                    <div className=\"text-right\">\r\n                      <div className=\"text-sm font-medium\">{item.request_count} requests</div>\r\n                    </div>\r\n                  </div>\r\n                  \r\n                  <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4 text-sm\">\r\n                    <div>\r\n                      <span className=\"text-muted-foreground\">Avg:</span>\r\n                      <span className={`ml-2 font-mono ${getPerformanceColor(item.avg_response_time_ms, 500)}`}>\r\n                        {formatDuration(item.avg_response_time_ms)}\r\n                      </span>\r\n                    </div>\r\n                    <div>\r\n                      <span className=\"text-muted-foreground\">P95:</span>\r\n                      <span className={`ml-2 font-mono ${getPerformanceColor(item.p95_response_time_ms, 1000)}`}>\r\n                        {formatDuration(item.p95_response_time_ms)}\r\n                      </span>\r\n                    </div>\r\n                    <div>\r\n                      <span className=\"text-muted-foreground\">P99:</span>\r\n                      <span className={`ml-2 font-mono ${getPerformanceColor(item.p99_response_time_ms, 2000)}`}>\r\n                        {formatDuration(item.p99_response_time_ms)}\r\n                      </span>\r\n                    </div>\r\n                    <div>\r\n                      <span className=\"text-muted-foreground\">Cache:</span>\r\n                      <span className=\"ml-2 font-mono\">\r\n                        {(item.cache_hit_rate * 100).toFixed(1)}%\r\n                      </span>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              ))}\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n      )}\r\n\r\n      {/* Recent Requests */}\r\n      {data && data.currentMetrics.length > 0 && (\r\n        <Card>\r\n          <CardHeader>\r\n            <CardTitle className=\"flex items-center gap-2\">\r\n              <Activity className=\"h-5 w-5\" />\r\n              Recent Requests (Live)\r\n            </CardTitle>\r\n          </CardHeader>\r\n          <CardContent>\r\n            <div className=\"space-y-3\">\r\n              {data.currentMetrics.slice(0, 20).map((metric, index) => (\r\n                <div key={index} className=\"flex items-center justify-between p-3 border rounded-lg\">\r\n                  <div className=\"flex items-center gap-3\">\r\n                    <Badge className={getStatusColor(metric.status_code)}>\r\n                      {metric.status_code}\r\n                    </Badge>\r\n                    <div>\r\n                      <div className=\"font-medium\">\r\n                        {metric.method} \r\n                        <span \r\n                          className=\"cursor-pointer hover:text-primary transition-colors ml-1\"\r\n                          onClick={() => {\r\n                            const fromISO = new Date(Date.now() - getTimeRangeMs(timeRange)).toISOString()\r\n                            const toISO = new Date().toISOString()\r\n                            router.push(`/admin/operational-insights?tab=audit&endpoint=${encodeURIComponent(metric.endpoint)}&from=${fromISO}&to=${toISO}`)\r\n                          }}\r\n                        >\r\n                          {metric.endpoint}\r\n                        </span>\r\n                      </div>\r\n                      <div className=\"text-sm text-muted-foreground\">\r\n                        {formatTime(metric.created_at)}\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                  \r\n                  <div className=\"flex items-center gap-4 text-sm\">\r\n                    <div className=\"text-right\">\r\n                      <div className=\"font-mono\">{formatDuration(metric.response_time_ms)}</div>\r\n                      <div className=\"text-muted-foreground\">Response</div>\r\n                    </div>\r\n                    <div className=\"text-right\">\r\n                      <div className=\"font-mono\">{metric.database_queries}</div>\r\n                      <div className=\"text-muted-foreground\">DB Queries</div>\r\n                    </div>\r\n                    <div className=\"text-right\">\r\n                      <Badge variant={metric.cache_hit ? 'default' : 'secondary'}>\r\n                        {metric.cache_hit ? 'Cache Hit' : 'Cache Miss'}\r\n                      </Badge>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              ))}\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n      )}\r\n\r\n      {loading && (\r\n        <div className=\"flex items-center justify-center py-8\">\r\n          <Loader2 className=\"h-8 w-8 animate-spin\" />\r\n          <span className=\"ml-2\">Loading performance data...</span>\r\n        </div>\r\n      )}\r\n\r\n      {!loading && !data && (\r\n        <Card>\r\n          <CardContent className=\"py-8\">\r\n            <div className=\"text-center space-y-4\">\r\n              <div className=\"text-muted-foreground\">\r\n                No performance data available for the selected time range\r\n              </div>\r\n              <div className=\"text-sm text-muted-foreground\">\r\n                <strong>How to use:</strong>\r\n                <ol className=\"mt-2 space-y-1 text-left max-w-md mx-auto\">\r\n                  <li>1. Select time range (1h, 6h, 24h)</li>\r\n                  <li>2. Filter by specific endpoint if needed</li>\r\n                  <li>3. Click endpoint in chart to jump to audit view</li>\r\n                </ol>\r\n              </div>\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n      )}\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\components\\admin\\PerformanceMonitor.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'DollarSign' is defined but never used. Allowed unused vars must match /^_/u.","line":6,"column":61,"nodeType":null,"messageId":"unusedVar","endLine":6,"endColumn":71}],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":21,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":21,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[913,916],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[913,916],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useState, useEffect } from 'react'\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'\nimport { Button } from '@/components/ui/button'\nimport { AlertTriangle, Activity, TrendingUp, TrendingDown, DollarSign, Clock, HardDrive, Cpu } from 'lucide-react'\nimport { performanceGuardrails, PerformanceMetrics } from '@/lib/performance/guardrails'\n\ninterface PerformanceSummary {\n  current: PerformanceMetrics | null\n  average: Partial<PerformanceMetrics>\n  violations: string[]\n  recommendations: string[]\n}\n\nexport function PerformanceMonitor() {\n  const [summary, setSummary] = useState<PerformanceSummary | null>(null)\n  const [isMonitoring, setIsMonitoring] = useState(true)\n  const [refreshInterval, setRefreshInterval] = useState(5000) // 5 seconds\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  const [alertConfig, setAlertConfig] = useState<any>(null)\n  const [testingAlerts, setTestingAlerts] = useState(false)\n\n  useEffect(() => {\n    if (!isMonitoring) return\n\n    const updateSummary = () => {\n      const perfSummary = performanceGuardrails.getPerformanceSummary()\n      setSummary(perfSummary)\n    }\n\n    // Initial update\n    updateSummary()\n\n    // Set up interval\n    const interval = setInterval(updateSummary, refreshInterval)\n\n    return () => clearInterval(interval)\n  }, [isMonitoring, refreshInterval])\n\n  // Load alert configuration\n  useEffect(() => {\n    const loadAlertConfig = async () => {\n      try {\n        const response = await fetch('/api/admin/test-alerts')\n        if (response.ok) {\n          const data = await response.json()\n          setAlertConfig(data.config)\n        }\n      } catch (error) {\n        console.error('Failed to load alert config:', error)\n      }\n    }\n    loadAlertConfig()\n  }, [])\n\n  const toggleMonitoring = () => {\n    setIsMonitoring(!isMonitoring)\n    performanceGuardrails.setEnabled(!isMonitoring)\n  }\n\n  const clearMetrics = () => {\n    performanceGuardrails.clear()\n    setSummary(null)\n  }\n\n  const testAlerts = async () => {\n    setTestingAlerts(true)\n    try {\n      const response = await fetch('/api/admin/test-alerts', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          severity: 'warning',\n          testMessage: 'Test alert triggered from Performance Monitor'\n        })\n      })\n      \n      if (response.ok) {\n        alert('Test alerts sent successfully! Check your configured channels.')\n      } else {\n        alert('Failed to send test alerts. Check console for details.')\n      }\n    } catch (error) {\n      console.error('Failed to test alerts:', error)\n      alert('Failed to send test alerts. Check console for details.')\n    } finally {\n      setTestingAlerts(false)\n    }\n  }\n\n  const _getStatusColor = (value: number, threshold: number) => {\n    if (value >= threshold) return 'text-red-600'\n    if (value >= threshold * 0.8) return 'text-yellow-600'\n    return 'text-green-600'\n  }\n\n  const getStatusIcon = (value: number, threshold: number) => {\n    if (value >= threshold) return <AlertTriangle className=\"w-4 h-4 text-red-600\" />\n    if (value >= threshold * 0.8) return <TrendingUp className=\"w-4 h-4 text-yellow-600\" />\n    return <TrendingDown className=\"w-4 h-4 text-green-600\" />\n  }\n\n  if (!summary) {\n    return (\n      <div className=\"space-y-6\">\n        <div className=\"flex items-center justify-between\">\n          <h1 className=\"text-3xl font-bold\">Performance Monitor</h1>\n          <div className=\"space-x-2\">\n            <Button onClick={toggleMonitoring} variant=\"outline\">\n              {isMonitoring ? 'Stop Monitoring' : 'Start Monitoring'}\n            </Button>\n          </div>\n        </div>\n        <Card>\n          <CardContent className=\"pt-6\">\n            <div className=\"text-center text-muted-foreground\">\n              <p>No performance data available</p>\n              <p className=\"text-sm mt-2\">Start monitoring to see real-time performance metrics</p>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    )\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center justify-between\">\n        <h1 className=\"text-3xl font-bold\">Performance Monitor</h1>\n        <div className=\"space-x-2\">\n          <Button onClick={toggleMonitoring} variant={isMonitoring ? 'destructive' : 'default'}>\n            {isMonitoring ? 'Stop Monitoring' : 'Start Monitoring'}\n          </Button>\n          <Button onClick={clearMetrics} variant=\"outline\">\n            Clear Metrics\n          </Button>\n          <Button \n            onClick={testAlerts} \n            variant=\"outline\" \n            disabled={testingAlerts}\n          >\n            {testingAlerts ? 'Testing...' : 'Test Alerts'}\n          </Button>\n        </div>\n      </div>\n\n      {/* Current Performance Metrics */}\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6\">\n        <Card>\n          <CardHeader className=\"pb-2\">\n            <CardTitle className=\"text-sm font-medium text-muted-foreground flex items-center gap-2\">\n              <Clock className=\"w-4 h-4\" />\n              Response Time\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold flex items-center gap-2\">\n              {summary.current?.responseTime ? `${summary.current.responseTime}ms` : 'N/A'}\n              {summary.current?.responseTime && getStatusIcon(summary.current.responseTime, 5000)}\n            </div>\n            <div className=\"text-xs text-muted-foreground mt-1\">\n              Avg: {summary.average.responseTime ? `${summary.average.responseTime.toFixed(0)}ms` : 'N/A'}\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"pb-2\">\n            <CardTitle className=\"text-sm font-medium text-muted-foreground flex items-center gap-2\">\n              <HardDrive className=\"w-4 h-4\" />\n              Memory Usage\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold flex items-center gap-2\">\n              {summary.current?.memoryUsage ? `${summary.current.memoryUsage.toFixed(1)}MB` : 'N/A'}\n              {summary.current?.memoryUsage && getStatusIcon(summary.current.memoryUsage, 512)}\n            </div>\n            <div className=\"text-xs text-muted-foreground mt-1\">\n              Avg: {summary.average.memoryUsage ? `${summary.average.memoryUsage.toFixed(1)}MB` : 'N/A'}\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"pb-2\">\n            <CardTitle className=\"text-sm font-medium text-muted-foreground flex items-center gap-2\">\n              <Cpu className=\"w-4 h-4\" />\n              CPU Usage\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold flex items-center gap-2\">\n              {summary.current?.cpuUsage ? `${summary.current.cpuUsage.toFixed(1)}%` : 'N/A'}\n              {summary.current?.cpuUsage && getStatusIcon(summary.current.cpuUsage, 80)}\n            </div>\n            <div className=\"text-xs text-muted-foreground mt-1\">\n              Avg: {summary.average.cpuUsage ? `${summary.average.cpuUsage.toFixed(1)}%` : 'N/A'}\n            </div>\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader className=\"pb-2\">\n            <CardTitle className=\"text-sm font-medium text-muted-foreground flex items-center gap-2\">\n              <Activity className=\"w-4 h-4\" />\n              Request Rate\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">\n              {summary.average.requestCount ? `${(summary.average.requestCount * 60).toFixed(0)}/min` : 'N/A'}\n            </div>\n            <div className=\"text-xs text-muted-foreground mt-1\">\n              Total: {summary.average.requestCount || 0}\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Alerts and Violations */}\n      {summary.violations.length > 0 && (\n        <Card className=\"border-red-200 bg-red-50\">\n          <CardHeader>\n            <CardTitle className=\"text-red-800 flex items-center gap-2\">\n              <AlertTriangle className=\"w-5 h-5\" />\n              Performance Alerts ({summary.violations.length})\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"space-y-2\">\n              {summary.violations.slice(-5).map((violation, index) => (\n                <div key={index} className=\"flex items-start gap-2 p-3 border border-red-300 bg-red-100 rounded-lg\">\n                  <AlertTriangle className=\"h-4 w-4 text-red-600 mt-0.5\" />\n                  <p className=\"text-red-800 text-sm\">\n                    {violation}\n                  </p>\n                </div>\n              ))}\n            </div>\n          </CardContent>\n        </Card>\n      )}\n\n      {/* Recommendations */}\n      {summary.recommendations.length > 0 && (\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <TrendingUp className=\"w-5 h-5\" />\n              Performance Recommendations\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"space-y-2\">\n              {summary.recommendations.map((recommendation, index) => (\n                <div key={index} className=\"flex items-start gap-2 p-3 bg-blue-50 rounded-lg\">\n                  <div className=\"w-2 h-2 bg-blue-500 rounded-full mt-2 flex-shrink-0\" />\n                  <p className=\"text-sm text-blue-800\">{recommendation}</p>\n                </div>\n              ))}\n            </div>\n          </CardContent>\n        </Card>\n      )}\n\n      {/* Configuration */}\n      <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n        <Card>\n          <CardHeader>\n            <CardTitle>Monitor Configuration</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n              <div>\n                <label className=\"text-sm font-medium\">Refresh Interval</label>\n                <select\n                  value={refreshInterval}\n                  onChange={(e) => setRefreshInterval(Number(e.target.value))}\n                  className=\"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500\"\n                >\n                  <option value={1000}>1 second</option>\n                  <option value={5000}>5 seconds</option>\n                  <option value={10000}>10 seconds</option>\n                  <option value={30000}>30 seconds</option>\n                </select>\n              </div>\n              <div>\n                <label className=\"text-sm font-medium\">Status</label>\n                <div className=\"mt-1 flex items-center gap-2\">\n                  <div className={`w-3 h-3 rounded-full ${isMonitoring ? 'bg-green-500' : 'bg-red-500'}`} />\n                  <span className=\"text-sm\">\n                    {isMonitoring ? 'Active Monitoring' : 'Monitoring Stopped'}\n                  </span>\n                </div>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        {/* Alert Configuration */}\n        <Card>\n          <CardHeader>\n            <CardTitle>Alert Configuration</CardTitle>\n          </CardHeader>\n          <CardContent>\n            {alertConfig ? (\n              <div className=\"space-y-3\">\n                <div className=\"text-sm\">\n                  <strong>Environment:</strong> {alertConfig.environment}\n                </div>\n                <div className=\"space-y-2\">\n                  <div className=\"flex items-center gap-2\">\n                    <div className={`w-2 h-2 rounded-full ${alertConfig.slackEnabled ? 'bg-green-500' : 'bg-gray-300'}`} />\n                    <span className=\"text-sm\">Slack Alerts {alertConfig.slackEnabled ? 'Enabled' : 'Disabled'}</span>\n                  </div>\n                  <div className=\"flex items-center gap-2\">\n                    <div className={`w-2 h-2 rounded-full ${alertConfig.emailEnabled ? 'bg-green-500' : 'bg-gray-300'}`} />\n                    <span className=\"text-sm\">Email Alerts {alertConfig.emailEnabled ? 'Enabled' : 'Disabled'}</span>\n                  </div>\n                  <div className=\"flex items-center gap-2\">\n                    <div className={`w-2 h-2 rounded-full ${alertConfig.pagerDutyEnabled ? 'bg-green-500' : 'bg-gray-300'}`} />\n                    <span className=\"text-sm\">PagerDuty {alertConfig.pagerDutyEnabled ? 'Enabled' : 'Disabled'}</span>\n                  </div>\n                </div>\n                <div className=\"pt-2\">\n                  <Button onClick={testAlerts} size=\"sm\" variant=\"outline\" disabled={testingAlerts}>\n                    {testingAlerts ? 'Testing...' : 'Test All Channels'}\n                  </Button>\n                </div>\n              </div>\n            ) : (\n              <div className=\"text-sm text-gray-500\">Loading alert configuration...</div>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\components\\admin\\ResilienceDashboard.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'X' is defined but never used. Allowed unused vars must match /^_/u.","line":7,"column":81,"nodeType":null,"messageId":"unusedVar","endLine":7,"endColumn":82}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport React, { useState, useEffect } from 'react'\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'\nimport { Button } from '@/components/ui/button'\nimport { Badge } from '@/components/ui/badge'\nimport { RefreshCw, TrendingUp, TrendingDown, AlertTriangle, CheckCircle, Bell, X } from 'lucide-react'\n\ninterface ResilienceMetric {\n  metric_name: string\n  metric_value: number\n  threshold: number\n  status: 'healthy' | 'alert' | 'no_data'\n}\n\ninterface Alert {\n  id: string\n  timestamp: string\n  metric: string\n  currentValue: number\n  threshold: number\n  severity: 'info' | 'warning' | 'critical'\n  message: string\n  acknowledged: boolean\n  acknowledgedBy?: string\n  acknowledgedAt?: string\n}\n\ninterface ResilienceDashboardProps {\n  className?: string\n}\n\nexport function ResilienceDashboard({ className = '' }: ResilienceDashboardProps) {\n  const [metrics, setMetrics] = useState<ResilienceMetric[]>([])\n  const [alerts, setAlerts] = useState<Alert[]>([])\n  const [isLoading, setIsLoading] = useState(false)\n  const [lastUpdated, setLastUpdated] = useState<Date | null>(null)\n\n  const fetchMetrics = async () => {\n    setIsLoading(true)\n    try {\n      const response = await fetch('/api/admin/resilience-metrics')\n      if (response.ok) {\n        const data = await response.json()\n        setMetrics(data.metrics || [])\n        setAlerts(data.alerts || [])\n        setLastUpdated(new Date())\n      }\n    } catch (error) {\n      console.error('Failed to fetch resilience metrics:', error)\n    } finally {\n      setIsLoading(false)\n    }\n  }\n\n  const acknowledgeAlert = async (alertId: string) => {\n    try {\n      const response = await fetch('/api/admin/resilience-metrics', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          alertId,\n          acknowledgedBy: 'admin' // In production, use actual user ID\n        })\n      })\n\n      if (response.ok) {\n        // Update local state\n        setAlerts(prev => prev.map(alert => \n          alert.id === alertId \n            ? { ...alert, acknowledged: true, acknowledgedBy: 'admin', acknowledgedAt: new Date().toISOString() }\n            : alert\n        ))\n      }\n    } catch (error) {\n      console.error('Failed to acknowledge alert:', error)\n    }\n  }\n\n  useEffect(() => {\n    fetchMetrics()\n    // Refresh every 5 minutes\n    const interval = setInterval(fetchMetrics, 5 * 60 * 1000)\n    return () => clearInterval(interval)\n  }, [])\n\n  const getMetricDisplay = (metric: ResilienceMetric) => {\n    const { metric_name, metric_value, threshold, status } = metric\n    \n    const displayNames: Record<string, string> = {\n      rollback_rate: 'Rollback Rate',\n      retry_success_rate: 'Retry Success Rate',\n      error_recovery_rate: 'Error Recovery Rate'\n    }\n\n    const formatValue = (value: number) => {\n      if (metric_name.includes('rate')) {\n        return `${value.toFixed(1)}%`\n      }\n      return value.toFixed(2)\n    }\n\n    const getStatusIcon = () => {\n      switch (status) {\n        case 'healthy':\n          return <CheckCircle className=\"w-4 h-4 text-green-500\" />\n        case 'alert':\n          return <AlertTriangle className=\"w-4 h-4 text-red-500\" />\n        case 'no_data':\n          return <AlertTriangle className=\"w-4 h-4 text-yellow-500\" />\n        default:\n          return null\n      }\n    }\n\n    const getStatusColor = () => {\n      switch (status) {\n        case 'healthy':\n          return 'bg-green-100 text-green-800'\n        case 'alert':\n          return 'bg-red-100 text-red-800'\n        case 'no_data':\n          return 'bg-yellow-100 text-yellow-800'\n        default:\n          return 'bg-gray-100 text-gray-800'\n      }\n    }\n\n    const getTrendIcon = () => {\n      if (status === 'no_data') return null\n      \n      if (metric_name.includes('rate') && metric_name !== 'rollback_rate') {\n        // Higher is better for success/recovery rates\n        return metric_value >= threshold ? \n          <TrendingUp className=\"w-4 h-4 text-green-500\" /> : \n          <TrendingDown className=\"w-4 h-4 text-red-500\" />\n      } else {\n        // Lower is better for rollback rate\n        return metric_value <= threshold ? \n          <TrendingUp className=\"w-4 h-4 text-green-500\" /> : \n          <TrendingDown className=\"w-4 h-4 text-red-500\" />\n      }\n    }\n\n    return (\n      <Card key={metric_name} className=\"col-span-1\">\n        <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n          <CardTitle className=\"text-sm font-medium\">\n            {displayNames[metric_name] || metric_name}\n          </CardTitle>\n          {getStatusIcon()}\n        </CardHeader>\n        <CardContent>\n          <div className=\"text-2xl font-bold\">{formatValue(metric_value)}</div>\n          <div className=\"flex items-center justify-between mt-2\">\n            <Badge className={getStatusColor()}>\n              {status === 'healthy' ? 'Healthy' : \n               status === 'alert' ? 'Alert' : 'No Data'}\n            </Badge>\n            <div className=\"flex items-center space-x-1\">\n              {getTrendIcon()}\n              <span className=\"text-xs text-muted-foreground\">\n                Target: {formatValue(threshold)}\n              </span>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n    )\n  }\n\n  const getAlertDisplay = (alert: Alert) => {\n    const getSeverityColor = () => {\n      switch (alert.severity) {\n        case 'critical': return 'bg-red-100 text-red-800 border-red-200'\n        case 'warning': return 'bg-yellow-100 text-yellow-800 border-yellow-200'\n        case 'info': return 'bg-blue-100 text-blue-800 border-blue-200'\n        default: return 'bg-gray-100 text-gray-800 border-gray-200'\n      }\n    }\n\n    const getSeverityIcon = () => {\n      switch (alert.severity) {\n        case 'critical': return <AlertTriangle className=\"w-4 h-4 text-red-600\" />\n        case 'warning': return <AlertTriangle className=\"w-4 h-4 text-yellow-600\" />\n        case 'info': return <Bell className=\"w-4 h-4 text-blue-600\" />\n        default: return <Bell className=\"w-4 h-4 text-gray-600\" />\n      }\n    }\n\n    return (\n      <div key={alert.id} className={`p-4 border rounded-lg ${getSeverityColor()}`}>\n        <div className=\"flex items-start justify-between\">\n          <div className=\"flex-1\">\n            <div className=\"flex items-center gap-2 mb-2\">\n              {getSeverityIcon()}\n              <Badge variant=\"outline\" className=\"capitalize\">\n                {alert.severity}\n              </Badge>\n              {alert.acknowledged && (\n                <Badge variant=\"secondary\" className=\"text-xs\">\n                  Acknowledged\n                </Badge>\n              )}\n            </div>\n            <h4 className=\"font-medium mb-1\">\n              {alert.metric.replace(/_/g, ' ').toUpperCase()}\n            </h4>\n            <p className=\"text-sm mb-2\">{alert.message}</p>\n            <div className=\"flex items-center gap-4 text-xs\">\n              <span>Current: {alert.currentValue.toFixed(1)}%</span>\n              <span>Threshold: {alert.threshold.toFixed(1)}%</span>\n              <span>Time: {new Date(alert.timestamp).toLocaleString()}</span>\n            </div>\n            {alert.acknowledged && (\n              <div className=\"text-xs mt-2 text-gray-600\">\n                Acknowledged by {alert.acknowledgedBy} at {new Date(alert.acknowledgedAt!).toLocaleString()}\n              </div>\n            )}\n          </div>\n          {!alert.acknowledged && (\n            <Button\n              onClick={() => acknowledgeAlert(alert.id)}\n              variant=\"outline\"\n              size=\"sm\"\n              className=\"ml-4\"\n            >\n              <CheckCircle className=\"w-4 h-4 mr-1\" />\n              Acknowledge\n            </Button>\n          )}\n        </div>\n      </div>\n    )\n  }\n\n  return (\n    <div className={`space-y-6 ${className}`}>\n      <div className=\"flex items-center justify-between\">\n        <div>\n          <h2 className=\"text-3xl font-bold tracking-tight\">Resilience Dashboard</h2>\n          <p className=\"text-muted-foreground\">\n            Real-time monitoring of Bookiji&apos;s resilience patterns\n          </p>\n        </div>\n        <div className=\"flex items-center space-x-4\">\n          {lastUpdated && (\n            <span className=\"text-sm text-muted-foreground\">\n              Last updated: {lastUpdated.toLocaleTimeString()}\n            </span>\n          )}\n          <Button \n            onClick={fetchMetrics} \n            disabled={isLoading}\n            variant=\"outline\"\n            size=\"sm\"\n          >\n            <RefreshCw className={`w-4 h-4 mr-2 ${isLoading ? 'animate-spin' : ''}`} />\n            Refresh\n          </Button>\n        </div>\n      </div>\n\n      {/* Active Alerts Section */}\n      {alerts.length > 0 && (\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <Bell className=\"w-5 h-5\" />\n              Active Alerts ({alerts.filter(a => !a.acknowledged).length})\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"space-y-3\">\n              {alerts.map(getAlertDisplay)}\n            </div>\n          </CardContent>\n        </Card>\n      )}\n\n      {/* Key Metrics Grid */}\n      <div className=\"grid gap-4 md:grid-cols-3\">\n        {metrics.map(getMetricDisplay)}\n      </div>\n\n      {/* Health Summary */}\n      <Card>\n        <CardHeader>\n          <CardTitle>System Health Summary</CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"space-y-4\">\n            {metrics.length === 0 ? (\n              <div className=\"text-center py-8 text-muted-foreground\">\n                No metrics available\n              </div>\n            ) : (\n              <>\n                <div className=\"flex items-center justify-between\">\n                  <span>Overall Health</span>\n                  <Badge className={\n                    metrics.every(m => m.status === 'healthy') ? 'bg-green-100 text-green-800' :\n                    metrics.some(m => m.status === 'alert') ? 'bg-red-100 text-red-800' :\n                    'bg-yellow-100 text-yellow-800'\n                  }>\n                    {metrics.every(m => m.status === 'healthy') ? 'All Systems Healthy' :\n                     metrics.some(m => m.status === 'alert') ? 'System Issues Detected' :\n                     'Limited Data Available'}\n                  </Badge>\n                </div>\n                \n                <div className=\"grid gap-2 text-sm\">\n                  {metrics.map(metric => (\n                    <div key={metric.metric_name} className=\"flex items-center justify-between\">\n                      <span className=\"capitalize\">\n                        {metric.metric_name.replace(/_/g, ' ')}\n                      </span>\n                      <span className={\n                        metric.status === 'healthy' ? 'text-green-600' :\n                        metric.status === 'alert' ? 'text-red-600' :\n                        'text-yellow-600'\n                      }>\n                        {metric.status === 'healthy' ? 'âœ“' : \n                         metric.status === 'alert' ? 'âœ—' : '?'}\n                      </span>\n                    </div>\n                  ))}\n                </div>\n              </>\n            )}\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Action Items */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Recommended Actions</CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"space-y-3\">\n            {metrics.some(m => m.status === 'alert') ? (\n              <>\n                <div className=\"flex items-start space-x-3 p-3 bg-red-50 rounded-lg\">\n                  <AlertTriangle className=\"w-5 h-5 text-red-500 mt-0.5\" />\n                  <div>\n                    <h4 className=\"font-medium text-red-800\">Immediate Attention Required</h4>\n                    <p className=\"text-sm text-red-700\">\n                      Some resilience metrics are outside healthy thresholds. \n                      Review system logs and consider scaling or optimization.\n                    </p>\n                  </div>\n                </div>\n              </>\n            ) : metrics.every(m => m.status === 'healthy') ? (\n              <div className=\"flex items-start space-x-3 p-3 bg-green-50 rounded-lg\">\n                <CheckCircle className=\"w-5 h-5 text-green-500 mt-0.5\" />\n                <div>\n                  <h4 className=\"font-medium text-green-800\">All Systems Operating Normally</h4>\n                  <p className=\"text-sm text-green-700\">\n                    Resilience patterns are performing within expected parameters. \n                    Continue monitoring for any changes.\n                  </p>\n                </div>\n              </div>\n            ) : (\n              <div className=\"flex items-start space-x-3 p-3 bg-yellow-50 rounded-lg\">\n                <AlertTriangle className=\"w-5 h-5 text-yellow-500 mt-0.5\" />\n                <div>\n                  <h4 className=\"font-medium text-yellow-800\">Limited Data Available</h4>\n                  <p className=\"text-sm text-yellow-700\">\n                    Some metrics have insufficient data for health assessment. \n                    Wait for more data or investigate data collection.\n                  </p>\n                </div>\n              </div>\n            )}\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  )\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\components\\admin\\SpecialtyAnalytics.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'motion' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":16},{"ruleId":"react/jsx-no-comment-textnodes","severity":2,"message":"Comments inside children section of tag should be placed inside braces","line":168,"column":54,"nodeType":"JSXText","messageId":"putCommentInBraces","endLine":170,"endColumn":11},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":170,"column":60,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":170,"endColumn":63,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4903,4906],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4903,4906],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has missing dependencies: 'loadAllSpecialtiesAnalytics' and 'loadSpecialtyAnalytics'. Either include them or remove the dependency array.","line":93,"column":6,"nodeType":"ArrayExpression","endLine":93,"endColumn":36,"suggestions":[{"desc":"Update the dependencies array to be: [loadAllSpecialtiesAnalytics, loadSpecialtyAnalytics, selectedSpecialty, timeRange]","fix":{"range":[2507,2537],"text":"[loadAllSpecialtiesAnalytics, loadSpecialtyAnalytics, selectedSpecialty, timeRange]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":1,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\r\n\r\nimport { useState, useEffect } from 'react'\r\nimport { motion } from 'framer-motion'\r\nimport { BarChart3, TrendingUp, Users, DollarSign, MapPin, Calendar } from 'lucide-react'\r\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'\r\nimport { Badge } from '@/components/ui/badge'\r\n\r\ninterface SpecialtyMetrics {\r\n  id: string\r\n  name: string\r\n  vendorCount: number\r\n  bookingCount: number\r\n}\r\n\r\ninterface TopVendor {\r\n  id: string\r\n  full_name: string\r\n  business_name: string\r\n  average_rating: number\r\n  total_bookings: number\r\n}\r\n\r\ninterface BookingTrend {\r\n  date: string\r\n  count: number\r\n  revenue: number\r\n}\r\n\r\ninterface SpecialtyAnalytics {\r\n  specialty?: {\r\n    id: string\r\n    name: string\r\n    parent_id: string | null\r\n    path: string\r\n  }\r\n  metrics: {\r\n    vendorCount: number\r\n    totalBookings: number\r\n    totalRevenue: number\r\n    averageRating: number\r\n    bookingTrends: BookingTrend[]\r\n    topVendors: TopVendor[]\r\n    geographicDistribution: {\r\n      countries: Array<{ name: string; count: number }>\r\n      cities: Array<{ name: string; count: number }>\r\n    }\r\n  }\r\n}\r\n\r\ninterface AllSpecialtiesAnalytics {\r\n  overview: {\r\n    totalSpecialties: number\r\n    totalVendors: number\r\n    totalBookings: number\r\n    overallTrends: BookingTrend[]\r\n  }\r\n  specialtyMetrics: SpecialtyMetrics[]\r\n  popularityRanking: SpecialtyMetrics[]\r\n}\r\n\r\n// Helper functions\r\nconst formatCurrency = (amount: number) => {\r\n  return new Intl.NumberFormat('en-US', {\r\n    style: 'currency',\r\n    currency: 'USD'\r\n  }).format(amount)\r\n}\r\n\r\nconst formatNumber = (num: number) => {\r\n  return new Intl.NumberFormat('en-US').format(num)\r\n}\r\n\r\nexport default function SpecialtyAnalytics() {\r\n  const [timeRange, setTimeRange] = useState<'7d' | '30d' | '90d' | '1y'>('30d')\r\n  const [selectedSpecialty, setSelectedSpecialty] = useState<string>('')\r\n  const [analytics, setAnalytics] = useState<SpecialtyAnalytics | AllSpecialtiesAnalytics | null>(null)\r\n  const [loading, setLoading] = useState(true)\r\n  const [specialties, setSpecialties] = useState<Array<{ id: string; name: string }>>([])\r\n\r\n  useEffect(() => {\r\n    loadSpecialties()\r\n  }, [])\r\n\r\n  useEffect(() => {\r\n    if (selectedSpecialty) {\r\n      loadSpecialtyAnalytics(selectedSpecialty)\r\n    } else {\r\n      loadAllSpecialtiesAnalytics()\r\n    }\r\n  // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [selectedSpecialty, timeRange])\r\n\r\n  const loadSpecialties = async () => {\r\n    try {\r\n      const response = await fetch('/api/specialties')\r\n      if (response.ok) {\r\n        const data = await response.json()\r\n        setSpecialties(data.items || [])\r\n      }\r\n    } catch (error) {\r\n      console.error('Error loading specialties:', error)\r\n    }\r\n  }\r\n\r\n  const loadSpecialtyAnalytics = async (specialtyId: string) => {\r\n    try {\r\n      setLoading(true)\r\n      const response = await fetch(`/api/analytics/specialties?specialtyId=${specialtyId}&timeRange=${timeRange}`)\r\n      if (response.ok) {\r\n        const data = await response.json()\r\n        setAnalytics(data.analytics)\r\n      }\r\n    } catch (error) {\r\n      console.error('Error loading specialty analytics:', error)\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  const loadAllSpecialtiesAnalytics = async () => {\r\n    try {\r\n      setLoading(true)\r\n      const response = await fetch(`/api/analytics/specialties?timeRange=${timeRange}`)\r\n      if (response.ok) {\r\n        const data = await response.json()\r\n        setAnalytics(data.analytics)\r\n      }\r\n    } catch (error) {\r\n      console.error('Error loading all specialties analytics:', error)\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  if (loading) {\r\n    return (\r\n      <div className=\"flex items-center justify-center h-64\">\r\n        <div className=\"text-gray-500\">Loading analytics...</div>\r\n      </div>\r\n    )\r\n  }\r\n\r\n  if (!analytics) {\r\n    return (\r\n      <div className=\"text-center py-8 text-gray-500\">\r\n        No analytics data available\r\n      </div>\r\n    )\r\n  }\r\n\r\n  const isSingleSpecialty = 'specialty' in analytics\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      {/* Header and Controls */}\r\n      <div className=\"flex items-center justify-between\">\r\n        <div>\r\n          <h2 className=\"text-2xl font-bold text-gray-900\">\r\n            {isSingleSpecialty ? `${analytics.specialty?.name} Analytics` : 'Specialty Analytics'}\r\n          </h2>\r\n          <p className=\"text-gray-600\">\r\n            {isSingleSpecialty ? 'Performance metrics for this specialty' : 'Overview of all specialties'}\r\n          </p>\r\n        </div>\r\n        \r\n        <div className=\"flex items-center space-x-4\">\r\n          // eslint-disable-next-line @typescript-eslint/no-explicit-any\n          <Select value={timeRange} onValueChange={(value: any) => setTimeRange(value)}>\r\n            <SelectTrigger className=\"w-32\">\r\n              <SelectValue />\r\n            </SelectTrigger>\r\n            <SelectContent>\r\n              <SelectItem value=\"7d\">Last 7 days</SelectItem>\r\n              <SelectItem value=\"30d\">Last 30 days</SelectItem>\r\n              <SelectItem value=\"90d\">Last 90 days</SelectItem>\r\n              <SelectItem value=\"1y\">Last year</SelectItem>\r\n            </SelectContent>\r\n          </Select>\r\n\r\n          <Select value={selectedSpecialty} onValueChange={setSelectedSpecialty}>\r\n            <SelectTrigger className=\"w-64\">\r\n              <SelectValue placeholder=\"Select specialty for detailed view\" />\r\n            </SelectTrigger>\r\n            <SelectContent>\r\n              <SelectItem value=\"\">All Specialties Overview</SelectItem>\r\n              {specialties.map(specialty => (\r\n                <SelectItem key={specialty.id} value={specialty.id}>\r\n                  {specialty.name}\r\n                </SelectItem>\r\n              ))}\r\n            </SelectContent>\r\n          </Select>\r\n        </div>\r\n      </div>\r\n\r\n      {isSingleSpecialty ? (\r\n        <SingleSpecialtyView analytics={analytics as SpecialtyAnalytics} />\r\n      ) : (\r\n        <AllSpecialtiesView analytics={analytics as AllSpecialtiesAnalytics} />\r\n      )}\r\n    </div>\r\n  )\r\n}\r\n\r\nfunction SingleSpecialtyView({ analytics }: { analytics: SpecialtyAnalytics }) {\r\n  const { _specialty, metrics } = analytics\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      {/* Key Metrics */}\r\n      <div className=\"grid grid-cols-1 md:grid-cols-4 gap-6\">\r\n        <Card>\r\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n            <CardTitle className=\"text-sm font-medium\">Total Vendors</CardTitle>\r\n            <Users className=\"h-4 w-4 text-muted-foreground\" />\r\n          </CardHeader>\r\n          <CardContent>\r\n            <div className=\"text-2xl font-bold\">{formatNumber(metrics.vendorCount)}</div>\r\n            <p className=\"text-xs text-muted-foreground\">\r\n              Active providers in this specialty\r\n            </p>\r\n          </CardContent>\r\n        </Card>\r\n\r\n        <Card>\r\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n            <CardTitle className=\"text-sm font-medium\">Total Bookings</CardTitle>\r\n            <Calendar className=\"h-4 w-4 text-muted-foreground\" />\r\n          </CardHeader>\r\n          <CardContent>\r\n            <div className=\"text-2xl font-bold\">{formatNumber(metrics.totalBookings)}</div>\r\n            <p className=\"text-xs text-muted-foreground\">\r\n              Bookings in selected period\r\n            </p>\r\n          </CardContent>\r\n        </Card>\r\n\r\n        <Card>\r\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n            <CardTitle className=\"text-sm font-medium\">Total Revenue</CardTitle>\r\n            <DollarSign className=\"h-4 w-4 text-muted-foreground\" />\r\n          </CardHeader>\r\n          <CardContent>\r\n            <div className=\"text-2xl font-bold\">{formatCurrency(metrics.totalRevenue)}</div>\r\n            <p className=\"text-xs text-muted-foreground\">\r\n              Revenue generated in period\r\n            </p>\r\n          </CardContent>\r\n        </Card>\r\n\r\n        <Card>\r\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n            <CardTitle className=\"text-sm font-medium\">Average Rating</CardTitle>\r\n            <BarChart3 className=\"h-4 w-4 text-muted-foreground\" />\r\n          </CardHeader>\r\n          <CardContent>\r\n            <div className=\"text-2xl font-bold\">{metrics.averageRating.toFixed(1)}</div>\r\n            <p className=\"text-xs text-muted-foreground\">\r\n              Customer satisfaction score\r\n            </p>\r\n          </CardContent>\r\n        </Card>\r\n      </div>\r\n\r\n      {/* Top Performing Vendors */}\r\n      <Card>\r\n        <CardHeader>\r\n          <CardTitle>Top Performing Vendors</CardTitle>\r\n        </CardHeader>\r\n        <CardContent>\r\n          <div className=\"space-y-4\">\r\n            {metrics.topVendors.map((vendor, index) => (\r\n              <div key={vendor.id} className=\"flex items-center justify-between p-3 border rounded-lg\">\r\n                <div className=\"flex items-center space-x-3\">\r\n                  <Badge variant=\"outline\">#{index + 1}</Badge>\r\n                  <div>\r\n                    <p className=\"font-medium\">{vendor.business_name || vendor.full_name}</p>\r\n                    <p className=\"text-sm text-gray-500\">\r\n                      {formatNumber(vendor.total_bookings)} bookings\r\n                    </p>\r\n                  </div>\r\n                </div>\r\n                <div className=\"text-right\">\r\n                  <p className=\"font-medium\">{vendor.average_rating.toFixed(1)} â­</p>\r\n                  <p className=\"text-sm text-gray-500\">Rating</p>\r\n                </div>\r\n              </div>\r\n            ))}\r\n          </div>\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* Geographic Distribution */}\r\n      <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\r\n        <Card>\r\n          <CardHeader>\r\n            <CardTitle>Geographic Distribution</CardTitle>\r\n          </CardHeader>\r\n          <CardContent>\r\n            <div className=\"space-y-3\">\r\n              {metrics.geographicDistribution.countries.slice(0, 5).map((country, index) => (\r\n                <div key={index} className=\"flex items-center justify-between\">\r\n                  <div className=\"flex items-center space-x-2\">\r\n                    <MapPin className=\"h-4 w-4 text-gray-400\" />\r\n                    <span className=\"text-sm\">{country.name}</span>\r\n                  </div>\r\n                  <Badge variant=\"secondary\">{country.count}</Badge>\r\n                </div>\r\n              ))}\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n\r\n        <Card>\r\n          <CardHeader>\r\n            <CardTitle>Booking Trends</CardTitle>\r\n          </CardHeader>\r\n          <CardContent>\r\n            <div className=\"space-y-3\">\r\n              {metrics.bookingTrends.slice(-7).map((trend, index) => (\r\n                <div key={index} className=\"flex items-center justify-between\">\r\n                  <span className=\"text-sm text-gray-600\">\r\n                    {new Date(trend.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}\r\n                  </span>\r\n                  <div className=\"flex items-center space-x-4\">\r\n                    <span className=\"text-sm\">{trend.count} bookings</span>\r\n                    <span className=\"text-sm font-medium\">{formatCurrency(trend.revenue / 100)}</span>\r\n                  </div>\r\n                </div>\r\n              ))}\r\n            </div>\r\n          </CardContent>\r\n        </Card>\r\n      </div>\r\n    </div>\r\n  )\r\n}\r\n\r\nfunction AllSpecialtiesView({ analytics }: { analytics: AllSpecialtiesAnalytics }) {\r\n  const { overview, specialtyMetrics, popularityRanking } = analytics\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      {/* Overview Metrics */}\r\n      <div className=\"grid grid-cols-1 md:grid-cols-4 gap-6\">\r\n        <Card>\r\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n            <CardTitle className=\"text-sm font-medium\">Total Specialties</CardTitle>\r\n            <BarChart3 className=\"h-4 w-4 text-muted-foreground\" />\r\n          </CardHeader>\r\n          <CardContent>\r\n            <div className=\"text-2xl font-bold\">{formatNumber(overview.totalSpecialties)}</div>\r\n            <p className=\"text-xs text-muted-foreground\">\r\n              Active service categories\r\n            </p>\r\n          </CardContent>\r\n        </Card>\r\n\r\n        <Card>\r\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n            <CardTitle className=\"text-sm font-medium\">Total Vendors</CardTitle>\r\n            <Users className=\"h-4 w-4 text-muted-foreground\" />\r\n          </CardHeader>\r\n          <CardContent>\r\n            <div className=\"text-2xl font-bold\">{formatNumber(overview.totalVendors)}</div>\r\n            <p className=\"text-xs text-muted-foreground\">\r\n              Active service providers\r\n            </p>\r\n          </CardContent>\r\n        </Card>\r\n\r\n        <Card>\r\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n            <CardTitle className=\"text-sm font-medium\">Total Bookings</CardTitle>\r\n            <Calendar className=\"h-4 w-4 text-muted-foreground\" />\r\n          </CardHeader>\r\n          <CardContent>\r\n            <div className=\"text-2xl font-bold\">{formatNumber(overview.totalBookings)}</div>\r\n            <p className=\"text-xs text-muted-foreground\">\r\n              Total bookings in period\r\n            </p>\r\n          </CardContent>\r\n        </Card>\r\n\r\n        <Card>\r\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\r\n            <CardTitle className=\"text-sm font-medium\">Growth Trend</CardTitle>\r\n            <TrendingUp className=\"h-4 w-4 text-muted-foreground\" />\r\n          </CardHeader>\r\n          <CardContent>\r\n            <div className=\"text-2xl font-bold text-green-600\">+12.5%</div>\r\n            <p className=\"text-xs text-muted-foreground\">\r\n              vs previous period\r\n            </p>\r\n          </CardContent>\r\n        </Card>\r\n      </div>\r\n\r\n      {/* Popularity Ranking */}\r\n      <Card>\r\n        <CardHeader>\r\n          <CardTitle>Most Popular Specialties</CardTitle>\r\n        </CardHeader>\r\n        <CardContent>\r\n          <div className=\"space-y-4\">\r\n            {popularityRanking.map((specialty, index) => (\r\n              <div key={specialty.id} className=\"flex items-center justify-between p-3 border rounded-lg\">\r\n                <div className=\"flex items-center space-x-3\">\r\n                  <Badge variant={index < 3 ? \"default\" : \"outline\"}>#{index + 1}</Badge>\r\n                  <div>\r\n                    <p className=\"font-medium\">{specialty.name}</p>\r\n                    <p className=\"text-sm text-gray-500\">\r\n                      {formatNumber(specialty.vendorCount)} vendors\r\n                    </p>\r\n                  </div>\r\n                </div>\r\n                <div className=\"text-right\">\r\n                  <p className=\"font-medium\">{formatNumber(specialty.bookingCount)}</p>\r\n                  <p className=\"text-sm text-gray-500\">Bookings</p>\r\n                </div>\r\n              </div>\r\n            ))}\r\n          </div>\r\n        </CardContent>\r\n      </Card>\r\n\r\n      {/* All Specialties Table */}\r\n      <Card>\r\n        <CardHeader>\r\n          <CardTitle>All Specialties Performance</CardTitle>\r\n        </CardHeader>\r\n        <CardContent>\r\n          <div className=\"overflow-x-auto\">\r\n            <table className=\"w-full\">\r\n              <thead>\r\n                <tr className=\"border-b\">\r\n                  <th className=\"text-left p-2\">Specialty</th>\r\n                  <th className=\"text-left p-2\">Vendors</th>\r\n                  <th className=\"text-left p-2\">Bookings</th>\r\n                  <th className=\"text-left p-2\">Performance</th>\r\n                </tr>\r\n              </thead>\r\n              <tbody>\r\n                {specialtyMetrics.map(specialty => (\r\n                  <tr key={specialty.id} className=\"border-b hover:bg-gray-50\">\r\n                    <td className=\"p-2 font-medium\">{specialty.name}</td>\r\n                    <td className=\"p-2\">{formatNumber(specialty.vendorCount)}</td>\r\n                    <td className=\"p-2\">{formatNumber(specialty.bookingCount)}</td>\r\n                    <td className=\"p-2\">\r\n                      <div className=\"w-full bg-gray-200 rounded-full h-2\">\r\n                        <div \r\n                          className=\"bg-blue-600 h-2 rounded-full\" \r\n                          style={{ \r\n                            width: `${Math.min((specialty.bookingCount / Math.max(...specialtyMetrics.map(s => s.bookingCount))) * 100, 100)}%` \r\n                          }}\r\n                        ></div>\r\n                      </div>\r\n                    </td>\r\n                  </tr>\r\n                ))}\r\n              </tbody>\r\n            </table>\r\n          </div>\r\n        </CardContent>\r\n      </Card>\r\n    </div>\r\n  )\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\components\\provider\\ProfileEditor.tsx","messages":[{"ruleId":"react/jsx-no-comment-textnodes","severity":2,"message":"Comments inside children section of tag should be placed inside braces","line":554,"column":21,"nodeType":"JSXText","messageId":"putCommentInBraces","endLine":556,"endColumn":19},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":556,"column":144,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":556,"endColumn":147,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[20768,20771],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[20768,20771],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react/jsx-no-comment-textnodes","severity":2,"message":"Comments inside children section of tag should be placed inside braces","line":800,"column":21,"nodeType":"JSXText","messageId":"putCommentInBraces","endLine":802,"endColumn":19},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":802,"column":154,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":802,"endColumn":157,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[32749,32752],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[32749,32752],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client';\r\n\r\nimport { useState, useEffect } from 'react';\r\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Input } from '@/components/ui/input';\r\nimport { Textarea } from '@/components/ui/textarea';\r\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\r\nimport { Badge } from '@/components/ui/badge';\r\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';\r\nimport { \r\n  User, \r\n  Award, \r\n  GraduationCap, \r\n  Briefcase, \r\n  Globe, \r\n  Plus, \r\n  Edit, \r\n  Trash2, \r\n  Save,\r\n  CheckCircle,\r\n  AlertCircle\r\n} from 'lucide-react';\r\nimport { \r\n  RichProviderProfile, \r\n  ProviderProfileUpdate,\r\n  CertificationRequest,\r\n  EducationRequest,\r\n  PortfolioRequest,\r\n  LanguageRequest,\r\n  LANGUAGE_PROFICIENCY_LEVELS,\r\n  DEGREE_TYPES,\r\n  _VERIFICATION_STATUS\r\n} from '@/types/provider';\r\n\r\ninterface ProfileEditorProps {\r\n  profile?: RichProviderProfile;\r\n  onSave?: (profile: ProviderProfileUpdate) => void;\r\n  className?: string;\r\n}\r\n\r\nexport default function ProfileEditor({ profile, onSave, className = '' }: ProfileEditorProps) {\r\n  const [isEditing, setIsEditing] = useState(false);\r\n  const [isLoading, setIsLoading] = useState(false);\r\n  const [formData, setFormData] = useState<ProviderProfileUpdate>({\r\n    bio: '',\r\n    portfolio_images: [],\r\n    specializations: [],\r\n    experience_years: 0,\r\n    hourly_rate: 0,\r\n    professional_summary: '',\r\n    service_area_radius: 10,\r\n    social_links: {}\r\n  });\r\n\r\n  const [certifications, setCertifications] = useState<CertificationRequest[]>([]);\r\n  const [education, setEducation] = useState<EducationRequest[]>([]);\r\n  const [portfolio, setPortfolio] = useState<PortfolioRequest[]>([]);\r\n  const [languages, setLanguages] = useState<LanguageRequest[]>([]);\r\n\r\n  const [newCertification, setNewCertification] = useState<CertificationRequest>({\r\n    certification_name: '',\r\n    issuing_organization: '',\r\n    issue_date: '',\r\n    expiry_date: '',\r\n    certificate_number: '',\r\n    certificate_url: ''\r\n  });\r\n\r\n  const [newEducation, setNewEducation] = useState<EducationRequest>({\r\n    institution_name: '',\r\n    degree_type: 'bachelor',\r\n    field_of_study: '',\r\n    start_year: new Date().getFullYear(),\r\n    end_year: new Date().getFullYear(),\r\n    is_current: false,\r\n    description: ''\r\n  });\r\n\r\n  const [newPortfolio, setNewPortfolio] = useState<PortfolioRequest>({\r\n    title: '',\r\n    description: '',\r\n    service_type: '',\r\n    images: [],\r\n    project_date: '',\r\n    client_name: '',\r\n    project_duration: '',\r\n    technologies_used: [],\r\n    is_featured: false,\r\n    display_order: 0\r\n  });\r\n\r\n  const [newLanguage, setNewLanguage] = useState<LanguageRequest>({\r\n    language_code: '',\r\n    language_name: '',\r\n    proficiency_level: 'fluent',\r\n    is_primary: false\r\n  });\r\n\r\n  const [newSpecialization, setNewSpecialization] = useState('');\r\n  const [newTechnology, setNewTechnology] = useState('');\r\n\r\n  useEffect(() => {\r\n    if (profile) {\r\n      setFormData({\r\n        bio: profile.bio || '',\r\n        portfolio_images: profile.portfolio_images || [],\r\n        specializations: profile.specializations || [],\r\n        experience_years: profile.experience_years || 0,\r\n        hourly_rate: profile.hourly_rate || 0,\r\n        professional_summary: profile.professional_summary || '',\r\n        service_area_radius: profile.service_area_radius || 10,\r\n        social_links: profile.social_links || {}\r\n      });\r\n\r\n      // Initialize related data from profile\r\n      if (profile.certifications) {\r\n        setCertifications(profile.certifications.map(c => ({\r\n          certification_name: c.certification_name,\r\n          issuing_organization: c.issuing_organization,\r\n          issue_date: c.issue_date || '',\r\n          expiry_date: c.expiry_date || '',\r\n          certificate_number: c.certificate_number || '',\r\n          certificate_url: c.certificate_url || ''\r\n        })));\r\n      }\r\n\r\n      if (profile.education) {\r\n        setEducation(profile.education.map(e => ({\r\n          institution_name: e.institution_name,\r\n          degree_type: e.degree_type || 'bachelor',\r\n          field_of_study: e.field_of_study || '',\r\n          start_year: e.start_year || new Date().getFullYear(),\r\n          end_year: e.end_year || new Date().getFullYear(),\r\n          is_current: e.is_current || false,\r\n          description: e.description || ''\r\n        })));\r\n      }\r\n\r\n      // Note: Portfolio data would come from a separate portfolio table\r\n      // For now, we'll initialize with empty array\r\n      setPortfolio([]);\r\n\r\n      if (profile.languages) {\r\n        setLanguages(profile.languages.map(l => ({\r\n          language_code: l,\r\n          language_name: l,\r\n          proficiency_level: 'fluent',\r\n          is_primary: false\r\n        })));\r\n      }\r\n    }\r\n  }, [profile]);\r\n\r\n  const handleSave = async () => {\r\n    setIsLoading(true);\r\n    try {\r\n      if (onSave) {\r\n        await onSave(formData);\r\n      }\r\n      setIsEditing(false);\r\n    } catch (error) {\r\n      console.error('Failed to save profile:', error);\r\n    } finally {\r\n      setIsLoading(false);\r\n    }\r\n  };\r\n\r\n  const addSpecialization = () => {\r\n    if (newSpecialization.trim() && !formData.specializations?.includes(newSpecialization.trim())) {\r\n      setFormData(prev => ({\r\n        ...prev,\r\n        specializations: [...(prev.specializations || []), newSpecialization.trim()]\r\n      }));\r\n      setNewSpecialization('');\r\n    }\r\n  };\r\n\r\n  const removeSpecialization = (spec: string) => {\r\n    setFormData(prev => ({\r\n      ...prev,\r\n      specializations: prev.specializations?.filter(s => s !== spec) || []\r\n    }));\r\n  };\r\n\r\n  const addCertification = () => {\r\n    if (newCertification.certification_name && newCertification.issuing_organization) {\r\n      setCertifications(prev => [...prev, { ...newCertification }]);\r\n      setNewCertification({\r\n        certification_name: '',\r\n        issuing_organization: '',\r\n        issue_date: '',\r\n        expiry_date: '',\r\n        certificate_number: '',\r\n        certificate_url: ''\r\n      });\r\n    }\r\n  };\r\n\r\n  const removeCertification = (index: number) => {\r\n    setCertifications(prev => prev.filter((_, i) => i !== index));\r\n  };\r\n\r\n  const addEducation = () => {\r\n    if (newEducation.institution_name) {\r\n      setEducation(prev => [...prev, { ...newEducation }]);\r\n      setNewEducation({\r\n        institution_name: '',\r\n        degree_type: 'bachelor',\r\n        field_of_study: '',\r\n        start_year: new Date().getFullYear(),\r\n        end_year: new Date().getFullYear(),\r\n        is_current: false,\r\n        description: ''\r\n      });\r\n    }\r\n  };\r\n\r\n  const removeEducation = (index: number) => {\r\n    setEducation(prev => prev.filter((_, i) => i !== index));\r\n  };\r\n\r\n  const addPortfolio = () => {\r\n    if (newPortfolio.title) {\r\n      setPortfolio(prev => [...prev, { ...newPortfolio, display_order: prev.length }]);\r\n      setNewPortfolio({\r\n        title: '',\r\n        description: '',\r\n        service_type: '',\r\n        images: [],\r\n        project_date: '',\r\n        client_name: '',\r\n        project_duration: '',\r\n        technologies_used: [],\r\n        is_featured: false,\r\n        display_order: 0\r\n      });\r\n    }\r\n  };\r\n\r\n  const removePortfolio = (index: number) => {\r\n    setPortfolio(prev => prev.filter((_, i) => i !== index));\r\n  };\r\n\r\n  const addTechnology = (portfolioIndex: number) => {\r\n    if (newTechnology.trim()) {\r\n      setPortfolio(prev => prev.map((p, i) => \r\n        i === portfolioIndex \r\n          ? { ...p, technologies_used: [...(p.technologies_used || []), newTechnology.trim()] }\r\n          : p\r\n      ));\r\n      setNewTechnology('');\r\n    }\r\n  };\r\n\r\n  const _removeTechnology = (portfolioIndex: number, techIndex: number) => {\r\n    setPortfolio(prev => prev.map((p, i) => \r\n      i === portfolioIndex \r\n        ? { ...p, technologies_used: (p.technologies_used || []).filter((_, ti) => ti !== techIndex) }\r\n        : p\r\n    ));\r\n  };\r\n\r\n  const addLanguage = () => {\r\n    if (newLanguage.language_name) {\r\n      setLanguages(prev => [...prev, { ...newLanguage }]);\r\n      setNewLanguage({\r\n        language_code: '',\r\n        language_name: '',\r\n        proficiency_level: 'fluent',\r\n        is_primary: false\r\n      });\r\n    }\r\n  };\r\n\r\n  const removeLanguage = (index: number) => {\r\n    setLanguages(prev => prev.filter((_, i) => i !== index));\r\n  };\r\n\r\n  const calculateProfileScore = (): number => {\r\n    let score = 0;\r\n    \r\n    // Basic info (40 points)\r\n    if (formData.bio) score += 10;\r\n    if (formData.professional_summary) score += 10;\r\n    if ((formData.experience_years || 0) > 0) score += 5;\r\n    if ((formData.hourly_rate || 0) > 0) score += 5;\r\n    if ((formData.service_area_radius || 0) > 0) score += 5;\r\n    if (profile?.avatar_url) score += 5;\r\n    \r\n    // Specializations and languages (20 points)\r\n    if (formData.specializations && formData.specializations.length > 0) score += 10;\r\n    if (languages.length > 0) score += 10;\r\n    \r\n    // Portfolio images (10 points)\r\n    if (formData.portfolio_images && formData.portfolio_images.length > 0) score += 10;\r\n    \r\n    // Certifications (10 points)\r\n    if (certifications.length > 0) score += 10;\r\n    \r\n    // Education (5 points)\r\n    if (education.length > 0) score += 5;\r\n    \r\n    // Portfolio projects (5 points)\r\n    if (portfolio.length > 0) score += 5;\r\n    \r\n    return Math.min(score, 100);\r\n  };\r\n\r\n  const profileScore = calculateProfileScore();\r\n\r\n  return (\r\n    <div className={`space-y-6 ${className}`}>\r\n      {/* Profile Completion Score */}\r\n      <Card>\r\n        <CardHeader>\r\n          <CardTitle className=\"flex items-center space-x-2\">\r\n            <CheckCircle className=\"h-5 w-5\" />\r\n            <span>Profile Completion</span>\r\n          </CardTitle>\r\n        </CardHeader>\r\n        <CardContent>\r\n          <div className=\"flex items-center space-x-4\">\r\n            <div className=\"flex-1\">\r\n              <div className=\"w-full bg-gray-200 rounded-full h-2.5\">\r\n                <div \r\n                  className=\"bg-blue-600 h-2.5 rounded-full transition-all duration-300\"\r\n                  style={{ width: `${profileScore}%` }}\r\n                ></div>\r\n              </div>\r\n            </div>\r\n            <span className=\"text-lg font-bold text-blue-600\">{profileScore}%</span>\r\n          </div>\r\n          <p className=\"text-sm text-gray-600 mt-2\">\r\n            Complete your profile to increase visibility and trust with potential clients\r\n          </p>\r\n        </CardContent>\r\n      </Card>\r\n\r\n      <Tabs defaultValue=\"basic\" className=\"w-full\">\r\n        <TabsList className=\"grid w-full grid-cols-5\">\r\n          <TabsTrigger value=\"basic\">Basic Info</TabsTrigger>\r\n          <TabsTrigger value=\"certifications\">Certifications</TabsTrigger>\r\n          <TabsTrigger value=\"education\">Education</TabsTrigger>\r\n          <TabsTrigger value=\"portfolio\">Portfolio</TabsTrigger>\r\n          <TabsTrigger value=\"languages\">Languages</TabsTrigger>\r\n        </TabsList>\r\n\r\n        {/* Basic Information Tab */}\r\n        <TabsContent value=\"basic\" className=\"space-y-6\">\r\n          <Card>\r\n            <CardHeader>\r\n              <CardTitle className=\"flex items-center space-x-2\">\r\n                <User className=\"h-5 w-5\" />\r\n                <span>Basic Information</span>\r\n              </CardTitle>\r\n            </CardHeader>\r\n            <CardContent className=\"space-y-4\">\r\n              <div>\r\n                <label className=\"block text-sm font-medium mb-2\">Professional Summary</label>\r\n                <Textarea\r\n                  value={formData.professional_summary || ''}\r\n                  onChange={(e) => setFormData(prev => ({ ...prev, professional_summary: e.target.value }))}\r\n                  placeholder=\"Tell potential clients about your expertise and what makes you unique...\"\r\n                  rows={4}\r\n                  disabled={!isEditing}\r\n                />\r\n              </div>\r\n\r\n              <div>\r\n                <label className=\"block text-sm font-medium mb-2\">Bio</label>\r\n                <Textarea\r\n                  value={formData.bio || ''}\r\n                  onChange={(e) => setFormData(prev => ({ ...prev, bio: e.target.value }))}\r\n                  placeholder=\"Share your story, passion, and approach to your work...\"\r\n                  rows={3}\r\n                  disabled={!isEditing}\r\n                />\r\n              </div>\r\n\r\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                <div>\r\n                  <label className=\"block text-sm font-medium mb-2\">Years of Experience</label>\r\n                  <Input\r\n                    type=\"number\"\r\n                    value={formData.experience_years || ''}\r\n                    onChange={(e) => setFormData(prev => ({ ...prev, experience_years: parseInt(e.target.value) || 0 }))}\r\n                    min=\"0\"\r\n                    max=\"50\"\r\n                    disabled={!isEditing}\r\n                  />\r\n                </div>\r\n\r\n                <div>\r\n                  <label className=\"block text-sm font-medium mb-2\">Hourly Rate ($)</label>\r\n                  <Input\r\n                    type=\"number\"\r\n                    value={formData.hourly_rate || ''}\r\n                    onChange={(e) => setFormData(prev => ({ ...prev, hourly_rate: parseFloat(e.target.value) || 0 }))}\r\n                    min=\"0\"\r\n                    step=\"0.01\"\r\n                    disabled={!isEditing}\r\n                  />\r\n                </div>\r\n              </div>\r\n\r\n              <div>\r\n                <label className=\"block text-sm font-medium mb-2\">Service Area Radius (km)</label>\r\n                <Input\r\n                  type=\"number\"\r\n                  value={formData.service_area_radius || ''}\r\n                  onChange={(e) => setFormData(prev => ({ ...prev, service_area_radius: parseInt(e.target.value) || 10 }))}\r\n                  min=\"1\"\r\n                  max=\"100\"\r\n                  disabled={!isEditing}\r\n                />\r\n              </div>\r\n\r\n              <div>\r\n                <label className=\"block text-sm font-medium mb-2\">Specializations</label>\r\n                <div className=\"flex space-x-2 mb-2\">\r\n                  <Input\r\n                    value={newSpecialization}\r\n                    onChange={(e) => setNewSpecialization(e.target.value)}\r\n                    placeholder=\"Add a specialization...\"\r\n                    disabled={!isEditing}\r\n                  />\r\n                  <Button \r\n                    onClick={addSpecialization} \r\n                    disabled={!isEditing || !newSpecialization.trim()}\r\n                    size=\"sm\"\r\n                  >\r\n                    <Plus className=\"h-4 w-4\" />\r\n                  </Button>\r\n                </div>\r\n                <div className=\"flex flex-wrap gap-2\">\r\n                  {formData.specializations?.map((spec, index) => (\r\n                    <Badge key={index} variant=\"secondary\" className=\"flex items-center space-x-1\">\r\n                      <span>{spec}</span>\r\n                      {isEditing && (\r\n                        <button\r\n                          onClick={() => removeSpecialization(spec)}\r\n                          className=\"ml-1 hover:text-red-500\"\r\n                        >\r\n                          <Trash2 className=\"h-3 w-3\" />\r\n                        </button>\r\n                      )}\r\n                    </Badge>\r\n                  ))}\r\n                </div>\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n        </TabsContent>\r\n\r\n        {/* Certifications Tab */}\r\n        <TabsContent value=\"certifications\" className=\"space-y-6\">\r\n          <Card>\r\n            <CardHeader>\r\n              <CardTitle className=\"flex items-center space-x-2\">\r\n                <Award className=\"h-5 w-5\" />\r\n                <span>Certifications</span>\r\n              </CardTitle>\r\n            </CardHeader>\r\n            <CardContent className=\"space-y-4\">\r\n              {/* Add New Certification */}\r\n              <div className=\"border rounded-lg p-4 bg-gray-50\">\r\n                <h4 className=\"font-medium mb-3\">Add New Certification</h4>\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                  <Input\r\n                    placeholder=\"Certification Name\"\r\n                    value={newCertification.certification_name}\r\n                    onChange={(e) => setNewCertification(prev => ({ ...prev, certification_name: e.target.value }))}\r\n                  />\r\n                  <Input\r\n                    placeholder=\"Issuing Organization\"\r\n                    value={newCertification.issuing_organization}\r\n                    onChange={(e) => setNewCertification(prev => ({ ...prev, issuing_organization: e.target.value }))}\r\n                  />\r\n                  <Input\r\n                    type=\"date\"\r\n                    placeholder=\"Issue Date\"\r\n                    value={newCertification.issue_date}\r\n                    onChange={(e) => setNewCertification(prev => ({ ...prev, issue_date: e.target.value }))}\r\n                  />\r\n                  <Input\r\n                    type=\"date\"\r\n                    placeholder=\"Expiry Date\"\r\n                    value={newCertification.expiry_date}\r\n                    onChange={(e) => setNewCertification(prev => ({ ...prev, expiry_date: e.target.value }))}\r\n                  />\r\n                  <Input\r\n                    placeholder=\"Certificate Number\"\r\n                    value={newCertification.certificate_number}\r\n                    onChange={(e) => setNewCertification(prev => ({ ...prev, certificate_number: e.target.value }))}\r\n                  />\r\n                  <Input\r\n                    placeholder=\"Certificate URL\"\r\n                    value={newCertification.certificate_url}\r\n                    onChange={(e) => setNewCertification(prev => ({ ...prev, certificate_url: e.target.value }))}\r\n                  />\r\n                </div>\r\n                <Button onClick={addCertification} className=\"mt-3\" disabled={!newCertification.certification_name || !newCertification.issuing_organization}>\r\n                  <Plus className=\"h-4 w-4 mr-2\" />\r\n                  Add Certification\r\n                </Button>\r\n              </div>\r\n\r\n              {/* Existing Certifications */}\r\n              <div className=\"space-y-3\">\r\n                {certifications.map((cert, index) => (\r\n                  <div key={index} className=\"border rounded-lg p-3 flex justify-between items-start\">\r\n                    <div>\r\n                      <h5 className=\"font-medium\">{cert.certification_name}</h5>\r\n                      <p className=\"text-sm text-gray-600\">{cert.issuing_organization}</p>\r\n                      <p className=\"text-xs text-gray-500\">\r\n                        {cert.issue_date && `Issued: ${cert.issue_date}`}\r\n                        {cert.expiry_date && ` â€¢ Expires: ${cert.expiry_date}`}\r\n                      </p>\r\n                    </div>\r\n                    <Button\r\n                      variant=\"outline\"\r\n                      size=\"sm\"\r\n                      onClick={() => removeCertification(index)}\r\n                      className=\"text-red-500 hover:text-red-700\"\r\n                    >\r\n                      <Trash2 className=\"h-4 w-4\" />\r\n                    </Button>\r\n                  </div>\r\n                ))}\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n        </TabsContent>\r\n\r\n        {/* Education Tab */}\r\n        <TabsContent value=\"education\" className=\"space-y-6\">\r\n          <Card>\r\n            <CardHeader>\r\n              <CardTitle className=\"flex items-center space-x-2\">\r\n                <GraduationCap className=\"h-5 w-5\" />\r\n                <span>Education</span>\r\n              </CardTitle>\r\n            </CardHeader>\r\n            <CardContent className=\"space-y-4\">\r\n              {/* Add New Education */}\r\n              <div className=\"border rounded-lg p-4 bg-gray-50\">\r\n                <h4 className=\"font-medium mb-3\">Add New Education</h4>\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                  <Input\r\n                    placeholder=\"Institution Name\"\r\n                    value={newEducation.institution_name}\r\n                    onChange={(e) => setNewEducation(prev => ({ ...prev, institution_name: e.target.value }))}\r\n                  />\r\n                  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n                  <Select value={newEducation.degree_type} onValueChange={(value) => setNewEducation(prev => ({ ...prev, degree_type: value as any }))}>\r\n                    <SelectTrigger>\r\n                      <SelectValue placeholder=\"Degree Type\" />\r\n                    </SelectTrigger>\r\n                    <SelectContent>\r\n                      {DEGREE_TYPES.map(degree => (\r\n                        <SelectItem key={degree.value} value={degree.value}>\r\n                          {degree.label}\r\n                        </SelectItem>\r\n                      ))}\r\n                    </SelectContent>\r\n                  </Select>\r\n                  <Input\r\n                    placeholder=\"Field of Study\"\r\n                    value={newEducation.field_of_study}\r\n                    onChange={(e) => setNewEducation(prev => ({ ...prev, field_of_study: e.target.value }))}\r\n                  />\r\n                  <div className=\"flex space-x-2\">\r\n                    <Input\r\n                      type=\"number\"\r\n                      placeholder=\"Start Year\"\r\n                      value={newEducation.start_year || ''}\r\n                      onChange={(e) => setNewEducation(prev => ({ ...prev, start_year: parseInt(e.target.value) || new Date().getFullYear() }))}\r\n                    />\r\n                    <Input\r\n                      type=\"number\"\r\n                      placeholder=\"End Year\"\r\n                      value={newEducation.end_year || ''}\r\n                      onChange={(e) => setNewEducation(prev => ({ ...prev, end_year: parseInt(e.target.value) || new Date().getFullYear() }))}\r\n                    />\r\n                  </div>\r\n                  <div className=\"flex items-center space-x-2\">\r\n                    <input\r\n                      type=\"checkbox\"\r\n                      id=\"isCurrent\"\r\n                      checked={newEducation.is_current}\r\n                      onChange={(e) => setNewEducation(prev => ({ ...prev, is_current: e.target.checked }))}\r\n                    />\r\n                    <label htmlFor=\"isCurrent\" className=\"text-sm\">Currently studying</label>\r\n                  </div>\r\n                </div>\r\n                <Textarea\r\n                  placeholder=\"Description (optional)\"\r\n                  value={newEducation.description || ''}\r\n                  onChange={(e) => setNewEducation(prev => ({ ...prev, description: e.target.value }))}\r\n                  className=\"mt-3\"\r\n                  rows={2}\r\n                />\r\n                <Button onClick={addEducation} className=\"mt-3\" disabled={!newEducation.institution_name}>\r\n                  <Plus className=\"h-4 w-4 mr-2\" />\r\n                  Add Education\r\n                </Button>\r\n              </div>\r\n\r\n              {/* Existing Education */}\r\n              <div className=\"space-y-3\">\r\n                {education.map((edu, index) => (\r\n                  <div key={index} className=\"border rounded-lg p-3 flex justify-between items-start\">\r\n                    <div>\r\n                      <h5 className=\"font-medium\">{edu.institution_name}</h5>\r\n                      <p className=\"text-sm text-gray-600\">\r\n                        {edu.degree_type && DEGREE_TYPES.find(d => d.value === edu.degree_type)?.label}\r\n                        {edu.field_of_study && ` in ${edu.field_of_study}`}\r\n                      </p>\r\n                      <p className=\"text-xs text-gray-500\">\r\n                        {edu.start_year} - {edu.is_current ? 'Present' : edu.end_year}\r\n                      </p>\r\n                      {edu.description && <p className=\"text-sm mt-1\">{edu.description}</p>}\r\n                    </div>\r\n                    <Button\r\n                      variant=\"outline\"\r\n                      size=\"sm\"\r\n                      onClick={() => removeEducation(index)}\r\n                      className=\"text-red-500 hover:text-red-700\"\r\n                    >\r\n                      <Trash2 className=\"h-4 w-4\" />\r\n                    </Button>\r\n                  </div>\r\n                ))}\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n        </TabsContent>\r\n\r\n        {/* Portfolio Tab */}\r\n        <TabsContent value=\"portfolio\" className=\"space-y-6\">\r\n          <Card>\r\n            <CardHeader>\r\n              <CardTitle className=\"flex items-center space-x-2\">\r\n                <Briefcase className=\"h-5 w-5\" />\r\n                <span>Portfolio</span>\r\n              </CardTitle>\r\n            </CardHeader>\r\n            <CardContent className=\"space-y-4\">\r\n              {/* Add New Portfolio Item */}\r\n              <div className=\"border rounded-lg p-4 bg-gray-50\">\r\n                <h4 className=\"font-medium mb-3\">Add New Portfolio Item</h4>\r\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\r\n                  <Input\r\n                    placeholder=\"Project Title\"\r\n                    value={newPortfolio.title}\r\n                    onChange={(e) => setNewPortfolio(prev => ({ ...prev, title: e.target.value }))}\r\n                  />\r\n                  <Input\r\n                    placeholder=\"Service Type\"\r\n                    value={newPortfolio.service_type}\r\n                    onChange={(e) => setNewPortfolio(prev => ({ ...prev, service_type: e.target.value }))}\r\n                  />\r\n                  <Input\r\n                    type=\"date\"\r\n                    placeholder=\"Project Date\"\r\n                    value={newPortfolio.project_date}\r\n                    onChange={(e) => setNewPortfolio(prev => ({ ...prev, project_date: e.target.value }))}\r\n                  />\r\n                  <Input\r\n                    placeholder=\"Project Duration\"\r\n                    value={newPortfolio.project_duration}\r\n                    onChange={(e) => setNewPortfolio(prev => ({ ...prev, project_duration: e.target.value }))}\r\n                  />\r\n                  <Input\r\n                    placeholder=\"Client Name (optional)\"\r\n                    value={newPortfolio.client_name}\r\n                    onChange={(e) => setNewPortfolio(prev => ({ ...prev, client_name: e.target.value }))}\r\n                  />\r\n                  <div className=\"flex items-center space-x-2\">\r\n                    <input\r\n                      type=\"checkbox\"\r\n                      id=\"isFeatured\"\r\n                      checked={newPortfolio.is_featured}\r\n                      onChange={(e) => setNewPortfolio(prev => ({ ...prev, is_featured: e.target.checked }))}\r\n                    />\r\n                    <label htmlFor=\"isFeatured\" className=\"text-sm\">Featured project</label>\r\n                  </div>\r\n                </div>\r\n                <Textarea\r\n                  placeholder=\"Project Description\"\r\n                  value={newPortfolio.description || ''}\r\n                  onChange={(e) => setNewPortfolio(prev => ({ ...prev, description: e.target.value }))}\r\n                  className=\"mt-3\"\r\n                  rows={2}\r\n                />\r\n                <div className=\"mt-3\">\r\n                  <label className=\"block text-sm font-medium mb-2\">Technologies Used</label>\r\n                  <div className=\"flex space-x-2 mb-2\">\r\n                    <Input\r\n                      value={newTechnology}\r\n                      onChange={(e) => setNewTechnology(e.target.value)}\r\n                      placeholder=\"Add technology...\"\r\n                    />\r\n                    <Button \r\n                      onClick={() => addTechnology(-1)} \r\n                      disabled={!newTechnology.trim()}\r\n                      size=\"sm\"\r\n                    >\r\n                      <Plus className=\"h-4 w-4\" />\r\n                    </Button>\r\n                  </div>\r\n                  <div className=\"flex flex-wrap gap-2\">\r\n                    {(newPortfolio.technologies_used || []).map((tech, index) => (\r\n                      <Badge key={index} variant=\"secondary\" className=\"flex items-center space-x-1\">\r\n                        <span>{tech}</span>\r\n                        <button\r\n                          onClick={() => setNewPortfolio(prev => ({ \r\n                            ...prev, \r\n                            technologies_used: (prev.technologies_used || []).filter((_, i) => i !== index) \r\n                          }))}\r\n                          className=\"ml-1 hover:text-red-500\"\r\n                        >\r\n                          <Trash2 className=\"h-3 w-3\" />\r\n                        </button>\r\n                      </Badge>\r\n                    ))}\r\n                  </div>\r\n                </div>\r\n                <Button onClick={addPortfolio} className=\"mt-3\" disabled={!newPortfolio.title}>\r\n                  <Plus className=\"h-4 w-4 mr-2\" />\r\n                  Add Portfolio Item\r\n                </Button>\r\n              </div>\r\n\r\n              {/* Existing Portfolio */}\r\n              <div className=\"space-y-3\">\r\n                {portfolio.map((item, index) => (\r\n                  <div key={index} className=\"border rounded-lg p-3 flex justify-between items-start\">\r\n                    <div className=\"flex-1\">\r\n                      <div className=\"flex items-center space-x-2 mb-2\">\r\n                        <h5 className=\"font-medium\">{item.title}</h5>\r\n                        {item.is_featured && (\r\n                          <Badge variant=\"default\" className=\"text-xs\">Featured</Badge>\r\n                        )}\r\n                      </div>\r\n                      <p className=\"text-sm text-gray-600\">{item.description}</p>\r\n                      <p className=\"text-xs text-gray-500 mt-1\">\r\n                        {item.service_type && `${item.service_type} â€¢ `}\r\n                        {item.project_date && `${item.project_date} â€¢ `}\r\n                        {item.project_duration && `${item.project_duration}`}\r\n                      </p>\r\n                      {(item.technologies_used || []).length > 0 && (\r\n                        <div className=\"flex flex-wrap gap-1 mt-2\">\r\n                          {(item.technologies_used || []).map((tech, techIndex) => (\r\n                            <Badge key={techIndex} variant=\"outline\" className=\"text-xs\">\r\n                              {tech}\r\n                            </Badge>\r\n                          ))}\r\n                        </div>\r\n                      )}\r\n                    </div>\r\n                    <Button\r\n                      variant=\"outline\"\r\n                      size=\"sm\"\r\n                      onClick={() => removePortfolio(index)}\r\n                      className=\"text-red-500 hover:text-red-700 ml-3\"\r\n                    >\r\n                      <Trash2 className=\"h-4 w-4\" />\r\n                    </Button>\r\n                  </div>\r\n                ))}\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n        </TabsContent>\r\n\r\n        {/* Languages Tab */}\r\n        <TabsContent value=\"languages\" className=\"space-y-6\">\r\n          <Card>\r\n            <CardHeader>\r\n              <CardTitle className=\"flex items-center space-x-2\">\r\n                <Globe className=\"h-5 w-5\" />\r\n                <span>Languages</span>\r\n              </CardTitle>\r\n            </CardHeader>\r\n            <CardContent className=\"space-y-4\">\r\n              {/* Add New Language */}\r\n              <div className=\"border rounded-lg p-4 bg-gray-50\">\r\n                <h4 className=\"font-medium mb-3\">Add New Language</h4>\r\n                <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\r\n                  <Input\r\n                    placeholder=\"Language Name\"\r\n                    value={newLanguage.language_name}\r\n                    onChange={(e) => setNewLanguage(prev => ({ \r\n                      ...prev, \r\n                      language_name: e.target.value,\r\n                      language_code: e.target.value.toLowerCase().substring(0, 2)\r\n                    }))}\r\n                  />\r\n                  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n                  <Select value={newLanguage.proficiency_level} onValueChange={(value) => setNewLanguage(prev => ({ ...prev, proficiency_level: value as any }))}>\r\n                    <SelectTrigger>\r\n                      <SelectValue placeholder=\"Proficiency Level\" />\r\n                    </SelectTrigger>\r\n                    <SelectContent>\r\n                      {LANGUAGE_PROFICIENCY_LEVELS.map(level => (\r\n                        <SelectItem key={level.value} value={level.value}>\r\n                          {level.label}\r\n                        </SelectItem>\r\n                      ))}\r\n                    </SelectContent>\r\n                  </Select>\r\n                  <div className=\"flex items-center space-x-2\">\r\n                    <input\r\n                      type=\"checkbox\"\r\n                      id=\"isPrimary\"\r\n                      checked={newLanguage.is_primary}\r\n                      onChange={(e) => setNewLanguage(prev => ({ ...prev, is_primary: e.target.checked }))}\r\n                    />\r\n                    <label htmlFor=\"isPrimary\" className=\"text-sm\">Primary language</label>\r\n                  </div>\r\n                </div>\r\n                <Button onClick={addLanguage} className=\"mt-3\" disabled={!newLanguage.language_name}>\r\n                  <Plus className=\"h-4 w-4 mr-2\" />\r\n                  Add Language\r\n                </Button>\r\n              </div>\r\n\r\n              {/* Existing Languages */}\r\n              <div className=\"space-y-3\">\r\n                {languages.map((lang, index) => (\r\n                  <div key={index} className=\"border rounded-lg p-3 flex justify-between items-center\">\r\n                    <div>\r\n                      <h5 className=\"font-medium\">{lang.language_name}</h5>\r\n                      <p className=\"text-sm text-gray-600\">\r\n                        {LANGUAGE_PROFICIENCY_LEVELS.find(l => l.value === lang.proficiency_level)?.label}\r\n                        {lang.is_primary && ' â€¢ Primary'}\r\n                      </p>\r\n                    </div>\r\n                    <Button\r\n                      variant=\"outline\"\r\n                      size=\"sm\"\r\n                      onClick={() => removeLanguage(index)}\r\n                      className=\"text-red-500 hover:text-red-700\"\r\n                    >\r\n                      <Trash2 className=\"h-4 w-4\" />\r\n                    </Button>\r\n                  </div>\r\n                ))}\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n        </TabsContent>\r\n      </Tabs>\r\n\r\n      {/* Action Buttons */}\r\n      <div className=\"flex justify-end space-x-3\">\r\n        {!isEditing ? (\r\n          <Button onClick={() => setIsEditing(true)}>\r\n            <Edit className=\"h-4 w-4 mr-2\" />\r\n            Edit Profile\r\n          </Button>\r\n        ) : (\r\n          <>\r\n            <Button variant=\"outline\" onClick={() => setIsEditing(false)}>\r\n              Cancel\r\n            </Button>\r\n            <Button onClick={handleSave} disabled={isLoading}>\r\n              {isLoading ? (\r\n                <>\r\n                  <AlertCircle className=\"h-4 w-4 mr-2 animate-spin\" />\r\n                  Saving...\r\n                </>\r\n              ) : (\r\n                <>\r\n                  <Save className=\"h-4 w-4 mr-2\" />\r\n                  Save Profile\r\n                </>\r\n              )}\r\n            </Button>\r\n          </>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\components\\provider\\ReviewResponse.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'motion' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":16},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'MessageSquare' is defined but never used. Allowed unused vars must match /^_/u.","line":5,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":5,"endColumn":23},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'AlertCircle' is defined but never used. Allowed unused vars must match /^_/u.","line":5,"column":44,"nodeType":null,"messageId":"unusedVar","endLine":5,"endColumn":55}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'checkExistingResponse'. Either include it or remove the dependency array.","line":44,"column":6,"nodeType":"ArrayExpression","endLine":44,"endColumn":29,"suggestions":[{"desc":"Update the dependencies array to be: [review.id, providerId, checkExistingResponse]","fix":{"range":[1238,1261],"text":"[review.id, providerId, checkExistingResponse]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useState, useEffect } from 'react'\nimport { motion } from 'framer-motion'\nimport { MessageSquare, Edit, CheckCircle, AlertCircle } from 'lucide-react'\n\ninterface Review {\n  id: string\n  customer_name: string\n  rating: number\n  comment: string\n  created_at: string\n  service_name: string\n}\n\ninterface ReviewResponse {\n  id?: string\n  review_id: string\n  provider_id: string\n  response_text: string\n  is_public: boolean\n  created_at?: string\n  updated_at?: string\n}\n\ninterface ReviewResponseProps {\n  review: Review\n  providerId: string\n  onResponseSubmitted?: (response: ReviewResponse) => void\n}\n\nexport default function ReviewResponse({ review, providerId, onResponseSubmitted }: ReviewResponseProps) {\n  const [responseText, setResponseText] = useState('')\n  const [isPublic, setIsPublic] = useState(true)\n  const [submitting, setSubmitting] = useState(false)\n  const [error, setError] = useState<string | null>(null)\n  const [existingResponse, setExistingResponse] = useState<ReviewResponse | null>(null)\n  const [showForm, setShowForm] = useState(false)\n\n  useEffect(() => {\n    // Check if there's an existing response\n    checkExistingResponse()\n  // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [review.id, providerId])\n\n  const checkExistingResponse = async () => {\n    try {\n      const response = await fetch(`/api/reviews/${review.id}/response?provider_id=${providerId}`)\n      if (response.ok) {\n        const data = await response.json()\n        if (data.response) {\n          setExistingResponse(data.response)\n          setResponseText(data.response.response_text)\n          setIsPublic(data.response.is_public)\n        }\n      }\n    } catch (error) {\n      console.error('Error checking existing response:', error)\n    }\n  }\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault()\n    setSubmitting(true)\n    setError(null)\n\n    try {\n      const endpoint = existingResponse \n        ? `/api/reviews/${review.id}/response/${existingResponse.id}`\n        : `/api/reviews/${review.id}/response`\n\n      const method = existingResponse ? 'PUT' : 'POST'\n\n      const response = await fetch(endpoint, {\n        method,\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({\n          review_id: review.id,\n          provider_id: providerId,\n          response_text: responseText.trim(),\n          is_public: isPublic,\n        }),\n      })\n\n      if (!response.ok) {\n        throw new Error('Failed to submit response')\n      }\n\n      const data = await response.json()\n      \n      if (existingResponse) {\n        setExistingResponse({ ...existingResponse, ...data.response })\n      } else {\n        setExistingResponse(data.response)\n      }\n\n      setShowForm(false)\n      onResponseSubmitted?.(data.response)\n      \n      // Show success message\n      setError(null)\n    } catch (error) {\n      setError('Failed to submit response. Please try again.')\n      console.error('Error submitting response:', error)\n    } finally {\n      setSubmitting(false)\n    }\n  }\n\n  const handleCancel = () => {\n    setShowForm(false)\n    if (existingResponse) {\n      setResponseText(existingResponse.response_text)\n      setIsPublic(existingResponse.is_public)\n    } else {\n      setResponseText('')\n      setIsPublic(true)\n    }\n    setError(null)\n  }\n\n  const handleEdit = () => {\n    setShowForm(true)\n  }\n\n  // If there's an existing response and we're not editing, show it\n  if (existingResponse && !showForm) {\n    return (\n      <div className=\"bg-blue-50 p-4 rounded-lg border border-blue-200\">\n        <div className=\"flex items-center justify-between mb-3\">\n          <h4 className=\"font-medium text-blue-800 flex items-center gap-2\">\n            <CheckCircle size={16} />\n            Your Response\n          </h4>\n          <button\n            onClick={handleEdit}\n            className=\"text-blue-600 hover:text-blue-700 text-sm flex items-center gap-1\"\n          >\n            <Edit size={14} />\n            Edit\n          </button>\n        </div>\n        \n        <p className=\"text-blue-700 mb-2\">{existingResponse.response_text}</p>\n        \n        <div className=\"flex items-center gap-4 text-xs text-blue-600\">\n          <span>\n            {existingResponse.is_public ? 'Public response' : 'Private response'}\n          </span>\n          <span>\n            {existingResponse.created_at && new Date(existingResponse.created_at).toLocaleDateString('en-US', {\n              year: 'numeric',\n              month: 'short',\n              day: 'numeric'\n            })}\n          </span>\n        </div>\n      </div>\n    )\n  }\n\n  return (\n    <div className=\"bg-gray-50 p-4 rounded-lg border border-gray-200\">\n      <h4 className=\"font-medium text-gray-800 mb-3\">\n        {existingResponse ? 'Edit Response' : 'Respond to Review'}\n      </h4>\n      \n      <form onSubmit={handleSubmit} className=\"space-y-4\">\n        <div>\n          <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n            Your Response *\n          </label>\n          <textarea\n            value={responseText}\n            onChange={(e) => setResponseText(e.target.value)}\n            rows={4}\n            className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"\n            placeholder=\"Share your perspective on this review...\"\n            required\n          />\n          <p className=\"text-xs text-gray-500 mt-1\">\n            Keep your response professional and constructive\n          </p>\n        </div>\n\n        <div className=\"flex items-center gap-2\">\n          <input\n            type=\"checkbox\"\n            id=\"isPublic\"\n            checked={isPublic}\n            onChange={(e) => setIsPublic(e.target.checked)}\n            className=\"w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500\"\n          />\n          <label htmlFor=\"isPublic\" className=\"text-sm text-gray-700\">\n            Make this response public (customers can see it)\n          </label>\n        </div>\n\n        {error && (\n          <div className=\"text-red-600 text-sm bg-red-50 p-2 rounded\">\n            {error}\n          </div>\n        )}\n\n        <div className=\"flex items-center gap-3\">\n          <button\n            type=\"submit\"\n            disabled={submitting || !responseText.trim()}\n            className=\"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors\"\n          >\n            {submitting ? 'Submitting...' : (existingResponse ? 'Update Response' : 'Submit Response')}\n          </button>\n          \n          <button\n            type=\"button\"\n            onClick={handleCancel}\n            className=\"px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors\"\n          >\n            Cancel\n          </button>\n        </div>\n      </form>\n\n      <div className=\"mt-4 p-3 bg-blue-50 rounded-lg\">\n        <h5 className=\"text-sm font-medium text-blue-800 mb-2\">Response Guidelines</h5>\n        <ul className=\"text-xs text-blue-700 space-y-1\">\n          <li>â€¢ Be professional and courteous</li>\n          <li>â€¢ Address specific concerns mentioned in the review</li>\n          <li>â€¢ Thank customers for positive feedback</li>\n          <li>â€¢ Offer solutions for any issues raised</li>\n          <li>â€¢ Keep responses concise and helpful</li>\n        </ul>\n      </div>\n    </div>\n  )\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\config\\performance.ts","messages":[{"ruleId":"import/no-anonymous-default-export","severity":1,"message":"Assign object to a variable before exporting as module default","line":196,"column":1,"nodeType":"ExportDefaultDeclaration","endLine":203,"endColumn":2}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Production Performance Guardrails Configuration\r\n * \r\n * This file contains production-ready thresholds and alert configurations\r\n * for the performance monitoring system.\r\n */\r\n\r\nimport { GuardrailConfig } from '@/lib/performance/guardrails'\r\n\r\n// Environment-specific configurations\r\nconst ENVIRONMENT_CONFIGS = {\r\n  development: {\r\n    maxResponseTime: 10000, // 10 seconds - more lenient for dev\r\n    maxMemoryUsage: 1024, // 1GB - dev environments often have more memory\r\n    maxCpuUsage: 90, // 90% - dev can run hotter\r\n    maxRequestRate: 2000, // 2000 req/min - higher for testing\r\n    maxErrorRate: 10, // 10% - more tolerant in dev\r\n    maxCostPerHour: 50, // $50/hr - dev environment\r\n    alertThreshold: 85, // Alert at 85% of limit\r\n  },\r\n  staging: {\r\n    maxResponseTime: 7000, // 7 seconds\r\n    maxMemoryUsage: 768, // 768MB\r\n    maxCpuUsage: 85, // 85%\r\n    maxRequestRate: 1500, // 1500 req/min\r\n    maxErrorRate: 7, // 7%\r\n    maxCostPerHour: 25, // $25/hr\r\n    alertThreshold: 80, // Alert at 80% of limit\r\n  },\r\n  production: {\r\n    maxResponseTime: 5000, // 5 seconds - strict for production\r\n    maxMemoryUsage: 512, // 512MB - optimize for cost\r\n    maxCpuUsage: 80, // 80% - leave headroom for spikes\r\n    maxRequestRate: 1000, // 1000 req/min - production traffic\r\n    maxErrorRate: 5, // 5% - low error tolerance\r\n    maxCostPerHour: 15, // $15/hr - cost control\r\n    alertThreshold: 75, // Alert at 75% of limit - early warning\r\n  },\r\n} as const\r\n\r\n// Alert channels configuration\r\nexport interface AlertChannelConfig {\r\n  enabled: boolean\r\n  webhook?: string\r\n  email?: string\r\n  slack?: {\r\n    webhookUrl: string\r\n    channel: string\r\n    username?: string\r\n  }\r\n  teams?: {\r\n    webhookUrl: string\r\n  }\r\n  pagerduty?: {\r\n    integrationKey: string\r\n    severity: 'critical' | 'error' | 'warning' | 'info'\r\n  }\r\n}\r\n\r\nexport const ALERT_CHANNELS: Record<string, AlertChannelConfig> = {\r\n  development: {\r\n    enabled: false, // Disable alerts in dev to avoid noise\r\n  },\r\n  staging: {\r\n    enabled: true,\r\n    slack: {\r\n      webhookUrl: process.env.SLACK_WEBHOOK_URL_STAGING || '',\r\n      channel: '#staging-alerts',\r\n      username: 'Bookiji Staging Monitor'\r\n    }\r\n  },\r\n  production: {\r\n    enabled: true,\r\n    slack: {\r\n      webhookUrl: process.env.SLACK_WEBHOOK_URL_PROD || '',\r\n      channel: '#production-alerts',\r\n      username: 'Bookiji Production Monitor'\r\n    },\r\n    email: process.env.ALERT_EMAIL || 'alerts@bookiji.com',\r\n    pagerduty: {\r\n      integrationKey: process.env.PAGERDUTY_INTEGRATION_KEY || '',\r\n      severity: 'critical'\r\n    }\r\n  }\r\n}\r\n\r\n// Critical thresholds that trigger immediate alerts\r\nexport const CRITICAL_THRESHOLDS = {\r\n  responseTime: 15000, // 15 seconds - system is essentially down\r\n  memoryUsage: 2048, // 2GB - memory leak or serious issue\r\n  cpuUsage: 95, // 95% - system overload\r\n  errorRate: 25, // 25% - major system failure\r\n  requestRate: 5000, // 5000 req/min - potential DDoS or runaway process\r\n}\r\n\r\n/**\r\n * Get performance configuration based on environment\r\n */\r\nexport function getPerformanceConfig(): GuardrailConfig {\r\n  const env = process.env.NODE_ENV || 'development'\r\n  const deployEnv = process.env.DEPLOY_ENV || env\r\n  \r\n  // Use production config for any production-like environment\r\n  const configKey = ['production', 'prod'].includes(deployEnv.toLowerCase()) ? 'production' : \r\n                   ['staging', 'stage'].includes(deployEnv.toLowerCase()) ? 'staging' : \r\n                   'development'\r\n  \r\n  return ENVIRONMENT_CONFIGS[configKey]\r\n}\r\n\r\n/**\r\n * Get alert configuration based on environment\r\n */\r\nexport function getAlertConfig(): AlertChannelConfig {\r\n  const env = process.env.NODE_ENV || 'development'\r\n  const deployEnv = process.env.DEPLOY_ENV || env\r\n  \r\n  const configKey = ['production', 'prod'].includes(deployEnv.toLowerCase()) ? 'production' : \r\n                   ['staging', 'stage'].includes(deployEnv.toLowerCase()) ? 'staging' : \r\n                   'development'\r\n  \r\n  return ALERT_CHANNELS[configKey]\r\n}\r\n\r\n/**\r\n * Alert severity levels\r\n */\r\nexport enum AlertSeverity {\r\n  INFO = 'info',\r\n  WARNING = 'warning', \r\n  ERROR = 'error',\r\n  CRITICAL = 'critical'\r\n}\r\n\r\n/**\r\n * Determine alert severity based on violation\r\n */\r\nexport function getAlertSeverity(metric: string, value: number, threshold: number): AlertSeverity {\r\n  const criticalThreshold = CRITICAL_THRESHOLDS[metric as keyof typeof CRITICAL_THRESHOLDS]\r\n  \r\n  if (criticalThreshold && value >= criticalThreshold) {\r\n    return AlertSeverity.CRITICAL\r\n  }\r\n  \r\n  const ratio = value / threshold\r\n  if (ratio >= 1.2) return AlertSeverity.CRITICAL\r\n  if (ratio >= 1.0) return AlertSeverity.ERROR\r\n  if (ratio >= 0.9) return AlertSeverity.WARNING\r\n  return AlertSeverity.INFO\r\n}\r\n\r\n/**\r\n * Format alert message for different channels\r\n */\r\nexport function formatAlertMessage(\r\n  violations: string[], \r\n  severity: AlertSeverity,\r\n  environment: string\r\n): {\r\n  title: string\r\n  message: string\r\n  color?: string\r\n  emoji?: string\r\n} {\r\n  const emoji = {\r\n    [AlertSeverity.CRITICAL]: 'ðŸš¨',\r\n    [AlertSeverity.ERROR]: 'âŒ', \r\n    [AlertSeverity.WARNING]: 'âš ï¸',\r\n    [AlertSeverity.INFO]: 'â„¹ï¸'\r\n  }[severity]\r\n\r\n  const color = {\r\n    [AlertSeverity.CRITICAL]: '#FF0000',\r\n    [AlertSeverity.ERROR]: '#FF4444',\r\n    [AlertSeverity.WARNING]: '#FFA500', \r\n    [AlertSeverity.INFO]: '#0066CC'\r\n  }[severity]\r\n\r\n  const title = `${emoji} ${severity.toUpperCase()} - Performance Alert (${environment})`\r\n  \r\n  const message = [\r\n    `Environment: ${environment}`,\r\n    `Severity: ${severity}`,\r\n    `Time: ${new Date().toISOString()}`,\r\n    '',\r\n    'Violations:',\r\n    ...violations.map(v => `â€¢ ${v}`),\r\n    '',\r\n    'Please investigate immediately if this is a production environment.'\r\n  ].join('\\n')\r\n\r\n  return { title, message, color, emoji }\r\n}\r\n\r\n// Export default configuration\r\nexport default {\r\n  getPerformanceConfig,\r\n  getAlertConfig,\r\n  getAlertSeverity,\r\n  formatAlertMessage,\r\n  CRITICAL_THRESHOLDS,\r\n  AlertSeverity\r\n}\r\n\r\n\r\n\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\hooks\\useNotifications.ts","messages":[{"ruleId":"prefer-const","severity":1,"message":"'_isSubscribed' is never reassigned. Use 'const' instead.","line":128,"column":9,"nodeType":"Identifier","messageId":"useConst","endLine":128,"endColumn":22,"fix":{"range":[4080,4105],"text":"const _isSubscribed = false"}}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'fetchNotifications'. Either include it or remove the dependency array.","line":279,"column":6,"nodeType":"ArrayExpression","endLine":279,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [fetchNotifications]","fix":{"range":[8798,8800],"text":"[fetchNotifications]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":1,"source":"import { useState, useEffect, useCallback } from 'react'\nimport { supabaseBrowserClient } from '@/lib/supabaseClient'\nimport { Notification } from '@/types/notification'\nimport { NotificationService } from '@/lib/services/notificationService'\n\ninterface NotificationState {\n  data: Notification[];\n  isLoading: boolean;\n  error: string | null;\n}\n\nexport function useNotifications() {\n  const [state, setState] = useState<NotificationState>({\n    data: [],\n    isLoading: false,\n    error: null\n  })\n\n  const notificationService = NotificationService.getInstance()\n\n  const fetchNotifications = useCallback(async () => {\n    const supabase = supabaseBrowserClient()\n    if (!supabase) {\n      setState(prev => ({ ...prev, isLoading: false, error: 'Supabase client not available' }))\n      return\n    }\n\n    const { data: { session } } = await supabase.auth.getSession()\n    if (!session) {\n      // Don't set error for unauthenticated users - just return empty state\n      setState(prev => ({\n        ...prev,\n        isLoading: false,\n        error: null,\n        data: []\n      }))\n      return\n    }\n\n    setState(prev => ({ ...prev, isLoading: true, error: null }))\n\n    try {\n      const notifications = await notificationService.fetchNotifications(session.access_token)\n      setState({\n        data: notifications,\n        isLoading: false,\n        error: null\n      })\n    } catch (error) {\n      setState(prev => ({\n        ...prev,\n        isLoading: false,\n        error: error instanceof Error ? error.message : 'Failed to load notifications'\n      }))\n    }\n  }, [notificationService])\n\n  const markAsRead = useCallback(async (notificationId: string) => {\n    const supabase = supabaseBrowserClient()\n    if (!supabase) return\n    \n    const { data: { session } } = await supabase.auth.getSession()\n    if (!session) return\n    try {\n      await notificationService.markAsRead(notificationId, session.access_token)\n      setState(prev => ({\n        ...prev,\n        data: prev.data.map(notification =>\n          notification.id === notificationId\n\n            ? { ...notification, read: true, read_at: new Date().toISOString() }\n\n            : notification\n        )\n      }))\n    } catch (error) {\n      console.error('Failed to mark notification as read:', error)\n    }\n  }, [notificationService])\n\n  const markAllAsRead = useCallback(async () => {\n    const supabase = supabaseBrowserClient()\n    if (!supabase) return\n    \n    const { data: { session } } = await supabase.auth.getSession()\n    if (!session) return\n    try {\n      await notificationService.markAllAsRead(session.access_token)\n      const timestamp = new Date().toISOString()\n      setState(prev => ({\n        ...prev,\n\n        data: prev.data.map(notification => ({ ...notification, read: true, read_at: timestamp }))\n\n      }))\n    } catch (error) {\n      console.error('Failed to mark all notifications as read:', error)\n    }\n  }, [notificationService])\n\n  const deleteNotification = useCallback(async (notificationId: string) => {\n    const supabase = supabaseBrowserClient()\n    if (!supabase) return\n    \n    const { data: { session } } = await supabase.auth.getSession()\n    if (!session) return\n    try {\n      await notificationService.deleteNotification(notificationId, session.access_token)\n      setState(prev => ({\n        ...prev,\n        data: prev.data.filter(notification => notification.id !== notificationId)\n      }))\n    } catch (error) {\n      console.error('Failed to delete notification:', error)\n    }\n  }, [notificationService])\n\n  // Set up real-time notifications with reconnection logic\n  useEffect(() => {\n    let channel: ReturnType<NonNullable<ReturnType<typeof supabaseBrowserClient>>['channel']> | null = null\n    let reconnectTimeout: ReturnType<typeof setTimeout> | null = null\n    let currentSupabase: ReturnType<typeof supabaseBrowserClient> | null = null\n    let reconnectAttempts = 0\n    let lastErrorTime = 0\n    const MAX_RECONNECT_ATTEMPTS = 5\n    const INITIAL_RECONNECT_DELAY = 2000 // 2 seconds\n    const MAX_RECONNECT_DELAY = 30000 // 30 seconds\n    let _isSubscribed = false\n\n    const subscribe = async () => {\n      const supabase = supabaseBrowserClient()\n      if (!supabase) return\n      currentSupabase = supabase\n      \n      const { data: { session } } = await supabase.auth.getSession()\n      if (!session?.user?.id) return\n\n      // Clean up existing channel if any\n      if (channel) {\n        supabase.removeChannel(channel)\n        channel = null\n      }\n\n      try {\n        channel = supabase\n          .channel(`notifications-${session.user.id}`, {\n            config: {\n              broadcast: { self: false },\n              presence: { key: session.user.id }\n            }\n          })\n          .on(\n            'postgres_changes',\n            {\n              event: 'INSERT',\n              schema: 'public',\n              table: 'notifications',\n              filter: `user_id=eq.${session.user.id}`\n            },\n            (payload) => {\n              setState(prev => ({\n                ...prev,\n                data: [payload.new as Notification, ...prev.data]\n              }))\n            }\n          )\n          .on(\n            'postgres_changes',\n            {\n              event: 'UPDATE',\n              schema: 'public',\n              table: 'notifications',\n              filter: `user_id=eq.${session.user.id}`\n            },\n            (payload) => {\n              setState(prev => ({\n                ...prev,\n                data: prev.data.map(notification =>\n                  notification.id === (payload.new as Notification).id\n                    ? payload.new as Notification\n                    : notification\n                )\n              }))\n            }\n          )\n          .on(\n            'postgres_changes',\n            {\n              event: 'DELETE',\n              schema: 'public',\n              table: 'notifications',\n              filter: `user_id=eq.${session.user.id}`\n            },\n            (payload) => {\n              setState(prev => ({\n                ...prev,\n                data: prev.data.filter(notification => notification.id !== payload.old.id)\n              }))\n            }\n          )\n          .subscribe((status) => {\n            if (status === 'SUBSCRIBED') {\n              isSubscribed = true\n              reconnectAttempts = 0 // Reset on successful subscription\n              lastErrorTime = 0\n            } else if (status === 'CHANNEL_ERROR') {\n              isSubscribed = false\n              // Only log if it's been more than 10 seconds since last error (avoid spam)\n              const now = Date.now()\n              if (now - lastErrorTime > 10000) {\n                console.warn('Notifications real-time channel error. Will retry automatically.')\n                lastErrorTime = now\n              }\n              if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {\n                attemptReconnect()\n              } else {\n                console.warn('Max reconnection attempts reached. Real-time notifications disabled. Polling will continue.')\n              }\n            } else if (status === 'CLOSED') {\n              isSubscribed = false\n              // Only attempt reconnect if it wasn't intentionally closed\n              if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {\n                attemptReconnect()\n              }\n            } else if (status === 'TIMED_OUT') {\n              isSubscribed = false\n              if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {\n                attemptReconnect()\n              }\n            }\n          })\n      } catch (error) {\n        console.error('Failed to set up notifications channel:', error)\n        isSubscribed = false\n        if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {\n          attemptReconnect()\n        }\n      }\n    }\n\n    const attemptReconnect = () => {\n      if (reconnectTimeout) return\n      \n      reconnectAttempts++\n      // Exponential backoff: 2s, 4s, 8s, 16s, 30s (max)\n      const delay = Math.min(\n        INITIAL_RECONNECT_DELAY * Math.pow(2, reconnectAttempts - 1),\n        MAX_RECONNECT_DELAY\n      )\n      \n      reconnectTimeout = setTimeout(() => {\n        reconnectTimeout = null\n        const supabase = supabaseBrowserClient()\n        if (!supabase) return\n        \n        subscribe()\n      }, delay)\n    }\n\n    subscribe()\n\n    return () => {\n      if (channel && currentSupabase) {\n        currentSupabase.removeChannel(channel)\n        channel = null\n      }\n      if (reconnectTimeout) {\n        clearTimeout(reconnectTimeout)\n        reconnectTimeout = null\n      }\n      isSubscribed = false\n    }\n  }, [])\n\n  // Initial fetch - only run once on mount\n  useEffect(() => {\n    fetchNotifications()\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, []) // Intentionally empty - only fetch once on mount\n\n  return {\n    notifications: state.data,\n    unreadCount: state.data.filter(n => !n.read).length,\n    isLoading: state.isLoading,\n    error: state.error,\n    markAsRead,\n    markAllAsRead,\n    deleteNotification,\n    refresh: fetchNotifications\n  }\n} ","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\hooks\\usePushSubscription.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'pushNotificationManager' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":33}],"suppressedMessages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'checkSubscriptionStatus'. Either include it or remove the dependency array.","line":33,"column":6,"nodeType":"ArrayExpression","endLine":33,"endColumn":8,"suggestions":[{"desc":"Update the dependencies array to be: [checkSubscriptionStatus]","fix":{"range":[850,852],"text":"[checkSubscriptionStatus]"}}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\n\nimport { useState, useEffect, useCallback } from 'react'\nimport { pushNotificationManager } from '@/lib/notifications/pushNotifications'\n\nexport interface PushSubscriptionState {\n  isSupported: boolean\n  isSubscribed: boolean\n  isSubscribing: boolean\n  error: string | null\n}\n\n/**\n * Hook for managing Web Push subscriptions\n */\nexport function usePushSubscription() {\n  const [state, setState] = useState<PushSubscriptionState>({\n    isSupported: false,\n    isSubscribed: false,\n    isSubscribing: false,\n    error: null\n  })\n\n  useEffect(() => {\n    // Check if push is supported\n    const isSupported = 'serviceWorker' in navigator && 'PushManager' in window\n    setState(prev => ({ ...prev, isSupported }))\n\n    if (isSupported) {\n      checkSubscriptionStatus()\n    }\n  // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [])\n\n  const checkSubscriptionStatus = useCallback(async () => {\n    try {\n      if ('serviceWorker' in navigator) {\n        const registration = await navigator.serviceWorker.ready\n        const subscription = await registration.pushManager.getSubscription()\n        setState(prev => ({ ...prev, isSubscribed: !!subscription }))\n      }\n    } catch (error) {\n      console.error('Error checking subscription status:', error)\n      setState(prev => ({ ...prev, error: 'Failed to check subscription status' }))\n    }\n  }, [])\n\n  const subscribe = useCallback(async () => {\n    if (!state.isSupported) {\n      setState(prev => ({ ...prev, error: 'Push notifications are not supported' }))\n      return false\n    }\n\n    setState(prev => ({ ...prev, isSubscribing: true, error: null }))\n\n    try {\n      // Get VAPID public key\n      const vapidResponse = await fetch('/api/notifications/push/vapid-public-key')\n      const { publicKey } = await vapidResponse.json()\n\n      if (!publicKey) {\n        throw new Error('VAPID public key not available')\n      }\n\n      // Register service worker\n      const registration = await navigator.serviceWorker.ready\n\n      // Subscribe to push\n      const keyArray = urlBase64ToUint8Array(publicKey)\n      const subscription = await registration.pushManager.subscribe({\n        userVisibleOnly: true,\n        applicationServerKey: keyArray as BufferSource\n      })\n\n      const p256dhKey = subscription.getKey('p256dh')\n      const authKey = subscription.getKey('auth')\n\n      if (!p256dhKey || !authKey) {\n        throw new Error('Push subscription keys missing')\n      }\n\n      // Send subscription to server\n      const response = await fetch('/api/notifications/push/subscribe', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          endpoint: subscription.endpoint,\n          keys: {\n            p256dh: uint8ArrayToBase64(new Uint8Array(p256dhKey)),\n            auth: uint8ArrayToBase64(new Uint8Array(authKey))\n          }\n        })\n      })\n\n      if (!response.ok) {\n        throw new Error('Failed to save subscription')\n      }\n\n      setState(prev => ({ ...prev, isSubscribed: true, isSubscribing: false }))\n      return true\n    } catch (error) {\n      console.error('Error subscribing to push:', error)\n      setState(prev => ({\n        ...prev,\n        error: error instanceof Error ? error.message : 'Failed to subscribe',\n        isSubscribing: false\n      }))\n      return false\n    }\n  }, [state.isSupported])\n\n  const unsubscribe = useCallback(async () => {\n    setState(prev => ({ ...prev, isSubscribing: true, error: null }))\n\n    try {\n      const registration = await navigator.serviceWorker.ready\n      const subscription = await registration.pushManager.getSubscription()\n\n      if (subscription) {\n        // Delete from server\n        await fetch('/api/notifications/push/subscribe', {\n          method: 'DELETE',\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify({ endpoint: subscription.endpoint })\n        })\n\n        // Unsubscribe from push\n        await subscription.unsubscribe()\n      }\n\n      setState(prev => ({ ...prev, isSubscribed: false, isSubscribing: false }))\n      return true\n    } catch (error) {\n      console.error('Error unsubscribing from push:', error)\n      setState(prev => ({\n        ...prev,\n        error: error instanceof Error ? error.message : 'Failed to unsubscribe',\n        isSubscribing: false\n      }))\n      return false\n    }\n  }, [])\n\n  return {\n    ...state,\n    subscribe,\n    unsubscribe,\n    refresh: checkSubscriptionStatus\n  }\n}\n\n// Helper functions for VAPID key conversion\nfunction urlBase64ToUint8Array(base64String: string): Uint8Array {\n  const padding = '='.repeat((4 - (base64String.length % 4)) % 4)\n  const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/')\n  const rawData = window.atob(base64)\n  const outputArray = new Uint8Array(rawData.length)\n\n  for (let i = 0; i < rawData.length; ++i) {\n    outputArray[i] = rawData.charCodeAt(i)\n  }\n  return outputArray\n}\n\nfunction uint8ArrayToBase64(array: Uint8Array): string {\n  const bytes = new Uint8Array(array)\n  let binary = ''\n  for (let i = 0; i < bytes.byteLength; i++) {\n    binary += String.fromCharCode(bytes[i])\n  }\n  return window.btoa(binary)\n}\n\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\lib\\bookingsCreateHandler.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'sendVendorNotification' is defined but never used. Allowed unused vars must match /^_/u.","line":2,"column":35,"nodeType":null,"messageId":"unusedVar","endLine":2,"endColumn":57}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { NextRequest, NextResponse } from 'next/server'\r\nimport { sendBookingConfirmation, sendVendorNotification } from '@/utils/sendEmail';\r\n\r\ninterface BookingRequest {\r\n  vendorId: string\r\n  serviceId: string\r\n  slotId: string\r\n  slotStart: string\r\n  slotEnd: string\r\n  customerName: string\r\n  customerEmail: string\r\n  customerPhone?: string\r\n  paymentMethod: 'credits' | 'card'\r\n  totalAmountCents: number\r\n  notes?: string\r\n}\r\n\r\n// Accepts dependencies as an argument for future extensibility (e.g., database, email, etc.)\r\nexport function makeBookingsCreateHandler() {\r\n  return async function POST(request: NextRequest) {\r\n    try {\r\n      const bookingData: BookingRequest = await request.json()\r\n      \r\n      // Validate required fields\r\n      const requiredFields = [\r\n        'vendorId', 'serviceId', 'slotStart', 'slotEnd', \r\n        'customerName', 'customerEmail', 'paymentMethod', 'totalAmountCents'\r\n      ]\r\n\r\n      const missingFields = requiredFields.filter(field => !bookingData[field as keyof BookingRequest])\r\n      \r\n      if (missingFields.length > 0) {\r\n        return NextResponse.json({\r\n          success: false,\r\n          error: `Missing required fields: ${missingFields.join(', ')}`\r\n        }, { status: 400 })\r\n      }\r\n\r\n      // Generate booking ID\r\n      const bookingId = `booking_${Date.now()}_${Math.random().toString(36).substring(2, 8)}`\r\n      const customerId = `customer_${Date.now()}_${Math.random().toString(36).substring(2, 6)}`\r\n\r\n      // Create booking record\r\n      const booking = {\r\n        id: bookingId,\r\n        customer_id: customerId,\r\n        vendor_id: bookingData.vendorId,\r\n        service_id: bookingData.serviceId,\r\n        slot_start: bookingData.slotStart,\r\n        slot_end: bookingData.slotEnd,\r\n        status: 'confirmed',\r\n        payment_method: bookingData.paymentMethod,\r\n        total_amount_cents: bookingData.totalAmountCents,\r\n        created_at: new Date().toISOString()\r\n      }\r\n\r\n      const customer = {\r\n        id: customerId,\r\n        email: bookingData.customerEmail,\r\n        full_name: bookingData.customerName,\r\n        phone: bookingData.customerPhone || null\r\n      }\r\n\r\n      // Send confirmation email\r\n      try {\r\n        await sendBookingConfirmation({\r\n          customerEmail: bookingData.customerEmail,\r\n          customerName: bookingData.customerName || 'Customer',\r\n          vendorName: 'Your Service Provider', // TODO: Fetch actual vendor name from database\r\n          serviceName: 'Service', // TODO: Fetch actual service name from database\r\n          bookingDate: new Date(bookingData.slotStart).toLocaleDateString(),\r\n          bookingTime: new Date(bookingData.slotStart).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),\r\n          bookingId: booking.id,\r\n        });\r\n        \r\n        // TODO: Also notify the vendor when we have vendor profile data\r\n        // if (vendorProfile?.email) {\r\n        //   await sendVendorNotification({...});\r\n        // }\r\n      } catch (emailError) {\r\n        console.error('Failed to send confirmation emails:', emailError);\r\n        // Don't fail the booking creation if email fails\r\n      }\r\n\r\n      return NextResponse.json({\r\n        success: true,\r\n        message: 'Booking created successfully',\r\n        booking,\r\n        customer,\r\n        next_steps: ['Booking confirmed', 'Check your email for details']\r\n      })\r\n\r\n    } catch (error) {\r\n      return NextResponse.json({\r\n        success: false,\r\n        error: error instanceof Error ? error.message : 'Booking creation failed'\r\n      }, { status: 500 })\r\n    }\r\n  }\r\n} ","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\lib\\cache\\invalidation.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'createClient' is defined but never used. Allowed unused vars must match /^_/u.","line":1,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":1,"endColumn":22}],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":273,"column":59,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":273,"endColumn":62,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8377,8380],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8377,8380],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":273,"column":69,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":273,"endColumn":72,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8387,8390],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8387,8390],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":278,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":278,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8524,8527],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8524,8527],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createClient } from '@supabase/supabase-js';\n\nimport { supabaseAdmin as supabase } from '@/lib/supabaseProxies';\n\nexport class CacheInvalidationManager {\n  private static instance: CacheInvalidationManager;\n  private invalidationHooks: Map<string, Set<string>> = new Map();\n  private invalidationTags: Map<string, string[]> = new Map();\n\n  private constructor() {\n    this.initializeDefaultHooks();\n  }\n\n  static getInstance(): CacheInvalidationManager {\n    if (!CacheInvalidationManager.instance) {\n      CacheInvalidationManager.instance = new CacheInvalidationManager();\n    }\n    return CacheInvalidationManager.instance;\n  }\n\n  private initializeDefaultHooks() {\n    // Register default invalidation patterns\n    this.registerInvalidation('vendor_specialties', [\n      'search:vendor:*',\n      'search:specialty:*',\n      'cache:vendor:*',\n      'cache:specialty:*'\n    ]);\n\n    this.registerInvalidation('vendor_services', [\n      'search:service:*',\n      'search:provider:*',\n      'cache:service:*',\n      'cache:provider:*'\n    ]);\n\n    this.registerInvalidation('vendor_locations', [\n      'search:geo:*',\n      'search:location:*',\n      'cache:geo:*',\n      'cache:location:*'\n    ]);\n\n    this.registerInvalidation('vendor_profiles', [\n      'search:vendor:*',\n      'search:provider:*',\n      'cache:vendor:*',\n      'cache:provider:*'\n    ]);\n\n    this.registerInvalidation('specialties', [\n      'search:specialty:*',\n      'cache:specialty:*',\n      'specialty:tree:*'\n    ]);\n\n    this.registerInvalidation('reviews', [\n      'search:rating:*',\n      'cache:rating:*',\n      'analytics:reviews:*'\n    ]);\n\n    this.registerInvalidation('bookings', [\n      'analytics:bookings:*',\n      'analytics:revenue:*',\n      'cache:analytics:*'\n    ]);\n  }\n\n  // Register cache keys to invalidate when data changes\n  registerInvalidation(dataType: string, cacheKeys: string[]) {\n    if (!this.invalidationHooks.has(dataType)) {\n      this.invalidationHooks.set(dataType, new Set());\n    }\n    cacheKeys.forEach(key => this.invalidationHooks.get(dataType)!.add(key));\n  }\n\n  // Register invalidation tags for semantic invalidation\n  registerInvalidationTags(cacheKey: string, tags: string[]) {\n    this.invalidationTags.set(cacheKey, tags);\n  }\n\n  // Invalidate cache when data changes\n  async invalidateCache(dataType: string, entityId?: string) {\n    const keysToInvalidate = this.invalidationHooks.get(dataType) || new Set();\n    \n    for (const cacheKey of keysToInvalidate) {\n      if (entityId && cacheKey.includes('*')) {\n        // Replace wildcards with actual entity ID\n        const specificKey = cacheKey.replace('*', entityId);\n        await this.clearSpecificCache(specificKey);\n      } else if (!entityId) {\n        await this.clearSpecificCache(cacheKey);\n      }\n    }\n\n    // Also invalidate by tags\n    await this.invalidateByTags(dataType);\n  }\n\n  // Invalidate cache by semantic tags\n  async invalidateByTags(tags: string | string[]) {\n    const tagArray = Array.isArray(tags) ? tags : [tags];\n    \n    try {\n      const { data, error } = await supabase.rpc('invalidate_cache_by_tags', {\n        tags_to_invalidate: tagArray\n      });\n\n      if (error) {\n        console.error('Cache invalidation by tags failed:', error);\n        return 0;\n      }\n\n      console.log(`Cache invalidated by tags ${tagArray.join(', ')}: ${data} entries removed`);\n      return data;\n    } catch (error) {\n      console.error('Cache invalidation by tags error:', error);\n      return 0;\n    }\n  }\n\n  // Clear specific cache entry\n  private async clearSpecificCache(cacheKey: string) {\n    try {\n      const { error } = await supabase.rpc('clear_cached_query', { \n        cache_key: cacheKey \n      });\n\n      if (error) {\n        console.error(`Cache invalidation failed for ${cacheKey}:`, error);\n      } else {\n        console.log(`Cache invalidated: ${cacheKey}`);\n      }\n    } catch (error) {\n      console.error(`Cache invalidation error for ${cacheKey}:`, error);\n    }\n  }\n\n  // Bulk invalidate multiple cache keys\n  async bulkInvalidate(cacheKeys: string[]) {\n    const results = await Promise.allSettled(\n      cacheKeys.map(key => this.clearSpecificCache(key))\n    );\n\n    const successCount = results.filter(r => r.status === 'fulfilled').length;\n    const failureCount = results.length - successCount;\n\n    console.log(`Bulk cache invalidation: ${successCount} successful, ${failureCount} failed`);\n    \n    return { successCount, failureCount };\n  }\n\n  // Get cache statistics\n  async getCacheStats() {\n    try {\n      const { data: cacheData, error: cacheError } = await supabase\n        .from('query_cache')\n        .select('*', { count: 'exact', head: true });\n\n      if (cacheError) {\n        console.error('Failed to get cache stats:', cacheError);\n        return null;\n      }\n\n      const { data: performanceData, error: perfError } = await supabase\n        .from('performance_metrics')\n        .select('cache_hit, response_time_ms')\n        .gte('created_at', new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString());\n\n      if (perfError) {\n        console.error('Failed to get performance stats:', perfError);\n        return null;\n      }\n\n      const totalRequests = performanceData?.length || 0;\n      const cacheHits = performanceData?.filter(m => m.cache_hit).length || 0;\n      const cacheHitRate = totalRequests > 0 ? (cacheHits / totalRequests) * 100 : 0;\n\n      return {\n        totalCacheEntries: cacheData?.length || 0,\n        cacheHitRate: Math.round(cacheHitRate * 100) / 100,\n        totalRequests24h: totalRequests,\n        cacheHits24h: cacheHits\n      };\n    } catch (error) {\n      console.error('Failed to get cache statistics:', error);\n      return null;\n    }\n  }\n\n  // Clear all cache (use with caution)\n  async clearAllCache() {\n    try {\n      const { data, error } = await supabase.rpc('clear_all_cache');\n      \n      if (error) {\n        console.error('Failed to clear all cache:', error);\n        return false;\n      }\n\n      console.log(`All cache cleared: ${data} entries removed`);\n      return true;\n    } catch (error) {\n      console.error('Failed to clear all cache:', error);\n      return false;\n    }\n  }\n\n  // Warm up cache with common queries\n  async warmUpCache() {\n    const commonQueries = [\n      { query: 'plumber', lat: 40.7128, lon: -74.0060, radius: 20 },\n      { query: 'electrician', lat: 34.0522, lon: -118.2437, radius: 20 },\n      { query: 'cleaning', lat: 41.8781, lon: -87.6298, radius: 20 },\n      { query: 'landscaping', lat: 29.7604, lon: -95.3698, radius: 20 }\n    ];\n\n    console.log('Warming up cache with common queries...');\n\n    for (const query of commonQueries) {\n      try {\n        const response = await fetch(`/api/search/providers/optimized?${new URLSearchParams({\n          query: query.query,\n          userLat: query.lat.toString(),\n          userLon: query.lon.toString(),\n          maxTravelDistance: query.radius.toString(),\n          limit: '20'\n        })}`);\n\n        if (response.ok) {\n          console.log(`Cache warmed for query: ${query.query}`);\n        }\n      } catch (error) {\n        console.error(`Failed to warm cache for query ${query.query}:`, error);\n      }\n    }\n\n    console.log('Cache warm-up completed');\n  }\n}\n\n// Export singleton instance\nexport const cacheManager = CacheInvalidationManager.getInstance();\n\n// Helper functions for common invalidation scenarios\nexport async function invalidateVendorCache(vendorId: string) {\n  return cacheManager.invalidateCache('vendor_profiles', vendorId);\n}\n\nexport async function invalidateSpecialtyCache(specialtyId: string) {\n  return cacheManager.invalidateCache('specialties', specialtyId);\n}\n\nexport async function invalidateLocationCache(locationId: string) {\n  return cacheManager.invalidateCache('vendor_locations', locationId);\n}\n\nexport async function invalidateServiceCache(serviceId: string) {\n  return cacheManager.invalidateCache('vendor_services', serviceId);\n}\n\nexport async function invalidateReviewCache(reviewId: string) {\n  return cacheManager.invalidateCache('reviews', reviewId);\n}\n\nexport async function invalidateAnalyticsCache() {\n  return cacheManager.invalidateByTags(['analytics', 'cache']);\n}\n\n// Middleware for automatic cache invalidation\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nexport function withCacheInvalidation<T extends (...args: any[]) => any>(\n  handler: T,\n  dataType: string\n): T {\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  return (async (...args: any[]) => {\n    const result = await handler(...args);\n    \n    // Invalidate related cache after successful operation\n    try {\n      await cacheManager.invalidateCache(dataType);\n    } catch (error) {\n      console.error('Cache invalidation failed:', error);\n      // Don't fail the main operation if cache invalidation fails\n    }\n    \n    return result;\n  }) as T;\n}\n\n// Enhanced cache invalidation worker for processing the queue\nexport async function processCacheInvalidationQueue() {\n  try {\n    const { data, error } = await supabase.rpc('drain_cache_invalidation_queue', {\n      _batch_size: 500,\n      _since_minutes: 60\n    })\n    \n    if (error) {\n      console.error('Failed to process cache invalidation queue:', error)\n      return null\n    }\n    \n    if (data) {\n      console.log('Cache invalidation queue processed:', data)\n      return data\n    }\n    \n    return null\n  } catch (error) {\n    console.error('Cache invalidation queue processing failed:', error)\n    return null\n  }\n}\n\n// Function to clean up old queue entries\nexport async function cleanCacheInvalidationQueue(daysToKeep: number = 7) {\n  try {\n    const { data, error } = await supabase.rpc('clean_cache_invalidation_queue', {\n      _days_to_keep: daysToKeep\n    })\n    \n    if (error) {\n      console.error('Failed to clean cache invalidation queue:', error)\n      return null\n    }\n    \n    console.log('Cache invalidation queue cleaned:', data, 'entries removed')\n    return data\n  } catch (error) {\n    console.error('Cache invalidation queue cleanup failed:', error)\n    return null\n  }\n}\n\n// Enhanced cache invalidation with backpressure handling\nexport async function invalidateCacheWithBackpressure(\n  tags: string[],\n  maxRetries: number = 3,\n  baseDelay: number = 1000\n) {\n  for (let attempt = 1; attempt <= maxRetries; attempt++) {\n    try {\n      await cacheManager.invalidateByTags(tags)\n      return true\n    } catch (error) {\n      if (attempt === maxRetries) {\n        console.error('Cache invalidation failed after all retries:', error)\n        throw error\n      }\n      \n      const delay = baseDelay * Math.pow(2, attempt - 1) // Exponential backoff\n      console.warn(`Cache invalidation attempt ${attempt} failed, retrying in ${delay}ms:`, error)\n      await new Promise(resolve => setTimeout(resolve, delay))\n    }\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\lib\\cli\\bookingRollback.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'createClient' is defined but never used. Allowed unused vars must match /^_/u.","line":1,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":1,"endColumn":22}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createClient } from '@supabase/supabase-js'\n\nimport { supabaseAdmin as supabase } from '@/lib/supabaseProxies';\n\ninterface RollbackOptions {\n  bookingId: string\n  targetState?: 'quoted' | 'hold_placed' | 'provider_confirmed' | 'receipt_issued'\n  reason?: string\n  dryRun?: boolean\n}\n\ninterface RollbackResult {\n  success: boolean\n  booking_id: string\n  from_state: string\n  to_state: string\n  rollback_time: string\n  audit_entries_created: number\n  errors?: string[]\n}\n\nexport class BookingRollbackCLI {\n  /**\n   * Rollback a booking to a previous state\n   */\n  static async rollback(options: RollbackOptions): Promise<RollbackResult> {\n    const { bookingId, targetState = 'quoted', reason = 'CLI_ROLLBACK', dryRun = false } = options\n\n    try {\n      console.log(`ðŸ”„ Starting rollback for booking ${bookingId} to state: ${targetState}`)\n      if (dryRun) console.log('ðŸ§ª DRY RUN MODE - No changes will be made')\n\n      // Get current booking state\n      const { data: booking, error: bookingError } = await supabase\n        .from('bookings')\n        .select('*')\n        .eq('id', bookingId)\n        .single()\n\n      if (bookingError || !booking) {\n        throw new Error(`Booking not found: ${bookingId}`)\n      }\n\n      const fromState = booking.state\n      console.log(`ðŸ“Š Current state: ${fromState}`)\n\n      // Validate rollback is possible\n      if (!this.canRollback(fromState, targetState)) {\n        throw new Error(`Cannot rollback from ${fromState} to ${targetState}`)\n      }\n\n      // Get audit trail\n      const { data: auditTrail, error: auditError } = await supabase\n        .from('booking_audit_log')\n        .select('*')\n        .eq('booking_id', bookingId)\n        .order('created_at', { ascending: true })\n\n      if (auditError) {\n        throw new Error(`Failed to fetch audit trail: ${auditError.message}`)\n      }\n\n      console.log(`ðŸ“ Found ${auditTrail?.length || 0} audit entries`)\n\n      if (dryRun) {\n        console.log('ðŸ§ª DRY RUN: Would rollback to', targetState)\n        return {\n          success: true,\n          booking_id: bookingId,\n          from_state: fromState,\n          to_state: targetState,\n          rollback_time: new Date().toISOString(),\n          audit_entries_created: 0\n        }\n      }\n\n      // Start transaction\n      const { error: updateError } = await supabase\n        .from('bookings')\n        .update({\n          state: targetState,\n          updated_at: new Date().toISOString(),\n          // Clear fields based on target state\n          ...(targetState === 'quoted' && {\n            stripe_payment_intent_id: null,\n            confirmed_at: null,\n            cancelled_at: null,\n            cancelled_reason: null,\n            refunded_at: null,\n            receipt_url: null\n          }),\n          ...(targetState === 'hold_placed' && {\n            confirmed_at: null,\n            cancelled_at: null,\n            cancelled_reason: null,\n            refunded_at: null,\n            receipt_url: null\n          }),\n          ...(targetState === 'provider_confirmed' && {\n            cancelled_at: null,\n            cancelled_reason: null,\n            refunded_at: null,\n            receipt_url: null\n          })\n        })\n        .eq('id', bookingId)\n\n      if (updateError) {\n        throw new Error(`Failed to update booking state: ${updateError.message}`)\n      }\n\n      // Log the rollback action\n      const { error: auditError2 } = await supabase\n        .from('booking_audit_log')\n        .insert({\n          booking_id: bookingId,\n          from_state: fromState,\n          to_state: targetState,\n          action: 'rollback',\n          actor_type: 'admin',\n          actor_id: 'cli_rollback',\n          metadata: {\n            reason,\n            rollback_time: new Date().toISOString(),\n            original_state: fromState,\n            target_state: targetState,\n            audit_trail_count: auditTrail?.length || 0\n          }\n        })\n\n      if (auditError2) {\n        console.warn(`âš ï¸ Warning: Failed to log rollback audit entry: ${auditError2.message}`)\n      }\n\n      console.log(`âœ… Successfully rolled back booking ${bookingId} from ${fromState} to ${targetState}`)\n\n      return {\n        success: true,\n        booking_id: bookingId,\n        from_state: fromState,\n        to_state: targetState,\n        rollback_time: new Date().toISOString(),\n        audit_entries_created: 1\n      }\n\n    } catch (error) {\n      console.error(`âŒ Rollback failed: ${error instanceof Error ? error.message : 'Unknown error'}`)\n      \n      return {\n        success: false,\n        booking_id: bookingId,\n        from_state: 'unknown',\n        to_state: targetState,\n        rollback_time: new Date().toISOString(),\n        audit_entries_created: 0,\n        errors: [error instanceof Error ? error.message : 'Unknown error']\n      }\n    }\n  }\n\n  /**\n   * Check if rollback is possible between states\n   */\n  private static canRollback(fromState: string, toState: string): boolean {\n    const stateOrder = ['quoted', 'hold_placed', 'provider_confirmed', 'receipt_issued']\n    \n    const fromIndex = stateOrder.indexOf(fromState)\n    const toIndex = stateOrder.indexOf(toState)\n    \n    if (fromIndex === -1 || toIndex === -1) {\n      return false // Invalid states\n    }\n    \n    // Can only rollback to earlier states\n    return toIndex <= fromIndex\n  }\n\n  /**\n   * Get rollback history for a booking\n   */\n  static async getRollbackHistory(bookingId: string) {\n    try {\n      const { data: auditEntries, error } = await supabase\n        .from('booking_audit_log')\n        .select('*')\n        .eq('booking_id', bookingId)\n        .eq('action', 'rollback')\n        .order('created_at', { ascending: false })\n\n      if (error) {\n        throw new Error(`Failed to fetch rollback history: ${error.message}`)\n      }\n\n      return auditEntries || []\n    } catch (error) {\n      console.error(`Failed to get rollback history: ${error instanceof Error ? error.message : 'Unknown error'}`)\n      return []\n    }\n  }\n\n  /**\n   * Validate a booking ID format\n   */\n  static isValidBookingId(bookingId: string): boolean {\n    // UUID v4 format\n    const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i\n    return uuidRegex.test(bookingId)\n  }\n}\n\n// CLI interface for direct usage\nexport async function cliRollback(args: string[]): Promise<void> {\n  if (args.length < 1) {\n    console.log('Usage: bkctl rollback <booking_id> [target_state] [--reason=\"reason\"] [--dry-run]')\n    console.log('Example: bkctl rollback 123e4567-e89b-12d3-a456-426614174000 quoted --reason=\"Testing rollback\"')\n    return\n  }\n\n  const bookingId = args[0]\n  const targetState = (args[1] as 'quoted' | 'hold_placed' | 'provider_confirmed' | 'receipt_issued') || 'quoted'\n  const reason = args.find(arg => arg.startsWith('--reason='))?.split('=')[1] || 'CLI_ROLLBACK'\n  const dryRun = args.includes('--dry-run')\n\n  if (!BookingRollbackCLI.isValidBookingId(bookingId)) {\n    console.error('âŒ Invalid booking ID format. Expected UUID v4.')\n    return\n  }\n\n  console.log(`ðŸš€ Starting rollback operation...`)\n  console.log(`ðŸ“‹ Booking ID: ${bookingId}`)\n  console.log(`ðŸŽ¯ Target State: ${targetState}`)\n  console.log(`ðŸ“ Reason: ${reason}`)\n  if (dryRun) console.log('ðŸ§ª Mode: DRY RUN')\n\n  const startTime = Date.now()\n  const result = await BookingRollbackCLI.rollback({\n    bookingId,\n    targetState,\n    reason,\n    dryRun\n  })\n\n  const duration = Date.now() - startTime\n\n  if (result.success) {\n    console.log(`âœ… Rollback completed in ${duration}ms`)\n    console.log(`ðŸ“Š Result: ${result.from_state} â†’ ${result.to_state}`)\n    console.log(`ðŸ“ Audit entries created: ${result.audit_entries_created}`)\n  } else {\n    console.error(`âŒ Rollback failed after ${duration}ms`)\n    if (result.errors) {\n      result.errors.forEach(error => console.error(`   - ${error}`))\n    }\n  }\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\lib\\kb\\provider.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'MockKbProvider' is defined but never used. Allowed unused vars must match /^_/u.","line":1,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":1,"endColumn":24}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { MockKbProvider } from './provider.mock';\r\nimport { createPgVectorProvider } from './provider.pgvector';\r\n\r\n// Easy provider switching - just change this line!\r\n// export const Kb = MockKbProvider;           // â† Mock provider (current)\r\nexport const Kb = createPgVectorProvider();    // â† pgvector provider (future)\r\n\r\n// Or use environment variable for dynamic switching:\r\n// export const Kb = process.env.KB_PROVIDER === 'pgvector' \r\n//   ? createPgVectorProvider() \r\n//   : MockKbProvider;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\lib\\reviewMonitoring.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'createClient' is defined but never used. Allowed unused vars must match /^_/u.","line":1,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":1,"endColumn":22}],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":20,"column":28,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":20,"endColumn":31,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[675,678],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[675,678],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":39,"column":24,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":39,"endColumn":27,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1206,1209],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1206,1209],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":67,"column":30,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":67,"endColumn":33,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1988,1991],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1988,1991],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":524,"column":29,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":524,"endColumn":32,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[16368,16371],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[16368,16371],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":528,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":528,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[16528,16531],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[16528,16531],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createClient } from '@supabase/supabase-js'\nimport { aiModeration, ModerationResult, ReviewData } from './aiModeration'\n\n// Initialize Supabase client\nimport { supabaseAdmin as supabase } from '@/lib/supabaseProxies';\n\nexport interface ModerationAuditLog {\n  id: string\n  review_id: string\n  moderator_id?: string\n  action: 'auto_flag' | 'manual_review' | 'approve' | 'reject' | 'flag' | 'remove'\n  reason: string\n  confidence_score: number\n  ai_categories: string[]\n  keyword_matches: string[]\n  behavioral_flags: string[]\n  processing_time_ms: number\n  created_at: string\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  metadata: Record<string, any>\n}\n\nexport interface ModerationMetrics {\n  total_reviews: number\n  flagged_reviews: number\n  auto_flagged: number\n  manual_reviews: number\n  false_positives: number\n  false_negatives: number\n  average_processing_time: number\n  ai_accuracy: number\n  category_distribution: Record<string, number>\n}\n\nexport interface ReviewModerationEvent {\n  type: 'review_submitted' | 'auto_flagged' | 'manual_review' | 'decision_made'\n  review_id: string\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  data: Record<string, any>\n  timestamp: string\n}\n\nexport class ReviewMonitoringService {\n  private static instance: ReviewMonitoringService\n\n  static getInstance(): ReviewMonitoringService {\n    if (!ReviewMonitoringService.instance) {\n      ReviewMonitoringService.instance = new ReviewMonitoringService()\n    }\n    return ReviewMonitoringService.instance\n  }\n\n  /**\n   * Log moderation decision for audit trail\n   */\n  async logModerationDecision(\n    reviewId: string,\n    action: ModerationAuditLog['action'],\n    reason: string,\n    confidenceScore: number,\n    aiCategories: string[],\n    keywordMatches: string[],\n    behavioralFlags: string[],\n    processingTimeMs: number,\n    moderatorId?: string,\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    metadata: Record<string, any> = {}\n  ): Promise<void> {\n    try {\n      const auditLog: Omit<ModerationAuditLog, 'id' | 'created_at'> = {\n        review_id: reviewId,\n        moderator_id: moderatorId,\n        action,\n        reason,\n        confidence_score: confidenceScore,\n        ai_categories: aiCategories,\n        keyword_matches: keywordMatches,\n        behavioral_flags: behavioralFlags,\n        processing_time_ms: processingTimeMs,\n        metadata\n      }\n\n      const { error } = await supabase\n        .from('review_moderation_log')\n        .insert(auditLog)\n\n      if (error) {\n        console.error('Failed to log moderation decision:', error)\n        // Fallback to console logging\n        console.log('Moderation Audit Log:', auditLog)\n      }\n    } catch (error) {\n      console.error('Error logging moderation decision:', error)\n    }\n  }\n\n  /**\n   * Process review with comprehensive monitoring\n   */\n  async processReviewWithMonitoring(\n    reviewData: ReviewData,\n    reviewId: string\n  ): Promise<ModerationResult> {\n    const startTime = Date.now()\n    \n    try {\n      // Get reviewer history for behavioral analysis\n      const reviewerHistory = await this.getReviewerHistory(reviewData.reviewerId)\n      \n      // Enhanced review data with history\n      const enhancedReviewData: ReviewData = {\n        ...reviewData,\n        reviewerHistory\n      }\n\n      // Run AI moderation\n      const moderationResult = await aiModeration.moderateReview(enhancedReviewData)\n      \n      const processingTime = Date.now() - startTime\n\n      // Extract categories and flags for logging\n      const aiCategories = Object.keys(moderationResult.categories).filter(\n        key => moderationResult.categories[key as keyof typeof moderationResult.categories]\n      )\n\n      const keywordMatches = moderationResult.reasons.filter(\n        reason => reason.includes('pattern:') || reason.includes('Detected')\n      )\n\n      const behavioralFlags = moderationResult.reasons.filter(\n        reason => reason.includes('Excessive') || reason.includes('All') || reason.includes('Suspicious')\n      )\n\n      // Log the moderation decision\n      await this.logModerationDecision(\n        reviewId,\n        moderationResult.isFlagged ? 'auto_flag' : 'approve',\n        moderationResult.reasons.join('; '),\n        moderationResult.confidence,\n        aiCategories,\n        keywordMatches,\n        behavioralFlags,\n        processingTime,\n        undefined, // Auto-moderation\n        {\n          original_rating: reviewData.rating,\n          text_length: reviewData.text.length,\n          reviewer_total_reviews: reviewerHistory.totalReviews,\n          reviewer_avg_rating: reviewerHistory.avgRating\n        }\n      )\n\n      // Emit monitoring event\n      this.emitModerationEvent({\n        type: moderationResult.isFlagged ? 'auto_flagged' : 'review_submitted',\n        review_id: reviewId,\n        data: {\n          confidence: moderationResult.confidence,\n          categories: aiCategories,\n          processing_time: processingTime,\n          suggested_action: moderationResult.suggestedAction\n        },\n        timestamp: new Date().toISOString()\n      })\n\n      return moderationResult\n    } catch (error) {\n      const processingTime = Date.now() - startTime\n      \n      // Log error for monitoring\n      await this.logModerationDecision(\n        reviewId,\n        'manual_review',\n        `Moderation failed: ${error instanceof Error ? error.message : 'Unknown error'}`,\n        0,\n        [],\n        [],\n        [],\n        processingTime,\n        undefined,\n        { error: true, error_message: error instanceof Error ? error.message : 'Unknown error' }\n      )\n\n      // Emit error event\n      this.emitModerationEvent({\n        type: 'manual_review',\n        review_id: reviewId,\n        data: {\n          error: true,\n          error_message: error instanceof Error ? error.message : 'Unknown error',\n          processing_time: processingTime\n        },\n        timestamp: new Date().toISOString()\n      })\n\n      // Return fallback result\n      return {\n        isFlagged: false,\n        confidence: 0,\n        categories: {\n          spam: false,\n          inappropriate: false,\n          fake: false,\n          harassment: false,\n          other: false\n        },\n        reasons: ['Moderation failed, manual review required'],\n        suggestedAction: 'review',\n        score: 0\n      }\n    }\n  }\n\n  /**\n   * Get reviewer history for behavioral analysis\n   */\n  private async getReviewerHistory(reviewerId: string) {\n    try {\n      const { data: reviews, error } = await supabase\n        .from('reviews')\n        .select('rating, created_at, comment')\n        .eq('reviewer_id', reviewerId)\n        .order('created_at', { ascending: false })\n\n      if (error) {\n        console.warn('Failed to fetch reviewer history:', error)\n        return {\n          totalReviews: 0,\n          avgRating: 0,\n          recentReviews: 0,\n          suspiciousPatterns: []\n        }\n      }\n\n      const totalReviews = reviews?.length || 0\n      const avgRating = reviews && reviews.length > 0 \n        ? reviews.reduce((sum, r) => sum + (r.rating || 0), 0) / reviews.length \n        : 0\n\n      // Count recent reviews (last 30 days)\n      const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000)\n      const recentReviews = reviews?.filter(r => new Date(r.created_at) > thirtyDaysAgo).length || 0\n\n      // Detect suspicious patterns\n      const suspiciousPatterns: string[] = []\n      \n      if (reviews && reviews.length > 0) {\n        // All same rating\n        const allSameRating = reviews.every(r => r.rating === reviews[0].rating)\n        if (allSameRating && reviews.length > 3) {\n          suspiciousPatterns.push(`All ${reviews[0].rating}-star reviews`)\n        }\n\n        // Very short reviews\n        const shortReviews = reviews.filter(r => r.comment && r.comment.length < 10).length\n        if (shortReviews > reviews.length * 0.5) {\n          suspiciousPatterns.push('High percentage of very short reviews')\n        }\n\n        // Rapid posting\n        if (recentReviews > 10) {\n          suspiciousPatterns.push('Excessive recent review activity')\n        }\n      }\n\n      return {\n        totalReviews,\n        avgRating,\n        recentReviews,\n        suspiciousPatterns\n      }\n    } catch (error) {\n      console.warn('Error fetching reviewer history:', error)\n      return {\n        totalReviews: 0,\n        avgRating: 0,\n        recentReviews: 0,\n        suspiciousPatterns: []\n      }\n    }\n  }\n\n  /**\n   * Get moderation metrics for dashboard\n   */\n  async getModerationMetrics(timeRange: '24h' | '7d' | '30d' = '7d'): Promise<ModerationMetrics> {\n    try {\n      const startDate = new Date()\n      switch (timeRange) {\n        case '24h':\n          startDate.setDate(startDate.getDate() - 1)\n          break\n        case '7d':\n          startDate.setDate(startDate.getDate() - 7)\n          break\n        case '30d':\n          startDate.setDate(startDate.getDate() - 30)\n          break\n      }\n\n      // Get review counts\n      const { count: totalReviews } = await supabase\n        .from('reviews')\n        .select('*', { count: 'exact', head: true })\n        .gte('created_at', startDate.toISOString())\n\n      const { count: flaggedReviews } = await supabase\n        .from('reviews')\n        .select('*', { count: 'exact', head: true })\n        .gte('created_at', startDate.toISOString())\n        .in('status', ['flagged', 'pending'])\n\n      // Get moderation log data\n      const { data: moderationLogs } = await supabase\n        .from('review_moderation_log')\n        .select('*')\n        .gte('created_at', startDate.toISOString())\n\n      // Calculate metrics\n      const autoFlagged = moderationLogs?.filter(log => log.action === 'auto_flag').length || 0\n      const manualReviews = moderationLogs?.filter(log => log.action === 'manual_review').length || 0\n      \n      const averageProcessingTime = moderationLogs && moderationLogs.length > 0\n        ? moderationLogs.reduce((sum, log) => sum + log.processing_time_ms, 0) / moderationLogs.length\n        : 0\n\n      // Calculate category distribution\n      const categoryDistribution: Record<string, number> = {}\n      moderationLogs?.forEach(log => {\n        log.ai_categories.forEach((category: string) => {\n          categoryDistribution[category] = (categoryDistribution[category] || 0) + 1\n        })\n      })\n\n      // Estimate AI accuracy (this would need manual review data for true accuracy)\n      const aiAccuracy = totalReviews ? ((totalReviews - manualReviews) / totalReviews) * 100 : 0\n\n      return {\n        total_reviews: totalReviews || 0,\n        flagged_reviews: flaggedReviews || 0,\n        auto_flagged: autoFlagged,\n        manual_reviews: manualReviews,\n        false_positives: 0, // Would need manual review data\n        false_negatives: 0, // Would need manual review data\n        average_processing_time: averageProcessingTime,\n        ai_accuracy: aiAccuracy,\n        category_distribution: categoryDistribution\n      }\n    } catch (error) {\n      console.error('Error fetching moderation metrics:', error)\n      return {\n        total_reviews: 0,\n        flagged_reviews: 0,\n        auto_flagged: 0,\n        manual_reviews: 0,\n        false_positives: 0,\n        false_negatives: 0,\n        average_processing_time: 0,\n        ai_accuracy: 0,\n        category_distribution: {}\n      }\n    }\n  }\n\n  /**\n   * Get moderation audit trail\n   */\n  async getModerationAuditTrail(\n    reviewId?: string,\n    limit: number = 100,\n    offset: number = 0\n  ): Promise<ModerationAuditLog[]> {\n    try {\n      let query = supabase\n        .from('review_moderation_log')\n        .select('*')\n        .order('created_at', { ascending: false })\n        .range(offset, offset + limit - 1)\n\n      if (reviewId) {\n        query = query.eq('review_id', reviewId)\n      }\n\n      const { data, error } = await query\n\n      if (error) {\n        console.error('Error fetching moderation audit trail:', error)\n        return []\n      }\n\n      return data || []\n    } catch (error) {\n      console.error('Error fetching moderation audit trail:', error)\n      return []\n    }\n  }\n\n  /**\n   * Emit moderation event for real-time monitoring\n   */\n  private emitModerationEvent(event: ReviewModerationEvent): void {\n    try {\n      // In a real implementation, this would emit to a WebSocket or event system\n      // For now, we'll log it and could integrate with your existing event system\n      console.log('Moderation Event:', event)\n      \n      // You could integrate this with:\n      // - WebSocket for real-time admin dashboard updates\n      // - Event streaming for analytics\n      // - Notification system for urgent flags\n      // - Metrics aggregation service\n    } catch (error) {\n      console.error('Error emitting moderation event:', error)\n    }\n  }\n\n  /**\n   * Generate moderation report\n   */\n  async generateModerationReport(\n    startDate: Date,\n    endDate: Date\n  ): Promise<{\n    summary: ModerationMetrics\n    trends: Array<{ date: string; metrics: Partial<ModerationMetrics> }>\n    topIssues: Array<{ category: string; count: number; examples: string[] }>\n    recommendations: string[]\n  }> {\n    try {\n      const summary = await this.getModerationMetrics('30d')\n      \n      // Generate daily trends (simplified - in production you'd want more sophisticated aggregation)\n      const trends: Array<{ date: string; metrics: Partial<ModerationMetrics> }> = []\n      const currentDate = new Date(startDate)\n      \n      while (currentDate <= endDate) {\n        const dayMetrics = await this.getModerationMetrics('24h')\n        trends.push({\n          date: currentDate.toISOString().split('T')[0],\n          metrics: {\n            total_reviews: dayMetrics.total_reviews,\n            flagged_reviews: dayMetrics.flagged_reviews,\n            auto_flagged: dayMetrics.auto_flagged\n          }\n        })\n        currentDate.setDate(currentDate.getDate() + 1)\n      }\n\n      // Analyze top issues\n      const { data: recentLogs } = await supabase\n        .from('review_moderation_log')\n        .select('ai_categories, keyword_matches, behavioral_flags')\n        .gte('created_at', startDate.toISOString())\n        .lte('created_at', endDate.toISOString())\n\n      const issueCounts: Record<string, number> = {}\n      const issueExamples: Record<string, string[]> = {}\n\n      recentLogs?.forEach(log => {\n        const allIssues = [\n          ...log.ai_categories,\n          ...log.keyword_matches,\n          ...log.behavioral_flags\n        ]\n\n        allIssues.forEach((issue: string) => {\n          issueCounts[issue] = (issueCounts[issue] || 0) + 1\n          if (!issueExamples[issue]) {\n            issueExamples[issue] = []\n          }\n          if (issueExamples[issue].length < 3) {\n            issueExamples[issue].push(issue)\n          }\n        })\n      })\n\n      const topIssues = Object.entries(issueCounts)\n        .sort(([, a], [, b]) => b - a)\n        .slice(0, 10)\n        .map(([category, count]) => ({\n          category,\n          count,\n          examples: issueExamples[category] || []\n        }))\n\n      // Generate recommendations\n      const recommendations: string[] = []\n      \n      if (summary.ai_accuracy < 80) {\n        recommendations.push('Consider retraining AI models or adjusting confidence thresholds')\n      }\n      \n      if (summary.average_processing_time > 5000) {\n        recommendations.push('Review moderation pipeline performance and optimize processing')\n      }\n      \n      if (summary.flagged_reviews > summary.total_reviews * 0.3) {\n        recommendations.push('High flag rate detected - review moderation criteria and thresholds')\n      }\n\n      if (topIssues.some(issue => issue.category.includes('financial') || issue.category.includes('spam'))) {\n        recommendations.push('Increase monitoring for financial spam and promotional content')\n      }\n\n      return {\n        summary,\n        trends,\n        topIssues,\n        recommendations\n      }\n    } catch (error) {\n      console.error('Error generating moderation report:', error)\n      throw error\n    }\n  }\n\n  /**\n   * Health check for monitoring system\n   */\n  async healthCheck(): Promise<{\n    status: 'healthy' | 'degraded' | 'unhealthy'\n    checks: Record<string, boolean>\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    details: Record<string, any>\n  }> {\n    const checks: Record<string, boolean> = {}\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    const details: Record<string, any> = {}\n\n    try {\n      // Check database connectivity\n      const { data: dbCheck } = await supabase\n        .from('review_moderation_log')\n        .select('count', { count: 'exact', head: true })\n        .limit(1)\n      \n      checks.database = !!dbCheck\n      details.database = { connected: !!dbCheck }\n\n      // Check AI moderation service\n      const aiStats = aiModeration.getModerationStats()\n      checks.aiService = aiStats.enabled\n      details.aiService = aiStats\n\n      // Check recent processing\n      const { data: recentLogs } = await supabase\n        .from('review_moderation_log')\n        .select('created_at')\n        .gte('created_at', new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString())\n        .limit(1)\n\n      checks.recentActivity = !!recentLogs && recentLogs.length > 0\n      details.recentActivity = { \n        hasRecentLogs: !!recentLogs && recentLogs.length > 0,\n        lastLogTime: recentLogs?.[0]?.created_at \n      }\n\n      // Determine overall status\n      const allChecksPassed = Object.values(checks).every(check => check)\n      const status: 'healthy' | 'degraded' | 'unhealthy' = allChecksPassed \n        ? 'healthy' \n        : checks.database \n          ? 'degraded' \n          : 'unhealthy'\n\n      return { status, checks, details }\n    } catch (error) {\n      console.error('Health check failed:', error)\n      return {\n        status: 'unhealthy',\n        checks: { database: false, aiService: false, recentActivity: false },\n        details: { error: error instanceof Error ? error.message : 'Unknown error' }\n      }\n    }\n  }\n}\n\n// Export singleton instance\nexport const reviewMonitoring = ReviewMonitoringService.getInstance()\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\lib\\services\\bookingWorker.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'createClient' is defined but never used. Allowed unused vars must match /^_/u.","line":1,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":1,"endColumn":22}],"suppressedMessages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":106,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":106,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2852,2855],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2852,2855],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":165,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":165,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5140,5143],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5140,5143],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":165,"column":53,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":165,"endColumn":56,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5152,5155],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5152,5155],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":210,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":210,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6481,6484],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6481,6484],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":210,"column":56,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":210,"endColumn":59,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6493,6496],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6493,6496],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}],"suppressions":[{"kind":"directive","justification":""}]}],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createClient } from '@supabase/supabase-js'\nimport { featureFlags } from '@/config/featureFlags'\n\nimport { supabaseAdmin as supabase } from '@/lib/supabaseProxies';\n\ninterface BookingWorkerConfig {\n  pollIntervalMs: number\n  maxRetries: number\n  timeoutMinutes: number\n}\n\nexport class BookingWorker {\n  private static instance: BookingWorker\n  private pollInterval?: NodeJS.Timeout\n  private isRunning = false\n  private config: BookingWorkerConfig\n\n  private constructor() {\n    this.config = {\n      pollIntervalMs: 30 * 1000, // 30 seconds\n      maxRetries: 3,\n      timeoutMinutes: featureFlags.provider.confirmation_timeout_minutes\n    }\n  }\n\n  static getInstance(): BookingWorker {\n    if (!BookingWorker.instance) {\n      BookingWorker.instance = new BookingWorker()\n    }\n    return BookingWorker.instance\n  }\n\n  /**\n   * Start the booking worker\n   */\n  start(): void {\n    if (this.isRunning) {\n      console.log('Booking worker already running')\n      return\n    }\n\n    this.isRunning = true\n    this.pollInterval = setInterval(() => {\n      this.processPendingBookings()\n    }, this.config.pollIntervalMs)\n\n    console.log(`Booking worker started - polling every ${this.config.pollIntervalMs}ms`)\n  }\n\n  /**\n   * Stop the booking worker\n   */\n  stop(): void {\n    if (this.pollInterval) {\n      clearInterval(this.pollInterval)\n      this.pollInterval = undefined\n    }\n    this.isRunning = false\n    console.log('Booking worker stopped')\n  }\n\n  /**\n   * Process pending bookings from the outbox\n   */\n  private async processPendingBookings(): Promise<void> {\n    try {\n      // Get pending hold_created events\n      const { data: pendingEvents, error } = await supabase\n        .from('payments_outbox')\n        .select('*')\n        .eq('event_type', 'hold_created')\n        .eq('status', 'pending')\n        .lte('retry_count', this.config.maxRetries)\n        .order('created_at', { ascending: true })\n        .limit(10) // Process in batches\n\n      if (error) {\n        console.error('Failed to fetch pending events:', error)\n        return\n      }\n\n      if (!pendingEvents || pendingEvents.length === 0) {\n        return // No pending events\n      }\n\n      console.log(`Processing ${pendingEvents.length} pending booking events`)\n\n      for (const event of pendingEvents) {\n        try {\n          await this.processBookingEvent(event)\n        } catch (eventError) {\n          console.error(`Failed to process event ${event.id}:`, eventError)\n          await this.markEventFailed(event.id, eventError instanceof Error ? eventError.message : 'Unknown error')\n        }\n      }\n\n    } catch (error) {\n      console.error('Error in processPendingBookings:', error)\n    }\n  }\n\n  /**\n   * Process a single booking event\n   */\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  private async processBookingEvent(event: any): Promise<void> {\n    const { booking_id, provider_id } = event.event_data\n\n    // Check if booking still exists and is in hold_placed state\n    const { data: booking, error: bookingError } = await supabase\n      .from('bookings')\n      .select('*')\n      .eq('id', booking_id)\n      .eq('state', 'hold_placed')\n      .single()\n\n    if (bookingError || !booking) {\n      console.log(`Booking ${booking_id} not found or not in hold_placed state, marking event as processed`)\n      await this.markEventProcessed(event.id)\n      return\n    }\n\n    // Check if we've exceeded the timeout\n    const timeSinceHold = Date.now() - new Date(booking.created_at).getTime()\n    const timeoutMs = this.config.timeoutMinutes * 60 * 1000\n\n    if (timeSinceHold > timeoutMs) {\n      console.log(`Booking ${booking_id} exceeded ${this.config.timeoutMinutes}min timeout, auto-cancelling`)\n      await this.autoCancelBooking(booking, event)\n      await this.markEventProcessed(event.id)\n      return\n    }\n\n    // Simulate provider confirmation (in real implementation, this would call provider APIs)\n    const shouldConfirm = await this.simulateProviderConfirmation(provider_id, booking_id)\n    \n    if (shouldConfirm) {\n      console.log(`Provider ${provider_id} confirmed booking ${booking_id}`)\n      await this.confirmBooking(booking, event)\n      await this.markEventProcessed(event.id)\n    } else {\n      // Provider hasn't responded yet, increment retry count\n      await this.incrementRetryCount(event.id)\n    }\n  }\n\n  /**\n   * Simulate provider confirmation (replace with real provider API calls)\n   */\n  private async simulateProviderConfirmation(__providerId: string, __bookingId: string): Promise<boolean> {\n    // For now, simulate 80% confirmation rate after 5-10 minutes\n    const timeSinceBooking = Date.now() - new Date().getTime() + 5 * 60 * 1000 // Simulate 5 min delay\n    const randomFactor = Math.random()\n    \n    // Higher chance of confirmation as time passes\n    const confirmationChance = Math.min(0.8, timeSinceBooking / (10 * 60 * 1000) * 0.8)\n    \n    return randomFactor < confirmationChance\n  }\n\n  /**\n   * Confirm a booking (transition to provider_confirmed)\n   */\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  private async confirmBooking(booking: any, event: any): Promise<void> {\n    try {\n      // Update booking state\n      const { error: updateError } = await supabase\n        .from('bookings')\n        .update({\n          state: 'provider_confirmed',\n          confirmed_at: new Date().toISOString()\n        })\n        .eq('id', booking.id)\n\n      if (updateError) {\n        throw new Error(`Failed to update booking state: ${updateError.message}`)\n      }\n\n      // Log the state transition\n      await supabase\n        .from('booking_audit_log')\n        .insert({\n          booking_id: booking.id,\n          from_state: 'hold_placed',\n          to_state: 'provider_confirmed',\n          action: 'state_change',\n          actor_type: 'system',\n          actor_id: 'booking_worker',\n          metadata: {\n            payment_intent: booking.stripe_payment_intent_id,\n            provider_id: booking.provider_id,\n            confirmation_time: new Date().toISOString(),\n            worker_event_id: event.id\n          }\n        })\n\n      console.log(`Booking ${booking.id} confirmed successfully`)\n\n    } catch (error) {\n      console.error(`Failed to confirm booking ${booking.id}:`, error)\n      throw error\n    }\n  }\n\n  /**\n   * Auto-cancel a booking due to timeout\n   */\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  private async autoCancelBooking(booking: any, event: any): Promise<void> {\n    try {\n      // Update booking state\n      const { error: updateError } = await supabase\n        .from('bookings')\n        .update({\n          state: 'cancelled',\n          cancelled_at: new Date().toISOString(),\n          cancelled_reason: 'PROVIDER_TIMEOUT'\n        })\n        .eq('id', booking.id)\n\n      if (updateError) {\n        throw new Error(`Failed to update booking state: ${updateError.message}`)\n      }\n\n      // Log the state transition\n      await supabase\n        .from('booking_audit_log')\n        .insert({\n          booking_id: booking.id,\n          from_state: 'hold_placed',\n          to_state: 'cancelled',\n          action: 'state_change',\n          actor_type: 'system',\n          actor_id: 'booking_worker',\n          metadata: {\n            payment_intent: booking.stripe_payment_intent_id,\n            provider_id: booking.provider_id,\n            cancellation_reason: 'PROVIDER_TIMEOUT',\n            timeout_minutes: this.config.timeoutMinutes,\n            worker_event_id: event.id\n          }\n        })\n\n      // TODO: Implement automatic refund via Stripe\n      console.log(`Booking ${booking.id} auto-cancelled due to provider timeout`)\n\n    } catch (error) {\n      console.error(`Failed to auto-cancel booking ${booking.id}:`, error)\n      throw error\n    }\n  }\n\n  /**\n   * Mark an event as processed\n   */\n  private async markEventProcessed(eventId: string): Promise<void> {\n    await supabase\n      .from('payments_outbox')\n      .update({\n        status: 'processed',\n        processed_at: new Date().toISOString()\n      })\n      .eq('id', eventId)\n  }\n\n  /**\n   * Mark an event as failed\n   */\n  private async markEventFailed(eventId: string, errorMessage: string): Promise<void> {\n    await supabase\n      .from('payments_outbox')\n      .update({\n        status: 'failed',\n        processed_at: new Date().toISOString(),\n        error_message: errorMessage\n      })\n      .eq('id', eventId)\n  }\n\n  /**\n   * Increment retry count for an event\n   */\n  private async incrementRetryCount(eventId: string): Promise<void> {\n    await supabase\n      .from('payments_outbox')\n      .update({\n        retry_count: supabase.rpc('increment', { row_id: eventId, column_name: 'retry_count' })\n      })\n      .eq('id', eventId)\n  }\n\n  /**\n   * Get worker status\n   */\n  getStatus(): { isRunning: boolean; config: BookingWorkerConfig } {\n    return {\n      isRunning: this.isRunning,\n      config: this.config\n    }\n  }\n}\n\n// Export singleton instance\nexport const bookingWorker = BookingWorker.getInstance()\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\lib\\services\\receiptService.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'createClient' is defined but never used. Allowed unused vars must match /^_/u.","line":1,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":1,"endColumn":22}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { createClient } from '@supabase/supabase-js'\n\nimport { supabaseAdmin as supabase } from '@/lib/supabaseProxies';\n\ninterface ReceiptData {\n  booking_id: string\n  customer_name: string\n  provider_name: string\n  service_type: string\n  price_cents: number\n  date_time: string\n  duration_minutes: number\n  receipt_number: string\n}\n\nexport class ReceiptService {\n  private static instance: ReceiptService\n\n  static getInstance(): ReceiptService {\n    if (!ReceiptService.instance) {\n      ReceiptService.instance = new ReceiptService()\n    }\n    return ReceiptService.instance\n  }\n\n  /**\n   * Generate receipt for a confirmed booking\n   */\n  async generateReceipt(bookingId: string): Promise<string> {\n    try {\n      // Get booking details\n      const { data: booking, error: bookingError } = await supabase\n        .from('bookings')\n        .select(`\n          *,\n          customer:profiles!bookings_customer_id_fkey(full_name),\n          provider:profiles!bookings_provider_id_fkey(full_name),\n          quote:quotes(estimated_duration_minutes)\n        `)\n        .eq('id', bookingId)\n        .eq('state', 'provider_confirmed')\n        .single()\n\n      if (bookingError || !booking) {\n        throw new Error(`Booking not found or not confirmed: ${bookingId}`)\n      }\n\n      // Generate receipt number\n      const receiptNumber = this.generateReceiptNumber(bookingId)\n\n      // Create receipt data\n      const receiptData: ReceiptData = {\n        booking_id: booking.id,\n        customer_name: booking.customer?.full_name || 'Unknown Customer',\n        provider_name: booking.provider?.full_name || 'Unknown Provider',\n        service_type: 'General Service', // Would come from service_id in real implementation\n        price_cents: booking.price_cents || 0,\n        date_time: booking.created_at,\n        duration_minutes: booking.quote?.estimated_duration_minutes || 60,\n        receipt_number: receiptNumber\n      }\n\n      // Generate receipt URL (in real implementation, this would create a PDF or HTML receipt)\n      const receiptUrl = this.createReceiptUrl(receiptData)\n\n      // Update booking with receipt URL and transition to receipt_issued\n      const { error: updateError } = await supabase\n        .from('bookings')\n        .update({\n          receipt_url: receiptUrl,\n          state: 'receipt_issued'\n        })\n        .eq('id', bookingId)\n\n      if (updateError) {\n        throw new Error(`Failed to update booking with receipt: ${updateError.message}`)\n      }\n\n      // Log the state transition\n      await supabase\n        .from('booking_audit_log')\n        .insert({\n          booking_id: booking.id,\n          from_state: 'provider_confirmed',\n          to_state: 'receipt_issued',\n          action: 'state_change',\n          actor_type: 'system',\n          actor_id: 'receipt_service',\n          metadata: {\n            receipt_url: receiptUrl,\n            receipt_number: receiptNumber,\n            generated_at: new Date().toISOString()\n          }\n        })\n\n      console.log(`Receipt generated for booking ${bookingId}: ${receiptUrl}`)\n\n      return receiptUrl\n\n    } catch (error) {\n      console.error(`Failed to generate receipt for booking ${bookingId}:`, error)\n      throw error\n    }\n  }\n\n  /**\n   * Generate a unique receipt number\n   */\n  private generateReceiptNumber(bookingId: string): string {\n    const timestamp = Date.now().toString(36)\n    const shortId = bookingId.substring(0, 8)\n    return `RCP-${timestamp}-${shortId}`.toUpperCase()\n  }\n\n  /**\n   * Create receipt URL (placeholder - would generate actual receipt)\n   */\n  private createReceiptUrl(receiptData: ReceiptData): string {\n    // In real implementation, this would:\n    // 1. Generate a PDF receipt\n    // 2. Upload to cloud storage\n    // 3. Return the public URL\n    \n    // For now, return a placeholder URL with receipt data\n    const baseUrl = process.env.NEXT_PUBLIC_APP_URL || 'https://bookiji.com'\n    const encodedData = encodeURIComponent(JSON.stringify(receiptData))\n    \n    return `${baseUrl}/receipt/${receiptData.booking_id}?data=${encodedData}`\n  }\n\n  /**\n   * Get receipt data for a booking\n   */\n  async getReceiptData(bookingId: string): Promise<ReceiptData | null> {\n    try {\n      const { data: booking, error } = await supabase\n        .from('bookings')\n        .select(`\n          *,\n          customer:profiles!bookings_customer_id_fkey(full_name),\n          provider:profiles!bookings_provider_id_fkey(full_name),\n          quote:quotes(estimated_duration_minutes)\n        `)\n        .eq('id', bookingId)\n        .eq('state', 'receipt_issued')\n        .single()\n\n      if (error || !booking) {\n        return null\n      }\n\n      return {\n        booking_id: booking.id,\n        customer_name: booking.customer?.full_name || 'Unknown Customer',\n        provider_name: booking.provider?.full_name || 'Unknown Provider',\n        service_type: 'General Service',\n        price_cents: booking.price_cents || 0,\n        date_time: booking.created_at,\n        duration_minutes: booking.quote?.estimated_duration_minutes || 60,\n        receipt_number: this.extractReceiptNumber(booking.receipt_url)\n      }\n\n    } catch (error) {\n      console.error(`Failed to get receipt data for booking ${bookingId}:`, error)\n      return null\n    }\n  }\n\n  /**\n   * Extract receipt number from receipt URL\n   */\n  private extractReceiptNumber(receiptUrl: string): string {\n    // Extract from URL or generate a fallback\n    const match = receiptUrl.match(/RCP-[A-Z0-9]+-[A-Z0-9]+/)\n    return match ? match[0] : 'RCP-UNKNOWN'\n  }\n\n  /**\n   * Send receipt notifications (email/SMS)\n   */\n  async sendReceiptNotifications(bookingId: string): Promise<void> {\n    try {\n      const receiptData = await this.getReceiptData(bookingId)\n      if (!receiptData) {\n        throw new Error(`Receipt data not found for booking ${bookingId}`)\n      }\n\n      // TODO: Implement email notification\n      console.log(`Would send email receipt to customer for booking ${bookingId}`)\n      \n      // TODO: Implement SMS notification\n      console.log(`Would send SMS receipt to customer for booking ${bookingId}`)\n\n    } catch (error) {\n      console.error(`Failed to send receipt notifications for booking ${bookingId}:`, error)\n      // Don't throw - notifications are not critical to the core flow\n    }\n  }\n\n  /**\n   * Process all confirmed bookings and generate receipts\n   */\n  async processConfirmedBookings(): Promise<void> {\n    try {\n      // Get all provider_confirmed bookings without receipts\n      const { data: confirmedBookings, error } = await supabase\n        .from('bookings')\n        .select('id, created_at')\n        .eq('state', 'provider_confirmed')\n        .is('receipt_url', null)\n        .order('created_at', { ascending: true })\n\n      if (error) {\n        console.error('Failed to fetch confirmed bookings:', error)\n        return\n      }\n\n      if (!confirmedBookings || confirmedBookings.length === 0) {\n        return // No confirmed bookings to process\n      }\n\n      console.log(`Processing ${confirmedBookings.length} confirmed bookings for receipt generation`)\n\n      for (const booking of confirmedBookings) {\n        try {\n          await this.generateReceipt(booking.id)\n          await this.sendReceiptNotifications(booking.id)\n        } catch (receiptError) {\n          console.error(`Failed to process receipt for booking ${booking.id}:`, receiptError)\n        }\n      }\n\n    } catch (error) {\n      console.error('Error in processConfirmedBookings:', error)\n    }\n  }\n}\n\n// Export singleton instance\nexport const receiptService = ReceiptService.getInstance()\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\reasoning\\artifacts\\types.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'Disagreement' is defined but never used. Allowed unused vars must match /^_/u.","line":1,"column":30,"nodeType":null,"messageId":"unusedVar","endLine":1,"endColumn":42}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { ReasoningSynthesis, Disagreement } from \"@/reasoning/orchestration\";\nimport {\n  _DeploymentEnvironment,\n  _DeploymentEnvironmentClassification,\n  DeploymentFingerprint,\n  _ReasoningConfigHash,\n} from \"./deploymentFingerprint\";\nimport { ExternalAdapterPolicy } from \"../adapters/policy\";\n\nexport type {\n  DeploymentEnvironment,\n  DeploymentEnvironmentClassification,\n  DeploymentFingerprint,\n  ReasoningConfigHash,\n} from \"./deploymentFingerprint\";\nexport type { ExternalAdapterPolicy } from \"../adapters/policy\";\nexport type {\n  ArtifactEvidence,\n  FullDisclosureAuditReport,\n  FullDisclosureLimits,\n  InputClosureEntry,\n} from \"./fullDisclosureAuditReport\";\n\nexport type HashAlgorithm = \"sha256\";\n\nexport interface GovernanceSnapshots {\n  readonly registry_hash: string;\n  readonly evolution_hash: string;\n}\n\nexport interface ReasoningArtifactIdentity {\n  readonly artifact_version: \"reasoning-artifact/v1\";\n  readonly artifact_id: string;\n  readonly logical_time: number;\n  readonly wall_time?: number;\n}\n\nexport interface ArtifactProvenance {\n  readonly system: string;\n  readonly system_version: string;\n  readonly phase: \"12\";\n  readonly genome_hash: string;\n  readonly governance: GovernanceSnapshots;\n  readonly deployment: DeploymentFingerprint;\n  readonly external_adapters: ExternalAdapterPolicy;\n  readonly external_adapter_usage?: readonly string[];\n}\n\nexport interface ArtifactInputsDigests {\n  readonly analytics: string;\n  readonly simcity?: string;\n  readonly audit?: string;\n  readonly trust?: string;\n}\n\nexport interface PersonaJudgment {\n  readonly topic: string;\n  readonly position: string;\n  readonly rationale_digests: readonly string[];\n}\n\nexport type UncertaintySource = \"signal_gap\" | \"signal_conflict\" | \"synthetic_context\" | \"governance_block\" | \"other\";\n\nexport interface PersonaUncertainty {\n  readonly id: string;\n  readonly topic: string;\n  readonly confidence_level: \"low\" | \"medium\" | \"high\";\n  readonly sources: readonly UncertaintySource[];\n  readonly irreducible: boolean;\n}\n\nexport interface PersonaArtifact {\n  readonly persona_id: string;\n  readonly persona_type: string;\n  readonly inputs_digest: string;\n  readonly judgments: readonly PersonaJudgment[];\n  readonly uncertainties: readonly PersonaUncertainty[];\n  readonly provenance: {\n    readonly origin: string;\n    readonly version?: string;\n  };\n}\n\nexport interface SynthesisConsensusEntry {\n  readonly topic: string;\n  readonly position: string;\n  readonly personas: readonly string[];\n}\n\nexport interface SynthesisDisagreementEntry {\n  readonly topic: string;\n  readonly positions: readonly {\n    readonly persona_id: string;\n    readonly position: string;\n  }[];\n}\n\nexport interface SynthesisSection {\n  readonly consensus: readonly SynthesisConsensusEntry[];\n  readonly disagreements: readonly SynthesisDisagreementEntry[];\n  readonly uncertainties: ReasoningSynthesis[\"uncertainties\"];\n}\n\nexport interface GuaranteesSection {\n  readonly deterministic: boolean;\n  readonly replayable: boolean;\n  readonly non_agency: boolean;\n  readonly disclaimers: readonly string[];\n}\n\nexport interface VerificationHooks {\n  readonly hash_algorithm: HashAlgorithm;\n  readonly replay_seed: string;\n  readonly steps: readonly string[];\n}\n\nexport interface HumanReview {\n  readonly reviewed: boolean;\n  readonly reviewer_id?: string;\n  readonly notes_digest?: string;\n}\n\nexport interface ReasoningArtifact {\n  readonly identity: ReasoningArtifactIdentity;\n  readonly provenance: ArtifactProvenance;\n  readonly inputs: ArtifactInputsDigests;\n  readonly personas: readonly PersonaArtifact[];\n  readonly synthesis: SynthesisSection;\n  readonly guarantees: GuaranteesSection;\n  readonly verification: VerificationHooks;\n  readonly human?: HumanReview;\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\scripts\\incidents-store.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'IncidentStatus' is defined but never used. Allowed unused vars must match /^_/u.","line":4,"column":25,"nodeType":null,"messageId":"unusedVar","endLine":4,"endColumn":39}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import fs from 'node:fs'\nimport path from 'node:path'\nimport { randomUUID } from 'node:crypto'\nimport type { Incident, IncidentStatus } from '../types/incidents'\n\nconst IS_SERVERLESS = process.env.VERCEL === '1'\nconst INCIDENTS_FILE = path.join(process.cwd(), 'ops-state', 'incidents.json')\n\n// In-memory store for serverless environments\nlet memoryStore: Incident[] = []\n\nfunction ensureFile() {\n  if (IS_SERVERLESS) return\n  try {\n    if (!fs.existsSync(path.dirname(INCIDENTS_FILE))) {\n      fs.mkdirSync(path.dirname(INCIDENTS_FILE), { recursive: true })\n    }\n    if (!fs.existsSync(INCIDENTS_FILE)) {\n      fs.writeFileSync(INCIDENTS_FILE, '[]', 'utf8')\n    }\n  } catch (error) {\n    console.warn('incidents-store: unable to ensure storage file', error)\n  }\n}\n\nexport function loadIncidents(): Incident[] {\n  if (IS_SERVERLESS) {\n    return memoryStore\n  }\n  ensureFile()\n  try {\n    const raw = fs.readFileSync(INCIDENTS_FILE, 'utf8')\n    return JSON.parse(raw) as Incident[]\n  } catch {\n    return []\n  }\n}\n\nexport function saveIncidents(incidents: Incident[]) {\n  if (IS_SERVERLESS) {\n    memoryStore = incidents\n    console.warn('Ops store in read-only mode: persistence unavailable.')\n    return\n  }\n  ensureFile()\n  try {\n    fs.writeFileSync(INCIDENTS_FILE, JSON.stringify(incidents, null, 2), 'utf8')\n  } catch (error) {\n    throw new Error(\n      `incidents-store: failed to persist incidents (is ops-state writable?): ${error instanceof Error ? error.message : String(error)}`\n    )\n  }\n}\n\nexport function createIncident(\n  partial: Omit<Incident, 'id' | 'createdAt' | 'updatedAt' | 'status'>\n): Incident {\n  const now = new Date().toISOString()\n  const { metadata: partialMetadata, ...rest } = partial\n  const incident: Incident = {\n    id: randomUUID(),\n    createdAt: now,\n    updatedAt: now,\n    status: 'open',\n    metadata: { ...partialMetadata },\n    ...rest\n  }\n  const all = loadIncidents()\n  all.push(incident)\n  saveIncidents(all)\n  return incident\n}\n\nexport function updateIncident(\n  id: string,\n  updates: Partial<Incident>\n): Incident | null {\n  const all = loadIncidents()\n  const idx = all.findIndex((i) => i.id === id)\n  if (idx === -1) return null\n  const now = new Date().toISOString()\n  const existing = all[idx]\n  \n  // Handle status transitions\n  if (updates.status === 'resolved' && existing.status !== 'resolved') {\n    updates.resolvedAt = now\n  }\n  if (updates.status === 'closed' && existing.status !== 'closed') {\n    updates.closedAt = now\n  }\n  \n  all[idx] = {\n    ...existing,\n    ...updates,\n    updatedAt: now\n  }\n  saveIncidents(all)\n  return all[idx]\n}\n\nexport function getIncident(id: string): Incident | null {\n  const all = loadIncidents()\n  return all.find((i) => i.id === id) || null\n}\n\nexport function getOpenIncidents(): Incident[] {\n  const all = loadIncidents()\n  return all.filter((i) => \n    i.status === 'open' || \n    i.status === 'investigating' || \n    i.status === 'mitigating'\n  )\n}\n\nexport function addSignalToIncident(\n  incidentId: string,\n  signal: Incident['signals'][0]\n): Incident | null {\n  const incident = getIncident(incidentId)\n  if (!incident) return null\n  \n  return updateIncident(incidentId, {\n    signals: [...incident.signals, signal]\n  })\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\scripts\\logs-analyzer.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'loadPatterns' is defined but never used. Allowed unused vars must match /^_/u.","line":9,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":9,"endColumn":22},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'savePatterns' is defined but never used. Allowed unused vars must match /^_/u.","line":9,"column":24,"nodeType":null,"messageId":"unusedVar","endLine":9,"endColumn":36},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'loadEvents' is defined but never used. Allowed unused vars must match /^_/u.","line":10,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":10,"endColumn":20}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * LogsAI - Pattern detection and analysis\n * \n * Detects patterns, regressions, and correlations in logs\n */\n\nimport { randomUUID } from 'node:crypto'\nimport type { LogEntry, LogPattern, LogAnalysis, LogCategory, LogSeverity } from '../types/logs'\nimport { loadPatterns, savePatterns } from './logs-store'\nimport { loadEvents } from './ops-events-store'\nimport type { OpsEvent } from '../types/opsEvents'\n\n/**\n * Extract error pattern from log message\n */\nfunction extractErrorPattern(message: string): string {\n  // Normalize common patterns\n  let pattern = message\n  \n  // Remove UUIDs\n  pattern = pattern.replace(/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/gi, '<uuid>')\n  \n  // Remove timestamps\n  pattern = pattern.replace(/\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}/g, '<timestamp>')\n  \n  // Remove numbers (but keep structure)\n  pattern = pattern.replace(/\\d+/g, '<number>')\n  \n  // Remove email addresses\n  pattern = pattern.replace(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}/g, '<email>')\n  \n  // Remove URLs\n  pattern = pattern.replace(/https?:\\/\\/[^\\s]+/g, '<url>')\n  \n  return pattern.trim()\n}\n\n/**\n * Detect patterns in logs\n */\nexport function detectPatterns(\n  logs: LogEntry[],\n  existingPatterns: LogPattern[] = []\n): {\n  newPatterns: LogPattern[]\n  recurringPatterns: LogPattern[]\n  regressions: LogPattern[]\n} {\n  const patternMap = new Map<string, {\n    pattern: string\n    category: LogCategory\n    severity: LogSeverity\n    occurrences: LogEntry[]\n    firstSeen: string\n    lastSeen: string\n  }>()\n  \n  // Group logs by pattern\n  for (const log of logs) {\n    if (log.severity === 'error' || log.severity === 'critical') {\n      const pattern = extractErrorPattern(log.message)\n      const key = `${log.category}:${pattern}`\n      \n      if (!patternMap.has(key)) {\n        patternMap.set(key, {\n          pattern,\n          category: log.category,\n          severity: log.severity,\n          occurrences: [],\n          firstSeen: log.timestamp,\n          lastSeen: log.timestamp\n        })\n      }\n      \n      const entry = patternMap.get(key)!\n      entry.occurrences.push(log)\n      if (new Date(log.timestamp) < new Date(entry.firstSeen)) {\n        entry.firstSeen = log.timestamp\n      }\n      if (new Date(log.timestamp) > new Date(entry.lastSeen)) {\n        entry.lastSeen = log.timestamp\n      }\n    }\n  }\n  \n  // Convert to patterns\n  const detectedPatterns: LogPattern[] = []\n  for (const [_key, data] of patternMap.entries()) {\n    const affectedServices = [\n      ...new Set(\n        data.occurrences\n          .map((log) => log.service)\n          .filter((s): s is string => !!s)\n      )\n    ]\n    \n    // Check if this pattern exists in stored patterns\n    const existing = existingPatterns.find(\n      (p) => p.pattern === data.pattern && p.category === data.category\n    )\n    \n    const isRegression = existing?.resolvedAt \n      ? new Date(data.firstSeen) > new Date(existing.resolvedAt)\n      : false\n    \n    detectedPatterns.push({\n      id: existing?.id || `pattern-${randomUUID()}`,\n      pattern: data.pattern,\n      category: data.category,\n      severity: data.severity,\n      description: data.occurrences[0]?.message || data.pattern,\n      firstSeen: existing?.firstSeen || data.firstSeen,\n      lastSeen: data.lastSeen,\n      occurrenceCount: data.occurrences.length,\n      affectedServices: affectedServices.length > 0 ? affectedServices : undefined,\n      isRegression,\n      resolvedAt: existing?.resolvedAt\n    })\n  }\n  \n  // Categorize patterns\n  const newPatterns: LogPattern[] = []\n  const recurringPatterns: LogPattern[] = []\n  const regressions: LogPattern[] = []\n  \n  for (const pattern of detectedPatterns) {\n    const existing = existingPatterns.find(\n      (p) => p.id === pattern.id || \n             (p.pattern === pattern.pattern && p.category === pattern.category)\n    )\n    \n    if (pattern.isRegression) {\n      regressions.push(pattern)\n    } else if (existing) {\n      recurringPatterns.push(pattern)\n    } else {\n      newPatterns.push(pattern)\n    }\n  }\n  \n  return { newPatterns, recurringPatterns, regressions }\n}\n\n/**\n * Correlate logs with deployments\n */\nexport function correlateWithDeployments(\n  logs: LogEntry[],\n  events: OpsEvent[]\n): LogAnalysis['deploymentCorrelations'] {\n  const deploymentEvents = events.filter((e) => e.type === 'deployment')\n  const correlations: LogAnalysis['deploymentCorrelations'] = []\n  \n  for (const deployment of deploymentEvents) {\n    const deploymentTime = new Date(deployment.timestamp).getTime()\n    const deploymentSha = deployment.data.deploymentSha as string | undefined\n    \n    if (!deploymentSha) continue\n    \n    // Find logs within 1 hour after deployment\n    const windowMs = 60 * 60 * 1000 // 1 hour\n    const correlatedLogs = logs.filter((log) => {\n      const logTime = new Date(log.timestamp).getTime()\n      return logTime >= deploymentTime && logTime <= deploymentTime + windowMs\n    })\n    \n    if (correlatedLogs.length > 0) {\n      const patterns = [\n        ...new Set(\n          correlatedLogs\n            .map((log) => extractErrorPattern(log.message))\n            .filter((p) => p.length > 0)\n        )\n      ]\n      \n      correlations.push({\n        deploymentSha,\n        deploymentTime: deployment.timestamp,\n        correlatedLogs: correlatedLogs.length,\n        patterns\n      })\n    }\n  }\n  \n  return correlations.length > 0 ? correlations : undefined\n}\n\n/**\n * Get top errors\n */\nexport function getTopErrors(logs: LogEntry[]): LogAnalysis['topErrors'] {\n  const errorMap = new Map<string, {\n    message: string\n    count: number\n    firstSeen: string\n    lastSeen: string\n    services: Set<string>\n  }>()\n  \n  for (const log of logs) {\n    if (log.severity === 'error' || log.severity === 'critical') {\n      const key = log.message\n      \n      if (!errorMap.has(key)) {\n        errorMap.set(key, {\n          message: log.message,\n          count: 0,\n          firstSeen: log.timestamp,\n          lastSeen: log.timestamp,\n          services: new Set()\n        })\n      }\n      \n      const entry = errorMap.get(key)!\n      entry.count++\n      if (new Date(log.timestamp) < new Date(entry.firstSeen)) {\n        entry.firstSeen = log.timestamp\n      }\n      if (new Date(log.timestamp) > new Date(entry.lastSeen)) {\n        entry.lastSeen = log.timestamp\n      }\n      if (log.service) {\n        entry.services.add(log.service)\n      }\n    }\n  }\n  \n  return Array.from(errorMap.values())\n    .map((entry) => ({\n      message: entry.message,\n      count: entry.count,\n      firstSeen: entry.firstSeen,\n      lastSeen: entry.lastSeen,\n      affectedServices: Array.from(entry.services)\n    }))\n    .sort((a, b) => b.count - a.count)\n    .slice(0, 10)\n}\n\n/**\n * Generate insights\n */\nexport function generateInsights(\n  logs: LogEntry[],\n  patterns: {\n    newPatterns: LogPattern[]\n    recurringPatterns: LogPattern[]\n    regressions: LogPattern[]\n  },\n  correlations?: LogAnalysis['deploymentCorrelations']\n): string[] {\n  const insights: string[] = []\n  \n  // Regression insights\n  if (patterns.regressions.length > 0) {\n    insights.push(\n      `âš ï¸ ${patterns.regressions.length} regression(s) detected: patterns that reappeared after resolution`\n    )\n  }\n  \n  // New pattern insights\n  if (patterns.newPatterns.length > 0) {\n    insights.push(\n      `ðŸ” ${patterns.newPatterns.length} new error pattern(s) detected`\n    )\n  }\n  \n  // Deployment correlation insights\n  if (correlations && correlations.length > 0) {\n    const totalCorrelated = correlations.reduce((sum, c) => sum + c.correlatedLogs, 0)\n    insights.push(\n      `ðŸ“¦ ${correlations.length} deployment(s) correlated with ${totalCorrelated} log entries`\n    )\n  }\n  \n  // Error rate insights\n  const errorCount = logs.filter((l) => l.severity === 'error' || l.severity === 'critical').length\n  const totalLogs = logs.length\n  if (totalLogs > 0) {\n    const errorRate = (errorCount / totalLogs) * 100\n    if (errorRate > 10) {\n      insights.push(\n        `ðŸ“Š High error rate: ${errorRate.toFixed(1)}% of logs are errors (${errorCount}/${totalLogs})`\n      )\n    }\n  }\n  \n  // Service-specific insights\n  const serviceErrors = new Map<string, number>()\n  for (const log of logs) {\n    if (log.severity === 'error' || log.severity === 'critical') {\n      const service = log.service || 'unknown'\n      serviceErrors.set(service, (serviceErrors.get(service) || 0) + 1)\n    }\n  }\n  \n  const topService = Array.from(serviceErrors.entries())\n    .sort((a, b) => b[1] - a[1])[0]\n  \n  if (topService && topService[1] > 10) {\n    insights.push(\n      `ðŸŽ¯ Service ${topService[0]} has ${topService[1]} error(s) - highest error count`\n    )\n  }\n  \n  return insights\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\scripts\\logs-store.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'loadIncidents' is defined but never used. Allowed unused vars must match /^_/u.","line":12,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":12,"endColumn":23}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * LogsAI - Log store utility\n * \n * Manages log entries and pattern detection\n */\n\nimport fs from 'node:fs'\nimport path from 'node:path'\nimport { randomUUID } from 'node:crypto'\nimport type { LogEntry, LogPattern, LogCategory, LogSeverity } from '../types/logs'\nimport { loadEvents } from './ops-events-store'\nimport { loadIncidents } from './incidents-store'\nimport type { OpsEvent } from '../types/opsEvents'\n\nconst IS_SERVERLESS = process.env.VERCEL === '1'\nconst LOGS_FILE = path.join(process.cwd(), 'ops-state', 'logs.json')\nconst PATTERNS_FILE = path.join(process.cwd(), 'ops-state', 'log-patterns.json')\n\n// In-memory stores for serverless environments\nlet memoryLogs: LogEntry[] = []\nlet memoryPatterns: LogPattern[] = []\n\nfunction ensureFile(filePath: string) {\n  if (IS_SERVERLESS) return\n  try {\n    if (!fs.existsSync(path.dirname(filePath))) {\n      fs.mkdirSync(path.dirname(filePath), { recursive: true })\n    }\n    if (!fs.existsSync(filePath)) {\n      fs.writeFileSync(filePath, '[]', 'utf8')\n    }\n  } catch (error) {\n    console.warn('logs-store: unable to ensure storage file', error)\n  }\n}\n\n// Log entries storage\nexport function loadLogs(): LogEntry[] {\n  if (IS_SERVERLESS) {\n    return memoryLogs\n  }\n  ensureFile(LOGS_FILE)\n  try {\n    const raw = fs.readFileSync(LOGS_FILE, 'utf8')\n    return JSON.parse(raw) as LogEntry[]\n  } catch {\n    return []\n  }\n}\n\nexport function saveLogs(logs: LogEntry[]) {\n  if (IS_SERVERLESS) {\n    memoryLogs = logs\n    console.warn('Ops store in read-only mode: persistence unavailable.')\n    return\n  }\n  ensureFile(LOGS_FILE)\n  try {\n    fs.writeFileSync(LOGS_FILE, JSON.stringify(logs, null, 2), 'utf8')\n  } catch (error) {\n    throw new Error(\n      `logs-store: failed to persist logs (is ops-state writable?): ${error instanceof Error ? error.message : String(error)}`\n    )\n  }\n}\n\nexport function createLogEntry(\n  partial: Omit<LogEntry, 'id' | 'timestamp'>\n): LogEntry {\n  const now = new Date().toISOString()\n  const log: LogEntry = {\n    id: randomUUID(),\n    timestamp: now,\n    ...partial\n  }\n  const all = loadLogs()\n  all.push(log)\n  saveLogs(all)\n  return log\n}\n\n// Pattern storage\nexport function loadPatterns(): LogPattern[] {\n  if (IS_SERVERLESS) {\n    return memoryPatterns\n  }\n  ensureFile(PATTERNS_FILE)\n  try {\n    const raw = fs.readFileSync(PATTERNS_FILE, 'utf8')\n    return JSON.parse(raw) as LogPattern[]\n  } catch {\n    return []\n  }\n}\n\nexport function savePatterns(patterns: LogPattern[]) {\n  if (IS_SERVERLESS) {\n    memoryPatterns = patterns\n    console.warn('Ops store in read-only mode: persistence unavailable.')\n    return\n  }\n  ensureFile(PATTERNS_FILE)\n  try {\n    fs.writeFileSync(PATTERNS_FILE, JSON.stringify(patterns, null, 2), 'utf8')\n  } catch (error) {\n    throw new Error(\n      `logs-store: failed to persist log patterns (is ops-state writable?): ${error instanceof Error ? error.message : String(error)}`\n    )\n  }\n}\n\n// Get logs by category\nexport function getLogsByCategory(category: LogCategory): LogEntry[] {\n  const all = loadLogs()\n  return all.filter((log) => log.category === category)\n}\n\n// Get logs by time range\nexport function getLogsByTimeRange(\n  startTime: string,\n  endTime?: string\n): LogEntry[] {\n  const all = loadLogs()\n  const start = new Date(startTime).getTime()\n  const end = endTime ? new Date(endTime).getTime() : Date.now()\n  \n  return all.filter((log) => {\n    const logTime = new Date(log.timestamp).getTime()\n    return logTime >= start && logTime <= end\n  })\n}\n\n// Get logs by severity\nexport function getLogsBySeverity(severity: LogSeverity): LogEntry[] {\n  const all = loadLogs()\n  return all.filter((log) => log.severity === severity)\n}\n\n// Get logs by service\nexport function getLogsByService(service: string): LogEntry[] {\n  const all = loadLogs()\n  return all.filter((log) => log.service === service)\n}\n\n// Convert OpsEvents to LogEntries for analysis\nexport function convertEventsToLogs(events: OpsEvent[]): LogEntry[] {\n  return events.map((event) => ({\n    id: event.id,\n    timestamp: event.timestamp,\n    category: event.type === 'error' ? 'error' : \n              event.type === 'deployment' ? 'system' : \n              event.type === 'webhook' ? 'booking' : 'event',\n    severity: event.severity,\n    message: event.title,\n    source: event.source,\n    service: event.service,\n    metadata: event.data,\n    tags: event.tags,\n    relatedEventIds: [event.id],\n    relatedIncidentIds: event.relatedIncidentIds,\n    deploymentSha: event.data.deploymentSha as string | undefined\n  }))\n}\n\n// Aggregate logs from multiple sources\nexport function aggregateLogs(\n  startTime?: string,\n  endTime?: string\n): LogEntry[] {\n  const logs: LogEntry[] = []\n  \n  // Load stored logs\n  const storedLogs = startTime || endTime\n    ? getLogsByTimeRange(startTime || '1970-01-01', endTime)\n    : loadLogs()\n  logs.push(...storedLogs)\n  \n  // Convert events to logs\n  const events = startTime || endTime\n    ? loadEvents().filter((e) => {\n        const eventTime = new Date(e.timestamp).getTime()\n        const start = startTime ? new Date(startTime).getTime() : 0\n        const end = endTime ? new Date(endTime).getTime() : Date.now()\n        return eventTime >= start && eventTime <= end\n      })\n    : loadEvents()\n  logs.push(...convertEventsToLogs(events))\n  \n  // Sort by timestamp (newest first)\n  logs.sort((a, b) => \n    new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime()\n  )\n  \n  return logs\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\simcity\\compiler\\ScenarioValidator.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'DomainRegistryEntry' is defined but never used. Allowed unused vars must match /^_/u.","line":1,"column":26,"nodeType":null,"messageId":"unusedVar","endLine":1,"endColumn":45}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { DomainRegistry, DomainRegistryEntry } from \"@/governance/DomainRegistry\";\nimport { DeprecationPolicy } from \"@/governance/DeprecationPolicy\";\nimport {\n  PerturbationType,\n  ScenarioPerturbation,\n  SimCityActorModel,\n  SimCityScenarioV2,\n} from \"../v2/types\";\n\nexport interface ValidationResult {\n  valid: boolean;\n  errors: string[];\n}\n\nexport const ALLOWED_PERTURBATIONS: Record<\n  PerturbationType,\n  { domain: string; description: string; min: number; max: number }\n> = {\n  demandSpike: { domain: \"booking\", description: \"Increase synthetic demand pressure\", min: 0.1, max: 3 },\n  providerDrop: { domain: \"provider\", description: \"Reduce provider availability\", min: -0.9, max: -0.05 },\n  cancellationBias: { domain: \"booking\", description: \"Bias toward cancellations and no-shows\", min: 0.05, max: 0.9 },\n  latencyInflation: { domain: \"ops\", description: \"Increase system latency\", min: 10, max: 2000 },\n  trustSignal: { domain: \"trust_safety\", description: \"Emit trust & safety synthetic flags\", min: 0.1, max: 1 },\n};\n\nfunction validateDomain(domain: string, registry: DomainRegistry): string | undefined {\n  const entry = registry.entries.find((candidate) => candidate.domain === domain);\n  if (!entry) return `Domain \"${domain}\" is not registered in governance.`;\n  if (entry.deprecation?.willDeprecate) {\n    const policy: DeprecationPolicy = entry.deprecation;\n    return `Domain \"${domain}\" is deprecated${policy.sunsetDate ? ` (sunsets ${policy.sunsetDate})` : \"\"}.`;\n  }\n  return undefined;\n}\n\nexport function validatePerturbations(\n  perturbations: readonly ScenarioPerturbation[],\n  registry: DomainRegistry\n): ValidationResult {\n  const errors: string[] = [];\n  perturbations.forEach((perturbation) => {\n    if (!ALLOWED_PERTURBATIONS[perturbation.type]) {\n      errors.push(`Perturbation \"${perturbation.type}\" is not allowed`);\n      return;\n    }\n    const range = ALLOWED_PERTURBATIONS[perturbation.type];\n    if (perturbation.domain !== range.domain) {\n      errors.push(`Perturbation \"${perturbation.type}\" must target domain \"${range.domain}\"`);\n    }\n    if (perturbation.magnitude < range.min || perturbation.magnitude > range.max) {\n      errors.push(\n        `Perturbation \"${perturbation.type}\" magnitude ${perturbation.magnitude} is outside allowed range ${range.min}-${range.max}`\n      );\n    }\n    const domainError = validateDomain(perturbation.domain, registry);\n    if (domainError) {\n      errors.push(domainError);\n    }\n  });\n\n  return { valid: errors.length === 0, errors };\n}\n\nexport function validateActors(actors: readonly SimCityActorModel[], registry: DomainRegistry): ValidationResult {\n  const errors: string[] = [];\n  actors.forEach((actor) => {\n    const domainError = validateDomain(actor.domain, registry);\n    if (domainError) errors.push(domainError);\n  });\n  return { valid: errors.length === 0, errors };\n}\n\nexport function validateScenario(sc: SimCityScenarioV2, registry: DomainRegistry): ValidationResult {\n  const errors: string[] = [];\n\n  if (!sc.baselineEnvelopes) {\n    errors.push(\"Scenario must include baseline envelopes (can be empty array)\");\n  }\n\n  const actorResult = validateActors(sc.actors, registry);\n  errors.push(...actorResult.errors);\n\n  const perturbationResult = validatePerturbations(sc.perturbations ?? [], registry);\n  errors.push(...perturbationResult.errors);\n\n  if (sc.assumptions.length === 0) {\n    errors.push(\"Scenario must declare assumptions\");\n  }\n\n  if (typeof sc.seed !== \"number\") {\n    errors.push(\"Scenario must include deterministic seed\");\n  }\n\n  return { valid: errors.length === 0, errors };\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\simcity\\v2\\types.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'StandardizedEvent' is defined but never used. Allowed unused vars must match /^_/u.","line":2,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":2,"endColumn":27}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { AnalyticsEnvelope } from \"@/contracts/analytics/AnalyticsEnvelope\";\nimport { StandardizedEvent } from \"@/contracts/analytics/StandardizedEvent\";\nimport { EvolutionFlags } from \"@/governance/EvolutionFlags\";\nimport { DomainRegistry, DomainRegistryEntry } from \"@/governance/DomainRegistry\";\n\nexport type ActorKind = \"user\" | \"provider\" | \"system\";\n\nexport type PerturbationType = \"demandSpike\" | \"providerDrop\" | \"cancellationBias\" | \"latencyInflation\" | \"trustSignal\";\n\nexport interface ScenarioPerturbation {\n  readonly type: PerturbationType;\n  readonly domain: string;\n  readonly magnitude: number;\n  readonly description: string;\n}\n\nexport interface ScenarioProvenance {\n  readonly source: \"scenario-compiler\";\n  readonly compiledAt: number;\n  readonly description: string;\n  readonly intent?: string;\n  readonly constraints?: string[];\n  readonly forkFrom?: string;\n}\n\nexport interface SimCityActorModel {\n  readonly id: string;\n  readonly kind: ActorKind;\n  readonly domain: string;\n  readonly seed: number;\n  readonly assumptions: string[];\n}\n\nexport interface SimCityScenarioV2 {\n  readonly id: string;\n  readonly label: string;\n  readonly seed: number;\n  readonly baselineEnvelopes: readonly AnalyticsEnvelope[];\n  readonly actors: readonly SimCityActorModel[];\n  readonly assumptions: readonly string[];\n  readonly timeOrigin?: number;\n  readonly evolution?: EvolutionFlags;\n  readonly perturbations?: readonly ScenarioPerturbation[];\n  readonly provenance?: ScenarioProvenance;\n  readonly confidence?: number;\n}\n\nexport interface SimCityMarketState {\n  readonly tick: number;\n  readonly logicalTime: number;\n  readonly demandLevel: number;\n  readonly providersAvailable: number;\n  readonly cancellations: number;\n  readonly noShows: number;\n  readonly retries: number;\n  readonly stressIndex: number;\n  readonly queueDepth: number;\n}\n\nexport interface GovernanceAnnotation {\n  readonly domain: string;\n  readonly permitted: boolean;\n  readonly reason?: string;\n  readonly evolution?: EvolutionFlags;\n}\n\nexport interface SimCitySyntheticEnvelope extends AnalyticsEnvelope {\n  readonly synthetic: true;\n  readonly metadata: Record<string, unknown> & {\n    simcity: {\n      version: \"v2\";\n      synthetic: true;\n      runId: string;\n      scenarioId: string;\n      simTime: number;\n      logicalTime: number;\n      baseline?: boolean;\n      forkOf?: string;\n      assumptions: string[];\n      governance: GovernanceAnnotation;\n      trustSafety?: { simulated: true; signals: string[] };\n    };\n    evolution?: EvolutionFlags;\n  };\n}\n\nexport interface HistoricalProfile {\n  readonly demandPerTick: number[];\n  readonly cancellationsPerTick: number[];\n  readonly providersPerTick: number[];\n  readonly avgLatencyMs: number;\n}\n\nexport interface MarketSimulationConfig {\n  readonly scenario: SimCityScenarioV2;\n  readonly registry: DomainRegistry;\n  readonly seed: number;\n  readonly horizon: number;\n  readonly forkOf?: string;\n  readonly demandShock?: number;\n  readonly providerShock?: number;\n  readonly cancellationBias?: number;\n}\n\nexport interface MarketSimulationResult {\n  readonly runId: string;\n  readonly envelopes: SimCitySyntheticEnvelope[];\n  readonly states: SimCityMarketState[];\n  readonly profile: HistoricalProfile;\n}\n\nexport interface CounterfactualChange {\n  readonly kind: \"demand\" | \"provider\" | \"cancellation\";\n  readonly magnitude: number;\n}\n\nexport interface CounterfactualResult {\n  readonly baseline: MarketSimulationResult;\n  readonly variant: MarketSimulationResult;\n  readonly delta: {\n    readonly bookings: number;\n    readonly cancellations: number;\n    readonly stress: number;\n  };\n}\n\nexport function deepFreeze<T>(value: T): T {\n  if (value && typeof value === \"object\") {\n    Object.freeze(value);\n    Object.values(value as Record<string, unknown>).forEach((child) => deepFreeze(child as unknown as T));\n  }\n  return value;\n}\n\nexport function assertRegistered(domain: string, registry: DomainRegistry): DomainRegistryEntry {\n  const entry = registry.entries.find((candidate) => candidate.domain === domain);\n  if (!entry) {\n    throw new Error(`Domain \"${domain}\" is not in the governance registry`);\n  }\n  if (entry.deprecation?.willDeprecate) {\n    throw new Error(`Domain \"${domain}\" is marked deprecated${entry.deprecation.sunsetDate ? ` (sunsets ${entry.deprecation.sunsetDate})` : \"\"}`);\n  }\n  return entry;\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\patri\\Projects\\bookijibck\\src\\trust\\reinforcement\\types.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'AuditTimeline' is defined but never used. Allowed unused vars must match /^_/u.","line":1,"column":22,"nodeType":null,"messageId":"unusedVar","endLine":1,"endColumn":35}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { AuditFrame, AuditTimeline, TimelineGovernance, EnvelopeProvenance } from \"@/audit/types\";\nimport { EvolutionFlags } from \"@/governance/EvolutionFlags\";\nimport { DomainRegistryEntry } from \"@/governance/DomainRegistry\";\n\nexport type RiskDimension = \"fraudLikelihood\" | \"noShowHazard\" | \"providerReliability\" | \"abuseRisk\";\n\nexport type RiskConfidence = \"low\" | \"medium\" | \"high\";\n\nexport interface RiskMetric {\n  readonly dimension: RiskDimension;\n  readonly value: number;\n  readonly trend: \"up\" | \"down\" | \"flat\";\n  readonly confidence: RiskConfidence;\n  readonly signals: readonly string[];\n  readonly rationale: string;\n}\n\nexport interface RiskStateSnapshot {\n  readonly id: string;\n  readonly frameId: string;\n  readonly timelineId: string;\n  readonly domain: string;\n  readonly timestamp: number;\n  readonly logicalTime: number;\n  readonly provenance: EnvelopeProvenance;\n  readonly metrics: readonly RiskMetric[];\n  readonly signals: readonly string[];\n  readonly assumptions: readonly string[];\n  readonly governance: TimelineGovernance;\n  readonly evolution?: EvolutionFlags;\n  readonly syntheticContext?: AuditFrame[\"syntheticContext\"];\n}\n\nexport interface RiskTrajectory {\n  readonly id: string;\n  readonly timelineId: string;\n  readonly startedAt: number;\n  readonly endedAt: number;\n  readonly snapshots: readonly RiskStateSnapshot[];\n  readonly derivedFrom: {\n    readonly frameIds: readonly string[];\n    readonly timelineStartedAt: number;\n  };\n  readonly warnings: readonly string[];\n  readonly replayCompatible: boolean;\n}\n\nexport type ThresholdComparator = \"gt\" | \"gte\" | \"lt\" | \"lte\";\n\nexport interface TrustSafetyThreshold {\n  readonly id: string;\n  readonly domain: string;\n  readonly dimension: RiskDimension;\n  readonly comparator: ThresholdComparator;\n  readonly value: number;\n  readonly contractVersion: string;\n  readonly label: string;\n  readonly interventionClass: \"observe\" | \"notify\" | \"throttle\" | \"pause\" | \"investigate\";\n  readonly deprecated?: boolean;\n  readonly evolution?: EvolutionFlags;\n  readonly description?: string;\n}\n\nexport interface ThresholdCrossing {\n  readonly thresholdId: string;\n  readonly snapshotId: string;\n  readonly dimension: RiskDimension;\n  readonly value: number;\n  readonly comparator: ThresholdComparator;\n  readonly crossed: boolean;\n  readonly occurredAt: number;\n  readonly evolution?: EvolutionFlags;\n  readonly signals: readonly string[];\n  readonly governance: TimelineGovernance;\n  readonly confidence: RiskConfidence;\n}\n\nexport interface InterventionJustification {\n  readonly id: string;\n  readonly domain: string;\n  readonly threshold: TrustSafetyThreshold;\n  readonly snapshotId: string;\n  readonly decision: \"justified\" | \"blocked\" | \"deferred\";\n  readonly whyNow: string;\n  readonly whyNotEarlier: string;\n  readonly whyThisIntervention: string;\n  readonly governance: TimelineGovernance & { readonly registryEntry?: DomainRegistryEntry };\n  readonly confidence: RiskConfidence;\n  readonly signals: readonly string[];\n  readonly assumptions: readonly string[];\n  readonly contractsReferenced: readonly string[];\n}\n\nexport interface CounterfactualObservation {\n  readonly timelineId: string;\n  readonly trajectoryId: string;\n  readonly meanRisk: number;\n  readonly cancellations: number;\n  readonly anomalies: number;\n  readonly latencyP95Ms?: number;\n  readonly syntheticShare?: number;\n  readonly evolution?: EvolutionFlags;\n}\n\nexport interface InterventionCounterfactual {\n  readonly id: string;\n  readonly baseline: CounterfactualObservation;\n  readonly variant: CounterfactualObservation;\n  readonly delta: {\n    readonly risk: number;\n    readonly cancellations: number;\n    readonly anomalies: number;\n    readonly latencyP95Ms?: number;\n  };\n  readonly signals: readonly string[];\n  readonly assumptions: readonly string[];\n  readonly replayCompatible: boolean;\n  readonly governanceNotes: readonly string[];\n}\n","usedDeprecatedRules":[]}]