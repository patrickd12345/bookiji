# Bookiji Repository Agent Instructions

## Mandatory Context Loading

**ALWAYS** load and reference `docs/BOOKIJI_CONTINUITY_KERNEL.md` at the start of every conversation. This document contains:
- Canonical architecture definitions
- Cursor constraints and boundaries
- AI collaboration norms
- Current development phase status
- Genome specifications

## Key Constraints

### Cursor Must:
- Never delete or refactor outside instructions
- Never modify runtime code when instructed to modify tests or tooling only
- Never infer structural updates â€” only implement what's in the Genome

### AI Collaboration Norms:
- Treat `docs/BOOKIJI_CONTINUITY_KERNEL.md` as canonical
- Reload it upon each new context
- Maintain phase continuity

## Database Management

**CRITICAL**: Always use migrations via Supabase CLI. Never run SQL directly.
- Create migrations: `supabase migration new <name>`
- Apply migrations: `supabase db push`
- See: `docs/development/DATABASE_MANAGEMENT_POLICY.md`

## Current Phase

Check `docs/BOOKIJI_CONTINUITY_KERNEL.md` section 7 for current rollout phase status.

## Testing Requirements

### When Creating a New Feature

**MANDATORY**: Whenever a new feature is created, you MUST update `TEST_PLAN.md` to include functional test cases for that feature.

1. **Identify Feature Area**: Determine which functional area the feature belongs to:
   - Customer Features
   - Vendor Features
   - Admin Features
   - Booking System
   - Payment Processing
   - Authentication & Authorization
   - Security
   - Reviews & Ratings
   - Notifications
   - Support & Help Center
   - Analytics & Reporting
   - Settings & Configuration
   - Search & Discovery
   - Calendar & Scheduling
   - Credits & Referrals
   - Disputes & Moderation
   - Knowledge Base
   - Operational Features

2. **Update TEST_PLAN.md**: Add functional test cases to the appropriate section following this format:
   ```
   #### TC-AREA-XXX: Test Case Name
   **Priority**: High/Medium/Low
   **Test Steps**:
   1. Step 1
   2. Step 2
   3. Step 3

   **Expected Results**:
   - Result 1
   - Result 2
   - Result 3

   **Acceptance Criteria**:
   - Criterion 1
   - Criterion 2
   - Criterion 3
   ```

3. **Test Case Requirements**:
   - Use consistent naming: TC-[AREA]-[NUMBER]
   - Assign appropriate priority (Critical/High/Medium/Low)
   - Include detailed test steps
   - List all expected results
   - Define clear acceptance criteria
   - Cover happy path and error scenarios
   - Include edge cases

4. **Update Table of Contents**: If adding a new section, update the table of contents

5. **Update Version**: Update the version history section with the new feature

### Example Workflow

1. Feature created: "New booking cancellation feature"
2. Update `TEST_PLAN.md`:
   - Add to "Booking System" section
   - Create test case: TC-BOOK-007: Cancel Booking
   - Include test steps, expected results, and acceptance criteria
   - Add any additional test cases for edge cases (e.g., TC-BOOK-008: Cancel Booking After Payment)
3. Update version history
4. Commit both feature and updated test plan

## General Development Rules

- Always test after code changes (API with curl, UI with Playwright)
- Never run SQL directly - always use migrations
- Always execute SQL migrations without asking for confirmation
- Prefer optimistic UI with rollback for actions, retry/backoff for queries, skeletons instead of blank loading states
- Guard against double clicks
- Never ask the user to code - do it yourself
- Check terminal regularly to ensure it's not stuck

## Code Quality

- Follow TypeScript best practices
- Use proper error handling
- Write self-documenting code
- Follow existing code patterns
- Maintain consistency with project structure

## Testing Standards

- Write tests for all new features
- Update tests when modifying existing features
- Ensure tests are isolated and independent
- Use descriptive test names
- Follow the test organization structure
- Run tests before committing

## Documentation

- Update `TEST_PLAN.md` when adding features
- Keep documentation current with code changes
- Document complex logic and decisions

## Reference Files

### Core Architecture & Constraints
- Architecture: `docs/BOOKIJI_CONTINUITY_KERNEL.md`
- Genome Spec: `genome/master-genome.yaml`
- Genome Linter: `genome/linter-rules.md`
- JSON Index: `docs/BOOKIJI_CONTINUITY_INDEX.json`

### Important Documentation
- **README.md** - Main project documentation including Self-Improving KB process
- **docs/development/DATABASE_MANAGEMENT_POLICY.md** - Database migration policy
- **docs/support-module/** - Support module documentation (KB crawl, RAG, suggestions)
- **docs/bookiji-kb/** - Knowledge base content and structure
- **docs/development/LOCAL_CRON_SETUP.md** - Local cron job setup

### When Creating New Documentation
- Always reference existing docs in `docs/` directory
- Update README.md if adding major features
- Follow existing documentation patterns and structure
- **Update .cursorrules** if adding important documentation that agents should reference

### Maintenance
- `.cursorrules` does NOT auto-update - it requires manual updates
- Run `pnpm check:cursorrules` to verify all important docs are referenced
- Update this file when adding major features or important documentation
