# Bookiji Repository Agent Instructions

## Mandatory Context Loading

- **Daily anchor**: Always refer to `docs/invariants.md` first. It lists the running invariants that code and tests enforce.
- **Expanded context**: When a task touches availability, scheduling, bookings, payments, or security, consult `docs/development/INVARIANT_COVERAGE_MATRIX.md` and the relevant files under `docs/invariants/`.
- **Knowledge Base**: At chat start, check `docs/index.md` and automatically load all KB files listed under the "Bookiji Knowledge Base" section. These files contain troubleshooting guides, FAQs, and vendor documentation that should be referenced when answering questions.

## Key Constraints

- **Truth comes from code and tests**: Do not invent architectural rules outside what runtime code enforces or tests fail when broken.
- **No unauthorized SQL**: Follow `docs/development/DATABASE_MANAGEMENT_POLICY.md`: create Supabase migrations, push them with the CLI, and never issue raw SQL against production schema.
- **Document updates**: When adding a new `.md` file, update `index.md` and ensure the file is referenced by `scripts/check-cursorrules-sync.mjs` by mentioning it there as appropriate.
- **Supabase Key Model**: This project uses the NEW Supabase key model, NOT legacy keys. Always use:
  - `NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY` (not `NEXT_PUBLIC_SUPABASE_ANON_KEY`)
  - `SUPABASE_SECRET_KEY` (not `SUPABASE_SERVICE_ROLE_KEY`)
  - Legacy keys (`SUPABASE_SERVICE_ROLE_KEY`, `NEXT_PUBLIC_SUPABASE_ANON_KEY`) are only used as fallbacks for backward compatibility. See `docs/deployment/SUPABASE_MIGRATION_GUIDE.md` for details.

## Testing Requirements

- Add or adjust tests when you touch logic that affects bookings, availability, payments, or invariants that now live under `docs/invariants/*.md`.
- Prefer executable verification (unit, integration, e2e) to prose. If you add an invariant to `docs/invariants.md`, point to the test(s) that already cover it.
- Run targeted test suites described in `docs/testing/SELECTOR_MAP.md` and the Playwright contracts when shipping API or UI changes.

## Database Workflow

1. Generate a migration with `supabase migration new <name>`.
2. Check the SQL, apply with `supabase db push`, and confirm `supabase db status` shows no pending migrations.
3. Do not execute `pg`, `psql`, or direct SQL; always go through the migration tooling.
4. If `supabase db push` fails, fix the migration history first, then rerun the push.

## Documentation Index Maintenance

- Keep `index.md` current: add new markdown files under the appropriate heading, preserve ordering, and remove entries for deleted files.
- Refer to this file when determining whether a doc already exists before creating a duplicate.

## Reference Files

- `README.md` – Primary project overview and launch guidance.
- `docs/invariants.md` – Single source of truth for enforced invariants.
- `docs/development/INVARIANT_COVERAGE_MATRIX.md` – Matrix linking invariants to coverage and enforcement points.
- `docs/development/DATABASE_MANAGEMENT_POLICY.md` – Database rules.
- `docs/testing/SELECTOR_MAP.md` – Key Playwright selectors and coverage notes.
- `docs/operations/PROOF_RUNBOOK.md` and `docs/operations/RELEASE_CONFIDENCE.md` – Release readiness references.

## Maintenance

- Keep `.cursorrules` aligned with reality; run `pnpm check:cursorrules` after adding or removing important docs so the sync script stays happy.
- Report any missing references that appear in the check output, and update both this file and `scripts/check-cursorrules-sync.mjs` if needed.
