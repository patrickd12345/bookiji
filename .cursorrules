# Bookiji Repository Agent Instructions

## Mandatory Context Loading

- **Daily anchor**: Always refer to `docs/invariants.md` first. It lists the running invariants that code and tests enforce.
- **Expanded context**: When a task touches availability, scheduling, bookings, payments, or security, consult `docs/development/INVARIANT_COVERAGE_MATRIX.md` and the relevant files under `docs/invariants/`.
- **Knowledge Base**: At chat start, check `docs/index.md` and automatically load all KB files listed under the "Bookiji Knowledge Base" section. These files contain troubleshooting guides, FAQs, and vendor documentation that should be referenced when answering questions.

## Key Constraints

- **Truth comes from code and tests**: Do not invent architectural rules outside what runtime code enforces or tests fail when broken.
- **No unauthorized SQL**: Follow `docs/development/DATABASE_MANAGEMENT_POLICY.md`: create Supabase migrations, push them with the CLI, and never issue raw SQL against production schema.
- **Document updates**: When adding a new `.md` file, update `index.md` and ensure the file is referenced by `scripts/check-cursorrules-sync.mjs` by mentioning it there as appropriate.
- **Supabase Key Model**: This project uses the NEW Supabase key model, NOT legacy keys. Always use:
  - `NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY` (not `NEXT_PUBLIC_SUPABASE_ANON_KEY`)
  - `SUPABASE_SECRET_KEY` (not `SUPABASE_SERVICE_ROLE_KEY`)
  - Legacy keys (`SUPABASE_SERVICE_ROLE_KEY`, `NEXT_PUBLIC_SUPABASE_ANON_KEY`) are only used as fallbacks for backward compatibility. See `docs/deployment/SUPABASE_MIGRATION_GUIDE.md` for details.

## Testing Requirements

- Add or adjust tests when you touch logic that affects bookings, availability, payments, or invariants that now live under `docs/invariants/*.md`.
- Prefer executable verification (unit, integration, e2e) to prose. If you add an invariant to `docs/invariants.md`, point to the test(s) that already cover it.
- Run targeted test suites described in `docs/testing/SELECTOR_MAP.md` and the Playwright contracts when shipping API or UI changes.

## Pre-Commit Checks

- **Always run pre-commit on modified files only**: At the end of each execution, automatically stage and run pre-commit checks on only the files that were modified during the session. Use `git add` to stage the modified files, then run `pnpm lint-staged` to execute ESLint fixes on the staged files. This ensures code quality without running checks on the entire codebase.

## Database Workflow

1. Generate a migration with `supabase migration new <name>`.
2. Check the SQL, apply with `supabase db push`, and confirm `supabase db status` shows no pending migrations.
3. Do not execute `pg`, `psql`, or direct SQL; always go through the migration tooling.
4. If `supabase db push` fails, fix the migration history first, then rerun the push.

## Documentation Index Maintenance

- Keep `index.md` current: add new markdown files under the appropriate heading, preserve ordering, and remove entries for deleted files.
- Refer to this file when determining whether a doc already exists before creating a duplicate.

## Project Planning & Timeline Maintenance

- **Visual Timeline Updates**: When tasks are completed, dates change, or status updates occur in Jira, update `docs/VENDOR_SCHEDULING_MVP_VISUAL.md` to reflect current progress. The indented timeline should show:
  - âœ… for completed tasks (status: Done)
  - ðŸ”„ for in-progress tasks (status: In Progress)
  - Updated dates if they change
  - Current status indicators
- **Sync Script**: Use `scripts/sync-jira-to-visual.mjs` to automatically sync Jira status to the visual timeline, or update manually as work progresses.
- **WBS Updates**: Keep `docs/VENDOR_SCHEDULING_MVP_WBS_GANTT.md` aligned with actual progress - update status, % complete, and dates when tasks are completed or schedules change.

## Reference Files

- `README.md` â€“ Primary project overview and launch guidance.
- `docs/invariants.md` â€“ Single source of truth for enforced invariants.
- `docs/development/INVARIANT_COVERAGE_MATRIX.md` â€“ Matrix linking invariants to coverage and enforcement points.
- `docs/development/DATABASE_MANAGEMENT_POLICY.md` â€“ Database rules.
- `docs/testing/SELECTOR_MAP.md` â€“ Key Playwright selectors and coverage notes.
- `docs/operations/PROOF_RUNBOOK.md` and `docs/operations/RELEASE_CONFIDENCE.md` â€“ Release readiness references.

## Maintenance

- Keep `.cursorrules` aligned with reality; run `pnpm check:cursorrules` after adding or removing important docs so the sync script stays happy.
- Report any missing references that appear in the check output, and update both this file and `scripts/check-cursorrules-sync.mjs` if needed.
