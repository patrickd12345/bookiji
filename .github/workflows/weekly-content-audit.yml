name: weekly-content-audit

on:
  workflow_dispatch:
  schedule:
    - cron: "0 9 * * 1" # Mondays 09:00 UTC

jobs:
  audit:
    runs-on: ubuntu-latest
    env:
      BASE: ${{ vars.PUBLIC_BASE_URL }}   # e.g. https://bookiji.com

      # size ceilings (compressed bytes)
      MAX_SITEMAP_KB: "1024"   # 1 MB
      MAX_ROBOTS_KB:  "32"
      MAX_ADS_KB:     "64"

      # cache targets (seconds)
      MIN_CACHE_SITEMAP: "3600"    # ≥1h
      MIN_CACHE_TXT:     "86400"   # ≥1d for robots/ads

    steps:
      - name: Check configuration
        run: |
          set -e
          if [ -z "$BASE" ]; then
            echo "::error ::Set repo variable PUBLIC_BASE_URL (e.g., https://bookiji.com)"; exit 1;
          fi
          echo "Auditing $BASE"

      - name: Helpers
        shell: bash
        run: |
          cat > get_header.sh <<'SH'
          #!/usr/bin/env bash
          # usage: ./get_header.sh headers_file "Header-Name"
          awk -v k="$2" 'BEGIN{IGNORECASE=1} $0 ~ "^"k":" {sub("\r$",""); print substr($0, index($0,$2))}' "$1"
          SH
          chmod +x get_header.sh

          cat > check_cache.sh <<'SH'
          #!/usr/bin/env bash
          # usage: ./check_cache.sh headers_file MIN_SECONDS
          H="$1"; MIN="$2"
          CC=$(./get_header.sh "$H" "Cache-Control")
          if [ -z "$CC" ]; then
            echo "::warning title=Missing Cache-Control::No Cache-Control header"; exit 1
          fi
          MAX=$(echo "$CC" | tr '[:upper:]' '[:lower:]' | sed -n 's/.*max-age=\([0-9]\+\).*/\1/p')
          if [ -z "$MAX" ]; then
            echo "::warning title=No max-age::Cache-Control has no max-age: $CC"; exit 1
          fi
          if [ "$MAX" -lt "$MIN" ]; then
            echo "::error title=Short cache::max-age=$MAX is below minimum $MIN"; exit 2
          fi
          echo "Cache-Control ok (max-age=$MAX)"
          SH
          chmod +x check_cache.sh

      - name: sitemap.xml
        run: |
          set -euo pipefail
          curl -fsS -D /tmp/h1 -o /tmp/sitemap.xml --compressed "$BASE/sitemap.xml"
          grep -Eiq '^Content-Type: (application|text)/xml' /tmp/h1
          grep -Eq '<(urlset|sitemapindex)\b' /tmp/sitemap.xml

          SIZE=$(wc -c </tmp/sitemap.xml)
          LIM=$(( ${MAX_SITEMAP_KB} * 1024 ))
          if [ "$SIZE" -gt "$LIM" ]; then
            echo "::error title=Large sitemap::${SIZE}B > ${LIM}B"; exit 1
          fi

          ./check_cache.sh /tmp/h1 "$MIN_CACHE_SITEMAP" || exit $?
          echo "✅ sitemap.xml ok (size=${SIZE}B)"

      - name: robots.txt
        run: |
          set -euo pipefail
          curl -fsS -D /tmp/h2 -o /tmp/robots.txt --compressed "$BASE/robots.txt"
          test -s /tmp/robots.txt
          grep -iq '^User-agent:' /tmp/robots.txt

          SIZE=$(wc -c </tmp/robots.txt)
          LIM=$(( ${MAX_ROBOTS_KB} * 1024 ))
          if [ "$SIZE" -gt "$LIM" ]; then
            echo "::error title=Large robots.txt::${SIZE}B > ${LIM}B"; exit 1
          fi

          ./check_cache.sh /tmp/h2 "$MIN_CACHE_TXT" || exit $?
          ENCODING=$(./get_header.sh /tmp/h2 "Content-Encoding" || true)
          if [ "$SIZE" -gt 1024 ] && [ -z "$ENCODING" ]; then
            echo "::warning title=Uncompressed robots.txt::Consider gzip/br when >1KB"
          fi
          echo "✅ robots.txt ok (size=${SIZE}B)"

      - name: ads.txt
        run: |
          set -euo pipefail
          curl -fsS -D /tmp/h3 -o /tmp/ads.txt --compressed "$BASE/ads.txt"
          test -s /tmp/ads.txt
          grep -Eq '^[^,#/ ]+,[^,#/ ]+,(DIRECT|RESELLER)' /tmp/ads.txt

          SIZE=$(wc -c </tmp/ads.txt)
          LIM=$(( ${MAX_ADS_KB} * 1024 ))
          if [ "$SIZE" -gt "$LIM" ]; then
            echo "::error title=Large ads.txt::${SIZE}B > ${LIM}B"; exit 1
          fi

          ./check_cache.sh /tmp/h3 "$MIN_CACHE_TXT" || exit $?
          ENCODING=$(./get_header.sh /tmp/h3 "Content-Encoding" || true)
          if [ "$SIZE" -gt 2048 ] && [ -z "$ENCODING" ]; then
            echo "::warning title=Uncompressed ads.txt::Consider gzip/br when >2KB"
          fi
          echo "✅ ads.txt ok (size=${SIZE}B)"
