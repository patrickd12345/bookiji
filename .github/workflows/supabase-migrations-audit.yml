name: Supabase Migrations Audit (Monthly)

on:
  schedule:
    # 09:00 UTC on the 1st of every month â€” adjust as you like
    - cron: "0 9 1 * *"
  workflow_dispatch: {}
  push:
    branches: [main, bookiji]
    paths:
      - "supabase/migrations/**"

jobs:
  audit-staging:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Auth & Link (Staging)
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN_STG }}
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF_STG }}
        run: |
          supabase link --project-ref "$SUPABASE_PROJECT_REF"

      - name: Remote migration list (Staging)
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN_STG }}
        run: |
          echo "## Remote migrations (staging)" >> $GITHUB_STEP_SUMMARY
          supabase migration list --linked --output json | tee migrations_staging.json
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat migrations_staging.json >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Compare repo migrations vs remote (Staging)
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN_STG }}
        run: |
          python .github/scripts/compare_supabase_migrations.py --env staging --remote-json migrations_staging.json

      - name: Schema dump & hash (Staging)
        id: schema-staging
        if: ${{ secrets.SUPABASE_DB_URL_STG != '' }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN_STG }}
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL_STG }}
        run: |
          # Dump schema only (no data). Produces supabase/schema.sql
          supabase db dump --schema-only --db-url env://SUPABASE_DB_URL

          # If you don't want to store DB URL, let CLI infer from 'link' (older CLI may need DB URL)
          # Compute hash even if file missing (shows 'N/A')
          if [ -f supabase/schema.sql ]; then
            sha256sum supabase/schema.sql | tee schema_staging.sha256
            echo "hash=$(cut -d' ' -f1 schema_staging.sha256)" >> $GITHUB_OUTPUT
          else
            echo "No schema.sql produced; check CLI/db-url permissions." | tee schema_staging.sha256
            echo "hash=N/A" >> $GITHUB_OUTPUT
          fi

          echo "### Schema hash (staging)" >> $GITHUB_STEP_SUMMARY
          echo "\`${{ steps.schema-staging.outputs.hash }}\`" >> $GITHUB_STEP_SUMMARY

      - name: Upload artifacts (Staging)
        uses: actions/upload-artifact@v4
        with:
          name: supabase-audit-staging
          path: |
            migrations_staging.json
            schema_staging.sha256
            supabase/schema.sql

      # Optional: post to your ops webhook (Slack/Teams/etc.)
      - name: Notify ops webhook (Staging) (optional)
        env:
          WEBHOOK_URL: ${{ secrets.OPS_WEBHOOK_URL_STG }}
        run: |
          if [ -n "$WEBHOOK_URL" ] && [ "$WEBHOOK_URL" != "" ]; then
            payload=$(jq -nc --arg env "staging" --arg hash "${{ steps.schema-staging.outputs.hash }}" '
              { text: ("Supabase migration audit (" + $env + "): schema_hash=" + $hash) }')
            curl -sS -X POST -H 'Content-Type: application/json' --data "$payload" "$WEBHOOK_URL" || true
          fi

  audit-production:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Auth & Link (Production)
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN_PROD }}
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF_PROD }}
        run: |
          supabase link --project-ref "$SUPABASE_PROJECT_REF"

      - name: Remote migration list (Production)
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN_PROD }}
        run: |
          echo "## Remote migrations (production)" >> $GITHUB_STEP_SUMMARY
          supabase migration list --linked --output json | tee migrations_production.json
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat migrations_production.json >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Compare repo migrations vs remote (Production)
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN_PROD }}
        run: |
          python .github/scripts/compare_supabase_migrations.py --env production --remote-json migrations_production.json

      - name: Schema dump & hash (Production)
        id: schema-production
        if: ${{ secrets.SUPABASE_DB_URL_PROD != '' }}
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN_PROD }}
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL_PROD }}
        run: |
          # Dump schema only (no data). Produces supabase/schema.sql
          supabase db dump --schema-only --db-url env://SUPABASE_DB_URL

          # If you don't want to store DB URL, let CLI infer from 'link' (older CLI may need DB URL)
          # Compute hash even if file missing (shows 'N/A')
          if [ -f supabase/schema.sql ]; then
            sha256sum supabase/schema.sql | tee schema_production.sha256
            echo "hash=$(cut -d' ' -f1 schema_production.sha256)" >> $GITHUB_OUTPUT
          else
            echo "No schema.sql produced; check CLI/db-url permissions." | tee schema_production.sha256
            echo "hash=N/A" >> $GITHUB_OUTPUT
          fi

          echo "### Schema hash (production)" >> $GITHUB_STEP_SUMMARY
          echo "\`${{ steps.schema-production.outputs.hash }}\`" >> $GITHUB_STEP_SUMMARY

      - name: Upload artifacts (Production)
        uses: actions/upload-artifact@v4
        with:
          name: supabase-audit-production
          path: |
            migrations_production.json
            schema_production.sha256
            supabase/schema.sql

      # Optional: post to your ops webhook (Slack/Teams/etc.)
      - name: Notify ops webhook (Production) (optional)
        env:
          WEBHOOK_URL: ${{ secrets.OPS_WEBHOOK_URL_PROD }}
        run: |
          if [ -n "$WEBHOOK_URL" ] && [ "$WEBHOOK_URL" != "" ]; then
            payload=$(jq -nc --arg env "production" --arg hash "${{ steps.schema-production.outputs.hash }}" '
              { text: ("Supabase migration audit (" + $env + "): schema_hash=" + $hash) }')
            curl -sS -X POST -H 'Content-Type: application/json' --data "$payload" "$WEBHOOK_URL" || true
          fi

  summary:
    runs-on: ubuntu-latest
    needs: [audit-staging, audit-production]
    if: always()
    steps:
      - name: Monthly Migration Audit Summary
        run: |
          echo "# ðŸ° Monthly Migration Fortress Audit" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š Audit Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u '+%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Staging Status:** ${{ needs.audit-staging.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Production Status:** ${{ needs.audit-production.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸŽ¯ What This Audit Proves" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Migrations are linked and visible**" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Schema fingerprint captured**" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Fortress walls are standing**" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **No manual dashboard changes**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“ Artifacts Available" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Migration lists for both environments" >> $GITHUB_STEP_SUMMARY
          echo "- Schema dumps with SHA-256 hashes" >> $GITHUB_STEP_SUMMARY
          echo "- Download from Actions â†’ Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ” Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. **Compare hashes** month-to-month for schema drift detection" >> $GITHUB_STEP_SUMMARY
          echo "2. **Review migration counts** to ensure consistency" >> $GITHUB_STEP_SUMMARY
          echo "3. **Download artifacts** if detailed analysis needed" >> $GITHUB_STEP_SUMMARY
          echo "4. **Celebrate** - your migration fortress is working!" >> $GITHUB_STEP_SUMMARY
