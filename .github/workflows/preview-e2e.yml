name: Preview E2E
on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      retention_days:
        description: "Artifact retention (days)"
        required: false
        default: "3"

concurrency:
  group: preview-e2e-${{ github.ref }}
  cancel-in-progress: true

jobs:
  preview-e2e:
    runs-on: ubuntu-latest
    timeout-minutes: 40
    environment: preview
    permissions:
      contents: read
      actions: read
    env:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
      SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
      SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
      STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
      STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET }}
      SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
      SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
      SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
      ALERT_WEBHOOK_URL: ${{ secrets.ALERT_WEBHOOK_URL }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install deps
        run: npm ci

      - name: Vercel CLI
        run: npm i -g vercel@latest

      - name: Deploy Preview (ephemeral)
        id: deploy
        run: |
          url=$(vercel deploy --token "$VERCEL_TOKEN" --scope "$VERCEL_ORG_ID" --project "$VERCEL_PROJECT_ID" --yes)
          echo "preview_url=$url" >> $GITHUB_OUTPUT
          echo "Preview at $url"
          echo "NEXT_PUBLIC_BASE_URL=$url" >> $GITHUB_ENV

      - name: Wait for health
        run: |
          npx wait-on -t 600000 ${{ steps.deploy.outputs.preview_url }}/api/health
          curl -fsSL "${{ steps.deploy.outputs.preview_url }}/api/health"

      # OPTIONAL: run remote Supabase migrations in a PR-only "shadow" schema if you have one.
      # Safe default is to skip remote migrations here and rely on unit tests. Leave this commented unless you've set up a non-prod DB.
      # - name: Supabase CLI (optional)
      #   run: npm i -g supabase@latest
      # - name: Link Supabase (optional)
      #   run: supabase link --project-ref $SUPABASE_PROJECT_REF --password $SUPABASE_DB_PASSWORD
      # - name: DB Push (optional)
      #   run: supabase db push

      - name: Cache Playwright browsers
        id: cache-playwright
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            playwright-${{ runner.os }}-

      - name: Install Playwright
        if: steps.cache-playwright.outputs.cache-hit != 'true'
        run: npx playwright install --with-deps | cat

      - name: "Guardrail: forbid vitest outside unit tests"
        run: |
          set -e
          if rg -n "from 'vitest'|require\\(['\"]vitest['\"]\\)" --glob '!src/**/__tests__/**' --glob '!src/**/*.test.*' --glob '!src/**/*.spec.*' . ; then
            echo "::error ::Forbidden 'vitest' import found outside unit tests."; exit 1; 
          fi

      - name: "Guardrail: forbid '@playwright/test' outside tests/**"
        run: |
          set -e
          if rg -n "from '@playwright/test'|require\\(['\"]@playwright/test['\"]\\)" --glob '!tests/**' . ; then
            echo "::error ::Forbidden '@playwright/test' import found outside tests/"; exit 1;
          fi

      - name: E2E Tests
        env:
          BASE_URL: ${{ steps.deploy.outputs.preview_url }}
          NODE_ENV: test
          RLH_BURST: 14
          TEST_VENDOR_SLUG: ${{ secrets.TEST_VENDOR_SLUG }}
          TEST_SERVICE_ID: ${{ secrets.TEST_SERVICE_ID }}
          ENABLE_TEST_WEBHOOK_BYPASS: 'true'
          TEST_WEBHOOK_KEY: ${{ secrets.TEST_WEBHOOK_KEY }}
          RATE_LIMIT_PI_MAX: '3'
          RATE_LIMIT_PI_WINDOW_MS: '2000'
          CANONICAL_HOST: bookiji.com
          ENABLE_TEST_ROUTES: 'true'
        run: npx playwright test tests/rate-limit.spec.ts tests/seo.spec.ts tests/webhook-roundtrip.spec.ts tests/ics.spec.ts tests/seo-canonical.spec.ts tests/rebooking-ui.spec.ts tests/a11y-home.spec.ts --reporter=line | cat

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report
          retention-days: ${{ github.ref == 'refs/heads/main' && 7 || (inputs.retention_days != '' && inputs.retention_days || 3) }}
          if-no-files-found: ignore

      - name: Collect axe JSON
        if: always() && (github.ref == 'refs/heads/main' || failure())
        run: |
          mkdir -p axe-artifacts
          find . -type f -path "**/test-results/**/attachments/axe-*.json" -exec cp {} axe-artifacts/ \; || true
          find . -type f -path "**/playwright-report/**/attachments/axe-*.json" -exec cp {} axe-artifacts/ \; || true

      - name: Upload axe artifacts
        if: always() && (github.ref == 'refs/heads/main' || failure())
        uses: actions/upload-artifact@v4
        with:
          name: axe-json-${{ github.run_number }}
          path: axe-artifacts
          if-no-files-found: ignore
          retention-days: ${{ github.ref == 'refs/heads/main' && 7 || (inputs.retention_days != '' && inputs.retention_days || 3) }}

      - name: Alert on failure
        if: failure() && env.ALERT_WEBHOOK_URL != ''
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data "{\"text\":\"‚ùå Preview E2E failed on PR #${{ github.event.pull_request.number }} (${{ github.sha }}).\"}" \
          ${{ env.ALERT_WEBHOOK_URL }}
