name: Synthetic Monitors (Prod)
on:
  schedule:
    - cron: '*/15 * * * *'   # every 15 minutes
  workflow_dispatch: {}

jobs:
  canaries:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment: production
    permissions:
      contents: read
      actions: read
    env:
      BASE_URL: https://bookiji.com
      ALERT_WEBHOOK_URL: ${{ secrets.ALERT_WEBHOOK_URL }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: 20 }
      - run: npm ci
      - name: Cache Playwright browsers
        id: cache-playwright
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            playwright-${{ runner.os }}-

      - name: Install Playwright
        if: steps.cache-playwright.outputs.cache-hit != 'true'
        run: npx playwright install --with-deps
      - name: Run canaries (twice, confirm breach)
        run: |
          set -e
          FAILED=0
          
          echo "üîÑ Running first canary check..."
          npx playwright test \
            tests/health.spec.ts \
            tests/calendar-links.spec.ts \
            tests/admin-guard.spec.ts \
            --reporter=line || FAILED=1
          
          if [ "$FAILED" -eq 1 ]; then
            echo "‚ö†Ô∏è  First canary failed, waiting 60s before retry..."
            sleep 60
            
            echo "üîÑ Running second canary check..."
            npx playwright test \
              tests/health.spec.ts \
              tests/calendar-links.spec.ts \
              tests/admin-guard.spec.ts \
              --reporter=line || FAILED=2
          fi
          
          if [ "$FAILED" -ge 2 ]; then
            echo "‚ùå Canary failed twice - this is a real issue"
            exit 1
          else
            echo "‚úÖ Canaries passed or only failed once (transient issue)"
          fi
      - name: Alert on failure
        if: failure() && env.ALERT_WEBHOOK_URL != ''
        run: |
          curl -X POST -H 'Content-Type: application/json' \
            --data "{\"text\":\"‚ùå Prod canary failed on ${GITHUB_WORKFLOW}. Check Playwright run.\"}" \
            "$ALERT_WEBHOOK_URL"
