# Immutable Deployments

This document describes Bookiji's immutable deployment strategy and practices.

## Overview

Immutable deployments ensure that:
- Every commit gets a unique, unchangeable deployment
- Rollbacks are safe and predictable
- Deployment history is fully traceable
- No in-place updates that could cause inconsistencies

## Vercel's Immutable Deployment Model

Vercel provides immutable deployments by default:

1. **Each commit** → Unique deployment with its own URL
2. **Deployment URLs** are permanent and never change
3. **Promotion** moves traffic to a different deployment (immutable)
4. **Rollback** promotes a previous deployment (no code changes)

### Deployment Lifecycle

```
Commit abc1234 → Deployment abc1234-vercel.vercel.app
  ↓
Promote to Production → www.bookiji.com points to abc1234
  ↓
New Commit def5678 → Deployment def5678-vercel.vercel.app
  ↓
Promote to Production → www.bookiji.com points to def5678
  ↓
Rollback → www.bookiji.com points back to abc1234
```

## CI Integration

### Deployment Metadata

Every E2E test run creates deployment metadata:

**File:** `deploy-metadata/deploy-{sha}.json`

```json
{
  "sha": "abc1234def5678...",
  "previewUrl": "https://pr-123.bookiji.com",
  "productionUrl": "https://www.bookiji.com",
  "createdAt": "2025-12-07T10:00:00Z"
}
```

**Generated by:** `.github/workflows/ci-e2e.yml`

**Uploaded as:** Artifact `deploy-metadata-{sha}`

### Accessing Metadata

**In CI:**
```yaml
- name: Download deploy metadata
  uses: actions/download-artifact@v4
  with:
    name: deploy-metadata-${{ github.sha }}
    path: deploy-metadata/
```

**In Scripts:**
```typescript
import * as fs from 'fs'

const metadata = JSON.parse(
  fs.readFileSync(`deploy-metadata/deploy-${process.env.GITHUB_SHA}.json`, 'utf-8')
)

console.log(`Deployment URL: ${metadata.previewUrl}`)
```

## Rollback Process

### Method 1: Vercel Dashboard

1. Go to Vercel Dashboard → Project → Deployments
2. Find previous successful deployment
3. Click "..." → "Promote to Production"
4. Confirm promotion

### Method 2: Vercel CLI

```bash
# List deployments
vercel ls

# Promote specific deployment
vercel promote <deployment-url> --yes
```

### Method 3: Automated Rollback Script

**Script:** `scripts/rollback.ts` (already exists)

```bash
# Rollback to previous deployment
npx tsx scripts/rollback.ts

# Rollback to specific SHA
npx tsx scripts/rollback.ts --sha abc1234
```

## Deployment URLs

### Preview Deployments

**Pattern:** `https://{branch}-{project}.vercel.app`

**Examples:**
- `https://pr-123-bookiji.vercel.app`
- `https://feature-booking-bookiji.vercel.app`

### Production

**Pattern:** `https://www.bookiji.com` (custom domain)

Always points to the currently promoted deployment.

## Best Practices

### 1. Never Modify Deployments

❌ **Don't:**
- SSH into production and edit files
- Hot-fix code in running containers
- Update environment variables on live deployment

✅ **Do:**
- Create new commit with fix
- Deploy new immutable deployment
- Promote when validated

### 2. Always Test Before Promotion

✅ **Process:**
1. Deploy to preview
2. Run E2E tests against preview
3. Validate canary (if applicable)
4. Promote to production

### 3. Keep Deployment History

✅ **Track:**
- Commit SHA for each deployment
- Deployment URL
- Promotion timestamp
- Test results

**Stored in:** `deploy-metadata/` directory

### 4. Use Feature Flags for Gradual Rollouts

Instead of modifying deployments, use feature flags:

```typescript
// Feature flag service
if (featureFlags.isEnabled('new-booking-flow', userId)) {
  // New code path
} else {
  // Old code path
}
```

This allows:
- Gradual rollout without new deployment
- Instant rollback via flag toggle
- A/B testing capabilities

## CI/CD Integration

### Workflow: `.github/workflows/ci-e2e.yml`

**Steps:**
1. Deploy preview (handled by Vercel)
2. Run E2E tests
3. Create deployment metadata
4. Upload metadata as artifact

**Metadata includes:**
- Commit SHA
- Preview URL
- Production URL (if applicable)
- Timestamp

### Canary Deployments

**Workflow:** `.github/workflows/ci-e2e.yml` → `canary-deploy` job

**Process:**
1. Deploy canary (immutable)
2. Run smoke tests
3. Analyze canary results
4. Promote or rollback based on analysis

**Rollback:** Automatic if canary fails

## Monitoring Deployments

### Vercel Dashboard

- View all deployments
- See commit SHA for each
- Check deployment status
- Access deployment URLs

### CI Artifacts

- Download `deploy-metadata-{sha}` artifacts
- View deployment history
- Trace issues to specific deployments

### GitHub Actions

- View workflow runs
- See which commit triggered deployment
- Check test results per deployment

## Troubleshooting

### Deployment Not Found

**Problem:** Can't find deployment for commit SHA

**Solution:**
- Check Vercel dashboard for deployment
- Verify commit was pushed to correct branch
- Check deployment logs in Vercel

### Rollback Failed

**Problem:** Can't rollback to previous deployment

**Solution:**
- Verify previous deployment exists in Vercel
- Check Vercel API token permissions
- Use Vercel dashboard for manual rollback

### Metadata Missing

**Problem:** `deploy-metadata/` directory empty

**Solution:**
- Ensure `ci-e2e.yml` workflow ran
- Check artifact upload step
- Download artifacts from GitHub Actions

## See Also

- [Vercel Deployment Documentation](https://vercel.com/docs/deployments)
- `docs/LEVEL4_ENHANCEMENTS.md` - Level 4 enhancements
- `scripts/rollback.ts` - Rollback script
- `.github/workflows/ci-e2e.yml` - CI workflow
