# F-015.3 Outbound Booking → Calendar Events (Write Path)

This document summarizes the mapping, idempotency, and failure recovery semantics implemented in F-015.3.

## Mapping rules
- Booking → Calendar Event mapping is deterministic:
  - Title: `Booking: {service_name || 'Appointment'}`
  - Description: `Booking ID: {booking_id} | Notes: {sanitized_notes}`
  - Times are stored in UTC.
  - `ics_uid` generated by `generateIcsUid(booking_id, provider_id, calendar_provider)`.

## Persistence
- Reuse `external_calendar_events` table as the canonical mirror and mapping store.
- New columns added (via migration file but not applied automatically):
  - `booking_id` (nullable)
  - `sync_status` (CREATED/UPDATED/CANCELLED/FAILED)
  - `last_error` (optional)
- Uniqueness:
  - `UNIQUE(provider_id, calendar_provider, external_event_id)` remains for inbound events
  - `UNIQUE(booking_id, calendar_provider)` enforced via unique index for outbound mappings when booking_id IS NOT NULL

## Idempotency
- Deterministic ICS UID + payload checksum (SHA-256) are used to detect duplicates and unchanged payloads.
- On create:
  - If mapping exists for (booking_id, calendar_provider) and checksum unchanged → no-op
  - If mapping exists and checksum changed → update path
  - Else → adapter.createEvent(...) executed and mapping persisted
- On update:
  - If checksum unchanged → no-op
  - Else → adapter.updateEvent(...) or deterministic cancel+recreate fallback
- On cancel:
  - adapter.deleteEvent/external cancel used if available; otherwise mapping marked CANCELLED locally

## Failure Recovery
- Adapter failures persist `sync_status = 'FAILED'` and `last_error` with error message.
- Mapping state is never lost on failure — retries can be performed deterministically by re-calling the same sync functions.
- All DB writes are performed per-booking; operations are atomic in the sense that mapping state is updated in a single upsert call.

## Files of Interest
- Migration (not applied): `supabase/migrations/20260119000000_outbound_calendar_sync.sql`
- ICS UID: `src/lib/calendar-sync/ics-uid.ts`
- Mapping: `src/lib/calendar-sync/outbound/map-booking-to-event.ts`
- Checksum: `src/lib/calendar-sync/checksum.ts` (payload checksum)
- Repository: `src/lib/calendar-sync/repositories/booking-event-repository.ts`
- Outbound flows:
  - `src/lib/calendar-sync/outbound/sync-booking-created.ts`
  - `src/lib/calendar-sync/outbound/sync-booking-updated.ts`
  - `src/lib/calendar-sync/outbound/sync-booking-cancelled.ts`
- Mock adapter for tests: `src/lib/calendar-adapters/mock.ts`
- Tests: `tests/lib/calendar-sync/**`

## Notes & Rationale
- Use existing table `external_calendar_events` per non-negotiables (no parallel tables).
- Use `provider_id` consistently.
- Adapter write methods are optional; flows handle absence (persist FAILED, fallback).
- No external API calls are made in code — mock adapter used for tests.

