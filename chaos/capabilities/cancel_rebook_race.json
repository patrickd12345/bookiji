{
  "id": "cancel_rebook_race",
  "name": "Cancel-Rebook Race",
  "description": "Proves slot exclusivity under cancel+rebook race conditions",
  "fixtureSpecs": {
    "vendor": {
      "type": "auth_user",
      "required": true,
      "template": {
        "email": "vendor-{{seed}}@test.bookiji.local",
        "fullName": "Vendor {{seed}}",
        "role": "vendor"
      }
    },
    "customer1": {
      "type": "auth_user",
      "required": true,
      "template": {
        "email": "customer1-{{seed}}@test.bookiji.local",
        "fullName": "Customer 1 {{seed}}",
        "role": "customer"
      }
    },
    "customer2": {
      "type": "auth_user",
      "required": true,
      "template": {
        "email": "customer2-{{seed}}@test.bookiji.local",
        "fullName": "Customer 2 {{seed}}",
        "role": "customer"
      }
    },
    "vendorProfile": {
      "type": "profile",
      "required": true,
      "dependsOn": ["vendor"],
      "template": {
        "id": "{{vendorId}}",
        "auth_user_id": "{{vendorId}}",
        "email": "vendor-{{seed}}@test.bookiji.local",
        "full_name": "Vendor {{seed}}",
        "role": "vendor"
      }
    },
    "customer1Profile": {
      "type": "profile",
      "required": true,
      "dependsOn": ["customer1"],
      "template": {
        "id": "{{customer1Id}}",
        "auth_user_id": "{{customer1Id}}",
        "email": "customer1-{{seed}}@test.bookiji.local",
        "full_name": "Customer 1 {{seed}}",
        "role": "customer"
      }
    },
    "customer2Profile": {
      "type": "profile",
      "required": true,
      "dependsOn": ["customer2"],
      "template": {
        "id": "{{customer2Id}}",
        "auth_user_id": "{{customer2Id}}",
        "email": "customer2-{{seed}}@test.bookiji.local",
        "full_name": "Customer 2 {{seed}}",
        "role": "customer"
      }
    },
    "service": {
      "type": "service",
      "required": true,
      "dependsOn": ["vendor"],
      "template": {
        "id": "{{serviceId}}",
        "provider_id": "{{vendorId}}",
        "name": "Test Service",
        "category": "test",
        "price": 10.00,
        "duration_minutes": 60,
        "is_active": true
      }
    },
    "slot": {
      "type": "slot",
      "required": true,
      "dependsOn": ["vendor"],
      "template": {
        "id": "{{slotId}}",
        "provider_id": "{{vendorId}}",
        "start_time": "{{slotStart}}",
        "end_time": "{{slotEnd}}",
        "is_available": true,
        "slot_type": "regular"
      }
    },
    "initialBooking": {
      "type": "booking",
      "required": true,
      "dependsOn": ["customer1", "vendor", "service", "slot"],
      "template": {
        "id": "{{initialBookingId}}",
        "customer_id": "{{customer1Id}}",
        "provider_id": "{{vendorId}}",
        "service_id": "{{serviceId}}",
        "start_time": "{{slotStart}}",
        "end_time": "{{slotEnd}}",
        "status": "confirmed",
        "total_amount": 10.00
      }
    }
  },
  "intentSpecs": {
    "cancel": {
      "intentId": "{{cancelIntentId}}",
      "endpoint": "/rpc/cancel_booking",
      "payloadTemplate": {
        "p_booking_id": "{{initialBookingId}}"
      }
    },
    "rebook": {
      "intentId": "{{rebookIntentId}}",
      "endpoint": "/rpc/claim_slot_and_create_booking",
      "payloadTemplate": {
        "p_slot_id": "{{slotId}}",
        "p_booking_id": "{{rebookBookingId}}",
        "p_customer_id": "{{customer2Id}}",
        "p_provider_id": "{{vendorId}}",
        "p_service_id": "{{serviceId}}",
        "p_total_amount": 10.00
      }
    }
  },
  "invariantSpecs": {
    "booking_cardinality": {
      "type": "cardinality",
      "query": {
        "type": "bookings",
        "filters": {
          "provider_id": "{{vendorId}}",
          "start_time": "{{slotStart}}",
          "end_time": "{{slotEnd}}",
          "exclude_status": ["cancelled", "no_show"]
        }
      },
      "expectation": {
        "type": "cardinality",
        "field": "bookings",
        "max": 1
      }
    },
    "availability_coherence": {
      "type": "coherence",
      "query": {
        "type": "multi",
        "queries": {
          "slot": { "type": "slot", "id": "{{slotId}}" },
          "bookings": {
            "type": "bookings",
            "filters": {
              "provider_id": "{{vendorId}}",
              "start_time": "{{slotStart}}",
              "end_time": "{{slotEnd}}",
              "exclude_status": ["cancelled", "no_show"]
            }
          }
        }
      },
      "expectation": {
        "type": "coherence",
        "condition": {
          "field": "bookings.length",
          "operator": "===",
          "value": 1
        },
        "then": {
          "slot.is_available": false
        }
      }
    }
  },
  "chaosProfile": {
    "send_request": 0.30,
    "retry_request": 0.40,
    "restart_process": 0.20,
    "no_op": 0.10
  }
}

