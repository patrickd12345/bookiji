FROM node:18-bookworm-slim

ENV TZ=UTC
ENV NODE_ENV=test
ENV PLAYWRIGHT_BROWSERS_PATH=/ms-playwright

WORKDIR /app

# System deps:
# - postgresql-client: used by Supabase CLI (and useful for debugging)
# - curl/ca-certificates: health checks / downloads
RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates \
    curl \
    postgresql-client \
  && rm -rf /var/lib/apt/lists/*

# Enable and pin pnpm (matches pnpm-lock.yaml v9)
RUN corepack enable && corepack prepare pnpm@9.1.2 --activate

# Copy lockfiles and package manifests first for better caching
COPY package.json pnpm-lock.yaml ./

# Install dependencies strictly from lockfile
RUN pnpm install --frozen-lockfile

# Copy full repo (migrations, seeds, tests)
COPY . .

# Install Playwright browser + OS deps (deterministic per @playwright/test version)
RUN pnpm exec playwright install --with-deps chromium

# Everything below here runs in the test job container
# Entrypoint will be specified by docker-compose to:
# - Run Supabase migrations
# - Seed test users/data
# - Run full test suite (vitest, then e2e)

# Default command is noop; actual test-run command set in docker-compose
CMD ["sleep", "infinity"]
