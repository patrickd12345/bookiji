#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "ğŸ›¡ï¸ Migration Guard - Pre-commit Check..."

# Check for any staged migration files
staged_migrations=$(git diff --cached --name-only --diff-filter=ACMR | grep "^supabase/migrations/" || echo "")

if [ -n "$staged_migrations" ]; then
  echo "ğŸ” Found staged migration files, checking format..."
  
  for file in $staged_migrations; do
    filename=$(basename "$file")
    
    # Skip _hold directory
    if [[ "$filename" == "_hold" ]]; then
      continue
    fi
    
    # Allow exception files with proper documentation
    if grep -q "-- EMERGENCY HOTFIX" "$file" 2>/dev/null; then
      echo "âš ï¸  Emergency hotfix detected: $filename"
      if [ ! -f "HOTFIX_MIGRATIONS.md" ]; then
        echo "âŒ Emergency hotfix requires HOTFIX_MIGRATIONS.md documentation"
        echo "ğŸ‘‰ Document the reason for this exception"
        exit 1
      fi
      continue
    fi
    
    # Enforce strict timestamp format: YYYYMMDDHHMMSS_name.sql or legacy 000_name.sql
    if [[ ! "$filename" =~ ^[0-9]{14}_.+\.sql$ && ! "$filename" =~ ^[0-9]{3}_.+\.sql$ ]]; then
      echo ""
      echo "âŒ MIGRATION GUARD VIOLATION!"
      echo "ğŸ“ File: $file"
      echo "ğŸš« Invalid filename format: $filename"
      echo ""
      echo "âœ… Valid formats:"
      echo "   â€¢ YYYYMMDDHHMMSS_description.sql (generated by CLI)"
      echo "   â€¢ 000_legacy_migration.sql (legacy format)"
      echo ""
      echo "ğŸ”§ How to fix:"
      echo "   1. Delete the malformed file: rm '$file'"
      echo "   2. Use CLI: supabase migration new your_description"
      echo "   3. Copy your SQL content to the generated file"
      echo ""
      echo "ğŸš¨ NEVER create migration files manually!"
      echo ""
      exit 1
    fi
    
    # Check for dangerous operations without safeguards
    if grep -qi "DROP TABLE\|TRUNCATE\|DELETE FROM.*WHERE" "$file" 2>/dev/null; then
      if ! grep -qi "IF EXISTS\|-- CONFIRMED SAFE" "$file" 2>/dev/null; then
        echo ""
        echo "âš ï¸  DANGEROUS OPERATION DETECTED!"
        echo "ğŸ“ File: $file"
        echo "ğŸš¨ Contains: DROP TABLE, TRUNCATE, or DELETE"
        echo ""
        echo "âœ… Add safety comment to proceed:"
        echo "   -- CONFIRMED SAFE: [reason why this is safe]"
        echo ""
        exit 1
      fi
    fi
    
    echo "âœ… $filename - format valid"
  done
  
  echo "ğŸ¯ All migration files passed pre-commit checks!"
else
  echo "ğŸ“ No migration files staged"
fi

echo "âœ… Migration Guard passed - commit allowed"